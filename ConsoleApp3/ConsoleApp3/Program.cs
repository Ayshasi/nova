using System;
using System.Collections;
using System.Collections.Specialized;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Diagnostics;
using System.IO;
using System.Text.RegularExpressions;
using System.IO.Compression;
using System.Xml;
using System.Xml.Linq;
using System.Net;
using System.Net.Mail;
using System.Configuration;
using System.Data.SqlClient;
using System.Data;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using System.Xml.XPath;
using Word = Microsoft.Office.Interop.Word;
using Xl = Microsoft.Office.Interop.Excel;
namespace Auto_Reports_Tool
{
    class CommonClass
    {
        //public string Lookupinfo= File.ReadAllText(System.Environment.CurrentDirectory + @"\ZipExtract.ini");
        //Main_Form Mf = new Main_Form();         
        string Zipname = "";
        public string cupjrnl = "";
        public bool cuppmjrnl = false;
        bool sensau = false;
        public Boolean bIsValidateRun = false;
        //public ArrayList Extractedfiles = new ArrayList();
        //public void KillProcess(string name)
        //{            
        //    foreach(Process P in Process.GetProcessesByName(name))
        //    {
        //        try
        //        {
        //            P.Kill();
        //        }
        //        catch (Exception e) {}
        //    }
        //}
        //***
        public bool extractzipsuccess = true;
        public void Recursive_ExtractZip(string Dir)
        {
            //Extractedfiles.Clear();
            try
            {
                foreach (string Z in Directory.GetFiles(Dir, "*.zip"))
                {
                    string WL = Path.GetDirectoryName(Z);
                    try
                    {
                        Zipname = Z;
                        UnZip(Z, WL);
                        if (Directory.GetFiles(WL, "*.zip").Count() > 0) Recursive_ExtractZip(WL);
                    }
                    catch (Exception e)
                    {
                        SaveToReport("Error: " + Path.GetFileName(Zipname) + e.Message + "\n" + e.StackTrace);
                        if (Directory.Exists(WL + @"\Error\" + SerializedClass.month + @"\" + SerializedClass.Date) == false)
                        {
                            Directory.CreateDirectory(WL + @"\Error\" + SerializedClass.month + @"\" + SerializedClass.Date);
                        }
                        File.Copy(Z, WL + @"\Error\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileName(Z), true);
                        File.Delete(Z);
                        extractzipsuccess = false;
                    }
                }
            }
            catch (Exception ex) { }
        }
        //***
        //***
        public bool ExtractRAR(string Z)
        {
            string WL = Path.GetDirectoryName(Z);
            try
            {
                if (Directory.Exists(Z.Replace(".rar", ""))) Directory.Delete(Z.Replace(".rar", ""), true);
                Zipname = Z;
                Process compiler = new Process();
                compiler.StartInfo.FileName = @"\\techsetserver1\software\application\7-zip\7z.exe";
                compiler.StartInfo.Arguments = "x " + "\"" + Z + "\"" + " -o" + "\"" + Z.Replace(".rar", "") + "\"";
                compiler.StartInfo.UseShellExecute = true;
                //compiler.StartInfo.RedirectStandardOutput = true;
                compiler.Start();
                //string gt = compiler.StandardOutput.ReadToEnd();
                compiler.WaitForExit();
                if (!Directory.Exists(Z.Replace(".rar", "")))
                {
                    SaveToReport("Error: Unable to extract rar file." + Path.GetFileName(Zipname));
                    //Move to Error
                    if (Directory.Exists(WL + @"\Error\" + SerializedClass.month + @"\" + SerializedClass.Date) == false)
                    {
                        Directory.CreateDirectory(WL + @"\Error\" + SerializedClass.month + @"\" + SerializedClass.Date);
                    }
                    File.Copy(Z, WL + @"\Error\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileName(Z), true);
                    File.Delete(Z);
                    return false;
                }
                return true;
            }
            catch (Exception e)
            {
                SaveToReport("Error: " + Path.GetFileName(Zipname) + e.Message + "\n" + e.StackTrace);
                //Move to Error
                if (Directory.Exists(WL + @"\Error\" + SerializedClass.month + @"\" + SerializedClass.Date) == false)
                {
                    Directory.CreateDirectory(WL + @"\Error\" + SerializedClass.month + @"\" + SerializedClass.Date);
                }
                File.Copy(Z, WL + @"\Error\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileName(Z), true);
                File.Delete(Z);
                return false;
            }
        }
        //***
        //***
        public bool ExtractZip(string Z)
        {
            //Extractedfiles.Clear();
            string WL = Path.GetDirectoryName(Z);
            try
            {
                Zipname = Z;
                UnZip(Z, WL);
                return true;
            }
            catch (Exception e)
            {
                SaveToReport("Error: " + Path.GetFileName(Zipname) + e.Message + "\n" + e.StackTrace);
                //Move to Error
                if (Directory.Exists(WL + @"\Error\" + SerializedClass.month + @"\" + SerializedClass.Date) == false)
                {
                    Directory.CreateDirectory(WL + @"\Error\" + SerializedClass.month + @"\" + SerializedClass.Date);
                }
                File.Copy(Z, WL + @"\Error\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileName(Z), true);
                File.Delete(Z);
                return false;
            }
        }
        //***
        public void UnZip_Old(string zipFile, string folderPath)
        {
            SaveToReport("Status: Extracting Zip file: " + Path.GetFileName(zipFile));
            folderPath = folderPath + @"\" + Path.GetFileNameWithoutExtension(zipFile);
            if (!File.Exists(zipFile))
                throw new FileNotFoundException();

            if (!Directory.Exists(folderPath))
                Directory.CreateDirectory(folderPath);

            Shell32.Shell objShell = new Shell32.Shell();
            Shell32.Folder destinationFolder = objShell.NameSpace(folderPath);
            Shell32.Folder sourceFile = objShell.NameSpace(zipFile);

            foreach (var file in sourceFile.Items())
            {
                destinationFolder.CopyHere(file, 4 | 16);
                //Extractedfiles.Add("");
            }
        }
        public void UnZip(string Z, string folderPath)
        {
            SaveToReport("Status: Extracting Zip file: " + Path.GetFileName(Z));
            folderPath = folderPath + @"\" + Path.GetFileNameWithoutExtension(Z);
            if (!File.Exists(Z))
                throw new FileNotFoundException();
            if (Directory.Exists(folderPath))
            {
                if (Directory.GetFiles(folderPath).Length > 0)
                    Directory.Delete(folderPath, true);
            }
            if (!Directory.Exists(folderPath))
                Directory.CreateDirectory(folderPath);
            try
            {
                Zipname = Z;
                Process compiler = new Process();
                compiler.StartInfo.FileName = @"\\techsetserver1\software\application\7-zip\7z.exe";
                compiler.StartInfo.Arguments = "x " + "\"" + Z + "\"" + " -o" + "\"" + folderPath + "\"";
                compiler.StartInfo.UseShellExecute = true;
                //compiler.StartInfo.RedirectStandardOutput = true;
                compiler.Start();
                //string gt = compiler.StandardOutput.ReadToEnd();
                compiler.WaitForExit();
            }
            catch (Exception e)
            {
                SaveToReport("Error: " + Path.GetFileName(Zipname) + e.Message + "\n" + e.StackTrace);
            }
        }
        //***
        public bool CheckWhetherFileBooked(string condition1, string stage = "FP")
        {
            DBClass Db = new DBClass();
            try
            {
                if (stage == "TUC") stage = "AC";
                //string condition = @"select COUNT(*) as Bcnt from Testing_Article where Artcl_ArticleId = '" + condition1 + @"'";
                string condition = @"select Artcl_Id from Article with(nolock) where Artcl_ArticleId = '" + condition1 + @"'";
                if (stage == "AC") condition = "SELECT JR_Main.JRM_ID froM JR_Main Inner Join JR_Stage_Tran on JR_Main.JRM_ID=JR_Stage_Tran.JRST_JRM_ID INNER JOIN JR_Articles on JR_Stage_Tran.JRST_ID=JR_Articles.JRA_JRST_ID INNER JOIN TrnsJournalRev on  TrnsJournalRev.JrnlTrns_ArticleId=JR_Articles.JRA_ID WHERE JR_Main.JRM_ArticleID='" + condition1 + @"'";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(condition, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                //System.Threading.Thread.Sleep(5000);
                if (!Db.SqlReader.HasRows)
                {
                    Db.SqlReader.Close();
                    Db.CloseConnection();
                    return false;
                }
                //if (Db.SqlReader.Read() == false)
                //{
                //    Db.SqlReader.Close();
                //    Db.CloseConnection();
                //    return false;
                //}
                //if (Db.SqlReader.Read() == true && ((stage == "FP" && Convert.ToInt64(Db.SqlReader["Artcl_Id"]) == 0) || (stage == "AC" && Convert.ToInt64(Db.SqlReader["JRM_ID"]) == 0)))
                //{
                //    Db.SqlReader.Close();
                //    Db.CloseConnection();
                //    return false;
                //}
                else
                {
                    Db.SqlReader.Close();
                    Db.CloseConnection();
                    return true;
                }
                // db.Sqladptr = new SqlDataAdapter(db.SqlCmd);
                // db.dt = new DataTable();
                // db.Sqladptr.Fill(db.dt);
                // db.CloseConnection();
                //if (db.dt.Rows.Count > 0)
                //{
                //    if ((stage == "FP" && Convert.ToInt64(db.dt.Rows[0]["Artcl_Id"]) == 0) || (stage == "AC" && Convert.ToInt64(db.dt.Rows[0]["JRM_ID"]) == 0))
                //    {
                //        return false;
                //    }
                //}
                //return true;
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                return false;
            }
            finally { Db.CloseConnection(); }

        }

        public bool Merge_PDF(XDocument xdoc, string jrnl, string vol, string iss)
        {
            //xdoc = XDocument.Parse(File.ReadAllText(@"\\techsetserver2\journal\AIP\"+jrnl+@"\ISSUE\"+ vol +"-"+iss+@"\DataSupplied\"+stage+@"\readme.xml").Replace("&", "&amp;").Replace("&amp;amp;", "&amp;"), LoadOptions.PreserveWhitespace);
            string missingfiles = "";
            if (Directory.Exists(@"D:\Journal\AIP\" + jrnl)) Directory.Delete(@"D:\Journal\AIP\" + jrnl, true);
            Directory.CreateDirectory(@"D:\Journal\AIP\" + jrnl);
            iTextSharp.text.Document document = new iTextSharp.text.Document();
            string outFile = Path.Combine(@"D:\Journal\AIP\" + jrnl + @"\MergedPDF.pdf");
            try
            {
                iTextSharp.text.pdf.PdfCopy writer = new iTextSharp.text.pdf.PdfCopy(document, new FileStream(outFile, FileMode.Create));
                document.Open();
                foreach (XElement Article in xdoc.XPathSelectElements(@"//lineup_items/article").ToList())
                {
                    try
                    {
                        if (Article.Descendants("aipid").Count() == 0)
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>PDF merging process error. 'aipid' article id missing in Readme xml file: for AIP: ", "AIP", true, "Printer files", Zipname);
                            SaveToReport("PDF merging process error. 'aipid' article id missing in Readme xml file: " + Path.GetFileName(Zipname));
                            continue;
                        }
                        string Aid = Article.Descendants("aipid").First().Value;
                        if (File.Exists(@"\\techsetserver2\journal\AIP\" + jrnl + @"\Articles\pdf\PRINT PDF\" + Aid + ".pdf"))
                        {
                            File.Copy(@"\\techsetserver2\journal\AIP\" + jrnl + @"\Articles\pdf\PRINT PDF\" + Aid + ".pdf", @"D:\Journal\AIP\" + jrnl + @"\" + Aid + ".pdf", true);
                            iTextSharp.text.pdf.PdfReader reader = new iTextSharp.text.pdf.PdfReader(@"D:\Journal\AIP\" + jrnl + @"\" + Aid + ".pdf");
                            for (int i = 1; i <= reader.NumberOfPages; i++)
                            {
                                iTextSharp.text.pdf.PdfImportedPage page = writer.GetImportedPage(reader, i);
                                writer.AddPage(page);
                            }
                            SaveToReport("Status: PDF file Merging: " + Aid + ".pdf : Pages: " + reader.NumberOfPages);
                            reader.Close();
                            File.Delete(@"D:\Journal\AIP\" + jrnl + @"\" + Aid + ".pdf");
                        }
                        else missingfiles += @"\\techsetserver2\journal\AIP\" + jrnl + @"\Articles\pdf\PRINT PDF\" + Aid + ".pdf \\n";
                        if (File.Exists(@"\\techsetserver2\journal\AIP\" + jrnl + @"\Articles\Pagination\" + Aid + ".3d"))
                        {
                            File.Move(@"\\techsetserver2\journal\AIP\" + jrnl + @"\Articles\Pagination\" + Aid + ".3d", @"\\techsetserver2\journal\AIP\" + jrnl + @"\ISSUE\" + vol + "-" + iss + @"\Pagination\" + Aid + ".3d");
                            SaveToReport("Status: Move 3D file: " + @"\\techsetserver2\journal\AIP\" + jrnl + @"\Articles\Pagination\" + Aid + @".3d to \\techsetserver2\journal\AIP\" + jrnl + @"\ISSUE\" + vol + "-" + iss + @"\Pagination\" + Aid + ".3d");
                        }
                        else missingfiles += @"\\techsetserver2\journal\AIP\" + jrnl + @"\Articles\Pagination\" + Aid + ".3d \\n";
                    }
                    catch (Exception ex)
                    {
                        SaveToReport("Error: " + ex.Message + ex.StackTrace);
                    }
                }
                writer.Close();
                document.Close();
                if (File.Exists(@"D:\Journal\AIP\" + jrnl + @"\MergedPDF.pdf"))
                {
                    File.Copy(@"D:\Journal\AIP\" + jrnl + @"\MergedPDF.pdf", @"\\techsetserver2\journal\AIP\" + jrnl + @"\ISSUE\" + vol + "-" + iss + @"\PDF\PRINT PDF\" + jrnl + "_" + vol + "_" + iss + ".pdf", true);
                    File.Delete(@"D:\Journal\AIP\" + jrnl + @"\MergedPDF.pdf");
                }
                if (missingfiles != "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>PDF merging process error. Following files are missing for AIP: " + missingfiles, "AIP", true, "AIP_Merging", Zipname);
                    SaveToReport("Following files are missing for AIP: " + missingfiles);
                }
                return true;
            }
            catch (Exception ex)
            {
                SaveToReport("Error: " + ex.Message + ex.StackTrace);
                return false;
            }
        }

        //***
        public void Book_GSA(string CL)
        {
            string stage = "First Proof Stage";
            DBClass Db = new DBClass();
            XElement author = null;
            string Auname = "", Auemail = "", Doi = "", Volume = "", Issue = "", Title = "", Txtfolio = "", TxtElec = "", LineArt = "", ArtElec = "", Artwork = "", Srcby = "", Atype = "article", atypeval = "", MSid = "", jacro = "", readme = Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\readme.xml";
            if (!File.Exists(readme))
            {
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>readme.XML file missing for GSA: ", "GSA", true, stage, Zipname);
                SaveToReport("readme.XML file missing for:  " + Path.GetFileName(Zipname));
                Clear();
                return;
            }
            try
            {
                XDocument XDoc = new XDocument();
                SaveToReport("Status: Validating Readme file: " + Path.GetFileName(Zipname));
                try
                {
                    XDoc = XDocument.Parse(File.ReadAllText(readme).Replace("&", "&amp;").Replace("&amp;amp;", "&amp;"), LoadOptions.PreserveWhitespace);
                }
                catch (Exception e)
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>readme.XML file is not valid for GSA: " + e.Message, "GSA", true, stage, Zipname);
                    File.Copy(Zipname, @"\\techsetserver2\Download\GSA_Error\" + Path.GetFileName(Zipname), true);
                    SaveToReport("readme.XML file is not valid for:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                    Clear();
                    return;
                }
                SaveToReport("Status: Validating against Booked Records: " + Path.GetFileName(Zipname));
                if (XDoc.Descendants("submission_type").Count() == 0)
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'submission_type' article id missing in Readme xml file: for GSA: ", "GSA", true, stage, Zipname);
                    SaveToReport("'submission_type' missing in Readme xml file: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                switch (XDoc.Root.Name.ToString().ToLower())
                {
                    case "geology_submission":
                        jacro = "geoy";
                        break;
                    case "gsabulletin_submission":
                        jacro = "gsab";
                        break;
                }
                if (jacro == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>New Journal found " + XDoc.Root.Name.ToString() + " for GSA: ", "GSA", true, stage, Zipname);
                    SaveToReport("New Journal found " + XDoc.Root.Name.ToString() + " : " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }

                string Aid = Path.GetFileNameWithoutExtension(Zipname).Split('-')[0] + '-' + Path.GetFileNameWithoutExtension(Zipname).Split('-')[1];
                string Rdate = "", Sdate = "";
                if (XDoc.Descendants("submission_date").Count() > 0) Rdate = XDoc.Descendants("submission_date").First().Value;
                if (XDoc.Descendants("due_date").Count() > 0) Sdate = XDoc.Descendants("due_date").First().Value;
                if (CheckWhetherFileBooked(Aid))
                {
                    if (XDoc.Descendants("submission_type").First().Value.ToLower() == "article")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for First Proof: ", "GSA", true, stage, Zipname);
                        SaveToReport("File already booked for First Proof: " + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    else if (XDoc.Descendants("submission_type").First().Value.ToLower() == "corrections" && XDoc.Descendants("submission_request").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() == "author correction")
                    {
                        string sche = Sdate;
                        stage = "Author Correction Stage";
                        string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                        if (uploaddate == "")
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "GSA", true, stage, Zipname);
                            SaveToReport("Artcl_UploadedDt not updated " + Path.GetFileName(Zipname));
                            Clear();
                            return;
                        }
                        SaveToReport("Status: Author Correction update JR_Main Table file: " + Path.GetFileName(Zipname));
                        string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + jacro + "' AND Jrnl_PublID='107'");
                        string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                        string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                        if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                        {
                            SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }
                        JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                        JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                        string JRA_ID = "";
                        string id = "", stageid = "", AUTUStatus = "25";
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=36") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=37") != "")
                                {
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=78") != "")
                                    {
                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=97") != "")
                                        {
                                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=98") != "")
                                            {
                                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 5: ", "GSL", true, stage, Zipname);
                                                SaveToReport("File already booked for Author Correction 5: " + Path.GetFileName(Zipname));
                                                //Move to Error
                                                Clear();
                                                return;
                                            }
                                            else
                                            {
                                                // Author Correction 5
                                                stage = "Author Correction 5 Stage";
                                                id = "5"; stageid = "98";
                                            }
                                        }
                                        else
                                        {
                                            // Author Correction 4
                                            stage = "Author Correction 4 Stage";
                                            id = "4"; stageid = "97";
                                        }
                                    }
                                    else
                                    {
                                        // Author Correction 3
                                        stage = "Author Correction 3 Stage";
                                        id = "3"; stageid = "78";
                                    }
                                }
                                else
                                {
                                    // Author Correction 2
                                    stage = "Author Correction 2 Stage";
                                    id = "2"; stageid = "37";
                                }
                            }
                            else
                            {
                                // Author Correction 1
                                stage = "Author Correction 1 Stage";
                                id = "1"; stageid = "36";
                            }
                        }
                        else
                        {
                            // Author Correction
                            stage = "Author Correction Stage";
                            id = ""; stageid = "35";
                        }
                        SaveToReport("Status: Author Correction " + id + " update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                        string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                        Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stageid + "','" + sche + "','" + Rdate + "','" + sche + "','" + sche + "','" + AUTUStatus + "',getdate(),'1','','" + Path.GetFileNameWithoutExtension(Zipname) + "','0')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query);
                        SaveToReport("Status: Author Correction " + id + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                        //JR_Articles 
                        JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stageid + "',getdate(),'1','0')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query);
                        SaveToReport("Status: Author Correction " + id + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                        //TrnsJournalRev 
                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction " + id + "','Pending')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query);
                        SaveToReport("Status: Upload files to Author Correction " + id + " file: " + Path.GetFileName(Zipname));
                        CreateTxtfile(Zipname, Aid, jacro, "GSA", "AC" + id);
                        goto skipGSA;
                    }
                    else if (XDoc.Descendants("submission_type").First().Value.ToLower() == "pip" && XDoc.Descendants("submission_request").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() == "pip")
                    {
                        string sche = Sdate;
                        stage = "PAP Stage";
                        string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                        if (uploaddate == "")
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "GSA", true, stage, Zipname);
                            SaveToReport("Artcl_UploadedDt not updated " + Path.GetFileName(Zipname));
                            Clear();
                            return;
                        }
                        SaveToReport("Status: PAP update JR_Main Table file: " + Path.GetFileName(Zipname));
                        string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + jacro + "' AND Jrnl_PublID='107'");
                        string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                        string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                        if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                        {
                            SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }
                        JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                        JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                        string JRA_ID = "";
                        string id = "", stageid = "", AUTUStatus = "25";
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=58") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=59") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=60") != "")
                                {
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=114") != "")
                                    {
                                        //SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for PAP III: ", "ASME", true, stage, Zipname);
                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for PAP III stage: ", "GSA", true, stage, Zipname);
                                        SaveToReport("File already booked for PAP III: " + Path.GetFileName(Zipname));
                                        Clear();
                                        return;
                                    }
                                    else
                                    {
                                        // PAP3
                                        stage = "PAP III Stage";
                                        id = "III"; stageid = "114";
                                    }

                                }
                                else
                                {
                                    // PAP2
                                    stage = "PAP II Stage";
                                    id = "II"; stageid = "60";
                                }
                            }
                            else
                            {
                                // PAP1                       
                                stage = "PAP I Stage";
                                id = "I"; stageid = "59";
                            }
                        }
                        else
                        {
                            //PAP                 
                            stage = "PAP Stage";
                            id = ""; stageid = "58";
                        }
                        SaveToReport("Status: PAP " + id + " update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                        string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                        Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stageid + "','" + sche + "','" + Rdate + "','" + sche + "','" + sche + "','" + AUTUStatus + "',getdate(),'1','','" + Path.GetFileNameWithoutExtension(Zipname) + "','0')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query);
                        SaveToReport("Status: PAP " + id + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                        //JR_Articles 
                        JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stageid + "',getdate(),'1','0')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query);
                        SaveToReport("Status: PAP " + id + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                        //TrnsJournalRev 
                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage.Replace(" Stage", "") + "','Pending')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query);
                        SaveToReport("Status: Upload files to PAP " + id + " file: " + Path.GetFileName(Zipname));
                        CreateTxtfile(Zipname, Aid, jacro, "GSA", "PAP" + id);
                        goto skipGSA;
                    }
                    else
                    {
                        SendMail(Aid, "Dear Team,<Br/><Br/>New stage file received for GSA: submission_type: " + XDoc.Descendants("submission_type").First().Value + "<Br/>submission_request: " + XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() + "<Br/> Kindly check and Validate Readme XML file for new stage.", "GSA", true, XDoc.Descendants("submission_type").First().Value, Zipname);
                        SaveToReport("New stage file received for GSA: " + XDoc.Descendants("submission_type").First().Value + " " + XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() + " " + Path.GetFileName(Zipname));
                    }
                    //Move to Error
                    Clear();
                    return;
                }

                if (XDoc.Descendants("submission_type").First().Value.ToLower() != "article")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File not booked for First Proof But received: " + XDoc.Descendants("submission_type").First().Value + " for: ", "GSA", true, stage, Zipname);
                    SaveToReport("File not booked for First Proof But received: " + XDoc.Descendants("submission_type").First().Value + " for: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                SaveToReport(@"Status: Collecting data from Readme file: " + Path.GetFileName(Zipname));
                foreach (XElement e in XDoc.Descendants("author").ToList())
                {
                    if (e.Attributes().Count() > 0 && e.Attributes("type").Count() == 1 && e.Attributes("type").First().Value == "corr")
                    {
                        author = e;
                        break;
                    }
                }
                if (XDoc.Descendants("gsabulletinid").Count() > 0) MSid = XDoc.Descendants("gsabulletinid").First().Value;
                if (XDoc.Descendants("geology").Count() > 0) MSid = XDoc.Descendants("geology").First().Value;
                if (XDoc.Descendants("article_type").Count() > 0) Atype = XDoc.Descendants("article_type").First().Value;
                if (XDoc.Descendants("doi").Count() > 0) Doi = XDoc.Descendants("doi").First().Value;
                if (XDoc.Descendants("volume").Count() > 0) Volume = XDoc.Descendants("volume").First().Value;
                if (XDoc.Descendants("issue").Count() > 0) Issue = XDoc.Descendants("issue").First().Value;
                if (XDoc.Descendants("article_title").Count() > 0) Title = XDoc.Descendants("article_title").First().Value;
                Title = Title.Replace(@"'", @"''");
                if (author != null)
                {
                    if (author.Elements("name").Count() > 0) Auname = author.Elements("name").First().Value;
                    if (author.Elements("email").Count() > 0) Auemail = author.Elements("email").First().Value;
                }
                Auname = Auname.Replace(@"'", @"''");
                if (XDoc.Descendants("total_pages").Count() > 0) Txtfolio = XDoc.Descendants("total_pages").First().Value;
                if (XDoc.Descendants("total_figures").Count() > 0) LineArt = XDoc.Descendants("total_figures").First().Value;
                if (XDoc.Descendants("cs_type").Count() > 0) Srcby = XDoc.Descendants("cs_type").First().Value;
                if (Srcby == "")
                {
                    string str = File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\readme.xml");
                    if (Regex.IsMatch(str.ToLower(), @"<file( [^<>]*?)? name=""([^<>]*?)\.doc(x)?""")) Srcby = "WORD";
                    else if (Regex.IsMatch(str.ToLower(), @"<file( [^<>]*?)? name=""([^<>]*?)\.pdf""")) Srcby = "PDF";
                }

                if (Txtfolio != "") TxtElec = "1";
                if (LineArt != "") { ArtElec = "1"; Artwork = "T1"; }
                SaveToReport("Status: Booking file: " + Path.GetFileName(Zipname));
                atypeval = ReturnDetail("ArtType_ID", "ArticleTypes", Db, "ArtType_Name='" + Atype + "'");
                string AJId = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + jacro + "' AND Jrnl_PublID='107'");
                if (AJId == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + jacro + ": ", "GSA", true, stage, Zipname);
                    SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing");
                    //Move to Error
                    Clear();
                    return;
                }
                string Artcl_Status = "DP";
                string book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_ArtType,Artcl_ExpFromTIDt,Artcl_DueDtCats,artcl_CEDuedate,Artcl_Platform,Artcl_ManuScriptID) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Sdate + @"','" + Srcby + @"','0','" + Artcl_Status + "','" + atypeval + @"','" + Sdate + @"','" + Sdate + @"','" + Sdate + "','InDesign','" + MSid + "')";
                if (LineArt != "")
                {
                    book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_StatusGFX,Artcl_ArtType,Artcl_ExpFromTIDt,Artcl_DueDtCats,artcl_CEDuedate,Artcl_Platform,Artcl_ManuScriptID) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Sdate + @"','" + Srcby + @"','0','" + Artcl_Status + "','GFXP','" + atypeval + @"','" + Sdate + @"','" + Sdate + @"','" + Sdate + "','InDesign','" + MSid + "')";
                }
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status: " + book);
                SaveToReport("Status: Update Transaction Details for file: " + Path.GetFileName(Zipname));
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Select Artcl_Id From Article WITH(NOLOCK) Where Artcl_ArticleId = '" + Aid + "'", Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                if (Db.SqlReader.Read())
                {
                    Int64 aaid = Convert.ToInt64(Db.SqlReader[0]);
                    Db.SqlReader.Close();
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, false, "GSA", Artcl_Status), Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Db.SqlCmd.CommandText);
                    CreateTxtfile(Zipname, Path.GetFileNameWithoutExtension(Zipname), jacro, "GSA");
                    if (LineArt != "")
                    {
                        SaveToReport("Status: Update Artwork Transaction Details for file: " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, true), Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Db.SqlCmd.CommandText);
                    }
                }
            skipGSA:
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                File.Delete(Zipname);
                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "GSA", false, stage);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "GSA", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }
        //***

        //***
        public void Book_AIP(string CL)
        {
            string stage = "First Proof Stage";
            DBClass Db = new DBClass();
            try
            {
                XDocument XDoc = new XDocument();
                SaveToReport("Status: Validating Readme file: " + Path.GetFileName(Zipname));
                if (File.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\readme.xml"))
                {
                    //try
                    //{
                    //    XDoc = XDocument.Parse(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\readme.xml").Replace(" & ", " &amp; "), LoadOptions.PreserveWhitespace);
                    //}
                    try
                    {
                        XDoc = XDocument.Parse(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\readme.xml").Replace("&", "&amp;").Replace("&amp;amp;", "&amp;"), LoadOptions.PreserveWhitespace);
                    }
                    catch (Exception e)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>readme.XML file is not valid for AIP: " + e.Message, "AIP", true, stage, Zipname);
                        File.Copy(Zipname, @"\\techsetserver2\Download\AIP_Error\" + Path.GetFileName(Zipname), true);
                        SaveToReport("readme.XML file is not valid for:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                        Clear();
                        //Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                        return;
                    }

                }
                else
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>readme.XML file missing for AIP: ", "AIP", true, stage, Zipname);
                    SaveToReport("readme.XML file missing for:  " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    // Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname),true);
                    return;
                }

                SaveToReport("Status: Validating against Booked Records: " + Path.GetFileName(Zipname));
                if (XDoc.Descendants("aipid").Count() == 0)
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'aipid' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                    SaveToReport("'aipid' article id missing in Readme xml file: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                if (XDoc.Descendants("coden3").Count() == 0)
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'coden3' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                    SaveToReport("'coden3' missing in Readme xml file: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                if (XDoc.Descendants("submission_type").Count() == 0)
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'submission_type' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                    SaveToReport("'submission_type' missing in Readme xml file: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                string Aid = XDoc.Descendants("aipid").First().Value;
                if (!Aid.Contains(XDoc.Descendants("coden3").First().Value))
                {
                    Aid = Aid + XDoc.Descendants("coden3").First().Value;
                }
                String AUTUStatus = "25";
                if (XDoc.Descendants("coden3").First().Value.ToLower() == "cha") AUTUStatus = "102";
                string Rdate = "", Sdate = "";
                if (XDoc.Descendants("submission_date").Count() > 0) Rdate = XDoc.Descendants("submission_date").First().Value;
                if (XDoc.Descendants("due_date").Count() > 0) Sdate = XDoc.Descendants("due_date").First().Value;
                DateTime Artcl_ExpFromTIDt = new DateTime();
                DateTime Artcl_ScheduledDt = new DateTime();
                DateTime artcl_CEDuedate = new DateTime();
                string Remarks = "";
                if (Sdate != "")
                {
                    var culture = System.Globalization.CultureInfo.InvariantCulture;
                    DateTime ddate = DateTime.ParseExact(Sdate, "MM/dd/yyyy HH:mm:ss", culture);
                    Artcl_ExpFromTIDt = CalculateAIPExpFromTIDt("AIP", Db, ddate);
                    Artcl_ScheduledDt = Artcl_ExpFromTIDt;
                    Artcl_ExpFromTIDt = CalculateAIPExpFromTIDt("AIP", Db, Artcl_ExpFromTIDt);
                    if (Rdate != "" && XDoc.Descendants("submission_type").First().Value.ToLower() == "starter")
                    {
                        culture = System.Globalization.CultureInfo.InvariantCulture;
                        DateTime ddate1 = DateTime.ParseExact(Rdate, "MM/dd/yyyy HH:mm:ss", culture);
                        double days = Math.Round(ReturnDays(ddate1, Db, Artcl_ScheduledDt) * 0.6);
                        artcl_CEDuedate = CalculateDueDate("", Db, AddDays(ddate1, Db, Convert.ToInt16(days)));
                    }
                }
                if (CheckWhetherFileBooked(Aid))
                {
                    if (XDoc.Descendants("submission_type").First().Value.ToLower() == "starter")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for First Proof: ", "AIP", true, stage, Zipname);
                        SaveToReport("File already booked for First Proof: " + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    else if (XDoc.Descendants("submission_type").First().Value.ToLower() == "printdeliverytovendor" && XDoc.Descendants("submission_request").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() == "issuetoprinter")
                    {
                        if (XDoc.Descendants("volume").Count() == 0)
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'volume' missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                            SaveToReport("'volume' missing in Readme xml file: " + Path.GetFileName(Zipname));
                            Clear();
                            return;
                        }
                        if (XDoc.Descendants("issue").Count() == 0)
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'issue' missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                            SaveToReport("'issue' missing in Readme xml file: " + Path.GetFileName(Zipname));
                            Clear();
                            return;
                        }
                        SaveToReport("Status: Printer update JR_Main Table file: " + Path.GetFileName(Zipname));
                        //JR_Main 
                        string vol = XDoc.Descendants("volume").First().Value;
                        string issue = XDoc.Descendants("issue").First().Value;
                        string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + XDoc.Descendants("coden3").First().Value + "' AND Jrnl_PublID='99'");
                        string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                        string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,LastModifiedDate,UsrID,Insert_Date, JRM_Volume, JRM_Issue) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"',getdate(),'1',getdate(),'" + vol + "','" + issue + "')";
                        JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + vol + "' AND JRM_Issue='" + issue + "'");
                        if (JRM_Id == "")
                        {
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }
                        JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + vol + "' AND JRM_Issue='" + issue + "'");
                        JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                        Remarks = "";
                        foreach (XElement e in XDoc.XPathSelectElements(@"//comments/comment/text").ToList())
                        {
                            Remarks += "<br/>" + e.Value;
                        }
                        if (Remarks != "") Remarks = Remarks.Replace("'", "''");

                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=42") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=57") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=71") != "")
                                {
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Printer Files 3: ", "AIP", true, stage, Zipname);
                                    SaveToReport("File already booked for Printer Files 3: " + Path.GetFileName(Zipname));
                                    //Move to Error
                                    Clear();
                                    return;
                                }
                                else
                                {
                                    stage = "Printer Files 3";
                                    string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','71','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','25',getdate(),'1','" + Remarks + "')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    foreach (XElement Article in XDoc.XPathSelectElements(@"//lineup_items/article").ToList())
                                    {
                                        if (Article.Descendants("aipid").Count() == 0)
                                        {
                                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'aipid' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                                            SaveToReport("'aipid' article id missing in Readme xml file: " + Path.GetFileName(Zipname));
                                            continue;
                                        }
                                        Aid = Article.Descendants("aipid").First().Value;
                                        string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                                        if (uploaddate == "")
                                        {
                                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.: ", "AIP", true, stage, Zipname);
                                            SaveToReport("Artcl_UploadedDt not updated: " + Path.GetFileName(Zipname));
                                            continue;
                                        }
                                        //JR_Articles 
                                        string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','25','71',getdate(),'1')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Printer Files 3 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                        //TrnsJournalRev 
                                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','25',getdate(),'1','Printer Files 3','Pending')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Printer Files 3 update Article Table file: " + Path.GetFileName(Zipname));
                                        ////Article 
                                        //Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate(),Artcl_Volume='" + vol + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                                        //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        //Db.OpenConnection();
                                        //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        //Db.SqlReader.Close();
                                        ////Transaction TrnsJournal        
                                        //string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                        //string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                        //Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                        //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        //Db.OpenConnection();
                                        //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        //Db.SqlReader.Close();
                                        Query = "update Article set Artcl_Volume='" + vol + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage + " Stage");
                                    }
                                    SaveToReport("Status: Copy files to Printer files 3: " + Path.GetFileName(Zipname));
                                    CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", stage, "", vol, issue);
                                    goto skipAIP;
                                }
                            }
                            else
                            {
                                stage = "Printer Files 2";
                                string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','57','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','25',getdate(),'1','" + Remarks + "')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                foreach (XElement Article in XDoc.XPathSelectElements(@"//lineup_items/article").ToList())
                                {
                                    if (Article.Descendants("aipid").Count() == 0)
                                    {
                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'aipid' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                                        SaveToReport("'aipid' article id missing in Readme xml file: " + Path.GetFileName(Zipname));
                                        continue;
                                    }
                                    Aid = Article.Descendants("aipid").First().Value;
                                    string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                                    if (uploaddate == "")
                                    {
                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.: ", "AIP", true, stage, Zipname);
                                        SaveToReport("Artcl_UploadedDt not updated: " + Path.GetFileName(Zipname));
                                        continue;
                                    }

                                    SaveToReport("Status: Printer Files 2 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                    //JR_Articles 
                                    string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','25','57',getdate(),'1')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Printer Files 2 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                    //TrnsJournalRev 
                                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','25',getdate(),'1','Printer Files 2','Pending')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Printer files 2 update Article Table file: " + Path.GetFileName(Zipname));
                                    ////Article 
                                    //Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate(),Artcl_Volume='" + vol + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                                    //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    //Db.OpenConnection();
                                    //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    //Db.SqlReader.Close();
                                    ////Transaction TrnsJournal        
                                    //string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                    //string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                    //Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                    //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    //Db.OpenConnection();
                                    //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    //Db.SqlReader.Close();
                                    Query = "update Article set Artcl_Volume='" + vol + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage + " Stage");
                                }
                                SaveToReport("Status: Copy files to Printer files 2: " + Path.GetFileName(Zipname));
                                CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", stage, "", vol, issue);
                                goto skipAIP;
                            }
                        }
                        else
                        {
                            stage = "Printer Files";
                            AUTUStatus = "25";
                            if (XDoc.Descendants("coden3").First().Value.ToLower() != "cha")
                            {
                                if (Merge_PDF(XDoc, XDoc.Descendants("coden3").First().Value.ToUpper(), vol, issue)) AUTUStatus = "28";
                            }
                            string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                            Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','42','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            foreach (XElement Article in XDoc.XPathSelectElements(@"//lineup_items/article").ToList())
                            {
                                if (Article.Descendants("aipid").Count() == 0)
                                {
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'aipid' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                                    SaveToReport("'aipid' article id missing in Readme xml file: " + Path.GetFileName(Zipname));
                                    continue;
                                }
                                Aid = Article.Descendants("aipid").First().Value;
                                string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                                if (uploaddate == "")
                                {
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.: ", "AIP", true, stage, Zipname);
                                    SaveToReport("Artcl_UploadedDt not updated: " + Path.GetFileName(Zipname));
                                    continue;
                                }
                                SaveToReport("Status: Printer Files update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                //JR_Articles 
                                string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','42',getdate(),'1')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: Printer Files update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                //TrnsJournalRev 
                                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','Printer Files','Pending')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: Printer files update Article Table file: " + Path.GetFileName(Zipname));
                                Query = "update Article set Artcl_Volume='" + vol + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                // SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage + " Stage");
                            }

                            SaveToReport("Status: Copy files to Printer files: " + Path.GetFileName(Zipname));
                            CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", stage, "", vol, issue);
                            goto skipAIP;
                        }

                    }
                    else if (XDoc.Descendants("submission_type").First().Value.ToLower() == "correctionstovendor")
                    {
                        stage = "Author Correction Stage";
                        string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                        if (uploaddate == "")//|| CheckWhetherFileBooked(Aid,"AC"))
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "AIP", true, stage, Zipname);
                            SaveToReport("Artcl_UploadedDt not updated " + Path.GetFileName(Zipname));
                            //Move to Error
                            Clear();
                            return;
                        }
                        SaveToReport("Status: Author Correction update JR_Main Table file: " + Path.GetFileName(Zipname));
                        // Author Correction   
                        //JR_Main 
                        string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + XDoc.Descendants("coden3").First().Value + "' AND Jrnl_PublID='99'");
                        string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                        string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                        if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                        {
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }
                        JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                        JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));

                        //JR_Stage_Tran  
                        string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                        string JRA_ID = "";
                        Remarks = "";
                        foreach (XElement e in XDoc.XPathSelectElements(@"//comments/comment/text").ToList())
                        {
                            Remarks += "<br/>" + e.Value;
                        }
                        if (Remarks != "") Remarks = Remarks.Replace("'", "''");
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=36") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=37") != "")
                                {
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=78") != "")
                                    {
                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=97") != "")
                                        {
                                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=98") != "")
                                            {
                                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 5: ", "AIP", true, stage, Zipname);
                                                SaveToReport("File already booked for Author Correction 5: " + Path.GetFileName(Zipname));
                                                //Move to Error
                                                Clear();
                                                return;
                                            }
                                            else
                                            {
                                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=97 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                                {
                                                    string Outpath = @"\\Techsetserver2\Journal\AIP\" + XDoc.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\AU Correction 4\Additional_correction\" + Path.GetFileName(Zipname);
                                                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                                    File.Copy(Zipname, Outpath, true);
                                                    UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 4. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                                    SaveToReport("Unclosed stage Author Correction 4: booked as additional correction. " + Path.GetFileName(Zipname));
                                                    Clear();
                                                    return;
                                                }
                                                stage = "Author Correction 5 Stage";
                                                SaveToReport("Status: Author Correction 5 update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                                //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','98',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','" + AUTUStatus + "',getdate(),'1','')";
                                                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','98','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                SaveToReport("Status: Author Correction 5 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                                //JR_Articles 
                                                JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','98',getdate(),'1')";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                SaveToReport("Status: Author Correction 5 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                                //TrnsJournalRev 
                                                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction 5','Pending')";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                //SaveToReport("Status: Author Correction 5 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                                ////Article 
                                                //Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                                //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                //Db.OpenConnection();
                                                //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                //Db.SqlReader.Close();
                                                ////Transaction TrnsJournal        
                                                //artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                                //transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                                //Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                                //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                //Db.OpenConnection();
                                                //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                //Db.SqlReader.Close();
                                                SaveToReport("Status: Upload files to Author Correction 5 file: " + Path.GetFileName(Zipname));
                                                CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", "AC5");
                                                goto skipAIP;
                                            }
                                        }
                                        else
                                        {
                                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=78 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                            {
                                                string Outpath = @"\\Techsetserver2\Journal\AIP\" + XDoc.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\AU Correction 3\Additional_correction\" + Path.GetFileName(Zipname);
                                                if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                                File.Copy(Zipname, Outpath, true);
                                                UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 3. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                                SaveToReport("Unclosed stage Author Correction 3: booked as additional correction. " + Path.GetFileName(Zipname));
                                                Clear();
                                                return;
                                            }
                                            stage = "Author Correction 4 Stage";
                                            SaveToReport("Status: Author Correction 4 update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                            //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','97',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','" + AUTUStatus + "',getdate(),'1','')";
                                            Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','97','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            SaveToReport("Status: Author Correction 4 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                            //JR_Articles 
                                            JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                            Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','97',getdate(),'1')";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            SaveToReport("Status: Author Correction 4 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                            //TrnsJournalRev 
                                            Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction 4','Pending')";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            //SaveToReport("Status: Author Correction 4 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                            ////Article 
                                            //Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                            //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            //Db.OpenConnection();
                                            //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            //Db.SqlReader.Close();
                                            ////Transaction TrnsJournal                             
                                            //artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                            //transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                            //Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                            //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            //Db.OpenConnection();
                                            //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            //Db.SqlReader.Close();
                                            SaveToReport("Status: Upload files to Author Correction 1 file: " + Path.GetFileName(Zipname));
                                            CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", "AC4");
                                            goto skipAIP;
                                        }
                                    }
                                    else
                                    {
                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=37 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                        {
                                            string Outpath = @"\\Techsetserver2\Journal\AIP\" + XDoc.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\AU Correction 2\Additional_correction\" + Path.GetFileName(Zipname);
                                            if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                            File.Copy(Zipname, Outpath, true);
                                            UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 2. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                            SaveToReport("Unclosed stage Author Correction 2: booked as additional correction. " + Path.GetFileName(Zipname));
                                            Clear();
                                            return;
                                        }
                                        stage = "Author Correction 3 Stage";
                                        SaveToReport("Status: Author Correction 3 update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                        //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','78',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','" + AUTUStatus + "',getdate(),'1','')";
                                        Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','78','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Author Correction 3 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                        //JR_Articles 
                                        JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','78',getdate(),'1')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Author Correction 3 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                        //TrnsJournalRev 
                                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction 3','Pending')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        //SaveToReport("Status: Author Correction 3 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                        ////Article 
                                        //Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                        //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        //Db.OpenConnection();
                                        //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        //Db.SqlReader.Close();
                                        ////Transaction TrnsJournal        
                                        //artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                        //transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                        //Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                        //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        //Db.OpenConnection();
                                        //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        //Db.SqlReader.Close();
                                        SaveToReport("Status: Upload files to Author Correction 3 file: " + Path.GetFileName(Zipname));
                                        CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", "AC3");
                                        goto skipAIP;
                                    }
                                }
                                else
                                {
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=36 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                    {
                                        string Outpath = @"\\Techsetserver2\Journal\AIP\" + XDoc.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\AU Correction 1\Additional_correction\" + Path.GetFileName(Zipname);
                                        if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                        File.Copy(Zipname, Outpath, true);
                                        UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 1. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                        SaveToReport("Unclosed stage Author Correction 1: booked as additional correction. " + Path.GetFileName(Zipname));
                                        Clear();
                                        return;
                                    }
                                    stage = "Author Correction 2 Stage";
                                    SaveToReport("Status: Author Correction 2 update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                    //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','37',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','" + AUTUStatus + "',getdate(),'1','')";
                                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','37','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Author Correction 2 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                    //JR_Articles 
                                    JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','37',getdate(),'1')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Author Correction 2 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                    //TrnsJournalRev 
                                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction 2','Pending')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    //SaveToReport("Status: Author Correction 2 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                    ////Article 
                                    //Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                    //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    //Db.OpenConnection();
                                    //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    //Db.SqlReader.Close();
                                    ////Transaction TrnsJournal                             
                                    //artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                    //transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                    //Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                    //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    //Db.OpenConnection();
                                    //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    //Db.SqlReader.Close();
                                    SaveToReport("Status: Upload files to Author Correction 2 file: " + Path.GetFileName(Zipname));
                                    CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", "AC2");
                                    goto skipAIP;
                                }
                            }
                            else
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                {
                                    string Outpath = @"\\Techsetserver2\Journal\AIP\" + XDoc.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\Additional_correction\" + Path.GetFileName(Zipname);
                                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                    File.Copy(Zipname, Outpath, true);
                                    UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                    SaveToReport("Unclosed stage Author Correction: booked as additional correction. " + Path.GetFileName(Zipname));
                                    Clear();
                                    return;
                                }
                                stage = "Author Correction 1 Stage";
                                SaveToReport("Status: Author Correction 1 update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','36',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','" + AUTUStatus + "',getdate(),'1','')";
                                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','36','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: Author Correction 1 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                //JR_Articles 
                                JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','36',getdate(),'1')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: Author Correction 1 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                //TrnsJournalRev 
                                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction 1','Pending')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                //SaveToReport("Status: Author Correction 1 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                ////Article 
                                //Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                //Db.OpenConnection();
                                //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                //Db.SqlReader.Close();
                                ////Transaction TrnsJournal                             
                                //artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                //transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                //Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                //Db.OpenConnection();
                                //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                //Db.SqlReader.Close();
                                SaveToReport("Status: Upload files to Author Correction 1 file: " + Path.GetFileName(Zipname));
                                CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", "AC1");
                                goto skipAIP;
                            }
                        }
                        else
                        {
                            //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','35',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','" + AUTUStatus + "',getdate(),'1','')";
                            Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','35','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                            SaveToReport("Status: Author Correction update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: Author Correction update JR_Articles Table file: " + Path.GetFileName(Zipname));
                            //JR_Articles 
                            JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                            Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','35',getdate(),'1')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: Author Correction update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                            //TrnsJournalRev 
                            Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction','Pending')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            //SaveToReport("Status: Author Correction update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                            ////Article 
                            //Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                            //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            //Db.OpenConnection();
                            //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            //Db.SqlReader.Close();
                            ////Transaction TrnsJournal                             
                            //artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                            //transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                            //Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                            //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            //Db.OpenConnection();
                            //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            //Db.SqlReader.Close();
                            SaveToReport("Status: Upload files to Author Correction file: " + Path.GetFileName(Zipname));
                            CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", "AC");
                            goto skipAIP;
                        }
                    }
                    else if (XDoc.Descendants("submission_type").First().Value.ToLower() == "revisionstovendor" && XDoc.Descendants("submission_request").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() == "authorproof")
                    {
                        stage = "TU Correction 1 Stage";
                        string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                        if (uploaddate == "")// || CheckWhetherFileBooked(Aid, "TUC"))
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.: ", "AIP", true, stage, Zipname);
                            SaveToReport("Artcl_UploadedDt not updated: " + Path.GetFileName(Zipname));
                            //Move to Error
                            Clear();
                            return;
                        }
                        SaveToReport("Status: TU Correction 1 update JR_Main Table file: " + Path.GetFileName(Zipname));
                        // Author Correction   
                        //JR_Main 
                        string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + XDoc.Descendants("coden3").First().Value + "' AND Jrnl_PublID='99'");
                        string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                        string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                        if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                        {
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }

                        JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                        JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                        Remarks = "";
                        foreach (XElement e in XDoc.XPathSelectElements(@"//comments/comment/text").ToList())
                        {
                            Remarks += "<br/>" + e.Value;
                        }
                        if (Remarks != "") Remarks = Remarks.Replace("'", "''");
                        //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        //Db.OpenConnection();
                        //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        //Db.SqlReader.Close();                         
                        //JR_Stage_Tran     
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=33") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=34") != "")
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for TU Correction 2: ", "AIP", true, stage, Zipname);
                                SaveToReport("File already booked for TU Correction 2: " + Path.GetFileName(Zipname));
                                //Move to Error
                                Clear();
                                return;
                            }
                            else
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=33 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                {
                                    string Outpath = @"\\Techsetserver2\Journal\AIP\" + XDoc.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\TU Correction\Additional_correction\" + Path.GetFileName(Zipname);
                                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                    File.Copy(Zipname, Outpath, true);
                                    UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for TU Correction 1. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                    SaveToReport("Unclosed stage TU Correction 1: booked as additional correction. " + Path.GetFileName(Zipname));
                                    Clear();
                                    return;
                                }
                                stage = "TU Correction 2 Stage";
                                string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','34',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','" + AUTUStatus + "',getdate(),'1','')";
                                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','34','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: TU Correction 2 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                //JR_Articles 
                                string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','34',getdate(),'1')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: TU Correction 2 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                //TrnsJournalRev 
                                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','TU Correction 2','Pending')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                //SaveToReport("Status: TU Correction 2 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                ////Article 
                                //Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                //Db.OpenConnection();
                                //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                //Db.SqlReader.Close();
                                ////Transaction TrnsJournal                             
                                //string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                //string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                //Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                //Db.OpenConnection();
                                //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                //Db.SqlReader.Close();
                                SaveToReport("Status: Upload files to TU Correction 2 file: " + Path.GetFileName(Zipname));
                                CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", "TUC2");
                                goto skipAIP;
                            }
                        }
                        else
                        {
                            SaveToReport("Status: TU Correction 1 update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                            string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                            //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','33',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','" + AUTUStatus + "',getdate(),'1','')";
                            Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','33','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: TU Correction 1 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                            //JR_Articles 
                            string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                            Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','33',getdate(),'1')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: TU Correction 1 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                            //TrnsJournalRev 
                            Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','TU Correction 1','Pending')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            //SaveToReport("Status: TU Correction 1 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                            ////Article 
                            //Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                            //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            //Db.OpenConnection();
                            //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            //Db.SqlReader.Close();
                            ////Transaction TrnsJournal                             
                            //string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                            //string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                            //Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                            //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            //Db.OpenConnection();
                            //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            //Db.SqlReader.Close();
                            SaveToReport("Status: Upload files to TU Correction 1 file: " + Path.GetFileName(Zipname));
                            CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", "TUC");
                            goto skipAIP;
                        }
                    }
                    else if (XDoc.Descendants("submission_type").First().Value.ToLower() == "paginationtovendor" && XDoc.Descendants("submission_request").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() == "finaldeliverables")
                    {
                        Boolean mutiarticles = false;
                        string readme = File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\readme.xml");
                        if (XDoc.Descendants("article_metadata").Count() > 1)
                        {
                            mutiarticles = true;
                            readme = Regex.Replace(readme, "<articles>(.*?)</articles>", "<articles></articles>", RegexOptions.Singleline);
                        }
                        foreach (XElement Articlemeta in XDoc.Descendants("article_metadata").ToList())
                        {
                            string readme1 = "";
                            if (mutiarticles == true)
                            {
                                readme1 = readme.Replace("<articles>", "<articles>" + Articlemeta.ToString(SaveOptions.DisableFormatting));
                            }
                            if (Articlemeta.Descendants("aipid").Count() == 0)
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'aipid' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                                SaveToReport("'aipid' article id missing in Readme xml file: " + Path.GetFileName(Zipname));
                                continue;
                            }
                            if (Articlemeta.Descendants("coden3").Count() == 0)
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'coden3' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                                SaveToReport("'coden3' missing in Readme xml file: " + Path.GetFileName(Zipname));
                                continue;
                            }
                            if (Articlemeta.Descendants("fpage").Count() == 0)
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'fpage' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                                SaveToReport("'fpage' missing in Readme xml file: " + Path.GetFileName(Zipname));
                                continue;
                            }
                            if (Articlemeta.Descendants("seqno").Count() == 0)
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'seqno' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                                SaveToReport("'seqno' missing in Readme xml file: " + Path.GetFileName(Zipname));
                                continue;
                            }
                            string PAPFileName = Articlemeta.Descendants("fpage").First().Value.Split('-')[0] + '_' + Articlemeta.Descendants("seqno").First().Value;
                            Aid = Articlemeta.Descendants("aipid").First().Value;
                            Aid = Aid + Articlemeta.Descendants("coden3").First().Value;

                            if (CheckWhetherFileBooked(Aid))
                            {
                                stage = "Final Web Delivery Stage";
                                string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                                if (uploaddate == "")//|| CheckWhetherFileBooked(Aid,"AC"))
                                {
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "AIP", true, stage, Zipname);
                                    SaveToReport("Artcl_UploadedDt not updated " + Aid + " " + Path.GetFileName(Zipname));
                                    //Move to Error
                                    //Clear();
                                    //return;
                                    continue;
                                }
                                SaveToReport("Status: Final Web Delivery update JR_Main Table file: " + Path.GetFileName(Zipname));
                                //WBID:8058;03042019
                                if (Articlemeta.Descendants("coden3").First().Value.ToLower() == "cha") File.WriteAllText(@"\\techsetserver1\software\Latex\Preedit-tools\AIP-Automation\In\" + Aid + ".txt", "");
                                //Status Validation;
                                AUTUStatus = "25";
                                if (File.Exists(@"\\techsetserver2\journal\AIP\" + Articlemeta.Descendants("coden3").First().Value + @"\Articles\pagination\" + Aid + ".3d") && File.Exists(@"\\techsetserver1\Software\AIP\JournalsList\JournalsList.xml"))
                                {
                                    try
                                    {
                                        string str = @"\\techsetserver1\Software\AIP\JournalsList\JournalsList.xml";
                                        XDocument xs = XDocument.Parse(File.ReadAllText(str), LoadOptions.PreserveWhitespace);
                                        foreach (XElement elt in xs.Descendants("journal").ToList())
                                        {
                                            if (elt.Elements("jacronym").First().Value.ToUpper() == Articlemeta.Descendants("coden3").First().Value.ToUpper())
                                            {
                                                if (elt.Elements("coden").First().Value != "")
                                                {
                                                    Process compiler = new Process();
                                                    compiler.StartInfo.FileName = @"\\techsetserver1\Library\AIP-PAP-PDF-SMART\AIP-PAP-PDF.exe";
                                                    compiler.StartInfo.Arguments = @"\\techsetserver2\journal\AIP\" + Articlemeta.Descendants("coden3").First().Value + @"\Articles\pagination\" + Aid + ".3d " + elt.Elements("coden").First().Value;
                                                    compiler.StartInfo.UseShellExecute = false;
                                                    compiler.StartInfo.RedirectStandardOutput = true;
                                                    compiler.Start();
                                                    string gt = compiler.StandardOutput.ReadToEnd();
                                                    compiler.WaitForExit();
                                                    if (gt.Trim().ToLower() == "true") AUTUStatus = "28";
                                                    SaveToReport("Status: Final Web Delivery Validation success: " + Aid);
                                                    break;
                                                }
                                            }
                                        }
                                    }
                                    catch (Exception exx)
                                    {
                                        AUTUStatus = "25";
                                        SaveToReport("Status: Final Web Delivery Validation Failed: " + Aid);
                                    }
                                }
                                //JR_Main 
                                string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + Articlemeta.Descendants("coden3").First().Value + "' AND Jrnl_PublID='99'");
                                string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                                string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                                if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                                {
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                }

                                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                                JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                                Remarks = "";
                                foreach (XElement e in Articlemeta.XPathSelectElements(@"comments/comment/text").ToList())
                                {
                                    Remarks += "<br/>" + e.Value;
                                }
                                if (Remarks != "") Remarks = Remarks.Replace("'", "''");
                                SaveToReport("Status: Final Web Delivery update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                //JR_Stage_Tran    
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=43") != "")
                                {
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=50") != "")
                                    {
                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=125") != "")
                                        {
                                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=126") != "")
                                            {
                                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=127") != "")
                                                {
                                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=128") != "")
                                                    {
                                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Web Delivery 6: ", "AIP", true, stage, Zipname);
                                                        SaveToReport("File already booked for Final Web Delivery 6: " + Path.GetFileName(Zipname));
                                                        //Move to Error
                                                        //Clear();
                                                        //return;
                                                        continue;
                                                    }
                                                    else
                                                    {
                                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=127 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                                        {
                                                            string Outpath = @"\\Techsetserver2\Journal\AIP\" + Articlemeta.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\Final Web Delivery 5\Additional_correction\" + Path.GetFileName(Zipname);
                                                            if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                                            File.Copy(Zipname, Outpath, true);
                                                            UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                                            if (readme != "") File.WriteAllText(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath) + @"\readme.xml", readme);
                                                            if (Path.GetFileNameWithoutExtension(Zipname).Split('_').Length > 1)
                                                            {
                                                                if (Directory.Exists(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath))) Directory.Move(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath).Split('_')[0]);
                                                            }
                                                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Web Delivery 5. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                                            SaveToReport("Unclosed stage Final Web Delivery 5: booked as additional correction. " + Path.GetFileName(Zipname));
                                                            continue;
                                                        }
                                                        stage = "Final Web Delivery 6 Stage";
                                                        string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                                        //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','128',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','15',getdate(),'1','','" + PAPFileName + @"')";
                                                        Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','128' ,'" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + @"','" + AUTUStatus + "',getdate(),'1','" + Remarks + "','" + PAPFileName + @"')";
                                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                        Db.OpenConnection();
                                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                        Db.SqlReader.Close();
                                                        SaveToReport("Status: Final Web Delivery 6 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                                        //JR_Articles 
                                                        string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','128',getdate(),'1')";
                                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                        Db.OpenConnection();
                                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                        Db.SqlReader.Close();
                                                        SaveToReport("Status: Final Web Delivery 6 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                                        //TrnsJournalRev 
                                                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','Final Web Delivery 6','Pending')";
                                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                        Db.OpenConnection();
                                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                        Db.SqlReader.Close();
                                                        //SaveToReport("Status: Final Web Delivery 6 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                                        ////Article 
                                                        //Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                                        //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                        //Db.OpenConnection();
                                                        //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                        //Db.SqlReader.Close();
                                                        ////Transaction TrnsJournal      
                                                        //string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                                        //string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                                        //Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                                        //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                        //Db.OpenConnection();
                                                        //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                        //Db.SqlReader.Close();
                                                        SaveToReport("Status: Upload files to Final Web Delivery 6 file: " + Path.GetFileName(Zipname));
                                                        //CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD6");
                                                        if (mutiarticles == true) CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD6", readme1);
                                                        else CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD6");
                                                        //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                                                    }
                                                }
                                                else
                                                {
                                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=126 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                                    {
                                                        string Outpath = @"\\Techsetserver2\Journal\AIP\" + Articlemeta.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\Final Web Delivery 4\Additional_correction\" + Path.GetFileName(Zipname);
                                                        if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                                        File.Copy(Zipname, Outpath, true);
                                                        UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                                        if (readme != "") File.WriteAllText(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath) + @"\readme.xml", readme);
                                                        if (Path.GetFileNameWithoutExtension(Zipname).Split('_').Length > 1)
                                                        {
                                                            if (Directory.Exists(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath))) Directory.Move(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath).Split('_')[0]);
                                                        }
                                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Web Delivery 4. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                                        SaveToReport("Unclosed stage Final Web Delivery 4: booked as additional correction. " + Path.GetFileName(Zipname));
                                                        continue;
                                                    }
                                                    stage = "Final Web Delivery 5 Stage";
                                                    string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                                    //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','127',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','15',getdate(),'1','','" + PAPFileName + @"')";
                                                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','127','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + @"','" + AUTUStatus + "',getdate(),'1','" + Remarks + "','" + PAPFileName + @"')";
                                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                    Db.OpenConnection();
                                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                    Db.SqlReader.Close();
                                                    SaveToReport("Status: Final Web Delivery 5 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                                    //JR_Articles 
                                                    string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','127',getdate(),'1')";
                                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                    Db.OpenConnection();
                                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                    Db.SqlReader.Close();
                                                    SaveToReport("Status: Final Web Delivery 5 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                                    //TrnsJournalRev 
                                                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','Final Web Delivery 5','Pending')";
                                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                    Db.OpenConnection();
                                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                    Db.SqlReader.Close();
                                                    //SaveToReport("Status: Final Web Delivery 5 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                                    ////Article 
                                                    //Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                                    //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                    //Db.OpenConnection();
                                                    //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                    //Db.SqlReader.Close();
                                                    ////Transaction TrnsJournal      
                                                    //string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                                    //string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                                    //Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                                    //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                    //Db.OpenConnection();
                                                    //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                    //Db.SqlReader.Close();
                                                    SaveToReport("Status: Upload files to Final Web Delivery 5 file: " + Path.GetFileName(Zipname));
                                                    //CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD5");
                                                    if (mutiarticles == true) CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD5", readme1);
                                                    else CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD5");
                                                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                                                }
                                            }
                                            else
                                            {
                                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=125 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                                {
                                                    string Outpath = @"\\Techsetserver2\Journal\AIP\" + Articlemeta.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\Final Web Delivery 3\Additional_correction\" + Path.GetFileName(Zipname);
                                                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                                    File.Copy(Zipname, Outpath, true);
                                                    UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                                    if (readme != "") File.WriteAllText(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath) + @"\readme.xml", readme);
                                                    if (Path.GetFileNameWithoutExtension(Zipname).Split('_').Length > 1)
                                                    {
                                                        if (Directory.Exists(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath))) Directory.Move(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath).Split('_')[0]);
                                                    }
                                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Web Delivery 3. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                                    SaveToReport("Unclosed stage Final Web Delivery 3: booked as additional correction. " + Path.GetFileName(Zipname));
                                                    continue;
                                                }
                                                stage = "Final Web Delivery 4 Stage";
                                                string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                                //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','126',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','15',getdate(),'1','','" + PAPFileName + @"')";
                                                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','126','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + @"','" + AUTUStatus + "',getdate(),'1','" + Remarks + "','" + PAPFileName + @"')";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                SaveToReport("Status: Final Web Delivery 4 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                                //JR_Articles 
                                                string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','126',getdate(),'1')";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                SaveToReport("Status: Final Web Delivery 4 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                                //TrnsJournalRev 
                                                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','Final Web Delivery 4','Pending')";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                //SaveToReport("Status: Final Web Delivery 4 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                                ////Article 
                                                //Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                                //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                //Db.OpenConnection();
                                                //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                //Db.SqlReader.Close();
                                                ////Transaction TrnsJournal      
                                                //string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                                //string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                                //Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                                //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                //Db.OpenConnection();
                                                //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                //Db.SqlReader.Close();
                                                SaveToReport("Status: Upload files to Final Web Delivery 4 file: " + Path.GetFileName(Zipname));
                                                //CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD4");
                                                if (mutiarticles == true) CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD4", readme1);
                                                else CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD4");
                                                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                                            }
                                        }
                                        else
                                        {
                                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=50 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                            {
                                                string Outpath = @"\\Techsetserver2\Journal\AIP\" + Articlemeta.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\Final Web Delivery 2\Additional_correction\" + Path.GetFileName(Zipname);
                                                if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                                File.Copy(Zipname, Outpath, true);
                                                UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                                if (readme != "") File.WriteAllText(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath) + @"\readme.xml", readme);
                                                if (Path.GetFileNameWithoutExtension(Zipname).Split('_').Length > 1)
                                                {
                                                    if (Directory.Exists(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath))) Directory.Move(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath).Split('_')[0]);
                                                }
                                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Web Delivery 2. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                                SaveToReport("Unclosed stage Final Web Delivery 2: booked as additional correction. " + Path.GetFileName(Zipname));
                                                continue;
                                            }
                                            stage = "Final Web Delivery 3 Stage";
                                            string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                            //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','125',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','15',getdate(),'1','','" + PAPFileName + @"')";
                                            Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','125','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + @"','" + AUTUStatus + "',getdate(),'1','" + Remarks + "','" + PAPFileName + @"')";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            SaveToReport("Status: Final Web Delivery 3 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                            //JR_Articles 
                                            string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                            Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','125',getdate(),'1')";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            SaveToReport("Status: Final Web Delivery 3 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                            //TrnsJournalRev 
                                            Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','Final Web Delivery 3','Pending')";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            //SaveToReport("Status: Final Web Delivery 3 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                            ////Article 
                                            //Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                            //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            //Db.OpenConnection();
                                            //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            //Db.SqlReader.Close();
                                            ////Transaction TrnsJournal      
                                            //string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                            //string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                            //Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                            //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            //Db.OpenConnection();
                                            //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            //Db.SqlReader.Close();
                                            SaveToReport("Status: Upload files to Final Web Delivery file: " + Path.GetFileName(Zipname));
                                            //CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD3");
                                            if (mutiarticles == true) CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD3", readme1);
                                            else CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD3");
                                            //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                                        }
                                    }
                                    else
                                    {
                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=43 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                        {
                                            string Outpath = @"\\Techsetserver2\Journal\AIP\" + Articlemeta.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\Final Web Delivery\Additional_correction\" + Path.GetFileName(Zipname);
                                            if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                            File.Copy(Zipname, Outpath, true);
                                            UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                            if (readme != "") File.WriteAllText(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath) + @"\readme.xml", readme);
                                            if (Path.GetFileNameWithoutExtension(Zipname).Split('_').Length > 1)
                                            {
                                                if (Directory.Exists(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath))) Directory.Move(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath).Split('_')[0]);
                                            }
                                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Web Delivery. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                            SaveToReport("Unclosed stage Final Web Delivery: booked as additional correction. " + Path.GetFileName(Zipname));
                                            continue;
                                        }
                                        stage = "Final Web Delivery 2 Stage";
                                        string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                        //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','50',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','15',getdate(),'1','','" + PAPFileName + @"')";
                                        Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','50','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + @"','" + AUTUStatus + "',getdate(),'1','" + Remarks + "','" + PAPFileName + @"')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Final Web Delivery 2 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                        //JR_Articles 
                                        string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','50',getdate(),'1')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Final Web Delivery 2 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                        //TrnsJournalRev 
                                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','Final Web Delivery 2','Pending')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        //SaveToReport("Status: Final Web Delivery 2 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                        ////Article 
                                        //Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                        //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        //Db.OpenConnection();
                                        //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        //Db.SqlReader.Close();
                                        ////Transaction TrnsJournal      
                                        //string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                        //string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                        //Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                        //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        //Db.OpenConnection();
                                        //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        //Db.SqlReader.Close();
                                        SaveToReport("Status: Upload files to Final Web Delivery 2 file: " + Path.GetFileName(Zipname));
                                        //CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD2");
                                        if (mutiarticles == true) CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD2", readme1);
                                        else CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD2");
                                        //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                                    }
                                }
                                else
                                {
                                    string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                    //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','43',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','15',getdate(),'1','','" + PAPFileName + @"')";
                                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','43','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + @"','" + AUTUStatus + "',getdate(),'1','" + Remarks + "','" + PAPFileName + @"')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Final Web Delivery update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                    //JR_Articles 
                                    string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','43',getdate(),'1')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Final Web Delivery update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                    //TrnsJournalRev 
                                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','Final Web Delivery','Pending')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    //SaveToReport("Status: Final Web Delivery update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                    ////Article 
                                    //Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                    //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    //Db.OpenConnection();
                                    //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    //Db.SqlReader.Close();
                                    ////Transaction TrnsJournal                             
                                    //string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                    //string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                    //Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                    //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    //Db.OpenConnection();
                                    //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    //Db.SqlReader.Close();
                                    SaveToReport("Status: Upload files to Final Web Delivery file: " + Path.GetFileName(Zipname));
                                    if (mutiarticles == true) CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD", readme1);
                                    else CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD");
                                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                                }
                            }
                        }

                        goto skipAIP;
                    }
                    else
                    {
                        //SendMail(Aid, "Dear Team,<Br/><Br/>New status update for AIP: " + XDoc.Descendants("submission_type").First().Value, "AIP", true, XDoc.Descendants("submission_type").First().Value, Zipname);
                        //SaveToReport("New status update for AIP: " + XDoc.Descendants("submission_type").First().Value + Path.GetFileName(Zipname));
                        ////Move to Error
                        //Clear();
                        //return;
                        if (XDoc.Descendants("submission_request").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").Count() > 0)
                        {
                            //SendMail(Aid, "Dear Team,<Br/><Br/>New stage file received for AIP: submission_type: " + XDoc.Descendants("submission_type").First().Value + "<Br/>submission_request: " + XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() + "<Br/> Kindly check and Validate Readme XML file for new stage.", "AIP", true, XDoc.Descendants("submission_type").First().Value, Zipname);
                            SaveToReport("New stage file received for AIP: " + XDoc.Descendants("submission_type").First().Value + " " + XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() + " " + Path.GetFileName(Zipname));
                        }
                        else
                        {
                            //SendMail(Aid, "Dear Team,<Br/><Br/>New stage file received for AIP: submission_type: " + XDoc.Descendants("submission_type").First().Value + "<Br/> Kindly check and Validate Readme XML file for new stage.", "AIP", true, XDoc.Descendants("submission_type").First().Value, Zipname);
                            SaveToReport("New stage file received for AIP: " + XDoc.Descendants("submission_type").First().Value + Path.GetFileName(Zipname));
                        }

                        //Move to Error
                        Clear();
                        return;
                    }
                }
                if (XDoc.Descendants("submission_type").First().Value.ToLower() != "starter")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File not booked for First Proof But received: " + XDoc.Descendants("submission_type").First().Value + " for: ", "AIP", true, stage, Zipname);
                    SaveToReport("File not booked for First Proof But received: " + XDoc.Descendants("submission_type").First().Value + " for: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                SaveToReport(@"Status: Collecting data from Readme file: 'coden3', 'aipid', 'doi', 'volume', 'issue', 'article_title', 'author[@type='corr']\name',  'author[@type='corr']\email', 'total_pages', 'total_figures', 'submission_date', 'due_date' & 'cs_type' " + Path.GetFileName(Zipname));
                XElement author = null;
                //string Auname = "", Auemail = "", Doi = "", Volume = "", Issue = "", Title = "", Txtfolio = "", TxtElec = "", LineArt = "", ArtElec = "", Rdate = "", Artwork = "", Sdate = "", Srcby = "", Atype="article",atypeval="";
                string Auname = "", Auemail = "", Doi = "", Volume = "", Issue = "", Title = "", Txtfolio = "", TxtElec = "", LineArt = "", ArtElec = "", Artwork = "", Srcby = "", Atype = "article", atypeval = "", MSid = "";
                foreach (XElement e in XDoc.Descendants("author").ToList())
                {
                    if (e.Attributes().Count() > 0 && e.Attributes("type").Count() == 1 && e.Attributes("type").First().Value == "corr")
                    {
                        author = e;
                        break;
                    }
                }
                if (XDoc.Descendants("edcode").Count() > 0) MSid = XDoc.Descendants("edcode").First().Value;
                if (XDoc.Descendants("article_type").Count() > 0) Atype = XDoc.Descendants("article_type").First().Value;
                if (XDoc.Descendants("doi").Count() > 0) Doi = XDoc.Descendants("doi").First().Value;
                if (XDoc.Descendants("volume").Count() > 0) Volume = XDoc.Descendants("volume").First().Value;
                if (XDoc.Descendants("issue").Count() > 0) Issue = XDoc.Descendants("issue").First().Value;
                if (XDoc.Descendants("article_title").Count() > 0) Title = XDoc.Descendants("article_title").First().Value;
                Title = Title.Replace(@"'", @"''");
                if (author != null)
                {
                    if (author.Elements("name").Count() > 0) Auname = author.Elements("name").First().Value;
                    if (author.Elements("email").Count() > 0) Auemail = author.Elements("email").First().Value;
                }
                Auname = Auname.Replace(@"'", @"''");
                if (XDoc.Descendants("total_pages").Count() > 0) Txtfolio = XDoc.Descendants("total_pages").First().Value;
                if (XDoc.Descendants("total_figures").Count() > 0) LineArt = XDoc.Descendants("total_figures").First().Value;
                Remarks = "";
                foreach (XElement e in XDoc.XPathSelectElements(@"//comments/comment/text").ToList())
                {
                    Remarks += "<br/>" + e.Value;
                }
                if (Remarks != "") Remarks = Remarks.Replace("'", "''");
                //if (XDoc.Descendants("submission_date").Count() > 0) Rdate = XDoc.Descendants("submission_date").First().Value;
                //if (XDoc.Descendants("due_date").Count() > 0) Sdate = XDoc.Descendants("due_date").First().Value;
                //***
                //P.Parthiban updated for duedate calculation; on 10th JULY 2018;
                //DateTime Artcl_ExpFromTIDt=new DateTime();
                //if (Sdate!="") 
                //{
                //    var culture = System.Globalization.CultureInfo.InvariantCulture;
                //    DateTime ddate = DateTime.ParseExact(Sdate, "MM/dd/yyyy hh:mm:ss", culture);                       
                //    Artcl_ExpFromTIDt = CalculateAIPExpFromTIDt("AIP", Db, ddate);
                //}  
                //DateTime Artcl_ExpFromTIDt = new DateTime();
                //DateTime Artcl_ScheduledDt = new DateTime();
                //DateTime artcl_CEDuedate = new DateTime();
                //if (Sdate != "")
                //{
                //    var culture = System.Globalization.CultureInfo.InvariantCulture;
                //    DateTime ddate = DateTime.ParseExact(Sdate, "MM/dd/yyyy HH:mm:ss", culture);
                //    Artcl_ExpFromTIDt = CalculateAIPExpFromTIDt("AIP", Db, ddate);
                //    Artcl_ScheduledDt = Artcl_ExpFromTIDt;
                //    Artcl_ExpFromTIDt = CalculateAIPExpFromTIDt("AIP", Db, Artcl_ExpFromTIDt);
                //    if (Rdate != "")
                //    {
                //        culture = System.Globalization.CultureInfo.InvariantCulture;
                //        DateTime ddate1 = DateTime.ParseExact(Rdate, "MM/dd/yyyy HH:mm:ss", culture);
                //        double days = Math.Round(ReturnDays(ddate1, Db, Artcl_ScheduledDt) * 0.6);
                //        artcl_CEDuedate = CalculateDueDate("", Db, AddDays(ddate1,Db, Convert.ToInt16(days)));
                //    }
                //}   
                //***
                if (XDoc.Descendants("cs_type").Count() > 0) Srcby = XDoc.Descendants("cs_type").First().Value;
                if (Srcby == "")
                {
                    string str = File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\readme.xml");
                    if (Regex.IsMatch(str.ToLower(), @"<file( [^<>]*?)? name=""([^<>]*?)\.doc(x)?""")) Srcby = "WORD";
                    else if (Regex.IsMatch(str.ToLower(), @"<file( [^<>]*?)? name=""([^<>]*?)\.pdf""")) Srcby = "PDF";
                }

                if (Txtfolio != "") TxtElec = "1";
                if (LineArt != "") { ArtElec = "1"; Artwork = "T1"; }

                /*SELECT * FROM Publishers where Publ_Acronym= 'AIP'
SELECT Jrnl_Id from Journal where Jrnl_Acronym='JVB' AND Jrnl_PublID='99'*/
                SaveToReport("Status: Booking file: " + Path.GetFileName(Zipname));
                //string condition = @"SELECT ArtType_ID FROM ArticleTypes WHERE ArtType_Name='" + Atype + "'";
                //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(condition, Db.GetConnection());
                //Db.OpenConnection();
                //Db.SqlReader = Db.SqlCmd.ExecuteReader();                   
                //if (Db.SqlReader.Read() == true)
                //{
                //    atypeval = Db.SqlReader["ArtType_ID"].ToString();
                //}
                //Db.SqlReader.Close();
                //Db.CloseConnection();
                //condition = @"SELECT Jrnl_Id from Journal where Jrnl_Acronym='" + XDoc.Descendants("coden3").First().Value + "' AND Jrnl_PublID='99'";
                //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(condition, Db.GetConnection());
                //Db.OpenConnection();
                //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                //string AJId = "";
                //if (Db.SqlReader.Read() == true) 
                //{
                //    AJId = Db.SqlReader["Jrnl_Id"].ToString();
                //}
                //Db.SqlReader.Close();
                //Db.CloseConnection();
                atypeval = ReturnDetail("ArtType_ID", "ArticleTypes", Db, "ArtType_Name='" + Atype + "'");
                string AJId = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + XDoc.Descendants("coden3").First().Value + "' AND Jrnl_PublID='99'");
                if (AJId == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + XDoc.Descendants("coden3").First().Value + ": ", "AIP", true, stage, Zipname);
                    SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + XDoc.Descendants("coden3").First().Value);
                    //Move to Error
                    Clear();
                    return;
                }

                //string book = @"insert into Testing_Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Sdate + @"','" + Srcby + @"','0','PT')";
                //if (LineArt != "")
                //{
                //    book = @"insert into Testing_Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_StatusGFX) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Sdate + @"','" + Srcby + @"','0','PT','GFXP')";                        
                //}                   
                //string book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_ArtType,Artcl_ExpFromTIDt) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Sdate + @"','" + Srcby + @"','0','PE_SRV','" + atypeval + @"','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"')";
                //if (LineArt != "")
                //{
                //    book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_StatusGFX,Artcl_ArtType,Artcl_ExpFromTIDt) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Sdate + @"','" + Srcby + @"','0','PE_SRV','GFXP','" + atypeval + @"','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-','/') + @"')";
                //}
                string Artcl_Status = "PE_SRV";
                if (Directory.GetFiles(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), "*.tex", SearchOption.AllDirectories).Length > 0) Artcl_Status = "PE";
                if (XDoc.Descendants("coden3").First().Value.ToLower() == "ltp") Artcl_Status = "DP";

                //***
                //P.Parthiban updated for duedate calculation; on 10th JULY 2018;
                //string book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_ArtType,Artcl_ExpFromTIDt) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Sdate + @"','" + Srcby + @"','0','" + Artcl_Status + "','" + atypeval + @"','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"')";
                //if (LineArt != "")
                //{
                //    book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_StatusGFX,Artcl_ArtType,Artcl_ExpFromTIDt) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Sdate + @"','" + Srcby + @"','0','" + Artcl_Status + "','GFXP','" + atypeval + @"','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"')";
                //}
                string book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_ArtType,Artcl_ExpFromTIDt,Artcl_DueDtCats,artcl_CEDuedate,Artcl_smartRemarks,Artcl_ManuScriptID) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Artcl_ScheduledDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Srcby + @"','0','" + Artcl_Status + "','" + atypeval + @"','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Sdate + @"','" + artcl_CEDuedate.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + "','" + Remarks + "','" + MSid + "')";
                if (LineArt != "")
                {
                    book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_StatusGFX,Artcl_ArtType,Artcl_ExpFromTIDt,Artcl_DueDtCats,artcl_CEDuedate,Artcl_smartRemarks,Artcl_ManuScriptID) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Artcl_ScheduledDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Srcby + @"','0','" + Artcl_Status + "','GFXP','" + atypeval + @"','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Sdate + @"','" + artcl_CEDuedate.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + "','" + Remarks + "','" + MSid + "')";
                }
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status: Update Transaction Details for file: " + Path.GetFileName(Zipname));
                //Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Select Artcl_Id From Testing_Article WITH(NOLOCK) Where Artcl_ArticleId = '" + Aid + "'", Db.GetConnection());
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Select Artcl_Id From Article WITH(NOLOCK) Where Artcl_ArticleId = '" + Aid + "'", Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                if (Db.SqlReader.Read())
                {
                    Int64 aaid = Convert.ToInt64(Db.SqlReader[0]);
                    Db.SqlReader.Close();
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, false, "AIP", Artcl_Status), Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP");
                    if (LineArt != "")
                    {
                        SaveToReport("Status: Update Artwork Transaction Details for file: " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, true), Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                    }
                }
            skipAIP:
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                File.Delete(Zipname);
                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "AIP", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }

        //***

        //***
        public void Book_New_AIP(string CL)
        {
            string stage = "First Proof Stage";
            DBClass Db = new DBClass();
            try
            {
                XDocument XDoc = new XDocument();
                SaveToReport("Status: Validating Readme file: " + Path.GetFileName(Zipname));
                if (File.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\readme.xml"))
                {
                    try
                    {
                        XDoc = XDocument.Parse(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\readme.xml").Replace("&", "&amp;").Replace("&amp;amp;", "&amp;"), LoadOptions.PreserveWhitespace);
                    }
                    catch (Exception e)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>readme.XML file is not valid for AIP: " + e.Message, "AIP", true, stage, Zipname);
                        File.Copy(Zipname, @"\\techsetserver2\Download\AIP_Error\" + Path.GetFileName(Zipname), true);
                        SaveToReport("readme.XML file is not valid for:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                        Clear();
                        return;
                    }
                }
                else
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>readme.XML file missing for AIP: ", "AIP", true, stage, Zipname);
                    SaveToReport("readme.XML file missing for:  " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
                SaveToReport("Status: Validating against Booked Records: " + Path.GetFileName(Zipname));
                if (XDoc.Descendants("edcode").Count() == 0)
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'edcode' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                    SaveToReport("'edcode' article id missing in Readme xml file: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                if (XDoc.Descendants("coden3").Count() == 0)
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'coden3' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                    SaveToReport("'coden3' missing in Readme xml file: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                if (XDoc.Descendants("submission_type").Count() == 0)
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'submission_type' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                    SaveToReport("'submission_type' missing in Readme xml file: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                string Aid = XDoc.Descendants("edcode").First().Value;
                String AUTUStatus = "25";
                if (XDoc.Descendants("coden3").First().Value.ToLower() == "cha") AUTUStatus = "102";
                string Rdate = "", Sdate = "";
                if (XDoc.Descendants("submission_date").Count() > 0) Rdate = XDoc.Descendants("submission_date").First().Value;
                if (XDoc.Descendants("due_date").Count() > 0) Sdate = XDoc.Descendants("due_date").First().Value;
                DateTime Artcl_ExpFromTIDt = new DateTime();
                DateTime Artcl_ScheduledDt = new DateTime();
                DateTime artcl_CEDuedate = new DateTime();
                string Remarks = "";
                if (Sdate != "")
                {
                    var culture = System.Globalization.CultureInfo.InvariantCulture;
                    DateTime ddate = DateTime.ParseExact(Sdate, "MM/dd/yyyy HH:mm:ss", culture);
                    Artcl_ExpFromTIDt = CalculateAIPExpFromTIDt("AIP", Db, ddate);
                    Artcl_ScheduledDt = Artcl_ExpFromTIDt;
                    Artcl_ExpFromTIDt = CalculateAIPExpFromTIDt("AIP", Db, Artcl_ExpFromTIDt);
                    if (Rdate != "" && XDoc.Descendants("submission_type").First().Value.ToLower() == "starter")
                    {
                        culture = System.Globalization.CultureInfo.InvariantCulture;
                        DateTime ddate1 = DateTime.ParseExact(Rdate, "MM/dd/yyyy HH:mm:ss", culture);
                        double days = Math.Round(ReturnDays(ddate1, Db, Artcl_ScheduledDt) * 0.6);
                        artcl_CEDuedate = CalculateDueDate("", Db, AddDays(ddate1, Db, Convert.ToInt16(days)));
                    }
                }
                if (CheckWhetherFileBooked(Aid))
                {
                    if (XDoc.Descendants("submission_type").First().Value.ToLower() == "starter")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for First Proof: ", "AIP", true, stage, Zipname);
                        SaveToReport("File already booked for First Proof: " + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    else if (XDoc.Descendants("submission_type").First().Value.ToLower() == "printdeliverytovendor" && XDoc.Descendants("submission_request").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() == "issuetoprinter")
                    {
                        if (XDoc.Descendants("volume").Count() == 0)
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'volume' missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                            SaveToReport("'volume' missing in Readme xml file: " + Path.GetFileName(Zipname));
                            Clear();
                            return;
                        }
                        if (XDoc.Descendants("issue").Count() == 0)
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'issue' missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                            SaveToReport("'issue' missing in Readme xml file: " + Path.GetFileName(Zipname));
                            Clear();
                            return;
                        }
                        SaveToReport("Status: Printer update JR_Main Table file: " + Path.GetFileName(Zipname));
                        //JR_Main 
                        string vol = XDoc.Descendants("volume").First().Value;
                        string issue = XDoc.Descendants("issue").First().Value;
                        string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + XDoc.Descendants("coden3").First().Value + "' AND Jrnl_PublID='99'");
                        string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                        string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,LastModifiedDate,UsrID,Insert_Date, JRM_Volume, JRM_Issue) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"',getdate(),'1',getdate(),'" + vol + "','" + issue + "')";
                        JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + vol + "' AND JRM_Issue='" + issue + "'");
                        if (JRM_Id == "")
                        {
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }
                        JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + vol + "' AND JRM_Issue='" + issue + "'");
                        JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                        Remarks = "";
                        foreach (XElement e in XDoc.XPathSelectElements(@"//comments/comment/text").ToList())
                        {
                            Remarks += "<br/>" + e.Value;
                        }
                        if (Remarks != "") Remarks = Remarks.Replace("'", "''");

                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=42") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=57") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=71") != "")
                                {
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Printer Files 3: ", "AIP", true, stage, Zipname);
                                    SaveToReport("File already booked for Printer Files 3: " + Path.GetFileName(Zipname));
                                    //Move to Error
                                    Clear();
                                    return;
                                }
                                else
                                {
                                    stage = "Printer Files 3";
                                    string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','71','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','25',getdate(),'1','" + Remarks + "')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    foreach (XElement Article in XDoc.XPathSelectElements(@"//lineup_items/article").ToList())
                                    {
                                        //if (Article.Descendants("aipid").Count() == 0)
                                        if (Article.Descendants("edcode").Count() == 0)
                                        {
                                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'edcode' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                                            SaveToReport("'edcode' article id missing in Readme xml file: " + Path.GetFileName(Zipname));
                                            continue;
                                        }
                                        Aid = XDoc.Descendants("edcode").First().Value; //Article.Descendants("aipid").First().Value;
                                        string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                                        if (uploaddate == "")
                                        {
                                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.: ", "AIP", true, stage, Zipname);
                                            SaveToReport("Artcl_UploadedDt not updated: " + Path.GetFileName(Zipname));
                                            continue;
                                        }
                                        //JR_Articles 
                                        string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','25','71',getdate(),'1')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Printer Files 3 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                        //TrnsJournalRev 
                                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','25',getdate(),'1','Printer Files 3','Pending')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Printer Files 3 update Article Table file: " + Path.GetFileName(Zipname));
                                        Query = "update Article set Artcl_Volume='" + vol + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage + " Stage");
                                    }
                                    SaveToReport("Status: Copy files to Printer files 3: " + Path.GetFileName(Zipname));
                                    CreateTxtfile(Zipname, XDoc.Descendants("edcode").First().Value, XDoc.Descendants("coden3").First().Value, "AIPNew", stage, "", vol, issue);
                                    goto skipAIP;
                                }
                            }
                            else
                            {
                                stage = "Printer Files 2";
                                string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','57','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','25',getdate(),'1','" + Remarks + "')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                foreach (XElement Article in XDoc.XPathSelectElements(@"//lineup_items/article").ToList())
                                {
                                    if (Article.Descendants("edcode").Count() == 0)
                                    {
                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'edcode' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                                        SaveToReport("'edcode' article id missing in Readme xml file: " + Path.GetFileName(Zipname));
                                        continue;
                                    }
                                    Aid = Article.Descendants("edcode").First().Value;
                                    string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                                    if (uploaddate == "")
                                    {
                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.: ", "AIP", true, stage, Zipname);
                                        SaveToReport("Artcl_UploadedDt not updated: " + Path.GetFileName(Zipname));
                                        continue;
                                    }

                                    SaveToReport("Status: Printer Files 2 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                    //JR_Articles 
                                    string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','25','57',getdate(),'1')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Printer Files 2 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                    //TrnsJournalRev 
                                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','25',getdate(),'1','Printer Files 2','Pending')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Printer files 2 update Article Table file: " + Path.GetFileName(Zipname));
                                    Query = "update Article set Artcl_Volume='" + vol + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage + " Stage");
                                }
                                SaveToReport("Status: Copy files to Printer files 2: " + Path.GetFileName(Zipname));
                                CreateTxtfile(Zipname, XDoc.Descendants("edcode").First().Value, XDoc.Descendants("coden3").First().Value, "AIPNew", stage, "", vol, issue);
                                goto skipAIP;
                            }
                        }
                        else
                        {
                            stage = "Printer Files";
                            AUTUStatus = "25";
                            if (XDoc.Descendants("coden3").First().Value.ToLower() != "cha")
                            {
                                if (Merge_PDF(XDoc, XDoc.Descendants("coden3").First().Value.ToUpper(), vol, issue)) AUTUStatus = "28";
                            }
                            string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                            Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','42','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            foreach (XElement Article in XDoc.XPathSelectElements(@"//lineup_items/article").ToList())
                            {
                                if (Article.Descendants("edcode").Count() == 0)
                                {
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'edcode' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                                    SaveToReport("'edcode' article id missing in Readme xml file: " + Path.GetFileName(Zipname));
                                    continue;
                                }
                                Aid = Article.Descendants("edcode").First().Value;
                                string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                                if (uploaddate == "")
                                {
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.: ", "AIP", true, stage, Zipname);
                                    SaveToReport("Artcl_UploadedDt not updated: " + Path.GetFileName(Zipname));
                                    continue;
                                }
                                SaveToReport("Status: Printer Files update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                //JR_Articles 
                                string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','42',getdate(),'1')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: Printer Files update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                //TrnsJournalRev 
                                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','Printer Files','Pending')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: Printer files update Article Table file: " + Path.GetFileName(Zipname));
                                Query = "update Article set Artcl_Volume='" + vol + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage + " Stage");
                            }

                            SaveToReport("Status: Copy files to Printer files: " + Path.GetFileName(Zipname));
                            CreateTxtfile(Zipname, XDoc.Descendants("edcode").First().Value, XDoc.Descendants("coden3").First().Value, "AIPNew", stage, "", vol, issue);
                            goto skipAIP;
                        }

                    }
                    //else if (XDoc.Descendants("submission_type").First().Value.ToLower() == "correctionstovendor" || (XDoc.Descendants("submission_type").First().Value.ToLower() == "revisionstovendor" && XDoc.Descendants("submission_request").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() == "aaproof"))
                    else if (XDoc.Descendants("submission_type").First().Value.ToLower() == "revisionstovendor" && XDoc.Descendants("submission_request").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() == "aaproof")
                    {
                        stage = "Author Correction Stage";
                        string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                        if (uploaddate == "")//|| CheckWhetherFileBooked(Aid,"AC"))
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "AIP", true, stage, Zipname);
                            SaveToReport("Artcl_UploadedDt not updated " + Path.GetFileName(Zipname));
                            //Move to Error
                            Clear();
                            return;
                        }
                        SaveToReport("Status: Author Correction update JR_Main Table file: " + Path.GetFileName(Zipname));
                        // Author Correction   
                        //JR_Main 
                        string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + XDoc.Descendants("coden3").First().Value + "' AND Jrnl_PublID='99'");
                        string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                        string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                        if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                        {
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }
                        JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                        JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));

                        //JR_Stage_Tran  
                        string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                        string JRA_ID = "";
                        Remarks = "";
                        foreach (XElement e in XDoc.XPathSelectElements(@"//comments/comment/text").ToList())
                        {
                            Remarks += "<br/>" + e.Value;
                        }
                        if (Remarks != "") Remarks = Remarks.Replace("'", "''");
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=36") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=37") != "")
                                {
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=78") != "")
                                    {
                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=97") != "")
                                        {
                                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=98") != "")
                                            {
                                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 5: ", "AIP", true, stage, Zipname);
                                                SaveToReport("File already booked for Author Correction 5: " + Path.GetFileName(Zipname));
                                                //Move to Error
                                                Clear();
                                                return;
                                            }
                                            else
                                            {
                                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=97 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                                {
                                                    string Outpath = @"\\Techsetserver2\Journal\AIP\" + XDoc.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\AU Correction 4\Additional_correction\" + Path.GetFileName(Zipname);
                                                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                                    File.Copy(Zipname, Outpath, true);
                                                    UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 4. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                                    SaveToReport("Unclosed stage Author Correction 4: booked as additional correction. " + Path.GetFileName(Zipname));
                                                    Clear();
                                                    return;
                                                }
                                                stage = "Author Correction 5 Stage";
                                                SaveToReport("Status: Author Correction 5 update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','98','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                SaveToReport("Status: Author Correction 5 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                                //JR_Articles 
                                                JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','98',getdate(),'1')";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                SaveToReport("Status: Author Correction 5 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                                //TrnsJournalRev 
                                                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction 5','Pending')";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                SaveToReport("Status: Upload files to Author Correction 5 file: " + Path.GetFileName(Zipname));
                                                CreateTxtfile(Zipname, XDoc.Descendants("edcode").First().Value, XDoc.Descendants("coden3").First().Value, "AIPNew", "AC5");
                                                goto skipAIP;
                                            }
                                        }
                                        else
                                        {
                                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=78 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                            {
                                                string Outpath = @"\\Techsetserver2\Journal\AIP\" + XDoc.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\AU Correction 3\Additional_correction\" + Path.GetFileName(Zipname);
                                                if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                                File.Copy(Zipname, Outpath, true);
                                                UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 3. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                                SaveToReport("Unclosed stage Author Correction 3: booked as additional correction. " + Path.GetFileName(Zipname));
                                                Clear();
                                                return;
                                            }
                                            stage = "Author Correction 4 Stage";
                                            SaveToReport("Status: Author Correction 4 update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                            Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','97','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            SaveToReport("Status: Author Correction 4 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                            //JR_Articles 
                                            JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                            Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','97',getdate(),'1')";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            SaveToReport("Status: Author Correction 4 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                            //TrnsJournalRev 
                                            Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction 4','Pending')";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            SaveToReport("Status: Upload files to Author Correction 1 file: " + Path.GetFileName(Zipname));
                                            CreateTxtfile(Zipname, XDoc.Descendants("edcode").First().Value, XDoc.Descendants("coden3").First().Value, "AIPNew", "AC4");
                                            goto skipAIP;
                                        }
                                    }
                                    else
                                    {
                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=37 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                        {
                                            string Outpath = @"\\Techsetserver2\Journal\AIP\" + XDoc.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\AU Correction 2\Additional_correction\" + Path.GetFileName(Zipname);
                                            if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                            File.Copy(Zipname, Outpath, true);
                                            UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 2. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                            SaveToReport("Unclosed stage Author Correction 2: booked as additional correction. " + Path.GetFileName(Zipname));
                                            Clear();
                                            return;
                                        }
                                        stage = "Author Correction 3 Stage";
                                        SaveToReport("Status: Author Correction 3 update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                        Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','78','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Author Correction 3 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                        //JR_Articles 
                                        JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','78',getdate(),'1')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Author Correction 3 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                        //TrnsJournalRev 
                                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction 3','Pending')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Upload files to Author Correction 3 file: " + Path.GetFileName(Zipname));
                                        CreateTxtfile(Zipname, XDoc.Descendants("edcode").First().Value, XDoc.Descendants("coden3").First().Value, "AIPNew", "AC3");
                                        goto skipAIP;
                                    }
                                }
                                else
                                {
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=36 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                    {
                                        string Outpath = @"\\Techsetserver2\Journal\AIP\" + XDoc.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\AU Correction 1\Additional_correction\" + Path.GetFileName(Zipname);
                                        if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                        File.Copy(Zipname, Outpath, true);
                                        UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 1. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                        SaveToReport("Unclosed stage Author Correction 1: booked as additional correction. " + Path.GetFileName(Zipname));
                                        Clear();
                                        return;
                                    }
                                    stage = "Author Correction 2 Stage";
                                    SaveToReport("Status: Author Correction 2 update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','37','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Author Correction 2 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                    //JR_Articles 
                                    JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','37',getdate(),'1')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Author Correction 2 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                    //TrnsJournalRev 
                                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction 2','Pending')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Upload files to Author Correction 2 file: " + Path.GetFileName(Zipname));
                                    CreateTxtfile(Zipname, XDoc.Descendants("edcode").First().Value, XDoc.Descendants("coden3").First().Value, "AIPNew", "AC2");
                                    goto skipAIP;
                                }
                            }
                            else
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                {
                                    string Outpath = @"\\Techsetserver2\Journal\AIP\" + XDoc.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\Additional_correction\" + Path.GetFileName(Zipname);
                                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                    File.Copy(Zipname, Outpath, true);
                                    UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                    SaveToReport("Unclosed stage Author Correction: booked as additional correction. " + Path.GetFileName(Zipname));
                                    Clear();
                                    return;
                                }
                                stage = "Author Correction 1 Stage";
                                SaveToReport("Status: Author Correction 1 update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','36','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: Author Correction 1 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                //JR_Articles 
                                JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','36',getdate(),'1')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: Author Correction 1 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                //TrnsJournalRev 
                                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction 1','Pending')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: Upload files to Author Correction 1 file: " + Path.GetFileName(Zipname));
                                CreateTxtfile(Zipname, XDoc.Descendants("edcode").First().Value, XDoc.Descendants("coden3").First().Value, "AIPNew", "AC1");
                                goto skipAIP;
                            }
                        }
                        else
                        {
                            Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','35','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                            SaveToReport("Status: Author Correction update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: Author Correction update JR_Articles Table file: " + Path.GetFileName(Zipname));
                            //JR_Articles 
                            JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                            Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','35',getdate(),'1')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: Author Correction update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                            //TrnsJournalRev 
                            Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction','Pending')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: Upload files to Author Correction file: " + Path.GetFileName(Zipname));
                            CreateTxtfile(Zipname, XDoc.Descendants("edcode").First().Value, XDoc.Descendants("coden3").First().Value, "AIPNew", "AC");
                            goto skipAIP;
                        }
                    }
                    //else if (XDoc.Descendants("submission_type").First().Value.ToLower() == "revisionstovendor" && XDoc.Descendants("submission_request").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() == "aaproof")
                    //{
                    //    SaveToReport("Status: Author Correction update JR_Main Table file: " + Path.GetFileName(Zipname));
                    //    string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + XDoc.Descendants("coden3").First().Value + "' AND Jrnl_PublID='99'");
                    //    string JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                    //    if (JRM_Id == "")
                    //    {
                    //        SendMail(Aid, "Dear Team,<Br/><Br/>Additional correction not booked for AIP: submission_type: " + XDoc.Descendants("submission_type").First().Value + "<Br/> Kindly check and Validate corrections yet to book.", "AIP", true, XDoc.Descendants("submission_type").First().Value, Zipname);
                    //        SaveToReport("Additional correction not booked Previous stage already closed for AIP: " + XDoc.Descendants("submission_type").First().Value + Path.GetFileName(Zipname));
                    //        Clear();
                    //        return;
                    //    }
                    //    JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                    //    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=97 AND isnull(JRST_UploadedDT ,'')=''") != "")
                    //    {
                    //        string Outpath = @"\\Techsetserver2\Journal\AIP\" + XDoc.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\AU Correction 4\Additional_correction\" + Path.GetFileName(Zipname);
                    //        if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    //        File.Copy(Zipname, Outpath, true);
                    //        UnZip(Zipname, Path.GetDirectoryName(Outpath));
                    //        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 4. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                    //        SaveToReport("Unclosed stage Author Correction 4: booked as additional correction. " + Path.GetFileName(Zipname));
                    //        Clear();
                    //        return;
                    //    }
                    //    else if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=78 AND isnull(JRST_UploadedDT ,'')=''") != "")
                    //    {
                    //        string Outpath = @"\\Techsetserver2\Journal\AIP\" + XDoc.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\AU Correction 3\Additional_correction\" + Path.GetFileName(Zipname);
                    //        if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    //        File.Copy(Zipname, Outpath, true);
                    //        UnZip(Zipname, Path.GetDirectoryName(Outpath));
                    //        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 3. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                    //        SaveToReport("Unclosed stage Author Correction 3: booked as additional correction. " + Path.GetFileName(Zipname));
                    //        Clear();
                    //        return;
                    //    }
                    //    else if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=37 AND isnull(JRST_UploadedDT ,'')=''") != "")
                    //    {
                    //        string Outpath = @"\\Techsetserver2\Journal\AIP\" + XDoc.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\AU Correction 2\Additional_correction\" + Path.GetFileName(Zipname);
                    //        if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    //        File.Copy(Zipname, Outpath, true);
                    //        UnZip(Zipname, Path.GetDirectoryName(Outpath));
                    //        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 2. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                    //        SaveToReport("Unclosed stage Author Correction 2: booked as additional correction. " + Path.GetFileName(Zipname));
                    //        Clear();
                    //        return;
                    //    }
                    //    else if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=36 AND isnull(JRST_UploadedDT ,'')=''") != "")
                    //    {
                    //        string Outpath = @"\\Techsetserver2\Journal\AIP\" + XDoc.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\AU Correction 1\Additional_correction\" + Path.GetFileName(Zipname);
                    //        if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    //        File.Copy(Zipname, Outpath, true);
                    //        UnZip(Zipname, Path.GetDirectoryName(Outpath));
                    //        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 1. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                    //        SaveToReport("Unclosed stage Author Correction 1: booked as additional correction. " + Path.GetFileName(Zipname));
                    //        Clear();
                    //        return;
                    //    }
                    //    else if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35 AND isnull(JRST_UploadedDT ,'')=''") != "")
                    //    {
                    //        string Outpath = @"\\Techsetserver2\Journal\AIP\" + XDoc.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\Additional_correction\" + Path.GetFileName(Zipname);
                    //        if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    //        File.Copy(Zipname, Outpath, true);
                    //        UnZip(Zipname, Path.GetDirectoryName(Outpath));
                    //        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                    //        SaveToReport("Unclosed stage Author Correction: booked as additional correction. " + Path.GetFileName(Zipname));
                    //        Clear();
                    //        return;
                    //    }
                    //    else
                    //    {
                    //        SendMail(Aid, "Dear Team,<Br/><Br/>Additional correction not booked for AIP: submission_type: " + XDoc.Descendants("submission_type").First().Value + "<Br/> Kindly check and Validate Previous stage already closed.", "AIP", true, XDoc.Descendants("submission_type").First().Value, Zipname);
                    //        SaveToReport("Additional correction not booked Previous stage already closed for AIP: " + XDoc.Descendants("submission_type").First().Value + Path.GetFileName(Zipname));
                    //        Clear();
                    //        return;
                    //    }
                    //}
                    //else if (XDoc.Descendants("submission_type").First().Value.ToLower() == "revisionstovendor" && XDoc.Descendants("submission_request").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() == "authorproof")
                    else if (XDoc.Descendants("submission_type").First().Value.ToLower() == "correctionstovendor" && XDoc.Descendants("submission_request").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() == "authorproof")
                    {
                        stage = "TU Correction 1 Stage";
                        string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                        if (uploaddate == "")// || CheckWhetherFileBooked(Aid, "TUC"))
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.: ", "AIP", true, stage, Zipname);
                            SaveToReport("Artcl_UploadedDt not updated: " + Path.GetFileName(Zipname));
                            //Move to Error
                            Clear();
                            return;
                        }
                        SaveToReport("Status: TU Correction 1 update JR_Main Table file: " + Path.GetFileName(Zipname));
                        // Author Correction   
                        //JR_Main 
                        string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + XDoc.Descendants("coden3").First().Value + "' AND Jrnl_PublID='99'");
                        string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                        string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                        if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                        {
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }

                        JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                        JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                        Remarks = "";
                        foreach (XElement e in XDoc.XPathSelectElements(@"//comments/comment/text").ToList())
                        {
                            Remarks += "<br/>" + e.Value;
                        }
                        if (Remarks != "") Remarks = Remarks.Replace("'", "''");
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=33") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=34") != "")
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for TU Correction 2: ", "AIP", true, stage, Zipname);
                                SaveToReport("File already booked for TU Correction 2: " + Path.GetFileName(Zipname));
                                //Move to Error
                                Clear();
                                return;
                            }
                            else
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=33 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                {
                                    string Outpath = @"\\Techsetserver2\Journal\AIP\" + XDoc.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\TU Correction\Additional_correction\" + Path.GetFileName(Zipname);
                                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                    File.Copy(Zipname, Outpath, true);
                                    UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for TU Correction 1. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                    SaveToReport("Unclosed stage TU Correction 1: booked as additional correction. " + Path.GetFileName(Zipname));
                                    Clear();
                                    return;
                                }
                                stage = "TU Correction 2 Stage";
                                string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','34','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: TU Correction 2 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                //JR_Articles 
                                string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','34',getdate(),'1')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: TU Correction 2 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                //TrnsJournalRev 
                                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','TU Correction 2','Pending')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: Upload files to TU Correction 2 file: " + Path.GetFileName(Zipname));
                                CreateTxtfile(Zipname, XDoc.Descendants("edcode").First().Value, XDoc.Descendants("coden3").First().Value, "AIPNew", "TUC2");
                                goto skipAIP;
                            }
                        }
                        else
                        {
                            SaveToReport("Status: TU Correction 1 update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                            string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                            Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','33','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: TU Correction 1 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                            //JR_Articles 
                            string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                            Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','33',getdate(),'1')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: TU Correction 1 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                            //TrnsJournalRev 
                            Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','TU Correction 1','Pending')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: Upload files to TU Correction 1 file: " + Path.GetFileName(Zipname));
                            CreateTxtfile(Zipname, XDoc.Descendants("edcode").First().Value, XDoc.Descendants("coden3").First().Value, "AIPNew", "TUC");
                            goto skipAIP;
                        }
                    }
                    else if ((XDoc.Descendants("submission_type").First().Value.ToLower() == "paginationtovendor" || XDoc.Descendants("submission_type").First().Value.ToLower() == "revisionstovendor") && XDoc.Descendants("submission_request").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() == "finaldeliverables")
                    {
                        Boolean mutiarticles = false;
                        string readme = File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\readme.xml");
                        if (XDoc.Descendants("article_metadata").Count() > 1)
                        {
                            mutiarticles = true;
                            readme = Regex.Replace(readme, "<articles>(.*?)</articles>", "<articles></articles>", RegexOptions.Singleline);
                        }
                        foreach (XElement Articlemeta in XDoc.Descendants("article_metadata").ToList())
                        {
                            string readme1 = "";
                            if (mutiarticles == true)
                            {
                                readme1 = readme.Replace("<articles>", "<articles>" + Articlemeta.ToString(SaveOptions.DisableFormatting));
                            }
                            if (Articlemeta.Descendants("edcode").Count() == 0)
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'edcode' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                                SaveToReport("'edcode' article id missing in Readme xml file: " + Path.GetFileName(Zipname));
                                continue;
                            }
                            if (Articlemeta.Descendants("coden3").Count() == 0)
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'coden3' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                                SaveToReport("'coden3' missing in Readme xml file: " + Path.GetFileName(Zipname));
                                continue;
                            }
                            if (Articlemeta.Descendants("fpage").Count() == 0)
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'fpage' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                                SaveToReport("'fpage' missing in Readme xml file: " + Path.GetFileName(Zipname));
                                continue;
                            }
                            if (Articlemeta.Descendants("seqno").Count() == 0)
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'seqno' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                                SaveToReport("'seqno' missing in Readme xml file: " + Path.GetFileName(Zipname));
                                continue;
                            }
                            string PAPFileName = Articlemeta.Descendants("fpage").First().Value.Split('-')[0] + '_' + Articlemeta.Descendants("seqno").First().Value;
                            Aid = Articlemeta.Descendants("edcode").First().Value;
                            //Aid = Aid + Articlemeta.Descendants("coden3").First().Value;

                            if (CheckWhetherFileBooked(Aid))
                            {
                                stage = "Final Web Delivery Stage";
                                string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                                if (uploaddate == "")//|| CheckWhetherFileBooked(Aid,"AC"))
                                {
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "AIP", true, stage, Zipname);
                                    SaveToReport("Artcl_UploadedDt not updated " + Aid + " " + Path.GetFileName(Zipname));
                                    //Move to Error
                                    //Clear();
                                    //return;
                                    continue;
                                }
                                SaveToReport("Status: Final Web Delivery update JR_Main Table file: " + Path.GetFileName(Zipname));
                                //WBID:8058;03042019
                                if (Articlemeta.Descendants("coden3").First().Value.ToLower() == "cha") File.WriteAllText(@"\\techsetserver1\software\Latex\Preedit-tools\AIP-Automation\In\" + Aid + ".txt", "");
                                //Status Validation;
                                AUTUStatus = "25";
                                if (File.Exists(@"\\techsetserver2\journal\AIP\" + Articlemeta.Descendants("coden3").First().Value + @"\Articles\pagination\" + Aid + ".3d") && File.Exists(@"\\techsetserver1\Software\AIP\JournalsList\JournalsList.xml"))
                                {
                                    try
                                    {
                                        string str = @"\\techsetserver1\Software\AIP\JournalsList\JournalsList.xml";
                                        XDocument xs = XDocument.Parse(File.ReadAllText(str), LoadOptions.PreserveWhitespace);
                                        foreach (XElement elt in xs.Descendants("journal").ToList())
                                        {
                                            if (elt.Elements("jacronym").First().Value.ToUpper() == Articlemeta.Descendants("coden3").First().Value.ToUpper())
                                            {
                                                if (elt.Elements("coden").First().Value != "")
                                                {
                                                    Process compiler = new Process();
                                                    compiler.StartInfo.FileName = @"\\techsetserver1\Library\AIP-PAP-PDF-SMART\AIP-PAP-PDF.exe";
                                                    compiler.StartInfo.Arguments = @"\\techsetserver2\journal\AIP\" + Articlemeta.Descendants("coden3").First().Value + @"\Articles\pagination\" + Aid + ".3d " + elt.Elements("coden").First().Value;
                                                    compiler.StartInfo.UseShellExecute = false;
                                                    compiler.StartInfo.RedirectStandardOutput = true;
                                                    compiler.Start();
                                                    string gt = compiler.StandardOutput.ReadToEnd();
                                                    compiler.WaitForExit();
                                                    if (gt.Trim().ToLower() == "true") AUTUStatus = "28";
                                                    SaveToReport("Status: Final Web Delivery Validation success: " + Aid);
                                                    break;
                                                }
                                            }
                                        }
                                    }
                                    catch (Exception exx)
                                    {
                                        AUTUStatus = "25";
                                        SaveToReport("Status: Final Web Delivery Validation Failed: " + Aid);
                                    }
                                }
                                //JR_Main 
                                string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + Articlemeta.Descendants("coden3").First().Value + "' AND Jrnl_PublID='99'");
                                string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                                string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                                if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                                {
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                }

                                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                                JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                                Remarks = "";
                                foreach (XElement e in Articlemeta.XPathSelectElements(@"comments/comment/text").ToList())
                                {
                                    Remarks += "<br/>" + e.Value;
                                }
                                if (Remarks != "") Remarks = Remarks.Replace("'", "''");
                                SaveToReport("Status: Final Web Delivery update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                //JR_Stage_Tran    
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=43") != "")
                                {
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=50") != "")
                                    {
                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=125") != "")
                                        {
                                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=126") != "")
                                            {
                                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=127") != "")
                                                {
                                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=128") != "")
                                                    {
                                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Web Delivery 6: ", "AIP", true, stage, Zipname);
                                                        SaveToReport("File already booked for Final Web Delivery 6: " + Path.GetFileName(Zipname));
                                                        //Move to Error
                                                        //Clear();
                                                        //return;
                                                        continue;
                                                    }
                                                    else
                                                    {
                                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=127 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                                        {
                                                            string Outpath = @"\\Techsetserver2\Journal\AIP\" + Articlemeta.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\Final Web Delivery 5\Additional_correction\" + Path.GetFileName(Zipname);
                                                            if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                                            File.Copy(Zipname, Outpath, true);
                                                            UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                                            if (readme != "") File.WriteAllText(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath) + @"\readme.xml", readme);
                                                            if (Path.GetFileNameWithoutExtension(Zipname).Split('_').Length > 1)
                                                            {
                                                                if (Directory.Exists(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath))) Directory.Move(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath).Split('_')[0]);
                                                            }
                                                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Web Delivery 5. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                                            SaveToReport("Unclosed stage Final Web Delivery 5: booked as additional correction. " + Path.GetFileName(Zipname));
                                                            continue;
                                                        }
                                                        stage = "Final Web Delivery 6 Stage";
                                                        string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                                        Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','128' ,'" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + @"','" + AUTUStatus + "',getdate(),'1','" + Remarks + "','" + PAPFileName + @"')";
                                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                        Db.OpenConnection();
                                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                        Db.SqlReader.Close();
                                                        SaveToReport("Status: Final Web Delivery 6 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                                        //JR_Articles 
                                                        string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','128',getdate(),'1')";
                                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                        Db.OpenConnection();
                                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                        Db.SqlReader.Close();
                                                        SaveToReport("Status: Final Web Delivery 6 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                                        //TrnsJournalRev 
                                                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','Final Web Delivery 6','Pending')";
                                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                        Db.OpenConnection();
                                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                        Db.SqlReader.Close();
                                                        SaveToReport("Status: Upload files to Final Web Delivery 6 file: " + Path.GetFileName(Zipname));
                                                        //CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD6");
                                                        if (mutiarticles == true) CreateTxtfile(Zipname, Articlemeta.Descendants("edcode").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIPNew", "FWD6", readme1);
                                                        else CreateTxtfile(Zipname, Articlemeta.Descendants("edcode").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIPNew", "FWD6");
                                                        //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                                                    }
                                                }
                                                else
                                                {
                                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=126 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                                    {
                                                        string Outpath = @"\\Techsetserver2\Journal\AIP\" + Articlemeta.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\Final Web Delivery 4\Additional_correction\" + Path.GetFileName(Zipname);
                                                        if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                                        File.Copy(Zipname, Outpath, true);
                                                        UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                                        if (readme != "") File.WriteAllText(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath) + @"\readme.xml", readme);
                                                        if (Path.GetFileNameWithoutExtension(Zipname).Split('_').Length > 1)
                                                        {
                                                            if (Directory.Exists(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath))) Directory.Move(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath).Split('_')[0]);
                                                        }
                                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Web Delivery 4. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                                        SaveToReport("Unclosed stage Final Web Delivery 4: booked as additional correction. " + Path.GetFileName(Zipname));
                                                        continue;
                                                    }
                                                    stage = "Final Web Delivery 5 Stage";
                                                    string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','127','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + @"','" + AUTUStatus + "',getdate(),'1','" + Remarks + "','" + PAPFileName + @"')";
                                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                    Db.OpenConnection();
                                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                    Db.SqlReader.Close();
                                                    SaveToReport("Status: Final Web Delivery 5 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                                    //JR_Articles 
                                                    string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','127',getdate(),'1')";
                                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                    Db.OpenConnection();
                                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                    Db.SqlReader.Close();
                                                    SaveToReport("Status: Final Web Delivery 5 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                                    //TrnsJournalRev 
                                                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','Final Web Delivery 5','Pending')";
                                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                    Db.OpenConnection();
                                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                    Db.SqlReader.Close();
                                                    SaveToReport("Status: Upload files to Final Web Delivery 5 file: " + Path.GetFileName(Zipname));
                                                    //CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD5");
                                                    if (mutiarticles == true) CreateTxtfile(Zipname, Articlemeta.Descendants("edcode").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIPNew", "FWD5", readme1);
                                                    else CreateTxtfile(Zipname, Articlemeta.Descendants("edcode").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIPNew", "FWD5");
                                                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                                                }
                                            }
                                            else
                                            {
                                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=125 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                                {
                                                    string Outpath = @"\\Techsetserver2\Journal\AIP\" + Articlemeta.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\Final Web Delivery 3\Additional_correction\" + Path.GetFileName(Zipname);
                                                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                                    File.Copy(Zipname, Outpath, true);
                                                    UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                                    if (readme != "") File.WriteAllText(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath) + @"\readme.xml", readme);
                                                    if (Path.GetFileNameWithoutExtension(Zipname).Split('_').Length > 1)
                                                    {
                                                        if (Directory.Exists(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath))) Directory.Move(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath).Split('_')[0]);
                                                    }
                                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Web Delivery 3. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                                    SaveToReport("Unclosed stage Final Web Delivery 3: booked as additional correction. " + Path.GetFileName(Zipname));
                                                    continue;
                                                }
                                                stage = "Final Web Delivery 4 Stage";
                                                string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','126','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + @"','" + AUTUStatus + "',getdate(),'1','" + Remarks + "','" + PAPFileName + @"')";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                SaveToReport("Status: Final Web Delivery 4 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                                //JR_Articles 
                                                string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','126',getdate(),'1')";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                SaveToReport("Status: Final Web Delivery 4 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                                //TrnsJournalRev 
                                                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','Final Web Delivery 4','Pending')";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                SaveToReport("Status: Upload files to Final Web Delivery 4 file: " + Path.GetFileName(Zipname));
                                                //CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD4");
                                                if (mutiarticles == true) CreateTxtfile(Zipname, Articlemeta.Descendants("edcode").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIPNew", "FWD4", readme1);
                                                else CreateTxtfile(Zipname, Articlemeta.Descendants("edcode").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIPNew", "FWD4");
                                                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                                            }
                                        }
                                        else
                                        {
                                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=50 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                            {
                                                string Outpath = @"\\Techsetserver2\Journal\AIP\" + Articlemeta.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\Final Web Delivery 2\Additional_correction\" + Path.GetFileName(Zipname);
                                                if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                                File.Copy(Zipname, Outpath, true);
                                                UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                                if (readme != "") File.WriteAllText(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath) + @"\readme.xml", readme);
                                                if (Path.GetFileNameWithoutExtension(Zipname).Split('_').Length > 1)
                                                {
                                                    if (Directory.Exists(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath))) Directory.Move(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath).Split('_')[0]);
                                                }
                                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Web Delivery 2. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                                SaveToReport("Unclosed stage Final Web Delivery 2: booked as additional correction. " + Path.GetFileName(Zipname));
                                                continue;
                                            }
                                            stage = "Final Web Delivery 3 Stage";
                                            string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                            Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','125','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + @"','" + AUTUStatus + "',getdate(),'1','" + Remarks + "','" + PAPFileName + @"')";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            SaveToReport("Status: Final Web Delivery 3 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                            //JR_Articles 
                                            string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                            Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','125',getdate(),'1')";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            SaveToReport("Status: Final Web Delivery 3 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                            //TrnsJournalRev 
                                            Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','Final Web Delivery 3','Pending')";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            SaveToReport("Status: Upload files to Final Web Delivery file: " + Path.GetFileName(Zipname));
                                            //CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD3");
                                            if (mutiarticles == true) CreateTxtfile(Zipname, Articlemeta.Descendants("edcode").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIPNew", "FWD3", readme1);
                                            else CreateTxtfile(Zipname, Articlemeta.Descendants("edcode").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIPNew", "FWD3");
                                            //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                                        }
                                    }
                                    else
                                    {
                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=43 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                        {
                                            string Outpath = @"\\Techsetserver2\Journal\AIP\" + Articlemeta.Descendants("coden3").First().Value + @"\Articles\DataSupplied\" + Aid + @"\Final Web Delivery\Additional_correction\" + Path.GetFileName(Zipname);
                                            if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                                            File.Copy(Zipname, Outpath, true);
                                            UnZip(Zipname, Path.GetDirectoryName(Outpath));
                                            if (readme != "") File.WriteAllText(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath) + @"\readme.xml", readme);
                                            if (Path.GetFileNameWithoutExtension(Zipname).Split('_').Length > 1)
                                            {
                                                if (Directory.Exists(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath))) Directory.Move(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath).Split('_')[0]);
                                            }
                                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Web Delivery. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                                            SaveToReport("Unclosed stage Final Web Delivery: booked as additional correction. " + Path.GetFileName(Zipname));
                                            continue;
                                        }
                                        stage = "Final Web Delivery 2 Stage";
                                        string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                        Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','50','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + @"','" + AUTUStatus + "',getdate(),'1','" + Remarks + "','" + PAPFileName + @"')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Final Web Delivery 2 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                        //JR_Articles 
                                        string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','50',getdate(),'1')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Final Web Delivery 2 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                        //TrnsJournalRev 
                                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','Final Web Delivery 2','Pending')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Upload files to Final Web Delivery 2 file: " + Path.GetFileName(Zipname));
                                        //CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD2");
                                        if (mutiarticles == true) CreateTxtfile(Zipname, Articlemeta.Descendants("edcode").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIPNew", "FWD2", readme1);
                                        else CreateTxtfile(Zipname, Articlemeta.Descendants("edcode").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIPNew", "FWD2");
                                        //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                                    }
                                }
                                else
                                {
                                    string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','43','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + @"','" + AUTUStatus + "',getdate(),'1','" + Remarks + "','" + PAPFileName + @"')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Final Web Delivery update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                    //JR_Articles 
                                    string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','43',getdate(),'1')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Final Web Delivery update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                    //TrnsJournalRev 
                                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','Final Web Delivery','Pending')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Upload files to Final Web Delivery file: " + Path.GetFileName(Zipname));
                                    if (mutiarticles == true) CreateTxtfile(Zipname, Articlemeta.Descendants("edcode").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIPNew", "FWD", readme1);
                                    else CreateTxtfile(Zipname, Articlemeta.Descendants("edcode").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIPNew", "FWD");
                                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                                }
                            }
                        }

                        goto skipAIP;
                    }
                    else
                    {
                        if (XDoc.Descendants("submission_request").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").Count() > 0)
                        {
                            SendMail(Aid, "Dear Team,<Br/><Br/>New stage file received for AIP: submission_type: " + XDoc.Descendants("submission_type").First().Value + "<Br/>submission_request: " + XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() + "<Br/> Kindly check and Validate Readme XML file for new stage.", "AIP", true, XDoc.Descendants("submission_type").First().Value, Zipname);
                            SaveToReport("New stage file received for AIP: " + XDoc.Descendants("submission_type").First().Value + " " + XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() + " " + Path.GetFileName(Zipname));
                        }
                        else
                        {
                            SendMail(Aid, "Dear Team,<Br/><Br/>New stage file received for AIP: submission_type: " + XDoc.Descendants("submission_type").First().Value + "<Br/> Kindly check and Validate Readme XML file for new stage.", "AIP", true, XDoc.Descendants("submission_type").First().Value, Zipname);
                            SaveToReport("New stage file received for AIP: " + XDoc.Descendants("submission_type").First().Value + Path.GetFileName(Zipname));
                        }

                        //Move to Error
                        Clear();
                        return;
                    }
                }
                if (XDoc.Descendants("submission_type").First().Value.ToLower() != "starter")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File not booked for First Proof But received: " + XDoc.Descendants("submission_type").First().Value + " for: ", "AIP", true, stage, Zipname);
                    SaveToReport("File not booked for First Proof But received: " + XDoc.Descendants("submission_type").First().Value + " for: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                SaveToReport(@"Status: Collecting data from Readme file: 'coden3', 'edcode', 'doi', 'volume', 'issue', 'article_title', 'author[@type='corr']\name',  'author[@type='corr']\email', 'total_pages', 'total_figures', 'submission_date', 'due_date' & 'cs_type' " + Path.GetFileName(Zipname));
                XElement author = null;
                string Auname = "", Auemail = "", Doi = "", Volume = "", Issue = "", Title = "", Txtfolio = "", TxtElec = "", LineArt = "", ArtElec = "", Artwork = "", Srcby = "", Atype = "article", atypeval = "", MSid = "";
                foreach (XElement e in XDoc.Descendants("author").ToList())
                {
                    if (e.Attributes().Count() > 0 && e.Attributes("type").Count() == 1 && e.Attributes("type").First().Value == "corr")
                    {
                        author = e;
                        break;
                    }
                }
                if (XDoc.Descendants("edcode").Count() > 0) MSid = XDoc.Descendants("edcode").First().Value;
                if (XDoc.Descendants("article_type").Count() > 0) Atype = XDoc.Descendants("article_type").First().Value;
                if (XDoc.Descendants("doi").Count() > 0) Doi = XDoc.Descendants("doi").First().Value;
                if (XDoc.Descendants("volume").Count() > 0) Volume = XDoc.Descendants("volume").First().Value;
                if (XDoc.Descendants("issue").Count() > 0) Issue = XDoc.Descendants("issue").First().Value;
                if (XDoc.Descendants("article_title").Count() > 0) Title = XDoc.Descendants("article_title").First().Value;
                Title = Title.Replace(@"'", @"''");
                if (author != null)
                {
                    if (author.Elements("name").Count() > 0) Auname = author.Elements("name").First().Value;
                    if (author.Elements("email").Count() > 0) Auemail = author.Elements("email").First().Value;
                }
                Auname = Auname.Replace(@"'", @"''");
                if (XDoc.Descendants("total_pages").Count() > 0) Txtfolio = XDoc.Descendants("total_pages").First().Value;
                if (XDoc.Descendants("total_figures").Count() > 0) LineArt = XDoc.Descendants("total_figures").First().Value;
                Remarks = "JPS Workflow";
                foreach (XElement e in XDoc.XPathSelectElements(@"//comments/comment/text").ToList())
                {
                    Remarks += "<br/>" + e.Value;
                }
                if (Remarks != "") Remarks = Remarks.Replace("'", "''");
                //***
                if (XDoc.Descendants("cs_type").Count() > 0) Srcby = XDoc.Descendants("cs_type").First().Value;
                if (Srcby == "")
                {
                    string str = File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\readme.xml");
                    if (Regex.IsMatch(str.ToLower(), @"<file( [^<>]*?)? name=""([^<>]*?)\.doc(x)?""")) Srcby = "WORD";
                    else if (Regex.IsMatch(str.ToLower(), @"<file( [^<>]*?)? name=""([^<>]*?)\.pdf""")) Srcby = "PDF";
                }

                if (Txtfolio != "") TxtElec = "1";
                if (LineArt != "") { ArtElec = "1"; Artwork = "T1"; }

                //System.Net.Mail.MailMessage MM = new System.Net.Mail.MailMessage("aipjournals@novatechset.com", "rokeeffe@aip.org", "Starter file – " + Path.GetFileName(Zipname), @"<html><head></head><body><p>Dear Rich,</p><p>We have successfully received the starter file of '" + Path.GetFileName(Zipname) + @"'. Thank you.</p><p>Regards,</p>AIP Team<br>Nova Techset</div></div></body></html>");
                //MM.To.Add("xml-sgml@aip.org");
                //System.Net.Mail.MailMessage MM = new System.Net.Mail.MailMessage("aipjournals@novatechset.com", "parthiban@novatechset.com", "Starter file – " + Path.GetFileName(Zipname), @"<html><head></head><body><p>Dear Rich,</p><p>We have successfully received the starter file of '" + Path.GetFileName(Zipname) + @"'. Thank you.</p><p>Regards,</p>AIP Team<br>Nova Techset</div></div></body></html>");
                ////MM.CC.Add("aipjournals@novatechset.com");
                //MM.CC.Add("parthiban@novatechset.com");
                //MM.CC.Add("rajasekar@novatechset.com");
                ////MM.CC.Add("rajeshkannah@novatechset.com");
                //System.Net.Mail.SmtpClient client = new System.Net.Mail.SmtpClient(SerializedClass.MailServer);
                //MM.IsBodyHtml = true;
                //client.Send(MM);

                SaveToReport("Status: Booking file: " + Path.GetFileName(Zipname));
                atypeval = ReturnDetail("ArtType_ID", "ArticleTypes", Db, "ArtType_Name='" + Atype + "'");
                string AJId = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + XDoc.Descendants("coden3").First().Value + "' AND Jrnl_PublID='99'");
                if (AJId == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + XDoc.Descendants("coden3").First().Value + ": ", "AIP", true, stage, Zipname);
                    SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + XDoc.Descendants("coden3").First().Value);
                    //Move to Error
                    Clear();
                    return;
                }
                string Artcl_Status = "PE_SRV";
                if (Directory.GetFiles(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), "*.tex", SearchOption.AllDirectories).Length > 0) Artcl_Status = "PE";
                if (XDoc.Descendants("coden3").First().Value.ToLower() == "ltp") Artcl_Status = "DP";
                string suppl = "";
                if (XDoc.Descendants("epaps").Count() > 0) suppl = "1";
                //Artcl_Status = "DP";
                string book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_ArtType,Artcl_ExpFromTIDt,Artcl_DueDtCats,artcl_CEDuedate,Artcl_smartRemarks,Artcl_ManuScriptID,Artcl_PII,Artcl_Supplement) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Artcl_ScheduledDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Srcby + @"','0','" + Artcl_Status + "','" + atypeval + @"','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Sdate + @"','" + artcl_CEDuedate.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + "','" + Remarks + "','" + MSid + "','JPS_Workflow','" + suppl + "')";
                if (LineArt != "")
                {
                    book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_StatusGFX,Artcl_ArtType,Artcl_ExpFromTIDt,Artcl_DueDtCats,artcl_CEDuedate,Artcl_smartRemarks,Artcl_ManuScriptID,Artcl_PII,Artcl_Supplement) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Artcl_ScheduledDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Srcby + @"','0','" + Artcl_Status + "','GFXP','" + atypeval + @"','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Sdate + @"','" + artcl_CEDuedate.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + "','" + Remarks + "','" + MSid + "','JPS_Workflow','" + suppl + "')";
                }
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status: Update Transaction Details for file: " + Path.GetFileName(Zipname));
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Select Artcl_Id From Article WITH(NOLOCK) Where Artcl_ArticleId = '" + Aid + "'", Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                if (Db.SqlReader.Read())
                {
                    Int64 aaid = Convert.ToInt64(Db.SqlReader[0]);
                    Db.SqlReader.Close();
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, false, "AIP", Artcl_Status), Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    CreateTxtfile(Zipname, XDoc.Descendants("edcode").First().Value, XDoc.Descendants("coden3").First().Value, "AIPNew");
                    if (LineArt != "")
                    {
                        SaveToReport("Status: Update Artwork Transaction Details for file: " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, true), Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                    }
                }
            skipAIP:
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                File.Delete(Zipname);
                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "AIP", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }


        //***
        public void Book_Veruscript(string CL, string stage)
        {
            string Mailstage = "First Proof Stage";
            DBClass Db = new DBClass();
            try
            {
                XDocument XDoc = new XDocument();
                SaveToReport("Status: Validating XML file: " + Path.GetFileName(Zipname));
                string[] name = Path.GetFileNameWithoutExtension(Zipname).ToString().Split('_');
                if (File.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + name[0] + @".xml"))
                {
                    try
                    {
                        XDoc = XDocument.Parse(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + name[0] + @".xml"), LoadOptions.PreserveWhitespace);
                    }
                    catch (Exception e)
                    {
                        SaveToReport("XML file is not valid for:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                        Clear();
                        //Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                        return;
                    }

                }
                else if (File.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + name[0] + @".xml"))
                {
                    try
                    {
                        XDoc = XDocument.Parse(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + name[0] + @".xml"), LoadOptions.PreserveWhitespace);
                    }
                    catch (Exception e)
                    {
                        SaveToReport("XML file is not valid for:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                        Clear();
                        //Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                        return;
                    }

                }
                else
                {
                    SaveToReport("XML file missing for:  " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }

                SaveToReport(@"Status: Collecting data from Readme file: 'journal-id[@journal-id-type='publisher']', 'article-id[@pub-id-type='manuscript']','article-id[@pub-id-type='doi']', 'article_title', 'contrib[@corresp='yes']\name',  'contrib[@corresp='yes']\email', 'due_date' & 'floats-group\\table-wrap' " + Path.GetFileName(Zipname));
                XElement author = null;
                string Auname = "", Auemail = "", Aid = "", Doi = "", Volume = "", Issue = "", Title = "", Txtfolio = "", TxtElec = "", LineArt = "", ArtElec = "", Artwork = "", Srcby = "", pubacro = "", txttab = "", Atype = "article", atypeval = "";
                DateTime Sdate = CalculateDueDate("VeruScript", Db, DateTime.Today);

                try
                {
                    Atype = XDoc.Root.Attributes("article-type").First().Value;
                }
                catch (Exception e) { Atype = "article"; }
                foreach (XElement e in XDoc.Descendants("contrib").ToList())
                {
                    if (e.Attributes().Count() > 0 && e.Attributes("corresp").Count() == 1 && e.Attributes("corresp").First().Value == "yes")
                    {
                        author = e;
                        break;
                    }
                }
                foreach (XElement e in XDoc.Descendants("journal-id").ToList())
                {
                    if (e.Attributes().Count() > 0 && e.Attributes("journal-id-type").Count() == 1 && e.Attributes("journal-id-type").First().Value == "publisher")
                    {
                        pubacro = e.Value;
                        break;
                    }
                }
                foreach (XElement e in XDoc.Descendants("article-id").ToList())
                {
                    if (e.Attributes().Count() > 0 && e.Attributes("pub-id-type").Count() == 1 && e.Attributes("pub-id-type").First().Value == "doi")
                    {
                        Doi = e.Value;
                    }
                    else if (e.Attributes().Count() > 0 && e.Attributes("pub-id-type").Count() == 1 && e.Attributes("pub-id-type").First().Value == "manuscript")
                    {
                        Aid = e.Value;
                    }
                }
                //if (XDoc.Descendants("volume").Count() > 0) Volume = XDoc.Descendants("volume").First().Value;
                //if (XDoc.Descendants("issue").Count() > 0) Issue = XDoc.Descendants("issue").First().Value;
                if (XDoc.Descendants("article-title").Count() > 0) Title = XDoc.Descendants("article-title").First().Value;
                if (author != null)
                {
                    if (author.Elements("name").Count() > 0) Auname = author.Elements("name").First().Value;
                    if (author.Elements("email").Count() > 0) Auemail = author.Elements("email").First().Value;
                }
                //if (XDoc.Descendants("total_pages").Count() > 0) Txtfolio = XDoc.Descendants("total_pages").First().Value;
                //if (XDoc.Descendants("total_figures").Count() > 0) LineArt = XDoc.Descendants("total_figures").First().Value; 
                if (XDoc.Descendants("floats-group").Count() > 0 && XDoc.Descendants("floats-group").First().Descendants("fig").Count() > 0) LineArt = XDoc.Descendants("floats-group").First().Descendants("fig").Count().ToString();
                if (XDoc.Descendants("floats-group").Count() > 0 && XDoc.Descendants("floats-group").First().Descendants("table-wrap").Count() > 0) txttab = XDoc.Descendants("floats-group").First().Descendants("table-wrap").Count().ToString();
                //if (XDoc.Descendants("history").Count() > 0)
                //{
                //    foreach (XElement e in XDoc.Descendants("history").First().Descendants("date").ToList())
                //    {
                //        if (e.Attributes().Count() > 0 && e.Attributes("date-type").Count() == 1 && e.Attributes("date-type").First().Value == "accepted")
                //        {
                //            Sdate =  e.Elements("month").First().Value + "-" + e.Elements("day").First().Value + "-" + e.Elements("year").First().Value ;
                //        }
                //    }
                //}
                //if (XDoc.Descendants("received_date").Count() > 0) Rdate = XDoc.Descendants("received_date").First().Value;
                //if (XDoc.Descendants("due_date").Count() > 0) Sdate = XDoc.Descendants("due_date").First().Value;
                //if (XDoc.Descendants("cs_type").Count() > 0) Srcby = XDoc.Descendants("cs_type").First().Value;

                SaveToReport("Status: Validating against Booked Records: " + Path.GetFileName(Zipname));
                if (Aid == "")
                {
                    SaveToReport("'aipid' article id missing in Readme xml file: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                if (pubacro == "")
                {
                    SaveToReport("'journal-id@[journal-id-type='publisher']' missing in xml file: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                ////Aid = pubacro + Aid;
                //if (CheckWhetherFileBooked(Aid))
                //{
                //    SaveToReport("File already booked: " + Path.GetFileName(Zipname));
                //    //Move to Error
                //    Clear();
                //    return;
                //}

                if (CheckWhetherFileBooked(Aid))
                {
                    if (stage == "FP")
                    {
                        SaveToReport("File already booked for First Proof: " + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    else if (stage == "AC")
                    {
                        Mailstage = "Author Correction Stage";
                        string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                        if (uploaddate == "" || CheckWhetherFileBooked(Aid, "AC"))
                        {
                            SaveToReport("File already booked for Author Correction: " + Path.GetFileName(Zipname));
                            //Move to Error
                            Clear();
                            return;
                        }
                        SaveToReport("Status: Author Correction update JR_Main Table file: " + Path.GetFileName(Zipname));
                        // Author Correction   
                        //JR_Main                          
                        string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + pubacro + "' AND Jrnl_PublID='98'");
                        string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                        string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: Author Correction update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                        //JR_Stage_Tran                           
                        string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                        Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','35',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','15',getdate(),'1','')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: Author Correction update JR_Articles Table file: " + Path.GetFileName(Zipname));
                        //JR_Articles 
                        string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','15','35',getdate(),'1')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: Author Correction update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                        //TrnsJournalRev 
                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','15',getdate(),'1','AU Correction','Pending')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: Author Correction update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                        //Article 
                        Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        //Transaction TrnsJournal                             
                        string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                        string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                        Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: Upload files to Author Correction file: " + Path.GetFileName(Zipname));
                        CreateTxtfile(Zipname, Aid, pubacro, "Veruscript", "AC");
                        goto skipVS;
                    }
                    else
                    {
                        SendMail(Aid, "New status update for Veruscript: " + XDoc.Descendants("submission_type").First().Value, "VeruScript", true, "New stage", Zipname);
                        SaveToReport("New status update for Veruscript: " + XDoc.Descendants("submission_type").First().Value + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                }
                /*SELECT * FROM Publishers where Publ_Acronym= 'AIP'
SELECT Jrnl_Id from Journal where Jrnl_Acronym='JVB' AND Jrnl_PublID='99'*/
                SaveToReport("Status: Booking file: " + Path.GetFileName(Zipname));
                //string condition = @"SELECT ArtType_ID FROM ArticleTypes WHERE ArtType_Name='" + Atype + "'";
                //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(condition, Db.GetConnection());
                //Db.OpenConnection();
                //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                //if (Db.SqlReader.Read() == true)
                //{
                //    atypeval = Db.SqlReader["ArtType_ID"].ToString();
                //}
                //Db.SqlReader.Close();
                //Db.CloseConnection();
                atypeval = ReturnDetail("ArtType_ID", "ArticleTypes", Db, "ArtType_Name='" + Atype + "'");
                //condition = @"SELECT Jrnl_Id from Journal where Jrnl_Acronym='" + pubacro + "' AND Jrnl_PublID='98'";
                //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(condition, Db.GetConnection());
                //Db.OpenConnection();
                //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                //string AJId = "";
                //if (Db.SqlReader.Read() == true)
                //{
                //    AJId = Db.SqlReader["Jrnl_Id"].ToString();
                //}
                //Db.SqlReader.Close();
                //Db.CloseConnection();
                string AJId = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + pubacro + "' AND Jrnl_PublID='98'");
                if (AJId == "")
                {
                    SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + pubacro);
                    //Move to Error
                    Clear();
                    return;
                }
                if (Txtfolio != "") TxtElec = "1";
                if (LineArt != "") { ArtElec = "1"; Artwork = "T1"; }
                //string book = @"insert into Testing_Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_TextTables,Artcl_FolderCreated,Artcl_Status) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "',getdate(),'" + Convert.ToDateTime(Sdate) + @"','" + txttab + @"','0','PT')";                          
                //   Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book, Db.GetConnection());
                //   Db.OpenConnection();
                //   Db.SqlReader = Db.SqlCmd.ExecuteReader();
                //   Db.SqlReader.Close();
                //   SaveToReport("Status: Update Transaction Details for file: " + Path.GetFileName(Zipname));
                //   Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Select Artcl_Id From Testing_Article WITH(NOLOCK) Where Artcl_ArticleId = '" + Aid + "'", Db.GetConnection());
                //   Db.OpenConnection();
                //   Db.SqlReader = Db.SqlCmd.ExecuteReader();
                //   if (Db.SqlReader.Read())
                //   {
                //       Int64 aaid = Convert.ToInt64(Db.SqlReader[0]);
                //       Db.SqlReader.Close();
                //       Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid), Db.GetConnection());
                //       Db.OpenConnection();
                //       Db.SqlReader = Db.SqlCmd.ExecuteReader();
                //       Db.SqlReader.Close();
                //   }
                //string book = @"insert into Testing_Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_TextTables,Artcl_FolderCreated,Artcl_Status) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "',getdate(),'" + Convert.ToDateTime(Sdate) + @"','" + txttab + @"','0','PT')";
                //if (LineArt != "")
                //{
                //    book = @"insert into Testing_Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_TextTables,Artcl_FolderCreated,Artcl_Status,Artcl_StatusGFX) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "',getdate(),'" + Convert.ToDateTime(Sdate) + @"','" + txttab + @"','0','PT','GFXP')";
                //}

                string book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_TextTables,Artcl_FolderCreated,Artcl_Status,Artcl_ArtType) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "',getdate(), CONVERT(datetime,'" + Sdate.ToString("yyyy-MM-dd hh:mm:ss") + @"',20),'" + txttab + @"','0','PT','" + atypeval + @"')";
                if (LineArt != "")
                {
                    book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_TextTables,Artcl_FolderCreated,Artcl_Status,Artcl_StatusGFX,Artcl_ArtType) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "',getdate(),CONVERT(datetime,'" + Sdate.ToString("yyyy-MM-dd hh:mm:ss") + @"',20),'" + txttab + @"','0','PT','GFXP','" + atypeval + @"')";
                }
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status: Update Transaction Details for file: " + Path.GetFileName(Zipname));
                //Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Select Artcl_Id From Testing_Article WITH(NOLOCK) Where Artcl_ArticleId = '" + Aid + "'", Db.GetConnection());
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Select Artcl_Id From Article WITH(NOLOCK) Where Artcl_ArticleId = '" + Aid + "'", Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                if (Db.SqlReader.Read())
                {
                    Int64 aaid = Convert.ToInt64(Db.SqlReader[0]);
                    Db.SqlReader.Close();
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid), Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    CreateTxtfile(Zipname, Aid, pubacro, "Veruscript");
                    if (LineArt != "")
                    {
                        SaveToReport("Status: Update Artwork Transaction Details for file: " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, true, "VeruScript"), Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                    }
                }
            skipVS:
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date) == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date);
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileName(Zipname), true);
                File.Delete(Zipname);
                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "VeruScript", false, Mailstage);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }
        //***
        public void Book_ASCE(string CL, string stage = "FP")
        {
            DBClass Db = new DBClass();
            string Aid = Path.GetFileNameWithoutExtension(Zipname), JAC = Path.GetFileNameWithoutExtension(Zipname).Split('-')[0];
            try
            {
                if (CheckWhetherFileBooked(Aid))
                {
                    SendMail(Aid, "Dear Team,<Br/><Br/>File already booked for First Proof: " + Path.GetFileName(Zipname), "ASCE", true, "First Proof Stage");
                    SaveToReport("File already booked for First Proof: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                string Atype = "article", atypeval = "";
                DateTime Sdate = CalculateDueDate("ASCE", Db, DateTime.Today);
                SaveToReport("Status: Booking file: " + Path.GetFileName(Zipname));
                atypeval = ReturnDetail("ArtType_ID", "ArticleTypes", Db, "ArtType_Name='" + Atype + "'");
                string AJId = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + JAC + "' AND Jrnl_PublID='101'");
                if (AJId == "")
                {
                    SendMail(Aid, "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + JAC + " " + Path.GetFileName(Zipname), "ASCE", true, "First Proof Stage");
                    SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + JAC);
                    //Move to Error
                    Clear();
                    return;
                }
                string book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_Title,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_Status,Artcl_ArtType) values('" + AJId + @"','" + Aid + @"','" + Aid + @"',getdate(),CONVERT(datetime,'" + Sdate.ToString("yyyy-MM-dd hh:mm:ss") + @"'),'PE','" + atypeval + @"')";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status: Update Transaction Details for file: " + Path.GetFileName(Zipname));
                //Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Select Artcl_Id From Testing_Article WITH(NOLOCK) Where Artcl_ArticleId = '" + Aid + "'", Db.GetConnection());
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Select Artcl_Id From Article WITH(NOLOCK) Where Artcl_ArticleId = '" + Aid + "'", Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                if (Db.SqlReader.Read())
                {
                    Int64 aaid = Convert.ToInt64(Db.SqlReader[0]);
                    Db.SqlReader.Close();
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid), Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    try
                    {
                        string Outpath = @"\\Techsetserver2\Journal\ASCE\" + JAC + @"\Articles\DataSupplied\" + Path.GetFileName(Zipname);
                        //string folderPath = Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath);
                        File.Copy(Zipname, Outpath, true);
                        //if (!Directory.Exists(folderPath)) Directory.CreateDirectory(folderPath);
                        //Shell32.Shell objShell = new Shell32.Shell();
                        //Shell32.Folder destinationFolder = objShell.NameSpace(folderPath);
                        //Shell32.Folder sourceFile = objShell.NameSpace(Outpath);
                        //foreach (var file in sourceFile.Items())
                        //{
                        //    destinationFolder.CopyHere(file, 4 | 16);
                        //}
                        UnZip(Zipname, Path.GetDirectoryName(Outpath));
                    }
                    catch (Exception e)
                    {
                        SendMail(Aid, e.Message + "<Br/>" + e.StackTrace, "ASCE", true, "First Proof Stage", Zipname);
                        SaveToReport(@"Error while creating file: \\Techsetserver2\Journal\ASCE\" + JAC + @"\Articles\DataSupplied\" + "\n" + e.Message + "\n" + e.StackTrace);
                        Clear();
                    }
                }
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                File.Delete(Zipname);
                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "ASCE", false, "First Proof Stage");
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                SendMail(Aid, e.Message + "<Br/>" + e.StackTrace, "ASCE", true, "First Proof Stage");
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }
        //***     
        //***
        public void Book_OSA(string CL)
        {
            string stage = "First Proof Stage";
            DBClass Db = new DBClass();
            string Aid = ""; string JAC = ""; bool txt = false; string msno = "";
            try
            {
                XDocument XDoc = new XDocument();
                SaveToReport("Status: Validating extyles xml file: " + Path.GetFileName(Zipname));
                if (File.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\extyles-" + Path.GetFileNameWithoutExtension(Zipname) + ".xml"))
                {
                    try
                    {
                        XDoc = XDocument.Parse(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\extyles-" + Path.GetFileNameWithoutExtension(Zipname) + ".xml"), LoadOptions.PreserveWhitespace);
                    }
                    catch (Exception e)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>extyles-" + Path.GetFileNameWithoutExtension(Zipname) + ".xml file is not valid for OSA: ", "OSA", true, stage, Zipname);
                        SaveToReport("extyles-" + Path.GetFileNameWithoutExtension(Zipname) + ".XML file is not valid for:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                        Clear();
                        return;
                    }

                }
                else if (File.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".txt"))
                {
                    try
                    {
                        txt = true;
                        XDoc = XDocument.Parse(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".txt").Replace("\r", "").Replace("\n", ""), LoadOptions.PreserveWhitespace);
                    }
                    catch (Exception e)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>" + Path.GetFileNameWithoutExtension(Zipname) + ".txt file is not valid for OSA: ", "OSA", true, stage, Zipname);
                        SaveToReport("extyles-" + Path.GetFileNameWithoutExtension(Zipname) + ".XML file is not valid for:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                        Clear();
                        return;
                    }

                }
                else
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>extyles-" + Path.GetFileNameWithoutExtension(Zipname) + ".xml file missing for OSA: ", "OSA", true, stage, Zipname);
                    SaveToReport("extyles-" + Path.GetFileNameWithoutExtension(Zipname) + ".xml file missing for:  " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
                SaveToReport("Status: Validating against Booked Records: " + Path.GetFileName(Zipname));
                IEnumerable<XElement> list1 = ((IEnumerable)XDoc.XPathEvaluate("//article-id[@pub-id-type='publisher-id']")).Cast<XElement>();
                IEnumerable<XElement> list1a = ((IEnumerable)XDoc.XPathEvaluate("//msnumber")).Cast<XElement>();
                //IEnumerable<XElement> listq = from el in XDoc.Descendants("article-id") where (string)el.Attribute("pub-id-type") == "publisher-id" select el;  
                if (list1.ToList().Count() == 0 && list1a.ToList().Count() == 0)
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>article id missing for OSA: ", "OSA", true, stage, Zipname);
                    SaveToReport("article id missing for OSA: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                IEnumerable<XElement> list2 = ((IEnumerable)XDoc.XPathEvaluate("//journal-id[@journal-id-type='publisher-id']")).Cast<XElement>();
                IEnumerable<XElement> list2a = ((IEnumerable)XDoc.XPathEvaluate("//jtitle")).Cast<XElement>();
                if (list2.ToList().Count() == 0 && list2a.ToList().Count() == 0)
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'journal acronym' missing for OSA: ", "OSA", true, stage, Zipname);
                    SaveToReport("'journal acronym' missing for OSA:: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                if (txt)
                {
                    Aid = list1a.First().Value;
                    JAC = list2a.First().Value;
                    if (JAC.ToLower() == "optical materials express") JAC = "OME";
                    else if (JAC.ToLower() == "osa continuum") JAC = "OSAC";
                    else if (JAC.ToLower() == "optics express") JAC = "OE";
                    else if (JAC.ToLower() == "biomedical optics express") JAC = "BOE";
                }
                else
                {
                    Aid = list1.First().Value;
                    JAC = list2.First().Value;
                }

                if (!Aid.Contains(JAC))
                {
                    msno = Aid;
                    Aid = JAC + Aid;
                }
                string Rdate = "", Sdate = "";
                //if (XDoc.Descendants("submission_date").Count() > 0) Rdate = XDoc.Descendants("submission_date").First().Value;
                //if (XDoc.Descendants("due_date").Count() > 0) Sdate = XDoc.Descendants("due_date").First().Value;
                //DateTime Artcl_ExpFromTIDt = new DateTime();
                //DateTime Artcl_ScheduledDt = new DateTime();
                //DateTime artcl_CEDuedate = new DateTime();
                //if (Sdate != "")
                //{
                //    var culture = System.Globalization.CultureInfo.InvariantCulture;
                //    DateTime ddate = DateTime.ParseExact(Sdate, "MM/dd/yyyy HH:mm:ss", culture);
                //    Artcl_ExpFromTIDt = CalculateAIPExpFromTIDt("AIP", Db, ddate);
                //    Artcl_ScheduledDt = Artcl_ExpFromTIDt;
                //    Artcl_ExpFromTIDt = CalculateAIPExpFromTIDt("AIP", Db, Artcl_ExpFromTIDt);
                //    if (Rdate != "" && XDoc.Descendants("submission_type").First().Value.ToLower() == "starter")
                //    {
                //        culture = System.Globalization.CultureInfo.InvariantCulture;
                //        DateTime ddate1 = DateTime.ParseExact(Rdate, "MM/dd/yyyy HH:mm:ss", culture);
                //        double days = Math.Round(ReturnDays(ddate1, Db, Artcl_ScheduledDt) * 0.6);
                //        artcl_CEDuedate = CalculateDueDate("", Db, AddDays(ddate1, Db, Convert.ToInt16(days)));
                //    }
                //}

                if (CheckWhetherFileBooked(Aid))
                {
                    if (ReturnDetail("Artcl_Status", "Article", Db, "Artcl_ArticleId='" + Aid + "'") == "Hold")
                    { Book_OSA_revises(CL); return; }
                    SendMail(Aid, "Dear Team,<Br/><Br/>File already booked for First Proof: " + Path.GetFileName(Zipname), "OSA", true, "First Proof Stage");
                    SaveToReport("File already booked for First Proof: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                string Atype = "article", atypeval = "";
                if (txt)
                {
                    try
                    {
                        Atype = XDoc.Descendants("arttype").First().Attributes("type").First().Value;
                    }
                    catch (Exception e) { Atype = "article"; }
                }
                else
                {
                    try
                    {
                        Atype = XDoc.Root.Attributes("article-type").First().Value;
                    }
                    catch (Exception e) { Atype = "article"; }
                }
                SaveToReport("Status: Booking file: " + Path.GetFileName(Zipname));
                atypeval = ReturnDetail("ArtType_ID", "ArticleTypes", Db, "ArtType_Name='" + Atype + "'");
                string AJId = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + JAC + "' AND Jrnl_PublID='105'");
                if (AJId == "")
                {
                    SendMail(Aid, "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + JAC + " " + Path.GetFileName(Zipname), "OSA", true, "First Proof Stage");
                    SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + JAC);
                    //Move to Error
                    Clear();
                    return;
                }
                string Doi = "", Volume = "", Issue = "", Title = "", Srcby = "Latex";
                if (((IEnumerable)XDoc.XPathEvaluate("//article-id[@pub-id-type='doi']")).Cast<XElement>().ToList().Count() > 0) Doi = ((IEnumerable)XDoc.XPathEvaluate("//article-id[@pub-id-type='doi']")).Cast<XElement>().First().Value;
                //if (txt && ((IEnumerable)XDoc.XPathEvaluate("//named-content[@content-type='doi']")).Cast<XElement>().ToList().Count() > 0) Doi = ((IEnumerable)XDoc.XPathEvaluate("//named-content[@content-type='doi']")).Cast<XElement>().First().Value;
                if (XDoc.Descendants("volume").Count() > 0) Volume = XDoc.Descendants("volume").First().Value;
                if (XDoc.Descendants("issue").Count() > 0) Issue = XDoc.Descendants("issue").First().Value;
                if (XDoc.Descendants("article-title").Count() > 0) Title = XDoc.Descendants("article-title").First().Value;
                if (txt && XDoc.Descendants("title").Count() > 0) Title = XDoc.Descendants("title").First().Value;
                Title = Title.Replace(@"'", @"''");
                if (Directory.GetFiles(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), "*.doc*", SearchOption.AllDirectories).Length > 0) Srcby = "Word";
                //if (author != null)
                //{
                //    if (author.Elements("name").Count() > 0) Auname = author.Elements("name").First().Value;
                //    if (author.Elements("email").Count() > 0) Auemail = author.Elements("email").First().Value;
                //}
                //if (XDoc.Descendants("total_pages").Count() > 0) Txtfolio = XDoc.Descendants("total_pages").First().Value;
                //if (XDoc.Descendants("total_figures").Count() > 0) LineArt = XDoc.Descendants("total_figures").First().Value;

                //if (XDoc.Descendants("submission_date").Count() > 0) Rdate = XDoc.Descendants("submission_date").First().Value;
                //if (XDoc.Descendants("due_date").Count() > 0) Sdate = XDoc.Descendants("due_date").First().Value;

                //if (XDoc.Descendants("cs_type").Count() > 0) Srcby = XDoc.Descendants("cs_type").First().Value;
                //if (Txtfolio != "") TxtElec = "1";
                //if (LineArt != "") { ArtElec = "1"; Artwork = "T1"; }                  
                SaveToReport("Status: Booking file: " + Path.GetFileName(Zipname));
                string Artcl_Status = "DP";
                //string book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_ArtType,Artcl_ExpFromTIDt,Artcl_DueDtCats,artcl_CEDuedate) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Artcl_ScheduledDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Srcby + @"','0','" + Artcl_Status + "','" + atypeval + @"','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Sdate + @"','" + artcl_CEDuedate.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + "')";
                //if (LineArt != "")
                //{
                //    book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_StatusGFX,Artcl_ArtType,Artcl_ExpFromTIDt,Artcl_DueDtCats,artcl_CEDuedate) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Artcl_ScheduledDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Srcby + @"','0','" + Artcl_Status + "','GFXP','" + atypeval + @"','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Sdate + @"','" + artcl_CEDuedate.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + "')";
                //}
                //Sdate = DateTime.Now.ToString("MM/dd/yyyy HH:mm:ss");
                //string Sdate1 = DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss");
                //var culture = System.Globalization.CultureInfo.InvariantCulture;
                //DateTime ddate = DateTime.ParseExact(Sdate1.Replace('-', '/'), "MM/dd/yyyy HH:mm:ss", culture);
                string book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_FolderCreated,Artcl_Status,Artcl_ArtType,Artcl_ExpFromTIDt,Artcl_ManuScriptID,artcl_SourceBy) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + DateTime.Now.ToString("MM/dd/yyyy HH:mm:ss").Replace('-', '/') + "','" + CalculateDueDate("", Db, AddDays(DateTime.Now, Db, 2)).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + "','0','" + Artcl_Status + "','" + atypeval + "','" + CalculateDueDate("", Db, AddDays(DateTime.Now, Db, 2)).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + "','" + msno + "','" + Srcby + "')";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status: Update Transaction Details for file: " + Path.GetFileName(Zipname));
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Select Artcl_Id From Article WITH(NOLOCK) Where Artcl_ArticleId = '" + Aid + "'", Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                if (Db.SqlReader.Read())
                {
                    Int64 aaid = Convert.ToInt64(Db.SqlReader[0]);
                    Db.SqlReader.Close();
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, false, "OSA", Artcl_Status), Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, true, "OSA", Artcl_Status), Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    if (txt) CreateTxtfile(Zipname, list1a.First().Value, JAC, "OSA");
                    else CreateTxtfile(Zipname, list1.First().Value, JAC, "OSA");
                    //if (folderPath.ToUpper().Contains(@"/OSA/"))
                    //{
                    //    foreach (string f in Directory.GetFiles(folderPath, "*.txt", SearchOption.TopDirectoryOnly))
                    //    {

                    if (txt)
                    {
                        File.Copy(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".txt", Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".XML", true);
                        File.Copy(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".XML", @"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(Zipname) + @".XML", true);
                        File.WriteAllText(@"D:\WatchTXT\" + Aid + @"xml.txt", @"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(Zipname) + ".XML" + @"~\\Techsetserver2\Journal\OSA\" + JAC + @"\Articles\DataSupplied\" + Aid + @"\First Proof\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @".XML");
                    }
                    try
                    {
                        ProcessStartInfo p = new ProcessStartInfo();
                        p.FileName = @"""\\techsetserver1\Software\OSA\OSA_META_VIEWER.exe""";
                        p.Arguments = @"""" + Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".XML" + @"""";
                        Process P1 = Process.Start(p);
                        P1.WaitForExit();
                    }
                    catch (Exception e1)
                    {
                        SendMail(Path.GetFileNameWithoutExtension(Zipname), e1.Message + "\n" + e1.StackTrace, "OSA", true, "OSAHIT");
                    }
                    if (File.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".html"))
                    {
                        try
                        {
                            using (WebClient client = new WebClient())
                            {
                                client.Credentials = new NetworkCredential("osaxml", "Osxm@123");
                                client.UploadFile("ftp://13.232.100.10/" + Aid + @".html", WebRequestMethods.Ftp.UploadFile, Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".html");
                                File.Copy(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".html", @"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(Zipname) + @".html", true);
                                File.WriteAllText(@"D:\WatchTXT\" + Aid + @"html.txt", @"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(Zipname) + ".html" + @"~\\Techsetserver2\Journal\OSA\" + JAC + @"\Articles\DataSupplied\" + Aid + @"\First Proof\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @".html");
                            }
                        }
                        catch (Exception e2)
                        {
                            SendMail(Path.GetFileNameWithoutExtension(Zipname), e2.Message + "\n" + e2.StackTrace, "OSA", true, "OSAHIT");
                        }
                    }
                    //    }
                    //}
                    //if (LineArt != "")
                    //{
                    //    SaveToReport("Status: Update Artwork Transaction Details for file: " + Path.GetFileName(Zipname));
                    //    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, true), Db.GetConnection());
                    //    Db.OpenConnection();
                    //    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    //    Db.SqlReader.Close();
                    //}
                }
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                File.Delete(Zipname);
                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "OSA", false, stage);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "OSA", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }

        public void Book_OSA_revises(string CL)
        {
            string stage = "First Proof Stage";
            DBClass Db = new DBClass();
            string Aid = ""; string JAC = ""; bool txt = false; string msno = "";
            try
            {
                XDocument XDoc = new XDocument();
                SaveToReport("Status: Validating extyles xml file: " + Path.GetFileName(Zipname));
                if (File.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\extyles-" + Path.GetFileNameWithoutExtension(Zipname) + ".xml"))
                {
                    try
                    {
                        XDoc = XDocument.Parse(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\extyles-" + Path.GetFileNameWithoutExtension(Zipname) + ".xml"), LoadOptions.PreserveWhitespace);
                    }
                    catch (Exception e)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>extyles-" + Path.GetFileNameWithoutExtension(Zipname) + ".xml file is not valid for OSA: ", "OSA", true, stage, Zipname);
                        SaveToReport("extyles-" + Path.GetFileNameWithoutExtension(Zipname) + ".XML file is not valid for:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                        Clear();
                        return;
                    }

                }
                else if (File.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".txt"))
                {
                    try
                    {
                        txt = true;
                        XDoc = XDocument.Parse(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".txt").Replace("\r", "").Replace("\n", ""), LoadOptions.PreserveWhitespace);
                    }
                    catch (Exception e)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>" + Path.GetFileNameWithoutExtension(Zipname) + ".txt file is not valid for OSA: ", "OSA", true, stage, Zipname);
                        SaveToReport("extyles-" + Path.GetFileNameWithoutExtension(Zipname) + ".XML file is not valid for:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                        Clear();
                        return;
                    }

                }
                else
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>extyles-" + Path.GetFileNameWithoutExtension(Zipname) + ".xml file missing for OSA: ", "OSA", true, stage, Zipname);
                    SaveToReport("extyles-" + Path.GetFileNameWithoutExtension(Zipname) + ".xml file missing for:  " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
                SaveToReport("Status: Validating against Booked Records: " + Path.GetFileName(Zipname));
                IEnumerable<XElement> list1 = ((IEnumerable)XDoc.XPathEvaluate("//article-id[@pub-id-type='publisher-id']")).Cast<XElement>();
                IEnumerable<XElement> list1a = ((IEnumerable)XDoc.XPathEvaluate("//msnumber")).Cast<XElement>();
                //IEnumerable<XElement> listq = from el in XDoc.Descendants("article-id") where (string)el.Attribute("pub-id-type") == "publisher-id" select el;  
                if (list1.ToList().Count() == 0 && list1a.ToList().Count() == 0)
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>article id missing for OSA: ", "OSA", true, stage, Zipname);
                    SaveToReport("article id missing for OSA: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                IEnumerable<XElement> list2 = ((IEnumerable)XDoc.XPathEvaluate("//journal-id[@journal-id-type='publisher-id']")).Cast<XElement>();
                IEnumerable<XElement> list2a = ((IEnumerable)XDoc.XPathEvaluate("//jtitle")).Cast<XElement>();
                if (list2.ToList().Count() == 0 && list2a.ToList().Count() == 0)
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'journal acronym' missing for OSA: ", "OSA", true, stage, Zipname);
                    SaveToReport("'journal acronym' missing for OSA:: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                if (txt)
                {
                    Aid = list1a.First().Value;
                    JAC = list2a.First().Value;
                    if (JAC.ToLower() == "optical materials express") JAC = "OME";
                    else if (JAC.ToLower() == "osa continuum") JAC = "OSAC";
                }
                else
                {
                    Aid = list1.First().Value;
                    JAC = list2.First().Value;
                }

                if (!Aid.Contains(JAC))
                {
                    msno = Aid;
                    Aid = JAC + Aid;
                }
                string Atype = "article", atypeval = "";
                if (txt)
                {
                    try
                    {
                        Atype = XDoc.Descendants("arttype").First().Attributes("type").First().Value;
                    }
                    catch (Exception e) { Atype = "article"; }
                }
                else
                {
                    try
                    {
                        Atype = XDoc.Root.Attributes("article-type").First().Value;
                    }
                    catch (Exception e) { Atype = "article"; }
                }
                SaveToReport("Status: Booking revised file: " + Path.GetFileName(Zipname));
                atypeval = ReturnDetail("ArtType_ID", "ArticleTypes", Db, "ArtType_Name='" + Atype + "'");
                string AJId = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + JAC + "' AND Jrnl_PublID='105'");
                if (AJId == "")
                {
                    SendMail(Aid, "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + JAC + " " + Path.GetFileName(Zipname), "OSA", true, "First Proof Stage");
                    SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + JAC);
                    //Move to Error
                    Clear();
                    return;
                }
                string Doi = "", Volume = "", Issue = "", Title = "", Srcby = "Latex";
                if (((IEnumerable)XDoc.XPathEvaluate("//article-id[@pub-id-type='doi']")).Cast<XElement>().ToList().Count() > 0) Doi = ((IEnumerable)XDoc.XPathEvaluate("//article-id[@pub-id-type='doi']")).Cast<XElement>().First().Value;
                if (XDoc.Descendants("volume").Count() > 0) Volume = XDoc.Descendants("volume").First().Value;
                if (XDoc.Descendants("issue").Count() > 0) Issue = XDoc.Descendants("issue").First().Value;
                if (XDoc.Descendants("article-title").Count() > 0) Title = XDoc.Descendants("article-title").First().Value;
                if (txt && XDoc.Descendants("title").Count() > 0) Title = XDoc.Descendants("title").First().Value;
                Title = Title.Replace(@"'", @"''");
                if (Directory.GetFiles(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), "*.doc*", SearchOption.AllDirectories).Length > 0) Srcby = "Word";
                SaveToReport("Status: Booking file: " + Path.GetFileName(Zipname));
                string Artcl_Status = "DP";
                string book = @"update Article set Artcl_JrnlId='" + AJId + @"', Artcl_ArticleId='" + Aid + @"',Artcl_DOI= '" + Doi + @"',Artcl_Volume='" + Volume + @"',Artcl_Issue='" + Issue + @"',Artcl_Title='" + Title + @"',Artcl_ReceivedDt='" + DateTime.Now.ToString("MM/dd/yyyy HH:mm:ss").Replace('-', '/') + @"',Artcl_ScheduledDt='" + CalculateDueDate("", Db, AddDays(DateTime.Now, Db, 2)).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"',Artcl_FolderCreated='1',Artcl_Status='" + Artcl_Status + @"',Artcl_ArtType='" + atypeval + @"',Artcl_ExpFromTIDt='" + CalculateDueDate("", Db, AddDays(DateTime.Now, Db, 2)).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"',Artcl_ManuScriptID='" + msno + @"', artcl_SourceBy='" + Srcby + @"' where Artcl_ArticleId='" + Aid + @"'";

                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status: Update Transaction Details for file: " + Path.GetFileName(Zipname));
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Select Artcl_Id From Article WITH(NOLOCK) Where Artcl_ArticleId = '" + Aid + "'", Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                if (Db.SqlReader.Read())
                {
                    Int64 aaid = Convert.ToInt64(Db.SqlReader[0]);
                    Db.SqlReader.Close();
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Insert into TrnsJournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) values(" + @"'" + aaid + @"','1','Admin',getdate(),getdate(),'36','Completed','20','Article','New Source file received from customer.',getdate(),1,'Pending')", Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    if (txt)
                    {
                        if (Directory.Exists(@"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1a.First().Value + @"\First Proof\" + Path.GetFileNameWithoutExtension(Zipname)))
                        {
                            if (!Directory.Exists(@"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1a.First().Value + @"\First Proof\Old\" + Path.GetFileNameWithoutExtension(Zipname) + @"\")) Directory.CreateDirectory(@"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1a.First().Value + @"\First Proof\Old\" + Path.GetFileNameWithoutExtension(Zipname) + @"\");
                            //Directory.Move(@"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1a.First().Value + @"\First Proof\" + Path.GetFileNameWithoutExtension(Zipname),@"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1a.First().Value + @"\Old\");
                            CopyFilesRecursively(new DirectoryInfo(@"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1a.First().Value + @"\First Proof\" + Path.GetFileNameWithoutExtension(Zipname) + @"\"), new DirectoryInfo(@"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1a.First().Value + @"\First Proof\Old\" + Path.GetFileNameWithoutExtension(Zipname) + @"\"));
                            Directory.Delete(@"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1a.First().Value + @"\First Proof\" + Path.GetFileNameWithoutExtension(Zipname) + @"\", true);
                            File.Copy(@"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1a.First().Value + @"\First Proof\" + Path.GetFileName(Zipname), @"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1a.First().Value + @"\First Proof\Old\" + Path.GetFileName(Zipname), true);
                            File.Delete(@"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1a.First().Value + @"\First Proof\" + Path.GetFileName(Zipname));
                        }
                        CreateTxtfile(Zipname, list1a.First().Value, JAC, "OSA");
                    }
                    else
                    {
                        if (Directory.Exists(@"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1.First().Value + @"\First Proof\" + Path.GetFileNameWithoutExtension(Zipname)))
                        {
                            if (!Directory.Exists(@"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1.First().Value + @"\First Proof\Old\" + Path.GetFileNameWithoutExtension(Zipname) + @"\")) Directory.CreateDirectory(@"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1.First().Value + @"\First Proof\Old\" + Path.GetFileNameWithoutExtension(Zipname) + @"\");
                            //Directory.Move(@"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1.First().Value + @"\First Proof\" + Path.GetFileNameWithoutExtension(Zipname),@"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1.First().Value + @"\Old\");
                            CopyFilesRecursively(new DirectoryInfo(@"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1.First().Value + @"\First Proof\" + Path.GetFileNameWithoutExtension(Zipname) + @"\"), new DirectoryInfo(@"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1.First().Value + @"\First Proof\Old\" + Path.GetFileNameWithoutExtension(Zipname) + @"\"));
                            Directory.Delete(@"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1.First().Value + @"\First Proof\" + Path.GetFileNameWithoutExtension(Zipname) + @"\", true);
                            File.Copy(@"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1.First().Value + @"\First Proof\" + Path.GetFileName(Zipname), @"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1.First().Value + @"\First Proof\Old\" + Path.GetFileName(Zipname), true);
                            File.Delete(@"\\Techsetserver2\Journal\osa\" + JAC + @"\Articles\DataSupplied\" + JAC + list1.First().Value + @"\First Proof\" + Path.GetFileName(Zipname));
                        }
                        CreateTxtfile(Zipname, list1.First().Value, JAC, "OSA");
                    }
                    if (txt)
                    {
                        File.Copy(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".txt", Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".XML", true);
                        File.Copy(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".XML", @"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(Zipname) + @".XML", true);
                        File.WriteAllText(@"D:\WatchTXT\" + Aid + @"xml.txt", @"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(Zipname) + ".XML" + @"~\\Techsetserver2\Journal\OSA\" + JAC + @"\Articles\DataSupplied\" + Aid + @"\First Proof\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @".XML");
                    }
                    try
                    {
                        ProcessStartInfo p = new ProcessStartInfo();
                        p.FileName = @"""\\techsetserver1\Software\OSA\OSA_META_VIEWER.exe""";
                        p.Arguments = @"""" + Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".XML" + @"""";
                        Process P1 = Process.Start(p);
                        P1.WaitForExit();
                    }
                    catch (Exception e1)
                    {
                        SendMail(Path.GetFileNameWithoutExtension(Zipname), e1.Message + "\n" + e1.StackTrace, "OSA", true, "OSAHIT");
                    }
                    if (File.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".html"))
                    {
                        try
                        {
                            using (WebClient client = new WebClient())
                            {
                                client.Credentials = new NetworkCredential("osaxml", "Osxm@123");
                                client.UploadFile("ftp://13.232.100.10/" + Aid + @".html", WebRequestMethods.Ftp.UploadFile, Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".html");
                                File.Copy(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".html", @"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(Zipname) + @".html", true);
                                File.WriteAllText(@"D:\WatchTXT\" + Aid + @"html.txt", @"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(Zipname) + ".html" + @"~\\Techsetserver2\Journal\OSA\" + JAC + @"\Articles\DataSupplied\" + Aid + @"\First Proof\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @".html");
                            }
                        }
                        catch (Exception e2)
                        {
                            SendMail(Path.GetFileNameWithoutExtension(Zipname), e2.Message + "\n" + e2.StackTrace, "OSA", true, "OSAHIT");
                        }
                    }
                }
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                File.Delete(Zipname);
                //SendMail(Aid, "Dear Team,<Br/><Br/>Revised file AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "OSA", false, stage);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking Revised file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "OSA", true, stage, Zipname);
                SaveToReport("Error while booking Revised file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }
        //*** 
        //***
        public void Book_GSL1(string CL)
        {
            string stage = "First Proof Stage";
            DBClass Db = new DBClass();
            try
            {
                XDocument XDoc = new XDocument();
                SaveToReport("Status: Validating Readme file: " + Path.GetFileName(Zipname));
                if (File.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".go.xml"))
                {
                    try
                    {
                        XDoc = XDocument.Parse(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".go.xml").Replace(" & ", " &amp; "), LoadOptions.PreserveWhitespace);
                    }
                    catch (Exception e)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Go.XML file is not valid for GSL: ", "GSL", true, stage, Zipname);
                        SaveToReport("Go.XML file is not valid for:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                        Clear();
                        return;
                    }
                }
                else
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Go.XML file missing for GSL: ", "GSL", true, stage, Zipname);
                    SaveToReport("Go.XML file missing for:  " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
                SaveToReport("Status: Validating against Booked Records: " + Path.GetFileName(Zipname));
                string Aid = "", Doi = "", Goxml = File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".go.xml"), JAcro = "", JName = "", DD = "", Stageval = "";
                Aid = Regex.Match(Goxml, @"<parameter value=""([^<>]*?)"" name=""manuscript-number""\s*/>").Groups[1].Value;
                Doi = Regex.Match(Goxml, @"<parameter value=""([^<>]*?)"" name=""DOI""\s*/>").Groups[1].Value;
                JAcro = Regex.Match(Goxml, @"<journal code=""([^<>]*?)""\s*/>").Groups[1].Value;
                DD = Regex.Match(Goxml, @"<parameter value=""([^<>]*?)"" name=""production-task-due-date""\s*/>").Groups[1].Value;
                Stageval = Regex.Match(Goxml, @"<parameter value=""([^<>]*?)"" name=""production-task-name""\s*/>").Groups[1].Value;
                if (Aid == "" || Doi == "" || JAcro == "" || Stageval == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>manuscript-number or DOI or journal code or production-task-name information missing in go xml for GSL: ", "GSL", true, stage, Zipname);
                    SaveToReport("CE format file not found in ZIP file for GSL: " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
                switch (JAcro.ToLower())
                {
                    case "geochem":
                        JName = "geea";
                        Aid = Aid.Replace(JName, JAcro);
                        break;
                    case "petgeo":
                        JName = "pg";
                        Aid = Aid.Replace(JName, JAcro);
                        break;
                    default:
                        JName = JAcro.ToLower();
                        break;
                }
                JAcro = JAcro.ToLower();
                bool FP = false, PP = false, PAP = false;
                switch (Stageval)
                {
                    case "Pre-edit":
                        stage = "Pre-Process Stage";
                        PP = true;
                        break;
                    case "Typesetting":
                        stage = "First Proof Stage";
                        foreach (Match m in Regex.Matches(Goxml, @"<file name=""([^<>]*?)""/>"))
                        {
                            if (Regex.IsMatch(m.Groups[1].Value.ToUpper(), @"([^<>]*?)CE\."))
                            {
                                FP = true;
                            }
                        }
                        if (!FP)
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>CE format file not found in ZIP file for GSL: ", "GSL", true, stage, Zipname);
                            SaveToReport("CE format file not found in ZIP file for GSL: " + Path.GetFileName(Zipname));
                            Clear();
                            return;
                        }
                        break;
                    case "Correcting":
                        foreach (Match m in Regex.Matches(Goxml, @"<file name=""([^<>]*?)""/>"))
                        {
                            if (m.Groups[1].Value.ToLower().Contains("parser1marked"))
                            {
                                stage = "PAP";
                                PAP = true;
                            }
                            else if (Regex.IsMatch(m.Groups[1].Value.ToLower(), @"proof\d+marked"))
                            {
                                stage = "AU Correction";
                                //if (!AU2 && !AU3 && !AU4 && !AU5)
                                //{
                                //    AU1 = true;
                                //    stage = "AU Correction1";
                                //}
                                //else
                                //{
                                //   SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Multiple format file found in ZIP file for GSL : ", "GSL", true, stage, Zipname);
                                //    SaveToReport("Multiple format file found in ZIP file for GSL: " + Path.GetFileName(Zipname));                                            
                                //    Clear();
                                //    return;
                                //}
                            }
                            else if (Regex.IsMatch(m.Groups[1].Value.ToLower(), @"proof\d+amend"))
                            {
                                stage = "TU Correction";
                                //if (!TU2)
                                //{
                                //    TU1 = true;
                                //    stage = "TU Correction1";
                                //}
                                //else
                                //{
                                //   SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Multiple format file found in ZIP file for GSL : ", "GSL", true, stage, Zipname);
                                //    SaveToReport("Multiple format file found in ZIP file for GSL: " + Path.GetFileName(Zipname));                                           
                                //    Clear();
                                //    return;
                                //}
                            }
                            //     else if ( m.Groups[1].Value.ToLower().Contains("proof2marked"))                                 
                            //     {
                            //       stage = "AU Correction";
                            //       if (!AU1 && !AU3 && !AU4 && !AU5)
                            //       {
                            //           AU2 = true;
                            //           stage = "AU Correction2";
                            //       }
                            //       else
                            //       {
                            //          SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Multiple format file found in ZIP file for GSL : ", "GSL", true, stage, Zipname);
                            //           SaveToReport("Multiple format file found in ZIP file for GSL: " + Path.GetFileName(Zipname));                                            
                            //           Clear();
                            //           return;
                            //       }
                            //     }
                            //else if ( m.Groups[1].Value.ToLower().Contains("proof3marked"))
                            //   {
                            //       stage = "AU Correction";
                            //       if (!AU2 && !AU1 && !AU4 && !AU5)
                            //       {
                            //           AU3 = true;
                            //           stage = "AU Correction3";
                            //       }
                            //       else
                            //       {
                            //          SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Multiple format file found in ZIP file for GSL : ", "GSL", true, stage, Zipname);
                            //           SaveToReport("Multiple format file found in ZIP file for GSL: " + Path.GetFileName(Zipname));                                           
                            //           Clear();
                            //           return;
                            //       }
                            //}
                            // else if ( m.Groups[1].Value.ToLower().Contains( "proof4marked"))
                            //   {
                            //       stage = "AU Correction";
                            //       if (!AU2 && !AU3 && !AU1 && !AU5)
                            //       {
                            //           AU4 = true;
                            //           stage = "AU Correction4";
                            //       }
                            //       else
                            //       {
                            //          SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Multiple format file found in ZIP file for GSL : ", "GSL", true, stage, Zipname);
                            //           SaveToReport("Multiple format file found in ZIP file for GSL: " + Path.GetFileName(Zipname));                                            
                            //           Clear();
                            //           return;
                            //       }
                            // } 
                            //   else if ( m.Groups[1].Value.ToLower().Contains("proof5marked"))
                            //   {
                            //       stage = "AU Correction";
                            //       if (!AU2 && !AU3 && !AU4 && !AU1)
                            //       {
                            //           AU5 = true;
                            //           stage = "AU Correction5";
                            //       }
                            //       else
                            //       {
                            //          SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Multiple format file found in ZIP file for GSL : ", "GSL", true, stage, Zipname);
                            //           SaveToReport("Multiple format file found in ZIP file for GSL: " + Path.GetFileName(Zipname));                                           
                            //           Clear();
                            //           return;
                            //       }
                            //   }

                            //else if ( m.Groups[1].Value.ToLower().Contains("proof2amend"))
                            //   {
                            //       stage = "TU Correction";
                            //       if (!TU1)
                            //       {
                            //           TU2 = true;
                            //           stage = "TU Correction2";
                            //       }
                            //       else
                            //       {
                            //          SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Multiple format file found in ZIP file for GSL : ", "GSL", true, stage, Zipname);
                            //           SaveToReport("Multiple format file found in ZIP file for GSL: " + Path.GetFileName(Zipname));                                          
                            //           Clear();
                            //           return;
                            //       }
                            //}                                   

                        }
                        break;
                }
                switch (stage)
                {
                    case "Pre-Process Stage":
                        break;
                    case "First Proof Stage":
                        break;
                    case "TU Correction":
                        break;
                    case "AU Correction":
                        break;
                    case "PAP":
                        break;
                }
                String AUTUStatus = "25";
                if (XDoc.Descendants("coden3").First().Value.ToLower() == "cha") AUTUStatus = "102";
                string Rdate = "", Sdate = "";
                if (XDoc.Descendants("submission_date").Count() > 0) Rdate = XDoc.Descendants("submission_date").First().Value;
                if (XDoc.Descendants("due_date").Count() > 0) Sdate = XDoc.Descendants("due_date").First().Value;
                DateTime Artcl_ExpFromTIDt = new DateTime();
                DateTime Artcl_ScheduledDt = new DateTime();
                DateTime artcl_CEDuedate = new DateTime();
                if (Sdate != "")
                {
                    var culture = System.Globalization.CultureInfo.InvariantCulture;
                    DateTime ddate = DateTime.ParseExact(Sdate, "MM/dd/yyyy HH:mm:ss", culture);
                    Artcl_ExpFromTIDt = CalculateAIPExpFromTIDt("AIP", Db, ddate);
                    Artcl_ScheduledDt = Artcl_ExpFromTIDt;
                    Artcl_ExpFromTIDt = CalculateAIPExpFromTIDt("AIP", Db, Artcl_ExpFromTIDt);
                    if (Rdate != "" && XDoc.Descendants("submission_type").First().Value.ToLower() == "starter")
                    {
                        culture = System.Globalization.CultureInfo.InvariantCulture;
                        DateTime ddate1 = DateTime.ParseExact(Rdate, "MM/dd/yyyy HH:mm:ss", culture);
                        double days = Math.Round(ReturnDays(ddate1, Db, Artcl_ScheduledDt) * 0.6);
                        artcl_CEDuedate = CalculateDueDate("", Db, AddDays(ddate1, Db, Convert.ToInt16(days)));
                    }
                }
                if (CheckWhetherFileBooked(Aid))
                {
                    if (XDoc.Descendants("submission_type").First().Value.ToLower() == "starter")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for First Proof: ", "AIP", true, stage, Zipname);
                        SaveToReport("File already booked for First Proof: " + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    else if (XDoc.Descendants("submission_type").First().Value.ToLower() == "printdeliverytovendor" && XDoc.Descendants("submission_request").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() == "issuetoprinter")
                    {
                        if (XDoc.Descendants("volume").Count() == 0)
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'volume' missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                            SaveToReport("'volume' missing in Readme xml file: " + Path.GetFileName(Zipname));
                            Clear();
                            return;
                        }
                        if (XDoc.Descendants("issue").Count() == 0)
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'issue' missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                            SaveToReport("'issue' missing in Readme xml file: " + Path.GetFileName(Zipname));
                            Clear();
                            return;
                        }
                        SaveToReport("Status: Printer update JR_Main Table file: " + Path.GetFileName(Zipname));
                        //JR_Main 
                        string vol = XDoc.Descendants("volume").First().Value;
                        string issue = XDoc.Descendants("issue").First().Value;
                        string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + XDoc.Descendants("coden3").First().Value + "' AND Jrnl_PublID='99'");
                        string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                        string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,LastModifiedDate,UsrID,Insert_Date, JRM_Volume, JRM_Issue) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"',getdate(),'1',getdate(),'" + vol + "','" + issue + "')";
                        JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + vol + "' AND JRM_Issue='" + issue + "'");
                        if (JRM_Id == "")
                        {
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }
                        JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + vol + "' AND JRM_Issue='" + issue + "'");
                        JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));

                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=42") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=57") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=71") != "")
                                {
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Printer Files 3: ", "AIP", true, stage, Zipname);
                                    SaveToReport("File already booked for Printer Files 3: " + Path.GetFileName(Zipname));
                                    //Move to Error
                                    Clear();
                                    return;
                                }
                                else
                                {
                                    stage = "Printer Files 3";
                                    string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','71','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','25',getdate(),'1','')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    foreach (XElement Article in XDoc.XPathSelectElements(@"//lineup_items/article").ToList())
                                    {
                                        if (Article.Descendants("aipid").Count() == 0)
                                        {
                                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'aipid' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                                            SaveToReport("'aipid' article id missing in Readme xml file: " + Path.GetFileName(Zipname));
                                            continue;
                                        }
                                        Aid = Article.Descendants("aipid").First().Value;
                                        string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                                        if (uploaddate == "")
                                        {
                                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.: ", "AIP", true, stage, Zipname);
                                            SaveToReport("Artcl_UploadedDt not updated: " + Path.GetFileName(Zipname));
                                            continue;
                                        }
                                        //JR_Articles 
                                        string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','25','71',getdate(),'1')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Printer Files 3 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                        //TrnsJournalRev 
                                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','25',getdate(),'1','Printer Files 3','Pending')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Printer Files 3 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                        //Article 
                                        Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate(),Artcl_Volume='" + vol + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        //Transaction TrnsJournal        
                                        string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                        string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                        Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage + " Stage");
                                    }
                                    SaveToReport("Status: Copy files to Printer files 3: " + Path.GetFileName(Zipname));
                                    CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", stage, "", vol, issue);
                                    goto skipAIP;
                                }
                            }
                            else
                            {
                                stage = "Printer Files 2";
                                string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','57','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','25',getdate(),'1','')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                foreach (XElement Article in XDoc.XPathSelectElements(@"//lineup_items/article").ToList())
                                {
                                    if (Article.Descendants("aipid").Count() == 0)
                                    {
                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'aipid' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                                        SaveToReport("'aipid' article id missing in Readme xml file: " + Path.GetFileName(Zipname));
                                        continue;
                                    }
                                    Aid = Article.Descendants("aipid").First().Value;
                                    string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                                    if (uploaddate == "")
                                    {
                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.: ", "AIP", true, stage, Zipname);
                                        SaveToReport("Artcl_UploadedDt not updated: " + Path.GetFileName(Zipname));
                                        continue;
                                    }

                                    SaveToReport("Status: Printer Files 2 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                    //JR_Articles 
                                    string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','25','57',getdate(),'1')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Printer Files 2 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                    //TrnsJournalRev 
                                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','25',getdate(),'1','Printer Files 2','Pending')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Printer files 2 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                    //Article 
                                    Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate(),Artcl_Volume='" + vol + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    //Transaction TrnsJournal        
                                    string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                    string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                    Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage + " Stage");
                                }
                                SaveToReport("Status: Copy files to Printer files 2: " + Path.GetFileName(Zipname));
                                CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", stage, "", vol, issue);
                                goto skipAIP;
                            }
                        }
                        else
                        {
                            stage = "Printer Files";
                            string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                            Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','42','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','25',getdate(),'1','')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            foreach (XElement Article in XDoc.XPathSelectElements(@"//lineup_items/article").ToList())
                            {
                                if (Article.Descendants("aipid").Count() == 0)
                                {
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'aipid' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                                    SaveToReport("'aipid' article id missing in Readme xml file: " + Path.GetFileName(Zipname));
                                    continue;
                                }
                                Aid = Article.Descendants("aipid").First().Value;
                                string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                                if (uploaddate == "")
                                {
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.: ", "AIP", true, stage, Zipname);
                                    SaveToReport("Artcl_UploadedDt not updated: " + Path.GetFileName(Zipname));
                                    continue;
                                }
                                SaveToReport("Status: Printer Files update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                //JR_Articles 
                                string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','25','42',getdate(),'1')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: Printer Files update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                //TrnsJournalRev 
                                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','25',getdate(),'1','Printer Files','Pending')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: Printer files update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                //Article 
                                Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate(),Artcl_Volume='" + vol + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                //Transaction TrnsJournal        
                                string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage + " Stage");
                            }

                            SaveToReport("Status: Copy files to Printer files: " + Path.GetFileName(Zipname));
                            CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", stage, "", vol, issue);
                            goto skipAIP;
                        }

                    }
                    else if (XDoc.Descendants("submission_type").First().Value.ToLower() == "correctionstovendor")
                    {
                        stage = "Author Correction Stage";
                        string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                        if (uploaddate == "")//|| CheckWhetherFileBooked(Aid,"AC"))
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "AIP", true, stage, Zipname);
                            SaveToReport("Artcl_UploadedDt not updated " + Path.GetFileName(Zipname));
                            //Move to Error
                            Clear();
                            return;
                        }
                        SaveToReport("Status: Author Correction update JR_Main Table file: " + Path.GetFileName(Zipname));
                        // Author Correction   
                        //JR_Main 
                        string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + XDoc.Descendants("coden3").First().Value + "' AND Jrnl_PublID='99'");
                        string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                        string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                        if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                        {
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }
                        JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                        JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));

                        //JR_Stage_Tran  
                        string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                        string JRA_ID = "";
                        string artid;
                        string transid;
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=36") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=37") != "")
                                {
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=78") != "")
                                    {
                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=97") != "")
                                        {
                                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=98") != "")
                                            {
                                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 5: ", "AIP", true, stage, Zipname);
                                                SaveToReport("File already booked for Author Correction 5: " + Path.GetFileName(Zipname));
                                                //Move to Error
                                                Clear();
                                                return;
                                            }
                                            else
                                            {
                                                stage = "Author Correction 5 Stage";
                                                SaveToReport("Status: Author Correction 5 update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                                //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','98',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','" + AUTUStatus + "',getdate(),'1','')";
                                                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','98','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','')";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                SaveToReport("Status: Author Correction 5 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                                //JR_Articles 
                                                JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','98',getdate(),'1')";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                SaveToReport("Status: Author Correction 5 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                                //TrnsJournalRev 
                                                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction 5','Pending')";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                SaveToReport("Status: Author Correction 5 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                                //Article 
                                                Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                //Transaction TrnsJournal        
                                                artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                                transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                                Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                SaveToReport("Status: Upload files to Author Correction 5 file: " + Path.GetFileName(Zipname));
                                                CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", "AC5");
                                                goto skipAIP;
                                            }
                                        }
                                        else
                                        {
                                            stage = "Author Correction 4 Stage";
                                            SaveToReport("Status: Author Correction 4 update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                            //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','97',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','" + AUTUStatus + "',getdate(),'1','')";
                                            Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','97','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','')";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            SaveToReport("Status: Author Correction 4 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                            //JR_Articles 
                                            JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                            Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','97',getdate(),'1')";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            SaveToReport("Status: Author Correction 4 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                            //TrnsJournalRev 
                                            Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction 4','Pending')";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            SaveToReport("Status: Author Correction 4 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                            //Article 
                                            Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            //Transaction TrnsJournal                             
                                            artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                            transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                            Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            SaveToReport("Status: Upload files to Author Correction 1 file: " + Path.GetFileName(Zipname));
                                            CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", "AC4");
                                            goto skipAIP;
                                        }
                                    }
                                    else
                                    {
                                        stage = "Author Correction 3 Stage";
                                        SaveToReport("Status: Author Correction 3 update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                        //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','78',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','" + AUTUStatus + "',getdate(),'1','')";
                                        Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','78','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Author Correction 3 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                        //JR_Articles 
                                        JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','78',getdate(),'1')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Author Correction 3 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                        //TrnsJournalRev 
                                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction 3','Pending')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Author Correction 3 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                        //Article 
                                        Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        //Transaction TrnsJournal        
                                        artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                        transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                        Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Upload files to Author Correction 3 file: " + Path.GetFileName(Zipname));
                                        CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", "AC3");
                                        goto skipAIP;
                                    }
                                }
                                else
                                {
                                    stage = "Author Correction 2 Stage";
                                    SaveToReport("Status: Author Correction 2 update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                    //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','37',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','" + AUTUStatus + "',getdate(),'1','')";
                                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','37','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Author Correction 2 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                    //JR_Articles 
                                    JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','37',getdate(),'1')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Author Correction 2 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                    //TrnsJournalRev 
                                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction 2','Pending')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Author Correction 2 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                    //Article 
                                    Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    //Transaction TrnsJournal                             
                                    artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                    transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                    Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Upload files to Author Correction 2 file: " + Path.GetFileName(Zipname));
                                    CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", "AC2");
                                    goto skipAIP;
                                }
                            }
                            else
                            {
                                stage = "Author Correction 1 Stage";
                                SaveToReport("Status: Author Correction 1 update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','36',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','" + AUTUStatus + "',getdate(),'1','')";
                                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','36','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: Author Correction 1 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                //JR_Articles 
                                JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','36',getdate(),'1')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: Author Correction 1 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                //TrnsJournalRev 
                                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction 1','Pending')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: Author Correction 1 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                //Article 
                                Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                //Transaction TrnsJournal                             
                                artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: Upload files to Author Correction 1 file: " + Path.GetFileName(Zipname));
                                CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", "AC1");
                                goto skipAIP;
                            }
                        }
                        else
                        {
                            //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','35',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','" + AUTUStatus + "',getdate(),'1','')";
                            Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','35','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','')";
                            SaveToReport("Status: Author Correction update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: Author Correction update JR_Articles Table file: " + Path.GetFileName(Zipname));
                            //JR_Articles 
                            JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                            Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','35',getdate(),'1')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: Author Correction update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                            //TrnsJournalRev 
                            Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction','Pending')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: Author Correction update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                            //Article 
                            Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            //Transaction TrnsJournal                             
                            artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                            transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                            Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: Upload files to Author Correction file: " + Path.GetFileName(Zipname));
                            CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", "AC");
                            goto skipAIP;
                        }
                    }
                    else if (XDoc.Descendants("submission_type").First().Value.ToLower() == "revisionstovendor" && XDoc.Descendants("submission_request").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() == "authorproof")
                    {
                        stage = "TU Correction 1 Stage";
                        string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                        if (uploaddate == "")// || CheckWhetherFileBooked(Aid, "TUC"))
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.: ", "AIP", true, stage, Zipname);
                            SaveToReport("Artcl_UploadedDt not updated: " + Path.GetFileName(Zipname));
                            //Move to Error
                            Clear();
                            return;
                        }
                        SaveToReport("Status: TU Correction 1 update JR_Main Table file: " + Path.GetFileName(Zipname));
                        // Author Correction   
                        //JR_Main 
                        string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + XDoc.Descendants("coden3").First().Value + "' AND Jrnl_PublID='99'");
                        string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                        string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                        if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                        {
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }

                        JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                        JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));

                        //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        //Db.OpenConnection();
                        //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        //Db.SqlReader.Close();                         
                        //JR_Stage_Tran     
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=33") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=34") != "")
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for TU Correction 2: ", "AIP", true, stage, Zipname);
                                SaveToReport("File already booked for TU Correction 2: " + Path.GetFileName(Zipname));
                                //Move to Error
                                Clear();
                                return;
                            }
                            else
                            {
                                stage = "TU Correction 2 Stage";
                                string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','34',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','" + AUTUStatus + "',getdate(),'1','')";
                                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','34','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: TU Correction 2 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                //JR_Articles 
                                string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','34',getdate(),'1')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: TU Correction 2 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                //TrnsJournalRev 
                                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','TU Correction 2','Pending')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: TU Correction 2 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                //Article 
                                Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                //Transaction TrnsJournal                             
                                string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: Upload files to TU Correction 2 file: " + Path.GetFileName(Zipname));
                                CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", "TUC2");
                                goto skipAIP;
                            }
                        }
                        else
                        {
                            SaveToReport("Status: TU Correction 1 update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                            string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                            //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','33',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','" + AUTUStatus + "',getdate(),'1','')";
                            Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','33','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: TU Correction 1 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                            //JR_Articles 
                            string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                            Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','33',getdate(),'1')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: TU Correction 1 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                            //TrnsJournalRev 
                            Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','TU Correction 1','Pending')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: TU Correction 1 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                            //Article 
                            Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            //Transaction TrnsJournal                             
                            string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                            string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                            Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: Upload files to TU Correction 1 file: " + Path.GetFileName(Zipname));
                            CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP", "TUC");
                            goto skipAIP;
                        }
                    }
                    else if (XDoc.Descendants("submission_type").First().Value.ToLower() == "paginationtovendor" && XDoc.Descendants("submission_request").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() == "finaldeliverables")
                    {
                        Boolean mutiarticles = false;
                        string readme = File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\readme.xml");
                        if (XDoc.Descendants("article_metadata").Count() > 1)
                        {
                            mutiarticles = true;
                            readme = Regex.Replace(readme, "<articles>(.*?)</articles>", "<articles></articles>", RegexOptions.Singleline);
                        }
                        foreach (XElement Articlemeta in XDoc.Descendants("article_metadata").ToList())
                        {
                            string readme1 = "";
                            if (mutiarticles == true)
                            {
                                readme1 = readme.Replace("<articles>", "<articles>" + Articlemeta.ToString(SaveOptions.DisableFormatting));
                            }
                            if (Articlemeta.Descendants("aipid").Count() == 0)
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'aipid' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                                SaveToReport("'aipid' article id missing in Readme xml file: " + Path.GetFileName(Zipname));
                                continue;
                            }
                            if (Articlemeta.Descendants("coden3").Count() == 0)
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'coden3' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                                SaveToReport("'coden3' missing in Readme xml file: " + Path.GetFileName(Zipname));
                                continue;
                            }
                            if (Articlemeta.Descendants("fpage").Count() == 0)
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'fpage' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                                SaveToReport("'fpage' missing in Readme xml file: " + Path.GetFileName(Zipname));
                                continue;
                            }
                            if (Articlemeta.Descendants("seqno").Count() == 0)
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'seqno' article id missing in Readme xml file: for AIP: ", "AIP", true, stage, Zipname);
                                SaveToReport("'seqno' missing in Readme xml file: " + Path.GetFileName(Zipname));
                                continue;
                            }
                            string PAPFileName = Articlemeta.Descendants("fpage").First().Value.Split('-')[0] + '_' + Articlemeta.Descendants("seqno").First().Value;
                            Aid = Articlemeta.Descendants("aipid").First().Value;
                            Aid = Aid + Articlemeta.Descendants("coden3").First().Value;
                            if (CheckWhetherFileBooked(Aid))
                            {
                                stage = "Final Web Delivery Stage";
                                string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                                if (uploaddate == "")//|| CheckWhetherFileBooked(Aid,"AC"))
                                {
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "AIP", true, stage, Zipname);
                                    SaveToReport("Artcl_UploadedDt not updated " + Aid + " " + Path.GetFileName(Zipname));
                                    //Move to Error
                                    //Clear();
                                    //return;
                                    continue;
                                }
                                SaveToReport("Status: Final Web Delivery update JR_Main Table file: " + Path.GetFileName(Zipname));
                                // Author Correction   
                                //JR_Main 
                                string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + Articlemeta.Descendants("coden3").First().Value + "' AND Jrnl_PublID='99'");
                                string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                                string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                                if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                                {
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                }

                                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                                JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));

                                SaveToReport("Status: Final Web Delivery update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                //JR_Stage_Tran    
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=43") != "")
                                {
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=50") != "")
                                    {
                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=125") != "")
                                        {
                                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=126") != "")
                                            {
                                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=127") != "")
                                                {
                                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=128") != "")
                                                    {
                                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Web Delivery 6: ", "AIP", true, stage, Zipname);
                                                        SaveToReport("File already booked for Final Web Delivery 6: " + Path.GetFileName(Zipname));
                                                        //Move to Error
                                                        //Clear();
                                                        //return;
                                                        continue;
                                                    }
                                                    else
                                                    {
                                                        stage = "Final Web Delivery 6 Stage";
                                                        string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                                        //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','128',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','15',getdate(),'1','','" + PAPFileName + @"')";
                                                        Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','128' ,'" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + @"','25',getdate(),'1','','" + PAPFileName + @"')";
                                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                        Db.OpenConnection();
                                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                        Db.SqlReader.Close();
                                                        SaveToReport("Status: Final Web Delivery 6 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                                        //JR_Articles 
                                                        string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','25','128',getdate(),'1')";
                                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                        Db.OpenConnection();
                                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                        Db.SqlReader.Close();
                                                        SaveToReport("Status: Final Web Delivery 6 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                                        //TrnsJournalRev 
                                                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','25',getdate(),'1','Final Web Delivery 6','Pending')";
                                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                        Db.OpenConnection();
                                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                        Db.SqlReader.Close();
                                                        SaveToReport("Status: Final Web Delivery 6 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                                        //Article 
                                                        Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                        Db.OpenConnection();
                                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                        Db.SqlReader.Close();
                                                        //Transaction TrnsJournal      
                                                        string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                                        string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                                        Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                        Db.OpenConnection();
                                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                        Db.SqlReader.Close();
                                                        SaveToReport("Status: Upload files to Final Web Delivery 6 file: " + Path.GetFileName(Zipname));
                                                        //CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD6");
                                                        if (mutiarticles == true) CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD6", readme1);
                                                        else CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD6");
                                                        //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                                                    }
                                                }
                                                else
                                                {
                                                    stage = "Final Web Delivery 5 Stage";
                                                    string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                                    //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','127',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','15',getdate(),'1','','" + PAPFileName + @"')";
                                                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','127','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + @"','25',getdate(),'1','','" + PAPFileName + @"')";
                                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                    Db.OpenConnection();
                                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                    Db.SqlReader.Close();
                                                    SaveToReport("Status: Final Web Delivery 5 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                                    //JR_Articles 
                                                    string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','25','127',getdate(),'1')";
                                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                    Db.OpenConnection();
                                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                    Db.SqlReader.Close();
                                                    SaveToReport("Status: Final Web Delivery 5 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                                    //TrnsJournalRev 
                                                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','25',getdate(),'1','Final Web Delivery 5','Pending')";
                                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                    Db.OpenConnection();
                                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                    Db.SqlReader.Close();
                                                    SaveToReport("Status: Final Web Delivery 5 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                                    //Article 
                                                    Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                    Db.OpenConnection();
                                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                    Db.SqlReader.Close();
                                                    //Transaction TrnsJournal      
                                                    string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                                    string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                                    Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                    Db.OpenConnection();
                                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                    Db.SqlReader.Close();
                                                    SaveToReport("Status: Upload files to Final Web Delivery 5 file: " + Path.GetFileName(Zipname));
                                                    //CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD5");
                                                    if (mutiarticles == true) CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD5", readme1);
                                                    else CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD5");
                                                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                                                }
                                            }
                                            else
                                            {
                                                stage = "Final Web Delivery 4 Stage";
                                                string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                                //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','126',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','15',getdate(),'1','','" + PAPFileName + @"')";
                                                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','126','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + @"','25',getdate(),'1','','" + PAPFileName + @"')";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                SaveToReport("Status: Final Web Delivery 4 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                                //JR_Articles 
                                                string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','25','126',getdate(),'1')";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                SaveToReport("Status: Final Web Delivery 4 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                                //TrnsJournalRev 
                                                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','25',getdate(),'1','Final Web Delivery 4','Pending')";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                SaveToReport("Status: Final Web Delivery 4 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                                //Article 
                                                Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                //Transaction TrnsJournal      
                                                string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                                string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                                Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                                Db.OpenConnection();
                                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                                Db.SqlReader.Close();
                                                SaveToReport("Status: Upload files to Final Web Delivery 4 file: " + Path.GetFileName(Zipname));
                                                //CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD4");
                                                if (mutiarticles == true) CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD4", readme1);
                                                else CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD4");
                                                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                                            }
                                        }
                                        else
                                        {
                                            stage = "Final Web Delivery 3 Stage";
                                            string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                            //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','125',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','15',getdate(),'1','','" + PAPFileName + @"')";
                                            Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','125','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + @"','25',getdate(),'1','','" + PAPFileName + @"')";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            SaveToReport("Status: Final Web Delivery 3 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                            //JR_Articles 
                                            string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                            Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','25','125',getdate(),'1')";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            SaveToReport("Status: Final Web Delivery 3 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                            //TrnsJournalRev 
                                            Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','25',getdate(),'1','Final Web Delivery 3','Pending')";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            SaveToReport("Status: Final Web Delivery 3 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                            //Article 
                                            Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            //Transaction TrnsJournal      
                                            string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                            string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                            Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                            SaveToReport("Status: Upload files to Final Web Delivery file: " + Path.GetFileName(Zipname));
                                            //CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD3");
                                            if (mutiarticles == true) CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD3", readme1);
                                            else CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD3");
                                            //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                                        }
                                    }
                                    else
                                    {
                                        stage = "Final Web Delivery 2 Stage";
                                        string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                        //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','50',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','15',getdate(),'1','','" + PAPFileName + @"')";
                                        Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','50','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + @"','25',getdate(),'1','','" + PAPFileName + @"')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Final Web Delivery 2 update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                        //JR_Articles 
                                        string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','25','50',getdate(),'1')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Final Web Delivery 2 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                        //TrnsJournalRev 
                                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','25',getdate(),'1','Final Web Delivery 2','Pending')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Final Web Delivery 2 update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                        //Article 
                                        Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        //Transaction TrnsJournal      
                                        string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                        string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                        Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: Upload files to Final Web Delivery 2 file: " + Path.GetFileName(Zipname));
                                        //CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD2");
                                        if (mutiarticles == true) CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD2", readme1);
                                        else CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD2");
                                        //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                                    }
                                }
                                else
                                {
                                    string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                    //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','43',getdate(),getdate(),'" + XDoc.Descendants("due_date").First().Value + @"','" + XDoc.Descendants("due_date").First().Value + @"','15',getdate(),'1','','" + PAPFileName + @"')";
                                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','43','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + @"','25',getdate(),'1','','" + PAPFileName + @"')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Final Web Delivery update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                    //JR_Articles 
                                    string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','25','43',getdate(),'1')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Final Web Delivery update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                    //TrnsJournalRev 
                                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','25',getdate(),'1','Final Web Delivery','Pending')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Final Web Delivery update Article and TrnsJournal Table file: " + Path.GetFileName(Zipname));
                                    //Article 
                                    Query = "update Article set Artcl_Status='UL',Artcl_UploadedDt=getdate() where Artcl_ArticleId='" + Aid + @"'";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    //Transaction TrnsJournal                             
                                    string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                    string transid = ReturnDetail("JrnlTrns_Id", "TrnsJournal", Db, "JrnlTrns_ArticleId = '" + artid + @"' AND JrnlTrns_JType!='artwork'");
                                    Query = "update TrnsJournal set JrnlTrns_NextProcessID='33' where JrnlTrns_Id='" + transid + @"'";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: Upload files to Final Web Delivery file: " + Path.GetFileName(Zipname));
                                    if (mutiarticles == true) CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD", readme1);
                                    else CreateTxtfile(Zipname, Articlemeta.Descendants("aipid").First().Value, Articlemeta.Descendants("coden3").First().Value, "AIP", "FWD");
                                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                                }
                            }
                        }

                        goto skipAIP;
                    }
                    else
                    {
                        //SendMail(Aid, "Dear Team,<Br/><Br/>New status update for AIP: " + XDoc.Descendants("submission_type").First().Value, "AIP", true, XDoc.Descendants("submission_type").First().Value, Zipname);
                        //SaveToReport("New status update for AIP: " + XDoc.Descendants("submission_type").First().Value + Path.GetFileName(Zipname));
                        ////Move to Error
                        //Clear();
                        //return;
                        if (XDoc.Descendants("submission_request").Count() > 0 && XDoc.Descendants("submission_request").First().Elements("type").Count() > 0)
                        {
                            SendMail(Aid, "Dear Team,<Br/><Br/>New stage file received for AIP: submission_type: " + XDoc.Descendants("submission_type").First().Value + "<Br/>submission_request: " + XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() + "<Br/> Kindly check and Validate Readme XML file for new stage.", "AIP", true, XDoc.Descendants("submission_type").First().Value, Zipname);
                            SaveToReport("New stage file received for AIP: " + XDoc.Descendants("submission_type").First().Value + " " + XDoc.Descendants("submission_request").First().Elements("type").First().Value.ToLower() + " " + Path.GetFileName(Zipname));
                        }
                        else
                        {
                            SendMail(Aid, "Dear Team,<Br/><Br/>New stage file received for AIP: submission_type: " + XDoc.Descendants("submission_type").First().Value + "<Br/> Kindly check and Validate Readme XML file for new stage.", "AIP", true, XDoc.Descendants("submission_type").First().Value, Zipname);
                            SaveToReport("New stage file received for AIP: " + XDoc.Descendants("submission_type").First().Value + Path.GetFileName(Zipname));
                        }

                        //Move to Error
                        Clear();
                        return;
                    }
                }
                SaveToReport(@"Status: Collecting data from Readme file: 'coden3', 'aipid', 'doi', 'volume', 'issue', 'article_title', 'author[@type='corr']\name',  'author[@type='corr']\email', 'total_pages', 'total_figures', 'submission_date', 'due_date' & 'cs_type' " + Path.GetFileName(Zipname));
                XElement author = null;
                //string Auname = "", Auemail = "", Doi = "", Volume = "", Issue = "", Title = "", Txtfolio = "", TxtElec = "", LineArt = "", ArtElec = "", Rdate = "", Artwork = "", Sdate = "", Srcby = "", Atype="article",atypeval="";
                string Auname = "", Auemail = "", Volume = "", Issue = "", Title = "", Txtfolio = "", TxtElec = "", LineArt = "", ArtElec = "", Artwork = "", Srcby = "", Atype = "article", atypeval = "";
                foreach (XElement e in XDoc.Descendants("author").ToList())
                {
                    if (e.Attributes().Count() > 0 && e.Attributes("type").Count() == 1 && e.Attributes("type").First().Value == "corr")
                    {
                        author = e;
                        break;
                    }
                }
                if (XDoc.Descendants("article_type").Count() > 0) Atype = XDoc.Descendants("article_type").First().Value;
                if (XDoc.Descendants("doi").Count() > 0) Doi = XDoc.Descendants("doi").First().Value;
                if (XDoc.Descendants("volume").Count() > 0) Volume = XDoc.Descendants("volume").First().Value;
                if (XDoc.Descendants("issue").Count() > 0) Issue = XDoc.Descendants("issue").First().Value;
                if (XDoc.Descendants("article_title").Count() > 0) Title = XDoc.Descendants("article_title").First().Value;
                Title = Title.Replace(@"'", @"''");
                if (author != null)
                {
                    if (author.Elements("name").Count() > 0) Auname = author.Elements("name").First().Value;
                    if (author.Elements("email").Count() > 0) Auemail = author.Elements("email").First().Value;
                }
                Auname = Auname.Replace(@"'", @"''");
                if (XDoc.Descendants("total_pages").Count() > 0) Txtfolio = XDoc.Descendants("total_pages").First().Value;
                if (XDoc.Descendants("total_figures").Count() > 0) LineArt = XDoc.Descendants("total_figures").First().Value;
                //if (XDoc.Descendants("submission_date").Count() > 0) Rdate = XDoc.Descendants("submission_date").First().Value;
                //if (XDoc.Descendants("due_date").Count() > 0) Sdate = XDoc.Descendants("due_date").First().Value;
                //***
                //P.Parthiban updated for duedate calculation; on 10th JULY 2018;
                //DateTime Artcl_ExpFromTIDt=new DateTime();
                //if (Sdate!="") 
                //{
                //    var culture = System.Globalization.CultureInfo.InvariantCulture;
                //    DateTime ddate = DateTime.ParseExact(Sdate, "MM/dd/yyyy hh:mm:ss", culture);                       
                //    Artcl_ExpFromTIDt = CalculateAIPExpFromTIDt("AIP", Db, ddate);
                //}  
                //DateTime Artcl_ExpFromTIDt = new DateTime();
                //DateTime Artcl_ScheduledDt = new DateTime();
                //DateTime artcl_CEDuedate = new DateTime();
                //if (Sdate != "")
                //{
                //    var culture = System.Globalization.CultureInfo.InvariantCulture;
                //    DateTime ddate = DateTime.ParseExact(Sdate, "MM/dd/yyyy HH:mm:ss", culture);
                //    Artcl_ExpFromTIDt = CalculateAIPExpFromTIDt("AIP", Db, ddate);
                //    Artcl_ScheduledDt = Artcl_ExpFromTIDt;
                //    Artcl_ExpFromTIDt = CalculateAIPExpFromTIDt("AIP", Db, Artcl_ExpFromTIDt);
                //    if (Rdate != "")
                //    {
                //        culture = System.Globalization.CultureInfo.InvariantCulture;
                //        DateTime ddate1 = DateTime.ParseExact(Rdate, "MM/dd/yyyy HH:mm:ss", culture);
                //        double days = Math.Round(ReturnDays(ddate1, Db, Artcl_ScheduledDt) * 0.6);
                //        artcl_CEDuedate = CalculateDueDate("", Db, AddDays(ddate1,Db, Convert.ToInt16(days)));
                //    }
                //}   
                //***
                if (XDoc.Descendants("cs_type").Count() > 0) Srcby = XDoc.Descendants("cs_type").First().Value;
                if (Txtfolio != "") TxtElec = "1";
                if (LineArt != "") { ArtElec = "1"; Artwork = "T1"; }

                /*SELECT * FROM Publishers where Publ_Acronym= 'AIP'
SELECT Jrnl_Id from Journal where Jrnl_Acronym='JVB' AND Jrnl_PublID='99'*/
                SaveToReport("Status: Booking file: " + Path.GetFileName(Zipname));
                //string condition = @"SELECT ArtType_ID FROM ArticleTypes WHERE ArtType_Name='" + Atype + "'";
                //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(condition, Db.GetConnection());
                //Db.OpenConnection();
                //Db.SqlReader = Db.SqlCmd.ExecuteReader();                   
                //if (Db.SqlReader.Read() == true)
                //{
                //    atypeval = Db.SqlReader["ArtType_ID"].ToString();
                //}
                //Db.SqlReader.Close();
                //Db.CloseConnection();
                //condition = @"SELECT Jrnl_Id from Journal where Jrnl_Acronym='" + XDoc.Descendants("coden3").First().Value + "' AND Jrnl_PublID='99'";
                //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(condition, Db.GetConnection());
                //Db.OpenConnection();
                //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                //string AJId = "";
                //if (Db.SqlReader.Read() == true) 
                //{
                //    AJId = Db.SqlReader["Jrnl_Id"].ToString();
                //}
                //Db.SqlReader.Close();
                //Db.CloseConnection();
                atypeval = ReturnDetail("ArtType_ID", "ArticleTypes", Db, "ArtType_Name='" + Atype + "'");
                string AJId = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + XDoc.Descendants("coden3").First().Value + "' AND Jrnl_PublID='99'");
                if (AJId == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + XDoc.Descendants("coden3").First().Value + ": ", "AIP", true, stage, Zipname);
                    SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + XDoc.Descendants("coden3").First().Value);
                    //Move to Error
                    Clear();
                    return;
                }

                //string book = @"insert into Testing_Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Sdate + @"','" + Srcby + @"','0','PT')";
                //if (LineArt != "")
                //{
                //    book = @"insert into Testing_Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_StatusGFX) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Sdate + @"','" + Srcby + @"','0','PT','GFXP')";                        
                //}                   
                //string book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_ArtType,Artcl_ExpFromTIDt) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Sdate + @"','" + Srcby + @"','0','PE_SRV','" + atypeval + @"','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"')";
                //if (LineArt != "")
                //{
                //    book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_StatusGFX,Artcl_ArtType,Artcl_ExpFromTIDt) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Sdate + @"','" + Srcby + @"','0','PE_SRV','GFXP','" + atypeval + @"','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-','/') + @"')";
                //}
                string Artcl_Status = "PE_SRV";
                if (Directory.GetFiles(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), "*.tex", SearchOption.AllDirectories).Length > 0) Artcl_Status = "PE";
                if (XDoc.Descendants("coden3").First().Value.ToLower() == "ltp") Artcl_Status = "DP";

                //***
                //P.Parthiban updated for duedate calculation; on 10th JULY 2018;
                //string book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_ArtType,Artcl_ExpFromTIDt) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Sdate + @"','" + Srcby + @"','0','" + Artcl_Status + "','" + atypeval + @"','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"')";
                //if (LineArt != "")
                //{
                //    book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_StatusGFX,Artcl_ArtType,Artcl_ExpFromTIDt) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Sdate + @"','" + Srcby + @"','0','" + Artcl_Status + "','GFXP','" + atypeval + @"','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"')";
                //}
                string book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_ArtType,Artcl_ExpFromTIDt,Artcl_DueDtCats,artcl_CEDuedate) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Artcl_ScheduledDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Srcby + @"','0','" + Artcl_Status + "','" + atypeval + @"','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Sdate + @"','" + artcl_CEDuedate.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + "')";
                if (LineArt != "")
                {
                    book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_StatusGFX,Artcl_ArtType,Artcl_ExpFromTIDt,Artcl_DueDtCats,artcl_CEDuedate) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Rdate + @"','" + Artcl_ScheduledDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Srcby + @"','0','" + Artcl_Status + "','GFXP','" + atypeval + @"','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Sdate + @"','" + artcl_CEDuedate.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + "')";
                }
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status: Update Transaction Details for file: " + Path.GetFileName(Zipname));
                //Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Select Artcl_Id From Testing_Article WITH(NOLOCK) Where Artcl_ArticleId = '" + Aid + "'", Db.GetConnection());
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Select Artcl_Id From Article WITH(NOLOCK) Where Artcl_ArticleId = '" + Aid + "'", Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                if (Db.SqlReader.Read())
                {
                    Int64 aaid = Convert.ToInt64(Db.SqlReader[0]);
                    Db.SqlReader.Close();
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, false, "AIP", Artcl_Status), Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    CreateTxtfile(Zipname, XDoc.Descendants("aipid").First().Value, XDoc.Descendants("coden3").First().Value, "AIP");
                    if (LineArt != "")
                    {
                        SaveToReport("Status: Update Artwork Transaction Details for file: " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, true), Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                    }
                }
            skipAIP:
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                File.Delete(Zipname);
                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "AIP", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }

        public void Book_GSL(string CL)
        {
            string stage = "First Proof Stage";
            DBClass Db = new DBClass();
            string mailsub = "", ProdEDtr = "", ProdEmail = "";
            try
            {
                XDocument XDoc = new XDocument();
                SaveToReport("Status: Validating Go.XML file: " + Path.GetFileName(Zipname));
                if (File.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".go.xml"))
                {
                    try
                    {
                        XDoc = XDocument.Parse(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".go.xml").Replace(" & ", " &amp; "), LoadOptions.PreserveWhitespace);
                    }
                    catch (Exception e)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Go.XML file is not valid for GSL: ", "GSL", true, stage, Zipname);
                        SaveToReport("Go.XML file is not valid for:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                        Clear();
                        return;
                    }
                }
                else
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Go.XML file missing for GSL: ", "GSL", true, stage, Zipname);
                    SaveToReport("Go.XML file missing for:  " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
                SaveToReport("Status: Validating against Booked Records: " + Path.GetFileName(Zipname));
                string Aid = "", Doi = "", Goxml = File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".go.xml"), JAcro = "", JName = "", DD = "", Stageval = "";
                if (Regex.IsMatch(Goxml, @"<parameter( [^<>]*?)? name=""manuscript-number""( [^<>]*?)?\s*/>"))
                {
                    Aid = Regex.Match(Regex.Match(Goxml, @"<parameter( [^<>]*?)? name=""manuscript-number""( [^<>]*?)?\s*/>").Value, @"value=""([^<>]*?)""").Groups[1].Value;
                }
                if (Regex.IsMatch(Goxml, @"<parameter( [^<>]*?)? name=""DOI""( [^<>]*?)?\s*/>"))
                {
                    Doi = Regex.Match(Regex.Match(Goxml, @"<parameter( [^<>]*?)? name=""DOI""( [^<>]*?)?\s*/>").Value, @"value=""([^<>]*?)""").Groups[1].Value;
                }
                if (Regex.IsMatch(Goxml, @"<parameter( [^<>]*?)? name=""production-task-due-date""( [^<>]*?)?\s*/>"))
                {
                    DD = Regex.Match(Regex.Match(Goxml, @"<parameter( [^<>]*?)? name=""production-task-due-date""( [^<>]*?)?\s*/>").Value, @"value=""([^<>]*?)""").Groups[1].Value;
                }
                if (Regex.IsMatch(Goxml, @"<parameter( [^<>]*?)? name=""production-task-name""( [^<>]*?)?\s*/>"))
                {
                    Stageval = Regex.Match(Regex.Match(Goxml, @"<parameter( [^<>]*?)? name=""production-task-name""( [^<>]*?)?\s*/>").Value, @"value=""([^<>]*?)""").Groups[1].Value;
                }
                JAcro = Regex.Match(Goxml, @"<journal( [^<>]*?)? code=""([^<>]*?)""( [^<>]*?)?\s*/>").Groups[2].Value;
                if (Aid == "" || Doi == "" || JAcro == "" || Stageval == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>manuscript-number or DOI or journal code or production-task-name information missing in go xml for GSL: ", "GSL", true, stage, Zipname);
                    SaveToReport("CE format file not found in ZIP file for GSL: " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
                switch (JAcro.ToLower())
                {
                    case "geochem":
                        JName = "geea";
                        Aid = Aid.Replace(JName, JAcro);
                        break;
                    case "petgeo":
                        JName = "pg";
                        Aid = Aid.Replace(JName, JAcro);
                        break;
                    case "jgsl":
                        JName = "jgs";
                        break;
                    default:
                        JName = JAcro.ToLower();
                        break;
                }
                mailsub = Doi;
                JAcro = JAcro.ToLower();
                bool FP = false, PP = false, AU = false, TU = false, FWD = false;
                switch (Stageval.ToLower())
                {
                    case "pre-edit":
                        stage = "Pre-Process Stage";
                        PP = true;
                        mailsub += "pre-edit";
                        break;
                    case "typesetting":
                        stage = "First Proof Stage";
                        foreach (Match m in Regex.Matches(Goxml, @"<file name=""([^<>]*?)""\s*/>"))
                        {
                            if (Regex.IsMatch(m.Groups[1].Value.ToUpper(), @"([^<>]*?)CE\."))
                            {
                                FP = true; mailsub += "ce"; break;
                            }
                        }
                        break;
                    case "correcting":
                        foreach (Match m in Regex.Matches(Goxml, @"<file name=""([^<>]*?)""\s*/>"))
                        {
                            if (Regex.IsMatch(m.Groups[1].Value.ToLower(), @"parser\d+marked"))
                            {
                                stage = "Final Web Delivery Stage";
                                FWD = true; mailsub += Regex.Match(m.Groups[1].Value.ToLower(), @"parser\d+marked").Groups[0].Value; break;
                            }
                            else if (Regex.IsMatch(m.Groups[1].Value.ToLower(), @"proof\d+marked"))
                            {
                                stage = "AU Correction Stage";
                                AU = true; mailsub += Regex.Match(m.Groups[1].Value.ToLower(), @"proof\d+marked").Groups[0].Value; break;
                            }
                            else if (Regex.IsMatch(m.Groups[1].Value.ToLower(), @"proof\d+amend"))
                            {
                                stage = "TU Correction Stage";
                                TU = true; mailsub += Regex.Match(m.Groups[1].Value.ToLower(), @"proof\d+amend").Groups[0].Value; break;
                            }
                        }
                        break;
                    case "parser":
                    case "upload to hwx":
                        mailsub += "Upload to HWX";
                        stage = "Final Web Delivery Stage";
                        FWD = true; break;
                }
                if (!PP && !FP && !AU && !TU && !FWD)
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to identify stage. File naming format is not valid in ZIP file for GSL: " + Stageval, "GSL", true, stage, Zipname);
                    SaveToReport("Unable to identify stage. File naming format is not valid in ZIP file for GSL: " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
                ProdEDtr = ReturnDetail("Jrnl_ProdEditor", "Journal", Db, "Jrnl_Acronym='" + JName + "' AND Jrnl_PublID='84'");
                ProdEmail = ReturnDetail("Jrnl_EditorEmail", "Journal", Db, "Jrnl_Acronym='" + JName + "' AND Jrnl_PublID='84'");
                SendMail(mailsub, "Dear " + ProdEDtr + "<Br/><Br/>Please note that we have downloaded " + Aid + " successfully from our ftp site. Let you know if any queries.<br><br>Regards<br>GSL Team", "NotifyGSL", false, ProdEmail);

                if (PP)
                {
                    if (!CheckWhetherFileBooked(Aid + "_PP"))
                    {
                        SaveToReport("Status: Booking file for Pre-Process: " + Path.GetFileName(Zipname));
                        string AJId = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + JName + "' AND Jrnl_PublID='84'");
                        string Platform = ReturnDetail("Jrnl_Platform", "Journal", Db, "Jrnl_Acronym='" + JName + "' AND Jrnl_PublID='84'");
                        if (AJId == "")
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for " + JName + ": ", "GSL", true, stage, Zipname);
                            SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + JName);
                            Clear();
                            return;
                        }
                        extractzipsuccess = true;
                        Recursive_ExtractZip(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                        if (!extractzipsuccess)
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while extracting zip file: " + Path.GetFileName(Zipname), "GSL", true, stage, Zipname);
                            SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Error while extracting zip file" + JName);
                            Clear();
                            return;
                        }
                        int num = 0;
                        foreach (String f in Directory.GetFiles(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\", "*.doc*", SearchOption.AllDirectories))
                        {
                            //if (!f.ToLower().Contains("new")) continue;
                            Word.Application WordApp = new Microsoft.Office.Interop.Word.Application();
                            object fileName = f;
                            object readOnly = false;
                            object isVisible = false;
                            object missing = System.Reflection.Missing.Value;
                            Word.Document aDoc = WordApp.Documents.Open(ref fileName,
                                                    ref missing, ref readOnly, ref missing,
                                                    ref missing, ref missing, ref missing,
                                                    ref missing, ref missing, ref missing,
                                                     ref missing, ref isVisible);
                            Word.WdStatistic stat = Word.WdStatistic.wdStatisticPages;
                            int num1 = aDoc.ComputeStatistics(stat, ref missing);
                            if (num1 > num) num = num1;
                            aDoc.Close();
                        }
                        //int lineart = 0;
                        // Figur count;  
                        string sche = CalculateDueDate("", Db, AddDays(DateTime.Today, Db, 2)).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                        string book = "insert into Article(Artcl_ArticleId,Artcl_JrnlId,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_ExpFromTIDt,Artcl_Status,LastModifiedDate,UsrID,Artcl_Remarks,Artcl_FolderCreated,artcl_doi,Artcl_FirstPage,Artcl_LastPage,Artcl_ActualSeq,Artcl_Seq,Artcl_Volume,Artcl_Issue,Complexity,Artcl_Platform,Artcl_CopyEditing,Artcl_ArtType,Artcl_TextFolios) values('" + Aid + "_PP" + "','" + AJId + "',GETDATE(),'" + sche + "','" + sche + "','PE',GETDATE(),1,'Auto Entry','0','" + Doi + "','0','0','0','0','','','None','" + Platform + "','Customer','236','" + num + "')";
                        SaveToReport("Status: " + book + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();

                        SaveToReport("Status: Update Transaction Details for file: " + Path.GetFileName(Zipname));

                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Select Artcl_Id From Article WITH(NOLOCK) Where Artcl_ArticleId = '" + Aid + "_PP" + "'", Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        if (Db.SqlReader.Read())
                        {
                            Int64 aaid = Convert.ToInt64(Db.SqlReader[0]);
                            Db.SqlReader.Close();
                            string Artcl_Status = "PE";
                            //if (lineart > 0) Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, true, "GSL", Artcl_Status), Db.GetConnection());
                            //else Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, false, "GSL", Artcl_Status), Db.GetConnection());
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, true, "GSL", Artcl_Status), Db.GetConnection());
                            SaveToReport("Status: " + Db.SqlCmd.CommandText + " " + Path.GetFileName(Zipname));
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand("update Article set Artcl_StatusGFX='GFCHK' where Artcl_ID='" + aaid + "'", Db.GetConnection());
                            SaveToReport("Status: " + Db.SqlCmd.CommandText + " " + Path.GetFileName(Zipname));
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, false, "GSL", Artcl_Status), Db.GetConnection());
                            SaveToReport("Status: " + Db.SqlCmd.CommandText + " " + Path.GetFileName(Zipname));
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            CreateTxtfile(Zipname, Aid, JName, "GSL", "PP");
                        }
                        if (JName == "jgs" || JName == "pg" || JName == "qjegh" || JName == "sjg" || JName == "pygs" || JName == "geea")
                        {
                            sche = CalculateDueDate("", Db, AddDays(DateTime.Today, Db, 1)).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                            stage = "PAP Stage";
                            //string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + "_PP" + @"'");
                            //if (uploaddate == "")
                            //{
                            //   SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt not updated.: ", "GSL", true, stage, Zipname);
                            //    SaveToReport("Artcl_UploadedDt not updated: " + Path.GetFileName(Zipname));
                            //    Clear();
                            //    return;
                            //}
                            SaveToReport("Status: PAP update JR_Main Table file: " + Path.GetFileName(Zipname));
                            //JR_Main                               
                            string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                            string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + AJId + @"','" + Aid + "_PP" + "',getdate(),'1',getdate())";
                            if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "_PP" + "' AND JRM_JournalID='" + AJId + "'") == "")
                            {
                                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                            }

                            JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "_PP" + "' AND JRM_JournalID='" + AJId + "'");
                            JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                            string JRA_ID = "";
                            string id = "", stageid = "58", AUTUStatus = "21";
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=58") != "")
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for PAP: ", "GSL", true, stage, Zipname);
                                SaveToReport("File already booked for PAP: " + Path.GetFileName(Zipname));
                                Clear();
                                return;
                            }
                            string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                            Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,JRST_MoveFiles,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stageid + "','" + sche + "',getdate(),'" + sche + "','" + sche + "','" + AUTUStatus + "',getdate(),'1','','0','" + Path.GetFileNameWithoutExtension(Zipname) + "')";
                            SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: PAP Stage update JR_Articles Table file: " + Path.GetFileName(Zipname));
                            //JR_Articles 
                            JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                            Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"_PP','" + AUTUStatus + "','" + stageid + "',getdate(),'1','0')";
                            SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: PAP Stage update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                            //TrnsJournalRev 
                            Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','PAP','Pending')";
                            SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }
                    }
                    else
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Pre-Process stage: ", "GSL", true, stage, Zipname);
                        SaveToReport("File already booked for Pre-Process stage for GSL: " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    goto skipGSL;
                }

                if (!CheckWhetherFileBooked(Aid))
                {
                    if (FP)
                    {
                        if (!CheckWhetherFileBooked(Aid + "_PP"))
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Pre-Process stage not booked for " + Aid + ".", "GSL", true, stage, Zipname);
                            SaveToReport("Pre-Process stage not booked for " + Aid + "." + Path.GetFileName(Zipname));
                            Clear();
                            return;
                        }
                        SaveToReport("Status: Booking file for First Proof: " + Path.GetFileName(Zipname));
                        string AJId = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + JName + "' AND Jrnl_PublID='84'");
                        if (AJId == "")
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for " + JName + ": ", "GSL", true, stage, Zipname);
                            SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + JName);
                            Clear();
                            return;
                        }
                        extractzipsuccess = true;
                        Recursive_ExtractZip(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                        if (!extractzipsuccess)
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while extracting zip file: " + Path.GetFileName(Zipname), "GSL", true, stage, Zipname);
                            SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Error while extracting zip file" + JName);
                            Clear();
                            return;
                        }
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand("update Article set Artcl_CupCams='" + Path.GetFileNameWithoutExtension(Zipname) + "' where Artcl_ArticleId ='" + Aid + "_PP" + "'", Db.GetConnection());
                        SaveToReport("Status: " + Db.SqlCmd.CommandText + " " + Path.GetFileName(Zipname));
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        string sche = CalculateDueDate("", Db, AddDays(DateTime.Today, Db, 5)).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                        string book = "insert into article([Artcl_ArticleId] ,[Artcl_ManuScriptID],[Artcl_Title],[Artcl_DOI],[Artcl_JrnlId] ,[Artcl_AuthorName],[Artcl_AuthorEmail],[Artcl_ReceivedDt],[Artcl_Scheduleddt],[Artcl_ExpFromTidt],[Artcl_Volume],[Artcl_Issue] ,[Artcl_TextElectronic],[Artcl_PDFToAuthor], [Artcl_PDFToProdEditor] ,[Artcl_PDFDespatched],[Artcl_Notes],[Artcl_Comments],[Artcl_Remarks] ,[LastModifiedDate] ,[UsrID] ,[Artcl_Seq]  ,[Artcl_Supplement] ,[Artcl_SpecInst]      ,[CSHL_SubCode]      ,[CSHL_MailSubject], [Cshl_EditorMail], [Artcl_ArtElectronic], [Artcl_CopyEditing], [Artcl_ArtWork],[Artcl_Status],[Artcl_ArtType],[Artcl_OUPCopyright],[Complexity],[Artcl_Platform],[Artcl_TextFolios],[Artcl_ArtLineArt],[Artcl_CupCams]) ";
                        book += "SELECT '" + Aid + "',[Artcl_ManuScriptID],[Artcl_Title],[Artcl_DOI],[Artcl_JrnlId] ,[Artcl_AuthorName],[Artcl_AuthorEmail],getdate(),'" + sche + "','" + sche + "',[Artcl_Volume],[Artcl_Issue] ,[Artcl_TextElectronic],[Artcl_PDFToAuthor], [Artcl_PDFToProdEditor],[Artcl_PDFDespatched] ,[Artcl_Notes],[Artcl_Comments],'First Proof Auto Booking',[LastModifiedDate] ,[UsrID] ,[Artcl_Seq],[Artcl_Supplement],[Artcl_SpecInst]      ,[CSHL_SubCode]      ,[CSHL_MailSubject], [Cshl_EditorMail], [Artcl_ArtElectronic], [Artcl_CopyEditing], [Artcl_ArtWork],'DP',[Artcl_ArtType],[Artcl_OUPCopyright],[Complexity],[Artcl_Platform],[Artcl_TextFolios],[Artcl_ArtLineArt],[Artcl_CupCams]  FROM [JTS].[dbo].[Article] WITH(NOLOCK) where Artcl_ArticleId ='" + Aid + "_PP" + "'";
                        SaveToReport("Status: " + book + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        int lineart = 0;
                        try
                        {
                            foreach (String f in Directory.GetFiles(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\", "*.xml"))
                            {
                                if (f.ToLower().Contains("_import")) continue;
                                string xmlcont = File.ReadAllText(f);
                                xmlcont = xmlcont.Replace("\r", "").Replace("\n", "");
                                string coll = "";
                                foreach (Match M in Regex.Matches(xmlcont, @"<meta-name>Notes on figures</meta-name>\s*<meta-value>([^<>]*?)</meta-value>", RegexOptions.Singleline))
                                {
                                    coll = coll + "<Br/>" + M.Value.Replace("<", "&lt;").Replace(">", "&gt;");

                                }
                                SaveToReport("Status:  3D images FTP Download validation process file: " + Path.GetFileName(Zipname));
                                if (coll != "")
                                {
                                    System.Net.Mail.MailMessage MM = new System.Net.Mail.MailMessage("automailer@novatechset.com", "tiworkflow@novatechset.com", Path.GetFileName(Zipname) + ": GSL 3D image Information", @"Dear Team,<Br/><Br/>GSL 3D image Information for: " + Path.GetFileName(Zipname) + "<Br/><Br/>" + coll + "<Br/><Br/>Regards,<Br/>TechSupport.");
                                    MM.CC.Add("Rajasekar@novatechset.com");
                                    MM.CC.Add("Saravanakumar@novatechset.com");
                                    //System.Net.Mail.SmtpClient client = new System.Net.Mail.SmtpClient("10.0.1.184");
                                    System.Net.Mail.SmtpClient client = new System.Net.Mail.SmtpClient(SerializedClass.MailServer);
                                    MM.IsBodyHtml = true;
                                    client.Send(MM);
                                }
                                //break;
                                //P.Parthiban added for GSL figure count;
                                foreach (Match M in Regex.Matches(xmlcont, @"<meta-name>Number of figures</meta-name>\s*<meta-value>(\d+)</meta-value>", RegexOptions.Singleline))
                                {
                                    lineart = Convert.ToInt32(M.Groups[1].Value);
                                    break;
                                }
                            }

                        }

                        catch (Exception e1)
                        { }
                        int num = 0;
                        foreach (String f in Directory.GetFiles(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\", "*CE.doc*", SearchOption.AllDirectories))
                        {
                            Word.Application WordApp = new Microsoft.Office.Interop.Word.Application();
                            object fileName = f;
                            object readOnly = false;
                            object isVisible = false;
                            object missing = System.Reflection.Missing.Value;
                            Word.Document aDoc = WordApp.Documents.Open(ref fileName,
                                                    ref missing, ref readOnly, ref missing,
                                                    ref missing, ref missing, ref missing,
                                                    ref missing, ref missing, ref missing,
                                                     ref missing, ref isVisible);
                            Word.WdStatistic stat = Word.WdStatistic.wdStatisticPages;
                            int num1 = aDoc.ComputeStatistics(stat, ref missing);
                            if (num1 > num) num = num1;
                            aDoc.Close();
                        }
                        //int lineart = 0;
                        //// Figur count;
                        //if (lineart > 0) book = "update Article set Artcl_TextFolios='" + num + "',Artcl_ArtLineArt='" + lineart + "', Artcl_CupCams='" + Path.GetFileNameWithoutExtension(Zipname) + "' where Artcl_ArticleId='" + Aid + @"'";
                        //else book = "update Article set Artcl_TextFolios='" + num + "',Artcl_CupCams='" + Path.GetFileNameWithoutExtension(Zipname) + "' where Artcl_ArticleId='" + Aid + @"'";
                        //SaveToReport("Status: " + book + " " + Path.GetFileName(Zipname));
                        //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book, Db.GetConnection());
                        //Db.OpenConnection();
                        //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        //Db.SqlReader.Close();

                        SaveToReport("Status: Update Transaction Details for file: " + Path.GetFileName(Zipname));

                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Select Artcl_Id From Article WITH(NOLOCK) Where Artcl_ArticleId = '" + Aid + "'", Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        if (Db.SqlReader.Read())
                        {
                            Int64 aaid = Convert.ToInt64(Db.SqlReader[0]);
                            Db.SqlReader.Close();
                            string Artcl_Status = "DP";
                            //if (lineart > 0) Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, true, "GSL", Artcl_Status), Db.GetConnection());
                            //else Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, false, "GSL", Artcl_Status), Db.GetConnection());
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, true, "GSL", Artcl_Status), Db.GetConnection());
                            SaveToReport("Status: " + Db.SqlCmd.CommandText + " " + Path.GetFileName(Zipname));
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand("update Article set Artcl_StatusGFX='GFCHK' where Artcl_ID='" + aaid + "'", Db.GetConnection());
                            SaveToReport("Status: " + Db.SqlCmd.CommandText + " " + Path.GetFileName(Zipname));
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand("update Article set Artcl_TextFolios='" + num + "' where Artcl_ID='" + aaid + "'", Db.GetConnection());
                            SaveToReport("Status: " + Db.SqlCmd.CommandText + " " + Path.GetFileName(Zipname));
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand("update Article set Artcl_CupCams='" + Path.GetFileNameWithoutExtension(Zipname) + "' where Artcl_ID='" + aaid + "'", Db.GetConnection());
                            SaveToReport("Status: " + Db.SqlCmd.CommandText + " " + Path.GetFileName(Zipname));
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, false, "GSL", Artcl_Status), Db.GetConnection());
                            SaveToReport("Status: " + Db.SqlCmd.CommandText + " " + Path.GetFileName(Zipname));
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            CreateTxtfile(Zipname, Aid, JName, "GSL");
                            string Artcl_CupCams = ReturnDetail("Artcl_CupCams", "Article", Db, "Artcl_ID='" + aaid + "'");
                            if (Artcl_CupCams == "")
                            {
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand("update Article set Artcl_CupCams='" + Path.GetFileNameWithoutExtension(Zipname) + "' where Artcl_ID='" + aaid + "'", Db.GetConnection());
                                SaveToReport("Status: " + Db.SqlCmd.CommandText + " " + Path.GetFileName(Zipname));
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                            }
                            if (lineart > 0)
                            {
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand("update Article set Artcl_ArtLineArt='" + lineart + "' where Artcl_ID='" + aaid + "'", Db.GetConnection());
                                SaveToReport("Status: " + Db.SqlCmd.CommandText + " " + Path.GetFileName(Zipname));
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                            }
                        }

                    }
                    else
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>First Proof stage not booked for " + Aid + ".", "GSL", true, stage, Zipname);
                        SaveToReport("First Proof stage not booked for " + Aid + "." + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                }
                else
                {
                    if (FP)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for First Proof stage: ", "GSL", true, stage, Zipname);
                        SaveToReport("File already booked for First Proof stage for GSL: " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    else if (AU)
                    {
                        string sche = CalculateDueDate("", Db, AddDays(DateTime.Today, Db, 1)).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/'); ;
                        stage = "Author Correction Stage";
                        string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                        if (uploaddate == "")
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "GSL", true, stage, Zipname);
                            SaveToReport("Artcl_UploadedDt not updated " + Path.GetFileName(Zipname));
                            Clear();
                            return;
                        }
                        SaveToReport("Status: Author Correction update JR_Main Table file: " + Path.GetFileName(Zipname));
                        string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + JName + "' AND Jrnl_PublID='84'");
                        string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                        string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                        if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                        {
                            SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }
                        JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                        JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                        string JRA_ID = "";
                        string id = "", stageid = "", AUTUStatus = "102";
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=36") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=37") != "")
                                {
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=78") != "")
                                    {
                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=97") != "")
                                        {
                                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=98") != "")
                                            {
                                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 5: ", "GSL", true, stage, Zipname);
                                                SaveToReport("File already booked for Author Correction 5: " + Path.GetFileName(Zipname));
                                                //Move to Error
                                                Clear();
                                                return;
                                            }
                                            else
                                            {
                                                // Author Correction 5
                                                stage = "Author Correction 5 Stage";
                                                id = "5"; stageid = "98";
                                            }
                                        }
                                        else
                                        {
                                            // Author Correction 4
                                            stage = "Author Correction 4 Stage";
                                            id = "4"; stageid = "97";
                                        }
                                    }
                                    else
                                    {
                                        // Author Correction 3
                                        stage = "Author Correction 3 Stage";
                                        id = "3"; stageid = "78";
                                    }
                                }
                                else
                                {
                                    // Author Correction 2
                                    stage = "Author Correction 2 Stage";
                                    id = "2"; stageid = "37";
                                }
                            }
                            else
                            {
                                // Author Correction 1
                                stage = "Author Correction 1 Stage";
                                id = "1"; stageid = "36";
                            }
                        }
                        else
                        {
                            // Author Correction
                            stage = "Author Correction Stage";
                            id = ""; stageid = "35"; sche = CalculateDueDate("", Db, AddDays(DateTime.Today, Db, 2)).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                        }
                        SaveToReport("Status: Author Correction " + id + " update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                        string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                        Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stageid + "','" + sche + "',getdate(),'" + sche + "','" + sche + "','" + AUTUStatus + "',getdate(),'1','','" + Path.GetFileNameWithoutExtension(Zipname) + "','0')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: Author Correction " + id + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                        //JR_Articles 
                        JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stageid + "',getdate(),'1','0')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: Author Correction " + id + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                        //TrnsJournalRev 
                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction " + id + "','Pending')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: Upload files to Author Correction " + id + " file: " + Path.GetFileName(Zipname));
                        CreateTxtfile(Zipname, Aid, JName, "GSL", "AC" + id);
                        goto skipGSL;

                    }
                    else if (TU)
                    {
                        string sche = CalculateDueDate("", Db, AddDays(DateTime.Today, Db, 1)).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                        stage = "TU Correction Stage";
                        string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                        if (uploaddate == "")// || CheckWhetherFileBooked(Aid, "TUC"))
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.: ", "GSL", true, stage, Zipname);
                            SaveToReport("Artcl_UploadedDt not updated: " + Path.GetFileName(Zipname));
                            Clear();
                            return;
                        }
                        SaveToReport("Status: TU Correction update JR_Main Table file: " + Path.GetFileName(Zipname));
                        //JR_Main 
                        string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + JName + "' AND Jrnl_PublID='84'");
                        string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                        string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                        if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                        {
                            SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }

                        JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                        JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                        string JRA_ID = "";
                        string id = "", stageid = "", AUTUStatus = "102";
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=33") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=34") != "")
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for TU Correction 2: ", "GSL", true, stage, Zipname);
                                SaveToReport("File already booked for TU Correction 2: " + Path.GetFileName(Zipname));
                                Clear();
                                return;
                            }
                            else
                            {
                                stage = "TU Correction 2 Stage";
                                id = "2"; stageid = "34";
                            }
                        }
                        else
                        {
                            stage = "TU Correction 1 Stage";
                            id = "1"; stageid = "33";
                        }
                        string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                        Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,JRST_MoveFiles,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stageid + "','" + sche + "',getdate(),'" + sche + "','" + sche + "','" + AUTUStatus + "',getdate(),'1','','0','" + Path.GetFileNameWithoutExtension(Zipname) + "')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: TU Correction " + id + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                        //JR_Articles 
                        JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stageid + "',getdate(),'1','0')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: TU Correction " + id + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                        //TrnsJournalRev 
                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','TU Correction " + id + "','Pending')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: Upload files to TU Correction " + id + " file: " + Path.GetFileName(Zipname));
                        CreateTxtfile(Zipname, Aid, JName, "GSL", "TUC" + id);
                        goto skipGSL;
                    }
                    else if (FWD)
                    {
                        string sche = CalculateDueDate("", Db, AddDays(DateTime.Today, Db, 1)).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                        stage = "Final Web Delivery Stage";
                        string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                        if (uploaddate == "")
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.: ", "GSL", true, stage, Zipname);
                            SaveToReport("Artcl_UploadedDt not updated: " + Path.GetFileName(Zipname));
                            Clear();
                            return;
                        }
                        SaveToReport("Status: Final Web Delivery update JR_Main Table file: " + Path.GetFileName(Zipname));
                        //JR_Main 
                        string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + JName + "' AND Jrnl_PublID='84'");
                        string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                        string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                        if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                        {
                            SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }

                        JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                        JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                        //string JRA_ID = "";
                        //string id = "", stageid = "58", AUTUStatus = "21";
                        //if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=58") != "")
                        //{  
                        //   SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'File already booked for PAP: ", "GSL", true, stage, Zipname);
                        //    SaveToReport("File already booked for PAP: " + Path.GetFileName(Zipname));
                        //    Clear();
                        //    return;   
                        //}                           
                        //string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                        //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,JRST_MoveFiles,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stageid + "','" + sche + "',getdate(),'" + sche + "','" + sche + "','" + AUTUStatus + "',getdate(),'1','','0','" + Path.GetFileNameWithoutExtension(Zipname) + "')";
                        //SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        //Db.OpenConnection();
                        //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        //Db.SqlReader.Close();
                        //SaveToReport("Status: PAP Stage update JR_Articles Table file: " + Path.GetFileName(Zipname));
                        ////JR_Articles 
                        //JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                        //Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stageid + "',getdate(),'1','0')";
                        //SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        //Db.OpenConnection();
                        //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        //Db.SqlReader.Close();
                        //SaveToReport("Status: PAP Stage update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                        ////TrnsJournalRev 
                        //Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','PAP','Pending')";
                        //SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        //Db.OpenConnection();
                        //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        //Db.SqlReader.Close();
                        //SaveToReport("Status: Upload files to PAP file: " + Path.GetFileName(Zipname));
                        //CreateTxtfile(Zipname, Aid, JName, "GSL", "PAP");
                        //goto skipGSL;
                        string id = "", stageid = "", AUTUStatus = "21";
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=43") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=50") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=125") != "")
                                {
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=126") != "")
                                    {
                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=127") != "")
                                        {
                                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=128") != "")
                                            {
                                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Web Delivery 6: ", "GSL", true, stage, Zipname);
                                                SaveToReport("File already booked for Final Web Delivery 6: " + Path.GetFileName(Zipname));
                                                //Move to Error
                                                Clear();
                                                return;
                                            }
                                            else
                                            {
                                                stage = "Final Web Delivery 6 Stage";
                                                id = "6"; stageid = "128";
                                            }
                                        }
                                        else
                                        {
                                            stage = "Final Web Delivery 5 Stage";
                                            id = "5"; stageid = "127";
                                        }
                                    }
                                    else
                                    {
                                        stage = "Final Web Delivery 4 Stage";
                                        id = "4"; stageid = "126";
                                    }
                                }
                                else
                                {
                                    stage = "Final Web Delivery 3 Stage";
                                    id = "3"; stageid = "125";
                                }
                            }
                            else
                            {
                                stage = "Final Web Delivery 2 Stage";
                                id = "2"; stageid = "50";
                            }
                        }
                        else
                        {
                            stage = "Final Web Delivery Stage";
                            id = ""; stageid = "43";
                        }
                        string JRA_ID = "";
                        string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                        Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,JRST_MoveFiles,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stageid + "','" + sche + "',getdate(),'" + sche + "','" + sche + "','" + AUTUStatus + "',getdate(),'1','','0','" + Path.GetFileNameWithoutExtension(Zipname) + "')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: Final Web Delivery " + id + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                        //JR_Articles 
                        JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stageid + "',getdate(),'1','0')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: Final Web Delivery " + id + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                        //TrnsJournalRev 
                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','Final Web Delivery " + id + "','Pending')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: Upload files to Final Web Delivery " + id + " file: " + Path.GetFileName(Zipname));
                        CreateTxtfile(Zipname, Aid, JName, "GSL", "FWD" + id);
                        goto skipGSL;
                    }
                }

            skipGSL:
                try
                {
                    foreach (String f in Directory.GetFiles(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\", "*.xml"))
                    {
                        if (!f.ToLower().Contains("_import")) continue;
                        string xmlcont = File.ReadAllText(f);
                        xmlcont = xmlcont.Replace("\r", "").Replace("\n", "");
                        string Tit = "", Stit = "", Abs = "", doi = "";
                        if (Regex.IsMatch(xmlcont, @"<title>([^<>]*?)</title>", RegexOptions.Singleline))
                        {
                            XElement elt = XElement.Parse("<Root>" + Regex.Match(xmlcont, @"<title>([^<>]*?)</title>", RegexOptions.Singleline).Value + "</Root>");
                            Tit = elt.Value;
                        }
                        if (Regex.IsMatch(xmlcont, @"<short-title>([^<>]*?)</short-title>", RegexOptions.Singleline))
                        {
                            XElement elt = XElement.Parse("<Root>" + Regex.Match(xmlcont, @"<short-title>([^<>]*?)</short-title>", RegexOptions.Singleline).Value + "</Root>");
                            Stit = elt.Value;
                        }
                        if (Regex.IsMatch(xmlcont, @"<doi>([^<>]*?)</doi>", RegexOptions.Singleline))
                        {
                            XElement elt = XElement.Parse("<Root>" + Regex.Match(xmlcont, @"<doi>([^<>]*?)</doi>", RegexOptions.Singleline).Value + "</Root>");
                            doi = elt.Value;
                        }
                        if (Regex.IsMatch(xmlcont, @"<abstract-text>([^<>]*?)</abstract-text>", RegexOptions.Singleline))
                        {
                            XElement elt = XElement.Parse("<Root>" + Regex.Match(xmlcont, @"<abstract-text>([^<>]*?)</abstract-text>", RegexOptions.Singleline).Value + "</Root>");
                            Abs = elt.Value;
                        }
                        SaveToReport("Status: Import XML title update process file: " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Select Artcl_Id From Article WITH(NOLOCK) Where Artcl_ArticleId = '" + Aid + "'", Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        if (Db.SqlReader.Read())
                        {
                            Int64 aaid = Convert.ToInt64(Db.SqlReader[0]);
                            Db.SqlReader.Close();
                            if (Tit != "")
                            {
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand("update Article set Artcl_Title='" + Tit.Replace(@"'", @"''") + "' where Artcl_ID='" + aaid + "'", Db.GetConnection());
                                SaveToReport("Status: " + Db.SqlCmd.CommandText + " " + Path.GetFileName(Zipname));
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                            }
                            if (Stit != "")
                            {
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand("update Article set  Artcl_ShortTitle='" + Stit.Replace(@"'", @"''") + "' where Artcl_ID='" + aaid + "'", Db.GetConnection());
                                SaveToReport("Status: " + Db.SqlCmd.CommandText + " " + Path.GetFileName(Zipname));
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                            }
                            if (Abs != "")
                            {
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand("update Article set Artcl_Abstract='" + Abs.Replace(@"'", @"''") + "' where Artcl_ID='" + aaid + "'", Db.GetConnection());
                                SaveToReport("Status: " + Db.SqlCmd.CommandText + " " + Path.GetFileName(Zipname));
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                            }
                            if (doi != "")
                            {
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand("update Article set Artcl_DOI='" + doi.Replace(@"'", @"''") + "' where Artcl_ID='" + aaid + "'", Db.GetConnection());
                                SaveToReport("Status: " + Db.SqlCmd.CommandText + " " + Path.GetFileName(Zipname));
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                            }
                        }
                    }
                }

                catch (Exception e1)
                {
                    System.Net.Mail.MailMessage MM = new System.Net.Mail.MailMessage("automailer@novatechset.com", "tiworkflow@novatechset.com", Path.GetFileName(Zipname) + ": GSL Title update from Import xml Error", @"Dear Team,<Br/><Br/>GSL Title update from Import xml Error for: " + Path.GetFileName(Zipname) + "<Br/><Br/>" + e1.Message + "<Br/><Br/>" + e1.StackTrace + "<Br/><Br/>Regards,<Br/>TechSupport.");
                    MM.CC.Add("Rajasekar@novatechset.com");
                    MM.CC.Add("Saravanakumar@novatechset.com");
                    //System.Net.Mail.SmtpClient client = new System.Net.Mail.SmtpClient("10.0.1.184");
                    System.Net.Mail.SmtpClient client = new System.Net.Mail.SmtpClient(SerializedClass.MailServer);
                    MM.IsBodyHtml = true;
                    client.Send(MM);

                }
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                File.Copy(Zipname.Replace(".zip", ".go.xml"), CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname.Replace(".zip", ".go.xml")), true);
                File.Delete(Zipname);
                File.Delete(Zipname.Replace(".zip", ".go.xml"));
                //if (PP) SendMail(Aid + "_PP", "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "GSL", false, "Pre-Process with PAP");
                //else SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "GSL", false, stage);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "GSL", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }

        public void BookGSL_Revises(string emailfile, string CL)
        {
            Zipname = emailfile;
            DBClass Db = new DBClass();
            string Aid = Path.GetFileNameWithoutExtension(emailfile).Split(' ')[0].ToUpper();
            string stage = "Final Web Delivery 2";
            try
            {
                string JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "'");
                string sche = CalculateDueDate("", Db, AddDays(DateTime.Today, Db, 1)).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                //_PP
                if (JRM_Id == "")
                {
                    JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "_PP'");
                    stage = "PAP I Stage"; string stageid = "59", id = "";
                    if (JRM_Id == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Revises entry not found: ", "GSLR", true, stage, Zipname);
                        SaveToReport("Revises entry not found: " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=58") != "")
                    {
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=59") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=60") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=114") != "")
                                {
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for PAP III stage: ", "GSLR", true, stage, Zipname);
                                    SaveToReport("File already booked for PAP III: " + Path.GetFileName(Zipname));
                                    Clear();
                                    return;
                                }
                                else
                                {
                                    // PAP3
                                    stage = "PAP III Stage";
                                    id = "III"; stageid = "114";
                                }

                            }
                            else
                            {
                                // PAP2
                                stage = "PAP II Stage";
                                id = "II"; stageid = "60";
                            }
                        }
                        else
                        {
                            // PAP1                       
                            stage = "PAP I Stage";
                            id = "I"; stageid = "59";
                        }
                    }
                    else
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>PAP stage not booked: ", "GSLR", true, stage, Zipname);
                        SaveToReport("PAP stage not booked: " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    //string mailsub = "", ProdEDtr = "", ProdEmail = "";  
                    SaveToReport("Status: " + stage + " update JR_Main Table file: " + Path.GetFileName(Zipname));
                    JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                    string JRA_ID = "";
                    string AUTUStatus = "21";
                    //if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=59") != "")
                    //{
                    //    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for PAP I: ", "GSLR", true, stage, Zipname);
                    //    SaveToReport("File already booked for PAP I: " + Path.GetFileName(Zipname));
                    //    Clear();
                    //    return;
                    //}
                    string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                    string Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,JRST_MoveFiles,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stageid + "','" + sche + "',getdate(),'" + sche + "','" + sche + "','" + AUTUStatus + "',getdate(),'1','','0','" + Path.GetFileNameWithoutExtension(Zipname) + "')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: PAP Stage update JR_Articles Table file: " + Path.GetFileName(Zipname));
                    //JR_Articles 
                    JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"_PP','" + AUTUStatus + "','" + stageid + "',getdate(),'1','0')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + stage + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                    //TrnsJournalRev 
                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage.Replace(" Stage", "") + "','Pending')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    Aid = Aid + "_PP";
                }
                else
                {
                    JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                    string id = "2", stageid = "50", AUTUStatus = "21";
                    string JRA_ID = "";
                    //if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=50") != "")
                    //{
                    //    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Web Delivery 2: ", "GSLR", true, stage, Zipname);
                    //    SaveToReport("File already booked for Final Web Delivery 2: " + Path.GetFileName(Zipname));
                    //    Clear();
                    //    return;
                    //}
                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=43") != "")
                    {
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=50") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=125") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=126") != "")
                                {
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=127") != "")
                                    {
                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=128") != "")
                                        {
                                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Web Delivery 6: ", "GSLR", true, stage, Zipname);
                                            SaveToReport("File already booked for Final Web Delivery 6: " + Path.GetFileName(Zipname));
                                            //Move to Error
                                            Clear();
                                            return;
                                        }
                                        else
                                        {
                                            stage = "Final Web Delivery 6 Stage";
                                            id = "6"; stageid = "128";
                                        }
                                    }
                                    else
                                    {
                                        stage = "Final Web Delivery 5 Stage";
                                        id = "5"; stageid = "127";
                                    }
                                }
                                else
                                {
                                    stage = "Final Web Delivery 4 Stage";
                                    id = "4"; stageid = "126";
                                }
                            }
                            else
                            {
                                stage = "Final Web Delivery 3 Stage";
                                id = "3"; stageid = "125";
                            }
                        }
                        else
                        {
                            stage = "Final Web Delivery 2 Stage";
                            id = "2"; stageid = "50";
                        }
                    }
                    else
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Final Web Delivery stage not booked: ", "GSLR", true, stage, Zipname);
                        SaveToReport("Final Web Delivery stage not booked: " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                    string Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,JRST_MoveFiles,Jrst_CupCams) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stageid + "','" + sche + "',getdate(),'" + sche + "','" + sche + "','" + AUTUStatus + "',getdate(),'1','','0','" + Path.GetFileNameWithoutExtension(Zipname) + "')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: Final Web Delivery " + id + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                    //JR_Articles 
                    JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stageid + "',getdate(),'1','0')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: Final Web Delivery " + id + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                    //TrnsJournalRev 
                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage.Replace(" Stage", "") + "','Pending')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: Upload files to Final Web Delivery " + id + " file: " + Path.GetFileName(Zipname));
                }
                if (!Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin"))
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                File.Delete(Zipname);
                //SendMail(Aid, "Dear Team,<Br/><Br/>Revised file AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "GSLR", false, stage);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "GSLR", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }
        //***
        public void Book_COB(string xlloc, string CL)
        {
            string stage = "Revises 1";
            DBClass Db = new DBClass();
            try
            {
                Zipname = xlloc;
                SaveToReport("Status: Processing excel file: " + xlloc);
                SaveToReport("Status: Collecting data from excel file: " + xlloc);
                Xl.Workbook xlWorkBook;
                Xl.Worksheet xlWorkSheet;
                Xl.Application xlapp;
                xlapp = new Xl.Application();
                xlapp.Visible = false;
                xlWorkBook = xlapp.Workbooks.Open(xlloc);
                xlWorkSheet = (Xl.Worksheet)xlWorkBook.Sheets[1];
                int lastRow = xlWorkSheet.Cells.SpecialCells(Xl.XlCellType.xlCellTypeLastCell).Row;
                System.Array MyValues = (System.Array)xlWorkSheet.get_Range("A1", "F" + lastRow.ToString()).Cells.Value;
                int ros = MyValues.GetLength(0);
                int cos = MyValues.GetLength(1);
                xlapp.Quit();
                xlapp = null;
                GC.Collect();
                GC.WaitForPendingFinalizers();
                foreach (Process P in Process.GetProcessesByName("EXCEL"))
                {
                    try
                    {
                        P.Kill();
                    }
                    catch (Exception e) { }
                }
                if (MyValues.GetValue(4, 1).ToString().Replace("\n", "").Replace("\r", "").ToLower() != "journal acronym")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick journal acronym. Please check its position in excel.", "COB", true, stage, Zipname);
                    SaveToReport("Unable to pick Issue. Please check its position in excel: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                else if (MyValues.GetValue(5, 1).ToString().ToLower() != "volume")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick Volume. Please check its position in excel.", "COB", true, stage, Zipname);
                    SaveToReport("Unable to pick Issue. Please check its position in excel: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                else if (MyValues.GetValue(6, 1).ToString().ToLower() != "issue")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick Issue. Please check its position in excel.", "COB", true, stage, Zipname);
                    SaveToReport("Unable to pick Issue. Please check its position in excel: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                string volume = MyValues.GetValue(5, 2).ToString(), issue = MyValues.GetValue(6, 2).ToString(), JournalAcronym = MyValues.GetValue(4, 2).ToString();
                if (volume == "" || issue == "" || JournalAcronym == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick Volume/Journal Acronym/Issue. Please check its position in excel.", "COB", true, stage, Zipname);
                    SaveToReport("Unable to pick Volume/Journal Acronym/Issue. Please check its position in excel: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                System.Collections.ArrayList ArticleID = new System.Collections.ArrayList();
                for (int i = 9; i <= ros; i++)
                {
                    if (ArticleID.Contains(MyValues.GetValue(i, 2).ToString()))
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Duplicate id present in excel." + MyValues.GetValue(i, 2).ToString(), "COB", true, stage, Zipname);
                        SaveToReport("Duplicate id present in excel." + MyValues.GetValue(i, 2).ToString() + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    else ArticleID.Add(MyValues.GetValue(i, 2).ToString());
                }
                ArticleID.Add("_" + volume + "_" + issue + "_TOC");
                string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + JournalAcronym + "' AND Jrnl_PublID='77'");
                string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,LastModifiedDate,UsrID,Insert_Date, JRM_Volume, JRM_Issue) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"',getdate(),'1',getdate(),'" + volume + "','" + issue + "')";
                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                if (JRM_Id == "")
                {
                    JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                }
                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=38") != "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Revises 1: ", "COB", true, stage, Zipname);
                    SaveToReport("File already booked for Revises 1: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','38',getdate(),getdate(),getdate(),getdate(),'17',getdate(),'1','')";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                foreach (string Aid1 in ArticleID)
                {
                    string Aid = JournalAcronym + Aid1;
                    if (!CheckWhetherFileBooked(Aid))
                    {
                        SaveToReport("Status: insert dummy FP entry article table " + Aid);
                        Query = "insert into article(Artcl_JrnlId,artcl_articleid,Artcl_Volume,Artcl_Issue,Artcl_UploadedDt,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_Status) values('" + Journalid + "','" + Aid + "','" + volume + "','" + issue + "',getdate(),getdate(),getdate(),'UL')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query + Aid);
                        SaveToReport("Status: insert dummy FP entry trnsjournal table " + Aid);
                        string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                        Query = "Insert into trnsjournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) Values(" + artid + ",1,'Administration',getdate(),getdate(),'14','Completed','33','Earticle closing','Auto Entry',getdate(),1,'Pending')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query + " " + Aid);
                    }
                    string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                    if (uploaddate == "")
                    {
                        //SendMail(Aid, "Dear Team,<Br/><Br/>'Artcl_UploadedDt not updated.: ", "COB", true, stage, Zipname);
                        //SaveToReport("Artcl_UploadedDt not updated: " + Aid + " " + Path.GetFileName(Zipname));
                        SaveToReport("Status: Update uploaded date status article table " + Aid);
                        Query = "update Article set Artcl_UploadedDt=getdate(),Artcl_Status='UL' where Artcl_ArticleId='" + Aid + @"'";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query + " " + Aid);
                    }
                    //JR_Articles 
                    string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','17','38',getdate(),'1')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + Path.GetFileName(Zipname));
                    SaveToReport("Status: Revises 1 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                    //TrnsJournalRev 
                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','17',getdate(),'1','Revises 1','Pending')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + Path.GetFileName(Zipname));
                    SaveToReport("Status: revises 1 update Article Table file: " + Path.GetFileName(Zipname));
                    Query = "update Article set Artcl_Volume='" + volume + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "COB", false, stage); 
                }
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                string Outpath = @"\\Techsetserver2\Journal\COB\" + JournalAcronym + @"\ISSUE\" + volume + "-" + issue + @"\DataSupplied\Revises 1\" + Path.GetFileName(Zipname);
                //if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                //File.Copy(Zipname, Outpath, true);
                File.Copy(Zipname, @"D:\WatchTXT\" + Path.GetFileName(Zipname), true);
                File.WriteAllText(@"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(Zipname) + @".txt", @"D:\WatchTXT\" + Path.GetFileName(Zipname) + @"~" + Outpath);
                File.Delete(Zipname);
                //SendMail(Path.GetFileNameWithoutExtension(Zipname), "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "COB", false, stage);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "COB", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }
        //***
        public void Book_Issue_SAGE(string CL, string file = "")
        {
            string stage = "Issue Booking", AUTUStatus = "25";
            string xlloc = "";
            string volume = "", issue = "", JournalAcronym = "";
            int tat = 1;
            System.Collections.ArrayList ArticleID = new System.Collections.ArrayList();
            DBClass Db = new DBClass();
            try
            {
                if (file != "")
                {
                    Zipname = file;
                    JournalAcronym = Path.GetFileNameWithoutExtension(Zipname).Split('_')[0].ToUpper();
                    volume = Path.GetFileNameWithoutExtension(Zipname).Split('_')[1];
                    issue = Path.GetFileNameWithoutExtension(Zipname).Split('_')[2];
                    string Q = "select JRA_ArticleID from JR_Articles left outer join JR_Stage_Tran on JRA_JRST_ID=JRST_ID left outer join   JR_Main on  JRST_JRM_ID=JRM_ID where JRM_Volume='" + volume + "' and JRM_Issue='" + issue + "' and isnull(JRM_ArticleID,'')='' and JRM_JournalID =(select jrnl_id from journal where Jrnl_Acronym='" + JournalAcronym + "' and Jrnl_PublID='4') and JRA_StageID='38'";
                    Db.Sqladptr = new SqlDataAdapter(new SqlCommand(Q, Db.GetConnection()));
                    Db.dt = new DataTable();
                    Db.Sqladptr.Fill(Db.dt);
                    Db.CloseConnection();
                    DataSet ds = new DataSet("New_DataSet");
                    ds.Tables.Add(Db.dt);
                    var rows = ds.Tables[0].Rows;
                    for (int j = 0; j < rows.Count; j++)
                    {
                        ArticleID.Add(rows[j][0].ToString());
                    }
                    if (ArticleID.Count == 0)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Revises 1 stage not booked: ", "SAGE", true, stage, Zipname);
                        SaveToReport("Revises 1 stage not booked: " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                }
                else
                {
                    if (Directory.GetFiles(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), "*.xls*", SearchOption.AllDirectories).Count() > 0)
                    {
                        foreach (string fn in Directory.GetFiles(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), "*.xls*", SearchOption.AllDirectories))
                        {
                            if (fn.ToLower().Contains("running") || fn.ToLower().Contains("order"))
                            {
                                xlloc = fn;
                                break;
                            }
                        }
                    }
                    else
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>XL file missing for SAGE: " + Path.GetFileName(Zipname), "SAGE", true, stage, Zipname);
                        SaveToReport("XML file missing for:  " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    if (xlloc == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>XL file missing for SAGE: " + Path.GetFileName(Zipname), "SAGE", true, stage, Zipname);
                        SaveToReport("XML file missing for:  " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    SaveToReport("Status: Processing excel file: " + xlloc);
                    SaveToReport("Status: Collecting data from excel file: " + xlloc);
                    Xl.Workbook xlWorkBook;
                    Xl.Worksheet xlWorkSheet;
                    Xl.Application xlapp;
                    xlapp = new Xl.Application();
                    xlapp.Visible = false;
                    xlWorkBook = xlapp.Workbooks.Open(xlloc);
                    xlWorkSheet = (Xl.Worksheet)xlWorkBook.Sheets[1];
                    int lastRow = xlWorkSheet.Cells.SpecialCells(Xl.XlCellType.xlCellTypeLastCell).Row;
                    System.Array MyValues = (System.Array)xlWorkSheet.get_Range("A1", "G" + lastRow.ToString()).Cells.Value;
                    int ros = MyValues.GetLength(0);
                    int cos = MyValues.GetLength(1);
                    xlapp.Quit();
                    xlapp = null;
                    GC.Collect();
                    GC.WaitForPendingFinalizers();
                    foreach (Process P in Process.GetProcessesByName("EXCEL"))
                    {
                        try
                        {
                            P.Kill();
                        }
                        catch (Exception e) { }
                    }
                    if (MyValues.GetValue(6, 4).ToString().Replace("\n", "").Replace("\r", "").ToLower() != "content type")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick Article. Please check its position in excel.", "SAGE", true, stage, Zipname);
                        SaveToReport("Unable to pick Article. Please check its position in excel: " + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    volume = Path.GetFileNameWithoutExtension(Zipname).Split(' ')[1].Split('.')[0]; issue = Path.GetFileNameWithoutExtension(Zipname).Split(' ')[1].Split('.')[1]; JournalAcronym = Path.GetFileNameWithoutExtension(Zipname).Split(' ')[0];
                    if (volume == "" || issue == "" || JournalAcronym == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick Volume/Journal Acronym/Issue/Stage. Please check its position in excel.", "SAGE", true, stage, Zipname);
                        SaveToReport("Unable to pick Volume/Journal Acronym/Issue/Stage. Please check its position in excel: " + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    JournalAcronym = JournalAcronym.ToUpper();
                    for (int i = 7; i <= ros; i++)
                    {
                        string val = "";
                        try
                        {
                            val = MyValues.GetValue(i, 1).ToString();
                        }
                        catch (Exception e1)
                        {
                            val = "";
                            break;
                        }
                        if (MyValues.GetValue(i, 4).ToString().Split('-').Length == 0 || MyValues.GetValue(i, 4).ToString().Split('-').Length != 2 || !Regex.IsMatch(MyValues.GetValue(i, 4).ToString().Split('-')[1].Trim(), @"^\d+$")) { continue; }
                        string artid = JournalAcronym + MyValues.GetValue(i, 4).ToString().Split('-')[1].Trim();
                        if (ArticleID.Contains(artid))
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Duplicate id present in excel." + MyValues.GetValue(i, 4).ToString(), "SAGE", true, stage, Zipname);
                            SaveToReport("Duplicate id present in excel." + MyValues.GetValue(i, 4).ToString() + Path.GetFileName(Zipname));
                            //Move to Error
                            Clear();
                            return;
                        }
                        else ArticleID.Add(artid);
                    }
                    if (ArticleID.Count == 0)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>No articles present.", "SAGE", true, stage, Zipname);
                        SaveToReport("No articles present." + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    ArticleID.Add(JournalAcronym + "_" + volume + "_" + issue + "_TOC");
                    ArticleID.Add(JournalAcronym + "_" + volume + "_" + issue + "_COVER");
                }
                string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + JournalAcronym + "' AND Jrnl_PublID='4'");
                if (Journalid == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Journal not found." + JournalAcronym, "SAGE", true, stage, Zipname);
                    SaveToReport("Journal not found. " + JournalAcronym + "  " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,LastModifiedDate,UsrID,Insert_Date, JRM_Volume, JRM_Issue) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"',getdate(),'1',getdate(),'" + volume + "','" + issue + "')";
                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                if (JRM_Id == "")
                {
                    JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                }
                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                string stid = "";
                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=38") != "")
                {
                    if (file == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Revises 1: ", "SAGE", true, stage, Zipname);
                        SaveToReport("File already booked for Revises 1: " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=39") != "")
                    {
                        //SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Revises 2: ", "SAGE", true, stage, Zipname);
                        //SaveToReport("File already booked for Revises 2: " + Path.GetFileName(Zipname));
                        //Clear();
                        //return;
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=40") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=99") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=101") != "")
                                {
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Revises 5: ", "SAGE", true, stage, Zipname);
                                    SaveToReport("File already booked for Revises 5: " + Path.GetFileName(Zipname));
                                    Clear();
                                    return;
                                }
                                else
                                {
                                    // Revises 5
                                    stage = "Revises 5";
                                    stid = "101";
                                }
                            }
                            else
                            {
                                // Revises 4
                                stage = "Revises 4";
                                stid = "99";
                            }

                        }
                        else
                        {
                            // Revises 3
                            stage = "Revises 3";
                            stid = "40";
                        }
                    }
                    else
                    {
                        // Revises 2                       
                        stage = "Revises 2";
                        stid = "39";
                    }
                }
                else
                {
                    //Revises 1                 
                    stage = "Revises 1";
                    stid = "38"; tat = 2;
                    AUTUStatus = "102";
                }

                string DD = CalculateDueDate("", Db, DateTime.Today, tat).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stid + "','" + DD + "',getdate(),'" + DD + "','" + DD + "','" + AUTUStatus + "',getdate(),'1','')";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                foreach (string Aid in ArticleID)
                {
                    if (!CheckWhetherFileBooked(Aid))
                    {
                        //if (Aid == JournalAcronym + "_" + volume + "_" + issue + "_TOC" || Aid == JournalAcronym + "_" + volume + "_" + issue + "_COVER" || Regex.IsMatch(Aid, JournalAcronym + "_" + volume + "_" + issue + @"_COVER(\d+)", RegexOptions.IgnoreCase) || Aid == JournalAcronym + "_" + volume + "_" + issue + "_FILLER" || Aid == JournalAcronym + "_" + volume + "_" + issue + "_AUTHOR_INDEX")
                        //{
                        SaveToReport("Status: insert dummy FP entry article table " + Aid);
                        Query = "insert into article(Artcl_JrnlId,artcl_articleid,Artcl_Volume,Artcl_Issue,Artcl_UploadedDt,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_Status,Inv_OtherTypesetter) values('" + Journalid + "','" + Aid + "','" + volume + "','" + issue + "',getdate(),getdate(),getdate(),'UL','Y')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query + Aid);
                        SaveToReport("Status: insert dummy FP entry trnsjournal table " + Aid);
                        string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                        Query = "Insert into trnsjournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) Values(" + artid + ",1,'Administration',getdate(),getdate(),'14','Completed','33','Dummy entries','Auto Entry',getdate(),1,'Pending')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query + " " + Aid);
                        //if (!Aid.Contains('_')) tat = 3;
                        //}
                        //else
                        //{
                        //    SendMail(Aid, "Dear Team,<Br/><Br/>First Proof not booked.: " + Aid, "GSA", true, stage, Zipname);
                        //    SaveToReport("First Proof not booked: " + Aid + " " + Path.GetFileName(Zipname));
                        //    continue;
                        //}
                    }
                    string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                    if (uploaddate == "")
                    {
                        SendMail(Aid, "Dear Team,<Br/><Br/>'Artcl_UploadedDt not updated.: " + Aid, "SAGE", true, stage, Zipname);
                        SaveToReport("Artcl_UploadedDt not updated: " + Aid + " " + Path.GetFileName(Zipname));
                        continue;
                    }
                    //JR_Articles 
                    string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stid + "',getdate(),'1')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + Path.GetFileName(Zipname));
                    SaveToReport("Status: " + stage + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                    //TrnsJournalRev 
                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + Path.GetFileName(Zipname));
                    SaveToReport("Status: " + stage + " update Article Table file: " + Path.GetFileName(Zipname));
                    Query = "update Article set Artcl_Volume='" + volume + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "SAGE", false, stage);
                }
                if (tat == 3)
                {
                    DD = CalculateDueDate("", Db, DateTime.Today, tat).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    Query = "update JR_Stage_Tran set JRST_DueDtCats='" + DD + "',JRST_ScheduledDt='" + DD + "',JRST_ExpectedDt='" + DD + "' where JRST_ID='" + (Convert.ToInt64(JRS_Id) + 1) + @"'";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                }
                try
                {
                    Query = @"UPDATE IssueScheduler SET CompletionDate=case when CompletionDate is null then '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss:fff") + "' else CompletionDate end Where  Volume= '" + volume + @"' and Issue=case when ISNUMERIC('" + issue + @"')>0 then '" + issue + @"' else 0 end and isnull(SpecialIssue,'')=case when ISNUMERIC('" + issue + @"')>0 then '' else '" + issue + @"' end and JournalID='" + JournalAcronym + "' and TaskName in    ('TOC generation', 'To NT Production')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection("ASME"));
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                }
                catch (Exception ex)
                {
                    SaveToReport("Status: Error on updating Sesame -  " + Path.GetFileName(Zipname) + ex.Message + " " + ex.StackTrace);

                }
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                string Outpath = @"\\Techsetserver2\Journal\SAGE\" + JournalAcronym + @"\ISSUE\" + volume + "-" + issue + @"\DataSupplied\" + stage + @"\" + Path.GetFileName(Zipname);
                //if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                //File.Copy(Zipname, Outpath, true);
                //SendMail(Path.GetFileNameWithoutExtension(Zipname), "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "SAGE", false, stage);
                try
                {
                    MailMessage MM = new MailMessage();
                    MM = new MailMessage("sagepub@novatechset.com", "gayathri@novatechset.com", JournalAcronym + "_" + volume + "_" + issue + " -- Issue for compilation", "Dear Team,<Br/><Br/>AutoBooking information updated successfully for stage: " + stage + @"<Br/>DueDate: " + DD + @"<Br/>Regards,<Br/>" + ReturnDetail("Jrnl_Contact", "Journal", Db, "Jrnl_Acronym='" + JournalAcronym + "' AND Jrnl_PublID='4'"));
                    if (stage != "Revises 1")
                    {
                        MM = new MailMessage("sagepub@novatechset.com", "gayathri@novatechset.com", JournalAcronym + "_" + volume + "_" + issue + " -- Issue for correction", "Dear Team,<Br/><Br/>AutoBooking information updated successfully for stage: " + stage + @"<Br/>DueDate: " + DD + @"<Br/>Regards,<Br/>" + ReturnDetail("Jrnl_Contact", "Journal", Db, "Jrnl_Acronym='" + JournalAcronym + "' AND Jrnl_PublID='4'"));
                    }
                    //MM.To.Add("gayathri@novatechset.com");
                    MM.To.Add("mastercopy_sage@novatechset.com");
                    //MM.CC.Add("sagepub@novatechset.com");
                    string strPMEmail = ReturnDetail("Jrnl_Email", "Journal", Db, "Jrnl_Acronym='" + JournalAcronym + "' AND Jrnl_PublID='4'");
                    MM.CC.Add(strPMEmail);
                    MM.CC.Add("hassain@novatechset.com");
                    MM.CC.Add("sundar@novatechset.com");
                    MM.CC.Add("ebooks@novatechset.com");
                    MM.CC.Add("vimalak@novatechset.com");
                    SmtpClient client = new SmtpClient(SerializedClass.MailServer);
                    MM.IsBodyHtml = true;
                    if (xlloc != "")
                    {
                        MM.Attachments.Add(new Attachment(xlloc));
                    }
                    client.Send(MM);
                    try
                    {
                        MM.Attachments.Dispose();
                    }
                    catch (Exception ex) { SaveToReport(ex.Message + ex.StackTrace); }
                }
                catch (Exception ex1) { SaveToReport(ex1.Message + ex1.StackTrace); }
                if (stage == "Revises 1")
                {
                    File.Copy(Zipname, @"D:\WatchTXT\" + Path.GetFileName(Zipname), true);
                    File.WriteAllText(@"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(Zipname) + @".txt", @"D:\WatchTXT\" + Path.GetFileName(Zipname) + @"~" + Outpath);
                    Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                }
                File.Delete(Zipname);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "SAGE", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }

        public void Book_NewIssue_SAGE(string CL, string file = "")
        {
            string stage = "Issue Booking", AUTUStatus = "25";
            string xlloc = "";
            string volume = "", issue = "", JournalAcronym = "", page = "0";
            int tat = 1, pid = 0;
            System.Collections.ArrayList ArticleID = new System.Collections.ArrayList();
            System.Collections.ArrayList ArticleID1 = new System.Collections.ArrayList();
            DBClass Db = new DBClass();
            try
            {
                if (file != "")
                {
                    Zipname = file;
                    JournalAcronym = Path.GetFileNameWithoutExtension(Zipname).Split('_')[0].ToUpper();
                    volume = Path.GetFileNameWithoutExtension(Zipname).Split('_')[1];
                    issue = Path.GetFileNameWithoutExtension(Zipname).Split('_')[2];
                    string Q = "select JRA_ArticleID from JR_Articles left outer join JR_Stage_Tran on JRA_JRST_ID=JRST_ID left outer join   JR_Main on  JRST_JRM_ID=JRM_ID where JRM_Volume='" + volume + "' and JRM_Issue='" + issue + "' and isnull(JRM_ArticleID,'')='' and JRM_JournalID =(select jrnl_id from journal where Jrnl_Acronym='" + JournalAcronym + "' and Jrnl_PublID='4') and JRA_StageID='38'";
                    Db.Sqladptr = new SqlDataAdapter(new SqlCommand(Q, Db.GetConnection()));
                    Db.dt = new DataTable();
                    Db.Sqladptr.Fill(Db.dt);
                    Db.CloseConnection();
                    DataSet ds = new DataSet("New_DataSet");
                    ds.Tables.Add(Db.dt);
                    var rows = ds.Tables[0].Rows;
                    for (int j = 0; j < rows.Count; j++)
                    {
                        ArticleID.Add(rows[j][0].ToString());
                    }
                    if (ArticleID.Count == 0)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Revises 1 stage not booked: ", "SAGE", true, stage, Zipname);
                        SaveToReport("Revises 1 stage not booked: " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                }
                else
                {
                    if (Directory.GetFiles(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), "*.xls*", SearchOption.AllDirectories).Count() > 0)
                    {
                        foreach (string fn in Directory.GetFiles(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), "*.xls*", SearchOption.AllDirectories))
                        {
                            if (fn.ToLower().Contains("running") || fn.ToLower().Contains("order"))
                            {
                                xlloc = fn;
                                break;
                            }
                        }
                    }
                    else
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>XL file missing for SAGE: " + Path.GetFileName(Zipname), "SAGE", true, stage, Zipname);
                        SaveToReport("XML file missing for:  " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    if (xlloc == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>XL file missing for SAGE: " + Path.GetFileName(Zipname), "SAGE", true, stage, Zipname);
                        SaveToReport("XML file missing for:  " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    SaveToReport("Status: Processing excel file: " + xlloc);
                    SaveToReport("Status: Collecting data from excel file: " + xlloc);
                    Xl.Workbook xlWorkBook;
                    Xl.Worksheet xlWorkSheet;
                    Xl.Application xlapp;
                    xlapp = new Xl.Application();
                    xlapp.Visible = false;
                    xlWorkBook = xlapp.Workbooks.Open(xlloc);
                    xlWorkSheet = (Xl.Worksheet)xlWorkBook.Sheets[1];
                    int lastRow = xlWorkSheet.Cells.SpecialCells(Xl.XlCellType.xlCellTypeLastCell).Row;
                    System.Array MyValues = (System.Array)xlWorkSheet.get_Range("A1", "J" + lastRow.ToString()).Cells.Value;
                    int ros = MyValues.GetLength(0);
                    int cos = MyValues.GetLength(1);
                    xlapp.Quit();
                    xlapp = null;
                    GC.Collect();
                    GC.WaitForPendingFinalizers();
                    foreach (Process P in Process.GetProcessesByName("EXCEL"))
                    {
                        try
                        {
                            P.Kill();
                        }
                        catch (Exception e) { }
                    }
                    if (MyValues.GetValue(6, 4).ToString().Replace("\n", "").Replace("\r", "").ToLower() != "content type")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick Article. Please check its position in excel.", "SAGE", true, stage, Zipname);
                        SaveToReport("Unable to pick Article. Please check its position in excel: " + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    volume = Path.GetFileNameWithoutExtension(Zipname).Split(' ')[1].Split('.')[0]; issue = Path.GetFileNameWithoutExtension(Zipname).Split(' ')[1].Split('.')[1]; JournalAcronym = Path.GetFileNameWithoutExtension(Zipname).Split(' ')[0];
                    if (volume == "" || issue == "" || JournalAcronym == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick Volume/Journal Acronym/Issue/Stage. Please check its position in excel.", "SAGE", true, stage, Zipname);
                        SaveToReport("Unable to pick Volume/Journal Acronym/Issue/Stage. Please check its position in excel: " + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    JournalAcronym = JournalAcronym.ToUpper();
                    for (int i = 1; i <= 10; i++)
                    {
                        try
                        {
                            if (MyValues.GetValue(6, i).ToString().ToLower() == "pages") { pid = i; break; }
                        }
                        catch (Exception e1)
                        {
                            pid = 0;
                            break;
                        }
                    }
                    for (int i = 7; i <= ros; i++)
                    {
                        string val = "";
                        page = "0";
                        try
                        {
                            val = MyValues.GetValue(i, 1).ToString();
                        }
                        catch (Exception e1)
                        {
                            val = "";
                            break;
                        }
                        if (pid > 0)
                        {
                            try
                            {
                                page = MyValues.GetValue(i, pid).ToString();
                            }
                            catch (Exception e1)
                            {
                                page = "0";
                            }
                        }
                        if (MyValues.GetValue(i, 4).ToString().Split('-').Length == 0 || MyValues.GetValue(i, 4).ToString().Split('-').Length != 2 || !Regex.IsMatch(MyValues.GetValue(i, 4).ToString().Split('-')[1].Trim(), @"^(Testing)?\d+$")) { continue; }
                        string artid = JournalAcronym + MyValues.GetValue(i, 4).ToString().Split('-')[1].Trim();
                        if (ArticleID1.Contains(artid))
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Duplicate id present in excel." + MyValues.GetValue(i, 4).ToString(), "SAGE", true, stage, Zipname);
                            SaveToReport("Duplicate id present in excel." + MyValues.GetValue(i, 4).ToString() + Path.GetFileName(Zipname));
                            //Move to Error
                            Clear();
                            return;
                        }
                        else
                        {
                            ArticleID1.Add(artid);
                            ArticleID.Add(artid + ":" + page);
                        }
                    }
                    if (ArticleID.Count == 0)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>No articles present.", "SAGE", true, stage, Zipname);
                        SaveToReport("No articles present." + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    ArticleID.Add(JournalAcronym + "_" + volume + "_" + issue + "_TOC:1");
                    ArticleID.Add(JournalAcronym + "_" + volume + "_" + issue + "_COVER:1");
                }
                string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + JournalAcronym + "' AND Jrnl_PublID='4'");
                if (Journalid == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Journal not found." + JournalAcronym, "SAGE", true, stage, Zipname);
                    SaveToReport("Journal not found. " + JournalAcronym + "  " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,LastModifiedDate,UsrID,Insert_Date, JRM_Volume, JRM_Issue) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"',getdate(),'1',getdate(),'" + volume + "','" + issue + "')";
                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                if (JRM_Id == "")
                {
                    JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                }
                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                string stid = "";
                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=38") != "")
                {
                    if (file == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Revises 1: ", "SAGE", true, stage, Zipname);
                        SaveToReport("File already booked for Revises 1: " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=39") != "")
                    {
                        //SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Revises 2: ", "SAGE", true, stage, Zipname);
                        //SaveToReport("File already booked for Revises 2: " + Path.GetFileName(Zipname));
                        //Clear();
                        //return;
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=40") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=99") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=101") != "")
                                {
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Revises 5: ", "SAGE", true, stage, Zipname);
                                    SaveToReport("File already booked for Revises 5: " + Path.GetFileName(Zipname));
                                    Clear();
                                    return;
                                }
                                else
                                {
                                    // Revises 5
                                    stage = "Revises 5";
                                    stid = "101";
                                }
                            }
                            else
                            {
                                // Revises 4
                                stage = "Revises 4";
                                stid = "99";
                            }

                        }
                        else
                        {
                            // Revises 3
                            stage = "Revises 3";
                            stid = "40";
                        }
                    }
                    else
                    {
                        // Revises 2                       
                        stage = "Revises 2";
                        stid = "39";
                    }
                }
                else
                {
                    //Revises 1                 
                    stage = "Revises 1";
                    stid = "38"; tat = 2;
                    AUTUStatus = "17";
                }

                string DD = CalculateDueDate("", Db, DateTime.Today, tat).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stid + "','" + DD + "',getdate(),'" + DD + "','" + DD + "','" + AUTUStatus + "',getdate(),'1','')";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                foreach (string Aid1 in ArticleID)
                {
                    string Aid = Aid1.Split(':')[0];
                    if (Aid1.Split(':').Length > 1) page = Aid1.Split(':')[1];
                    else page = "0";
                    if (!CheckWhetherFileBooked(Aid))
                    {
                        //if (Aid == JournalAcronym + "_" + volume + "_" + issue + "_TOC" || Aid == JournalAcronym + "_" + volume + "_" + issue + "_COVER" || Regex.IsMatch(Aid, JournalAcronym + "_" + volume + "_" + issue + @"_COVER(\d+)", RegexOptions.IgnoreCase) || Aid == JournalAcronym + "_" + volume + "_" + issue + "_FILLER" || Aid == JournalAcronym + "_" + volume + "_" + issue + "_AUTHOR_INDEX")
                        //{
                        SaveToReport("Status: insert dummy FP entry article table " + Aid);
                        Query = "insert into article(Artcl_JrnlId,artcl_articleid,Artcl_Volume,Artcl_Issue,Artcl_UploadedDt,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_Status,Inv_OtherTypesetter,Proof_Pages) values('" + Journalid + "','" + Aid + "','" + volume + "','" + issue + "',getdate(),getdate(),getdate(),'UL','Y','" + page + "')";
                        if (stage != "Revises 1")
                        {
                            Query = "insert into article(Artcl_JrnlId,artcl_articleid,Artcl_Volume,Artcl_Issue,Artcl_UploadedDt,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_Status,Inv_OtherTypesetter) values('" + Journalid + "','" + Aid + "','" + volume + "','" + issue + "',getdate(),getdate(),getdate(),'UL','Y')";
                        }
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query + Aid);
                        SaveToReport("Status: insert dummy FP entry trnsjournal table " + Aid);
                        string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                        Query = "Insert into trnsjournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) Values(" + artid + ",1,'Administration',getdate(),getdate(),'14','Completed','33','Dummy entries','Auto Entry',getdate(),1,'Pending')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query + " " + Aid);
                        //if (!Aid.Contains('_')) tat = 3;
                        //}
                        //else
                        //{
                        //    SendMail(Aid, "Dear Team,<Br/><Br/>First Proof not booked.: " + Aid, "GSA", true, stage, Zipname);
                        //    SaveToReport("First Proof not booked: " + Aid + " " + Path.GetFileName(Zipname));
                        //    continue;
                        //}
                    }
                    string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                    if (uploaddate == "")
                    {
                        SendMail(Aid, "Dear Team,<Br/><Br/>'Artcl_UploadedDt not updated.: " + Aid, "SAGE", true, stage, Zipname);
                        SaveToReport("Artcl_UploadedDt not updated: " + Aid + " " + Path.GetFileName(Zipname));
                        continue;
                    }
                    //JR_Articles 
                    string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stid + "',getdate(),'1')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + Path.GetFileName(Zipname));
                    SaveToReport("Status: " + stage + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                    //TrnsJournalRev 
                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + Path.GetFileName(Zipname));
                    SaveToReport("Status: " + stage + " update Article Table file: " + Path.GetFileName(Zipname));
                    Query = "update Article set Artcl_Volume='" + volume + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "SAGE", false, stage);
                }
                if (tat == 3)
                {
                    DD = CalculateDueDate("", Db, DateTime.Today, tat).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    Query = "update JR_Stage_Tran set JRST_DueDtCats='" + DD + "',JRST_ScheduledDt='" + DD + "',JRST_ExpectedDt='" + DD + "' where JRST_ID='" + (Convert.ToInt64(JRS_Id) + 1) + @"'";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                }
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                string Outpath = @"\\Techsetserver2\Journal\SAGE\" + JournalAcronym + @"\ISSUE\" + volume + "-" + issue + @"\DataSupplied\" + stage + @"\" + Path.GetFileName(Zipname);
                //if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                //File.Copy(Zipname, Outpath, true);
                //SendMail(Path.GetFileNameWithoutExtension(Zipname), "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "SAGE", false, stage);
                try
                {
                    Query = @"UPDATE IssueScheduler SET CompletionDate=case when CompletionDate is null then '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss:fff") + "' else CompletionDate end Where  Volume= '" + volume + @"' and Issue=case when ISNUMERIC('" + issue + @"')>0 then '" + issue + @"' else 0 end and isnull(SpecialIssue,'')=case when ISNUMERIC('" + issue + @"')>0 then '' else '" + issue + @"' end and JournalID='" + JournalAcronym + "' and TaskName in    ('TOC generation', 'To NT Production')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection("ASME"));
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                }
                catch (Exception ex)
                {
                    SaveToReport("Status: Error on updating Sesame -  " + Path.GetFileName(Zipname) + ex.Message + " " + ex.StackTrace);

                }
                try
                {
                    MailMessage MM = new MailMessage();
                    MM = new MailMessage("sagepub@novatechset.com", "gayathri@novatechset.com", JournalAcronym + "_" + volume + "_" + issue + " -- Issue for compilation", "Dear Team,<Br/><Br/>AutoBooking information updated successfully for stage: " + stage + @"<Br/>DueDate: " + DD + @"<Br/><Br/>Regards,<Br/>" + ReturnDetail("Jrnl_Contact", "Journal", Db, "Jrnl_Acronym='" + JournalAcronym + "' AND Jrnl_PublID='4'"));
                    if (stage != "Revises 1")
                    {
                        MM = new MailMessage("sagepub@novatechset.com", "gayathri@novatechset.com", JournalAcronym + "_" + volume + "_" + issue + " -- Issue for correction", "Dear Team,<Br/><Br/>AutoBooking information updated successfully for stage: " + stage + @"<Br/>DueDate: " + DD + @"<Br/><Br/>Regards,<Br/>" + ReturnDetail("Jrnl_Contact", "Journal", Db, "Jrnl_Acronym='" + JournalAcronym + "' AND Jrnl_PublID='4'"));
                    }
                    //MM.To.Add("gayathri@novatechset.com");
                    MM.To.Add("mastercopy_sage@novatechset.com");
                    string strPMEmail = ReturnDetail("Jrnl_Email", "Journal", Db, "Jrnl_Acronym='" + JournalAcronym + "' AND Jrnl_PublID='4'");
                    MM.CC.Add(strPMEmail);
                    MM.CC.Add("hassain@novatechset.com");
                    MM.CC.Add("sundar@novatechset.com");
                    MM.CC.Add("ebooks@novatechset.com");
                    MM.CC.Add("vimalak@novatechset.com");
                    SmtpClient client = new SmtpClient(SerializedClass.MailServer);
                    MM.IsBodyHtml = true;
                    if (xlloc != "")
                    {
                        MM.Attachments.Add(new Attachment(xlloc));
                    }
                    client.Send(MM);
                    try
                    {
                        MM.Attachments.Dispose();
                    }
                    catch (Exception ex) { SaveToReport(ex.Message + ex.StackTrace); }
                }
                catch (Exception ex1) { SaveToReport(ex1.Message + ex1.StackTrace); }
                if (stage == "Revises 1")
                {
                    File.Copy(Zipname, @"D:\WatchTXT\" + Path.GetFileName(Zipname), true);
                    File.WriteAllText(@"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(Zipname) + @".txt", @"D:\WatchTXT\" + Path.GetFileName(Zipname) + @"~" + Outpath);
                    Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                }
                File.Delete(Zipname);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "SAGE", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }

        //***
        public void Book_Issue_Resupply_SAGE(string CL, string file = "")
        {
            string stage = "Issue Booking", AUTUStatus = "";
            string xlloc = "";
            string volume = "", issue = "", JournalAcronym = "", page = "0", JrsID = "";
            int pid = 0;
            System.Collections.ArrayList ArticleID = new System.Collections.ArrayList();
            System.Collections.ArrayList ArticleIDadded = new System.Collections.ArrayList();
            System.Collections.ArrayList ArticleID1 = new System.Collections.ArrayList();
            DBClass Db = new DBClass();
            try
            {
                if (file != "")
                {
                    Zipname = file;
                    JournalAcronym = Path.GetFileNameWithoutExtension(Zipname).Split('_')[0].ToUpper().Trim();
                    volume = Path.GetFileNameWithoutExtension(Zipname).Split('_')[1].Trim();
                    issue = Path.GetFileNameWithoutExtension(Zipname).Split('_')[2].Trim();
                    string Q = "select JRA_ArticleID,JRST_Status,Jrst_Jrs_ID from JR_Articles Inner join JR_Stage_Tran on JRA_JRST_ID=JRST_ID Inner join   JR_Main on  JRST_JRM_ID=JRM_ID where JRM_Volume='" + volume + "' and JRM_Issue='" + issue + "' and isnull(JRM_ArticleID,'')='' and JRM_JournalID =(select jrnl_id from journal where Jrnl_Acronym='" + JournalAcronym + "' and Jrnl_PublID='4') and JRA_StageID in ('38','39','40') and isnull(JRST_UploadedDT,'')=''";
                    Db.Sqladptr = new SqlDataAdapter(new SqlCommand(Q, Db.GetConnection()));
                    Db.dt = new DataTable();
                    Db.Sqladptr.Fill(Db.dt);
                    Db.CloseConnection();
                    DataSet ds = new DataSet("New_DataSet");
                    ds.Tables.Add(Db.dt);
                    var rows = ds.Tables[0].Rows;
                    for (int j = 0; j < rows.Count; j++)
                    {
                        ArticleIDadded.Add(rows[j][0].ToString());
                        AUTUStatus = rows[j][1].ToString();
                        JrsID = rows[j][2].ToString();
                    }
                    if (ArticleIDadded.Count == 0)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Revises 1 stage not booked: ", "SAGE", true, stage, Zipname);
                        SaveToReport("Revises 1 stage not booked: " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    xlloc = file;
                    SaveToReport("Status: Collecting data from excel file: " + xlloc);
                    Xl.Workbook xlWorkBook;
                    Xl.Worksheet xlWorkSheet;
                    Xl.Application xlapp;
                    xlapp = new Xl.Application();
                    xlapp.Visible = false;
                    xlWorkBook = xlapp.Workbooks.Open(xlloc);
                    xlWorkSheet = (Xl.Worksheet)xlWorkBook.Sheets[1];
                    int lastRow = xlWorkSheet.Cells.SpecialCells(Xl.XlCellType.xlCellTypeLastCell).Row;
                    System.Array MyValues = (System.Array)xlWorkSheet.get_Range("A1", "J" + lastRow.ToString()).Cells.Value;
                    int ros = MyValues.GetLength(0);
                    int cos = MyValues.GetLength(1);
                    xlapp.Quit();
                    xlapp = null;
                    GC.Collect();
                    GC.WaitForPendingFinalizers();
                    foreach (Process P in Process.GetProcessesByName("EXCEL"))
                    {
                        try
                        {
                            P.Kill();
                        }
                        catch (Exception e) { }
                    }
                    if (MyValues.GetValue(6, 4).ToString().Replace("\n", "").Replace("\r", "").ToLower() != "content type")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick Article. Please check its position in excel.", "SAGE", true, stage, Zipname);
                        SaveToReport("Unable to pick Article. Please check its position in excel: " + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    if (volume == "" || issue == "" || JournalAcronym == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick Volume/Journal Acronym/Issue/Stage. Please check its position in excel.", "SAGE", true, stage, Zipname);
                        SaveToReport("Unable to pick Volume/Journal Acronym/Issue/Stage. Please check its position in excel: " + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    JournalAcronym = JournalAcronym.ToUpper();
                    for (int i = 1; i <= 10; i++)
                    {
                        try
                        {
                            if (MyValues.GetValue(6, i).ToString().ToLower() == "pages") { pid = i; break; }
                        }
                        catch (Exception e1)
                        {
                            pid = 0;
                            break;
                        }
                    }
                    for (int i = 7; i <= ros; i++)
                    {
                        string val = "";
                        page = "0";
                        try
                        {
                            val = MyValues.GetValue(i, 1).ToString();
                        }
                        catch (Exception e1)
                        {
                            val = "";
                            break;
                        }
                        if (pid > 0)
                        {
                            try
                            {
                                page = MyValues.GetValue(i, pid).ToString();
                            }
                            catch (Exception e1)
                            {
                                page = "0";
                            }
                        }
                        string artid = "";
                        if (Regex.IsMatch(MyValues.GetValue(i, 4).ToString().Trim(), JournalAcronym + "_" + volume + '_' + issue, RegexOptions.IgnoreCase)) { artid = MyValues.GetValue(i, 4).ToString().Trim(); }
                        else if (MyValues.GetValue(i, 4).ToString().Split('-').Length == 0 || MyValues.GetValue(i, 4).ToString().Split('-').Length != 2 || !Regex.IsMatch(MyValues.GetValue(i, 4).ToString().Split('-')[1].Trim(), @"^(Testing)?\d+$")) { continue; }
                        else
                        {
                            artid = JournalAcronym + MyValues.GetValue(i, 4).ToString().Split('-')[1].Trim();
                        }
                        if (ArticleID1.Contains(artid))
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Duplicate id present in excel." + MyValues.GetValue(i, 4).ToString(), "SAGE", true, stage, Zipname);
                            SaveToReport("Duplicate id present in excel." + MyValues.GetValue(i, 4).ToString() + Path.GetFileName(Zipname));
                            //Move to Error
                            Clear();
                            return;
                        }
                        else
                        {
                            ArticleID1.Add(artid);
                            ArticleID.Add(artid + ":" + page);
                        }
                    }
                    if (ArticleID.Count == 0)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>No articles present.", "SAGE", true, stage, Zipname);
                        SaveToReport("No articles present." + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                }
                string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + JournalAcronym + "' AND Jrnl_PublID='4'");
                if (Journalid == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Journal not found." + JournalAcronym, "SAGE", true, stage, Zipname);
                    SaveToReport("Journal not found. " + JournalAcronym + "  " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                string JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                bool resupply = false;
                if (JRM_Id != "")
                {
                    JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                    string stid = "";
                    string JRS_Id = ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=" + JrsID);
                    if (JRS_Id != "")
                    {
                        JRS_Id = Convert.ToString((Convert.ToInt64(JRS_Id) - 1));
                        stage = "Revises 1";
                        if (JrsID == "39")
                            stage = "Revises 2";
                        if (JrsID == "40")
                            stage = "Revises 3";
                        stid = JrsID;
                        string added = "";
                        foreach (string Aid1 in ArticleID)
                        {
                            added = added + ";" + Aid1;
                            string Aid = Aid1.Split(':')[0];
                            if (Aid1.Split(':').Length > 1) page = Aid1.Split(':')[1];
                            else page = "0";
                            if (!ArticleIDadded.Contains(Aid))
                            {
                                string Query = "";
                                if (!CheckWhetherFileBooked(Aid))
                                {
                                    SaveToReport("Status: insert dummy FP entry article table " + Aid);
                                    Query = "insert into article(Artcl_JrnlId,artcl_articleid,Artcl_Volume,Artcl_Issue,Artcl_UploadedDt,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_Status,Inv_OtherTypesetter,Proof_Pages) values('" + Journalid + "','" + Aid + "','" + volume + "','" + issue + "',getdate(),getdate(),getdate(),'UL','Y','" + page + "')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: " + Query + Aid);
                                    SaveToReport("Status: insert dummy FP entry trnsjournal table " + Aid);
                                    string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                    Query = "Insert into trnsjournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) Values(" + artid + ",1,'Administration',getdate(),getdate(),'14','Completed','33','Dummy entries','Auto Entry',getdate(),1,'Pending')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: " + Query + " " + Aid);
                                }
                                string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                                if (uploaddate == "")
                                {
                                    SendMail(Aid, "Dear Team,<Br/><Br/>'Artcl_UploadedDt not updated.: " + Aid, "SAGE", true, stage, Zipname);
                                    SaveToReport("Artcl_UploadedDt not updated: " + Aid + " " + Path.GetFileName(Zipname));
                                    continue;
                                }
                                //JR_Articles 
                                string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stid + "',getdate(),'1')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: " + Query + Path.GetFileName(Zipname));
                                SaveToReport("Status: " + stage + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                //TrnsJournalRev 
                                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: " + Query + Path.GetFileName(Zipname));
                                SaveToReport("Status: " + stage + " update Article Table file: " + Path.GetFileName(Zipname));
                                Query = "update Article set Artcl_Volume='" + volume + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                                if (page != "0" && page != ReturnDetail("Proof_Pages", "Article", Db, "Artcl_ArticleId='" + Aid + @"'"))
                                {
                                    Query = "update Article set Artcl_Volume='" + volume + "',Artcl_Issue='" + issue + "',Proof_Pages='" + page + "' where Artcl_ArticleId='" + Aid + @"'";
                                }
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "SAGE", false, stage);
                                resupply = true;
                            }
                            else
                            {
                                if (page != "0" && page != ReturnDetail("Proof_Pages", "Article", Db, "Artcl_ArticleId='" + Aid + @"'"))
                                {
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand("update Article set Proof_Pages='" + page + "' where Artcl_ArticleId='" + Aid + @"'", Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: update Article set Proof_Pages='" + page + "' where Artcl_ArticleId='" + Aid + @"' " + Path.GetFileName(Zipname));
                                    resupply = true;
                                }
                            }
                        }
                        foreach (string Aid1 in ArticleIDadded)
                        {
                            if (!added.Contains(Aid1 + ":") && !Aid1.Contains("_COVER") && !Aid1.Contains("_TOC"))
                            {
                                string JRA_ID = ReturnDetail("JRA_ID", "JR_Articles", Db, "JRA_JRST_ID='" + (Convert.ToInt64(JRS_Id) + 1) + @"' and JRA_ArticleID='" + Aid1 + @"' and JRA_StageID='" + stid + "'");
                                if (JRA_ID != "")
                                {
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand("delete from TrnsJournalRev where JrnlTrns_ArticleId='" + JRA_ID + "' delete from JR_Articles where JRA_ID='" + JRA_ID + "'", Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: delete from TrnsJournalRev where JrnlTrns_ArticleId='" + JRA_ID + "' delete from JR_Articles where JRA_ID='" + JRA_ID + "' " + Path.GetFileName(Zipname));
                                }
                                SaveToReport("Status: " + stage + " update Article Table file: " + Path.GetFileName(Zipname));
                                if (ReturnDetail("Artcl_id", "Article", Db, "Artcl_Volume='" + volume + "' and Artcl_Issue='" + issue + "' and Artcl_ArticleId='" + Aid1 + @"'") != "")
                                {
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand("update Article set Artcl_Volume='',Artcl_Issue='' where Artcl_ArticleId='" + Aid1 + @"'", Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: update Article set Artcl_Volume='',Artcl_Issue='' where Artcl_ArticleId='" + Aid1 + @"' " + Path.GetFileName(Zipname));
                                    resupply = true;
                                }
                            }
                        }
                        if (resupply)
                        {
                            SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                            if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                            {
                                Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                            }
                            File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                            string Outpath = @"\\Techsetserver2\Journal\SAGE\" + JournalAcronym + @"\ISSUE\" + volume + "-" + issue + @"\DataSupplied\" + stage + @"\" + Path.GetFileName(Zipname);
                            //if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                            //File.Copy(Zipname, Outpath, true);
                            //SendMail(Path.GetFileNameWithoutExtension(Zipname), "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file issue resupply excel: " + Path.GetFileName(Zipname), "SAGE", false, stage);
                            //try
                            //{
                            //    MailMessage MM = new MailMessage();
                            //    MM = new MailMessage("sagepub@novatechset.com", "rajeshkannah@novatechset.com", JournalAcronym + "_" + volume + "_" + issue + " -- Issue for compilation - Resupply", "Dear Team,<Br/><Br/>AutoBooking information updated successfully for stage: " + stage + @"<Br/><Br/>Regards,<Br/>" + ReturnDetail("Jrnl_Contact", "Journal", Db, "Jrnl_Acronym='" + JournalAcronym + "' AND Jrnl_PublID='4'"));
                            //    MM.To.Add("gayathri@novatechset.com");
                            //    MM.To.Add("mastercopy_sage@novatechset.com");
                            //    MM.CC.Add("sagepub@novatechset.com");
                            //    MM.CC.Add("hassain@novatechset.com");
                            //    MM.CC.Add("sundar@novatechset.com");
                            //    SmtpClient client = new SmtpClient(SerializedClass.MailServer);
                            //    MM.IsBodyHtml = true;
                            //    if (xlloc != "")
                            //    {
                            //        MM.Attachments.Add(new Attachment(xlloc));
                            //    }
                            //    client.Send(MM);
                            //    try
                            //    {
                            //        MM.Attachments.Dispose();
                            //    }
                            //    catch (Exception ex) { SaveToReport(ex.Message + ex.StackTrace); }
                            //}
                            //catch (Exception ex1) { SaveToReport(ex1.Message + ex1.StackTrace); }
                            if (stage == "Revises 1")
                            {
                                File.Copy(Zipname, @"D:\WatchTXT\" + Path.GetFileName(Zipname), true);
                                File.WriteAllText(@"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(Zipname) + @".txt", @"D:\WatchTXT\" + Path.GetFileName(Zipname) + @"~" + Outpath);
                            }
                            File.Delete(Zipname);
                            SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
                        }
                        else
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>No additional articles found in issue resupply excel: " + Path.GetFileName(Zipname), "SAGE", true, stage, Zipname);
                            SaveToReport("No additional articles found in  issue resupply excel: " + Path.GetFileName(Zipname));
                            Clear();
                        }
                    }
                    else
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Revises 1 stage not booked issue resupply excel: ", "SAGE", true, stage, Zipname);
                        SaveToReport("Revises 1 stage not booked issue resupply excel: " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                }
                else
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Revises 1 stage not booked issue resupply excel: ", "SAGE", true, stage, Zipname);
                    SaveToReport("Revises 1 stage not booked issue resupply excel: " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file issue resupply excel: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "SAGE", true, stage, Zipname);
                SaveToReport("Error while booking file issue resupply excel: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }

        public void Book_Issue_SAGE_Printer(string CL, string file)
        {
            Zipname = file;
            string stage = "Issue Booking", AUTUStatus = "25";
            DBClass Db = new DBClass();
            try
            {
                string JournalAcronym = Path.GetFileNameWithoutExtension(Zipname).Split('_')[0].ToUpper();
                string volume = Path.GetFileNameWithoutExtension(Zipname).Split('_')[1];
                string issue = Path.GetFileNameWithoutExtension(Zipname).Split('_')[2];
                System.Collections.ArrayList ArticleID = new System.Collections.ArrayList();
                string Q = "select JRA_ArticleID from JR_Articles left outer join JR_Stage_Tran on JRA_JRST_ID=JRST_ID left outer join   JR_Main on  JRST_JRM_ID=JRM_ID where JRM_Volume='" + volume + "' and JRM_Issue='" + issue + "' and isnull(JRM_ArticleID,'')='' and JRM_JournalID =(select jrnl_id from journal where Jrnl_Acronym='" + JournalAcronym + "' and Jrnl_PublID='4') and JRA_StageID='38'";
                Db.Sqladptr = new SqlDataAdapter(new SqlCommand(Q, Db.GetConnection()));
                Db.dt = new DataTable();
                Db.Sqladptr.Fill(Db.dt);
                Db.CloseConnection();
                DataSet ds = new DataSet("New_DataSet");
                ds.Tables.Add(Db.dt);
                var rows = ds.Tables[0].Rows;
                for (int j = 0; j < rows.Count; j++)
                {
                    ArticleID.Add(rows[j][0].ToString());
                }
                if (ArticleID.Count == 0)
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Revises 1 stage not booked: ", "SAGE", true, stage, Zipname);
                    SaveToReport("Revises 1 stage not booked: " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
                string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + JournalAcronym + "' AND Jrnl_PublID='4'");
                string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,LastModifiedDate,UsrID,Insert_Date, JRM_Volume, JRM_Issue) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"',getdate(),'1',getdate(),'" + volume + "','" + issue + "')";
                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                if (JRM_Id == "")
                {
                    JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                }
                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                string stid = "", stid1 = "", stage1 = "";
                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=42") != "")
                {
                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=57") != "")
                    {
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=71") != "")
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Printer Files 3: ", "SAGE", true, stage, Zipname);
                            SaveToReport("File already booked for Printer Files 3: " + Path.GetFileName(Zipname));
                            //Move to Error
                            Clear();
                            return;
                        }
                        else
                        {
                            stage = "Printer Files 3";
                            stid = "71";
                            stage1 = "Final Web Delivery 3";
                            stid1 = "125";
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND isnull(JRST_UploadedDT,'')='' AND (JRST_JRS_ID=50 or JRST_JRS_ID=57) ") != "")
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Printer Files 2/Final Web Delivery 2 & not closed yet.", "SAGE", true, stage, Zipname);
                                SaveToReport("File already booked for Printer Files 2/Final Web Delivery 2 & not closed yet: " + Path.GetFileName(Zipname));
                                Clear();
                                return;
                            }
                        }
                    }
                    else
                    {
                        stage = "Printer Files 2";
                        stid = "57";
                        stage1 = "Final Web Delivery 2";
                        stid1 = "50";
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND isnull(JRST_UploadedDT,'')='' AND (JRST_JRS_ID=43 or JRST_JRS_ID=42) ") != "")
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Printer Files/Final Web Delivery & not closed yet.", "SAGE", true, stage, Zipname);
                            SaveToReport("File already booked for Printer Files/Final Web Delivery & not closed yet: " + Path.GetFileName(Zipname));
                            Clear();
                            return;
                        }
                    }
                }
                else
                {
                    stage = "Printer Files";
                    stid = "42";
                    stage1 = "Final Web Delivery";
                    stid1 = "43";
                }
                string DD = CalculateDueDate("", Db, DateTime.Today, 1).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stid + "','" + DD + "',getdate(),'" + DD + "','" + DD + "','" + AUTUStatus + "',getdate(),'1','')";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                foreach (string Aid in ArticleID)
                {
                    string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stid + "',getdate(),'1')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + Path.GetFileName(Zipname));
                    SaveToReport("Status: " + stage + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                    //TrnsJournalRev 
                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + Path.GetFileName(Zipname));
                    //SaveToReport("Status: " + stage + " update Article Table file: " + Path.GetFileName(Zipname));
                    //Query = "update Article set Artcl_Volume='" + volume + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                    //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    //Db.OpenConnection();
                    //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    //Db.SqlReader.Close();
                    //SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "SAGE", false, stage);
                }
                stid = stid1;
                string st = stage;
                stage = stage1;
                AUTUStatus = "20";
                JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stid + "','" + DD + "',getdate(),'" + DD + "','" + DD + "','" + AUTUStatus + "',getdate(),'1','')";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                foreach (string Aid in ArticleID)
                {
                    string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stid + "',getdate(),'1')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + Path.GetFileName(Zipname));
                    SaveToReport("Status: " + stage + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                    //TrnsJournalRev 
                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + Path.GetFileName(Zipname));
                    //SaveToReport("Status: " + stage + " update Article Table file: " + Path.GetFileName(Zipname));
                    //Query = "update Article set Artcl_Volume='" + volume + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                    //Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    //Db.OpenConnection();
                    //Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    //Db.SqlReader.Close();
                    //SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "SAGE", false, stage);
                }
                if (Path.GetExtension(Zipname).ToLower() == ".zip")
                {
                    try
                    {
                        string serverPath = @"\\techsetserver2\Journal\SAGE\" + JournalAcronym + @"\ISSUE\" + volume + "-" + issue + @"\DataSupplied\Printer Files\";
                        File.Copy(Zipname, serverPath + Path.GetFileName(Zipname));
                        ExtractZip(serverPath + Path.GetFileName(Zipname));
                    }
                    catch (Exception ex11) { SaveToReport(ex11.Message + ex11.StackTrace); }

                }
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                File.Delete(Zipname);
                //Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                //SendMail(Path.GetFileNameWithoutExtension(Zipname), "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "SAGE", false, stage);
                try
                {
                    MailMessage MM = new MailMessage();
                    MM = new MailMessage("sagepub@novatechset.com", "gayathri@novatechset.com", JournalAcronym + "_" + volume + "_" + issue + " -- Issue approved for printer and online", "Dear Team,<Br/><Br/>AutoBooking information updated successfully for stage: " + st + " " + stage1 + @"<Br/>DueDate: " + DD + @"<Br/><Br/>Regards,<Br/>" + ReturnDetail("Jrnl_Contact", "Journal", Db, "Jrnl_Acronym='" + JournalAcronym + "' AND Jrnl_PublID='4'"));
                    //MM.To.Add("gayathri@novatechset.com");
                    MM.To.Add("mastercopy_sage@novatechset.com");
                    string strPMEmail = ReturnDetail("Jrnl_Email", "Journal", Db, "Jrnl_Acronym='" + JournalAcronym + "' AND Jrnl_PublID='4'");
                    MM.CC.Add(strPMEmail);
                    MM.CC.Add("hassain@novatechset.com");
                    MM.CC.Add("sundar@novatechset.com");
                    MM.CC.Add("ebooks@novatechset.com");
                    MM.CC.Add("vimalak@novatechset.com");
                    SmtpClient client = new SmtpClient(SerializedClass.MailServer);
                    MM.IsBodyHtml = true;
                    client.Send(MM);
                }
                catch (Exception ex1) { SaveToReport(ex1.Message + ex1.StackTrace); }
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "SAGE", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }

        //***
        public void Book_Issue_GSA(string xlloc, string CL)
        {
            string stage = "Issue Booking", filler = "", AI = "", erra = "";
            DBClass Db = new DBClass();
            try
            {
                Zipname = xlloc;
                SaveToReport("Status: Processing excel file: " + xlloc);
                SaveToReport("Status: Collecting data from excel file: " + xlloc);
                Xl.Workbook xlWorkBook;
                Xl.Worksheet xlWorkSheet;
                Xl.Application xlapp;
                xlapp = new Xl.Application();
                xlapp.Visible = false;
                xlWorkBook = xlapp.Workbooks.Open(xlloc);
                xlWorkSheet = (Xl.Worksheet)xlWorkBook.Sheets[1];
                int lastRow = xlWorkSheet.Cells.SpecialCells(Xl.XlCellType.xlCellTypeLastCell).Row;
                System.Array MyValues = (System.Array)xlWorkSheet.get_Range("A1", "C" + lastRow.ToString()).Cells.Value;
                int ros = MyValues.GetLength(0);
                int cos = MyValues.GetLength(1);
                xlapp.Quit();
                xlapp = null;
                GC.Collect();
                GC.WaitForPendingFinalizers();
                foreach (Process P in Process.GetProcessesByName("EXCEL"))
                {
                    try
                    {
                        P.Kill();
                    }
                    catch (Exception e) { }
                }
                if (MyValues.GetValue(1, 1).ToString().Replace("\n", "").Replace("\r", "").ToLower() != "journal")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick journal acronym. Please check its position in excel.", "GSA", true, stage, Zipname);
                    SaveToReport("Unable to pick Issue. Please check its position in excel: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                else if (MyValues.GetValue(2, 1).ToString().ToLower() != "volume")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick Volume. Please check its position in excel.", "GSA", true, stage, Zipname);
                    SaveToReport("Unable to pick Issue. Please check its position in excel: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                else if (MyValues.GetValue(3, 1).ToString().ToLower() != "issue")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick Issue. Please check its position in excel.", "GSA", true, stage, Zipname);
                    SaveToReport("Unable to pick Issue. Please check its position in excel: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                else if (MyValues.GetValue(4, 1).ToString().ToLower() != "stage")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick stage. Please check its position in excel.", "GSA", true, stage, Zipname);
                    SaveToReport("Unable to pick Issue. Please check its position in excel: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                string volume = MyValues.GetValue(2, 2).ToString(), issue = MyValues.GetValue(3, 2).ToString(), JournalAcronym = MyValues.GetValue(1, 2).ToString(), sta = MyValues.GetValue(4, 2).ToString();
                if (volume == "" || issue == "" || JournalAcronym == "" || sta == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick Volume/Journal Acronym/Issue/Stage. Please check its position in excel.", "GSA", true, stage, Zipname);
                    SaveToReport("Unable to pick Volume/Journal Acronym/Issue/Stage. Please check its position in excel: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                JournalAcronym = JournalAcronym.ToUpper();
                System.Collections.ArrayList ArticleID = new System.Collections.ArrayList();
                for (int i = 7; i <= ros; i++)
                {
                    string val = "";
                    try
                    {
                        val = MyValues.GetValue(i, 1).ToString();
                        if (val.ToLower() == "filler")
                        { filler = "Y"; continue; }
                        else if (val.ToLower() == "author index")
                        { AI = "Y"; continue; }
                        else if (val.ToLower() == "erratum")
                        { erra = "Y"; continue; }
                        else if (val.ToLower() != "article")
                        { continue; }
                    }
                    catch (Exception e1)
                    {
                        val = "";
                        break;
                    }
                    //string artid = MyValues.GetValue(i, 3).ToString() + '-' + MyValues.GetValue(i, 2).ToString();
                    string artid = MyValues.GetValue(i, 3).ToString();
                    string cnt = ReturnDetail("count(*) as id", "Article", Db, "Artcl_JrnlId in (select Jrnl_Id from Journal where Jrnl_PublID='107') and Artcl_ArticleId like'" + artid + "%'");
                    if (Convert.ToInt16(cnt) > 1)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>" + Path.GetFileNameWithoutExtension(Zipname) + @" Multiple articles found for GSA: ", "GSA", true, stage, artid);
                        SaveToReport("Multiple articles found for:  " + Path.GetFileName(Zipname));
                        continue;
                    }
                    else if (Convert.ToInt16(cnt) == 0) artid = MyValues.GetValue(i, 3).ToString() + '-' + MyValues.GetValue(i, 2).ToString();
                    else artid = ReturnDetail("Artcl_ArticleId", "Article", Db, "Artcl_JrnlId in (select Jrnl_Id from Journal where Jrnl_PublID='107') and Artcl_ArticleId like'" + artid + "%'");
                    if (ArticleID.Contains(artid))
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Duplicate id present in excel." + MyValues.GetValue(i, 3).ToString(), "GSA", true, stage, Zipname);
                        SaveToReport("Duplicate id present in excel." + MyValues.GetValue(i, 3).ToString() + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    else ArticleID.Add(artid);
                }
                if (ArticleID.Count == 0)
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>No articles present.", "GSA", true, stage, Zipname);
                    SaveToReport("No articles present." + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                ArticleID.Add(JournalAcronym + "_" + volume + "_" + issue + "_TOC");
                ArticleID.Add(JournalAcronym + "_" + volume + "_" + issue + "_COVER");
                if (filler == "Y") ArticleID.Add(JournalAcronym + "_" + volume + "_" + issue + "_FILLER");
                if (AI == "Y") ArticleID.Add(JournalAcronym + "_" + volume + "_" + issue + "_AUTHOR_INDEX");
                if (erra == "Y") ArticleID.Add(JournalAcronym + "_" + volume + "_" + issue + "_ERRATUM");
                string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + JournalAcronym + "' AND Jrnl_PublID='107'");
                string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,LastModifiedDate,UsrID,Insert_Date, JRM_Volume, JRM_Issue) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"',getdate(),'1',getdate(),'" + volume + "','" + issue + "')";
                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                if (JRM_Id == "")
                {
                    JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                }
                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                string stid = "";
                if (sta.Trim().ToLower() != "revises" && sta.Trim().ToLower() != "printer")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to identify stages.", "GSA", true, stage, Zipname);
                    SaveToReport("Unable to identify stages." + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
                switch (sta.Trim().ToLower())
                {
                    case "revises":
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=38") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=39") != "")
                                {
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=40") != "")
                                    {
                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=99") != "")
                                        {
                                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=101") != "")
                                            {
                                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Revises 5: ", "GSA", true, stage, Zipname);
                                                SaveToReport("File already booked for Revises 5: " + Path.GetFileName(Zipname));
                                                Clear();
                                                return;
                                            }
                                            else
                                            {
                                                // Revises 5
                                                stage = "Revises 5";
                                                stid = "101";
                                            }
                                        }
                                        else
                                        {
                                            // Revises 4
                                            stage = "Revises 4";
                                            stid = "99";
                                        }

                                    }
                                    else
                                    {
                                        // Revises 3
                                        stage = "Revises 3";
                                        stid = "40";
                                    }
                                }
                                else
                                {
                                    // Revises 2                       
                                    stage = "Revises 2";
                                    stid = "39";
                                }
                            }
                            else
                            {
                                //Revises 1                 
                                stage = "Revises 1";
                                stid = "38";
                            }
                            break;
                        }
                    case "printer":
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=42") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=57") != "")
                                {
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=71") != "")
                                    {
                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Printer Files 3: ", "GSA", true, stage, Zipname);
                                        SaveToReport("File already booked for Printer Files 3: " + Path.GetFileName(Zipname));
                                        //Move to Error
                                        Clear();
                                        return;
                                    }
                                    else
                                    {
                                        stage = "Printer Files 3";
                                        stid = "71";
                                    }
                                }
                                else
                                {
                                    stage = "Printer Files 2";
                                    stid = "57";
                                }
                            }
                            else
                            {
                                stage = "Printer Files";
                                stid = "42";
                            }
                        }
                        break;
                }

                string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stid + "',getdate(),getdate(),getdate(),getdate(),'25',getdate(),'1','')";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                foreach (string Aid in ArticleID)
                {
                    if (!CheckWhetherFileBooked(Aid))
                    {
                        if (Aid == JournalAcronym + "_" + volume + "_" + issue + "_TOC" || Aid == JournalAcronym + "_" + volume + "_" + issue + "_COVER" || Regex.IsMatch(Aid, JournalAcronym + "_" + volume + "_" + issue + @"_COVER(\d+)", RegexOptions.IgnoreCase) || Aid == JournalAcronym + "_" + volume + "_" + issue + "_FILLER" || Aid == JournalAcronym + "_" + volume + "_" + issue + "_AUTHOR_INDEX")
                        {
                            SaveToReport("Status: insert dummy FP entry article table " + Aid);
                            Query = "insert into article(Artcl_JrnlId,artcl_articleid,Artcl_Volume,Artcl_Issue,Artcl_UploadedDt,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_Status) values('" + Journalid + "','" + Aid + "','" + volume + "','" + issue + "',getdate(),getdate(),getdate(),'UL')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: " + Query + Aid);
                            SaveToReport("Status: insert dummy FP entry trnsjournal table " + Aid);
                            string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                            Query = "Insert into trnsjournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) Values(" + artid + ",1,'Administration',getdate(),getdate(),'14','Completed','33','Earticle closing','Auto Entry',getdate(),1,'Pending')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: " + Query + " " + Aid);
                        }
                        else
                        {
                            SendMail(Aid, "Dear Team,<Br/><Br/>First Proof not booked.: " + Aid, "GSA", true, stage, Zipname);
                            SaveToReport("First Proof not booked: " + Aid + " " + Path.GetFileName(Zipname));
                            continue;
                        }
                    }
                    string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                    if (uploaddate == "")
                    {
                        SendMail(Aid, "Dear Team,<Br/><Br/>'Artcl_UploadedDt not updated.: " + Aid, "GSA", true, stage, Zipname);
                        SaveToReport("Artcl_UploadedDt not updated: " + Aid + " " + Path.GetFileName(Zipname));
                        continue;
                    }
                    //JR_Articles 
                    string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','25','" + stid + "',getdate(),'1')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + Path.GetFileName(Zipname));
                    SaveToReport("Status: " + stage + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                    //TrnsJournalRev 
                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','25',getdate(),'1','" + stage + "','Pending')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + Path.GetFileName(Zipname));
                    SaveToReport("Status: " + stage + " update Article Table file: " + Path.GetFileName(Zipname));
                    Query = "update Article set Artcl_Volume='" + volume + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "GSA", false, stage);
                }
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                string Outpath = @"\\Techsetserver2\Journal\GSA\" + JournalAcronym + @"\ISSUE\" + volume + "-" + issue + @"\DataSupplied\" + stage + @"\" + Path.GetFileName(Zipname);
                //if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                //File.Copy(Zipname, Outpath, true);
                if (!Regex.IsMatch(stage.ToLower(), "printer"))
                {
                    File.Copy(Zipname, @"D:\WatchTXT\" + Path.GetFileName(Zipname), true);
                    File.WriteAllText(@"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(Zipname) + @".txt", @"D:\WatchTXT\" + Path.GetFileName(Zipname) + @"~" + Outpath);
                }
                File.Delete(Zipname);
                //SendMail(Path.GetFileNameWithoutExtension(Zipname), "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "GSA", false, stage);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "GSA", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }
        //***
        public void Book_AIPJPS_Printer(string xlloc, string CL)
        {
            string stage = "Printer files", stid = "", AUTUStatus = "28";
            DBClass Db = new DBClass();
            try
            {
                Zipname = xlloc;
                string Query = "";
                SaveToReport("Status: Processing excel file: " + xlloc);
                SaveToReport("Status: Collecting data from excel file: " + xlloc);
                Xl.Workbook xlWorkBook;
                Xl.Worksheet xlWorkSheet;
                Xl.Application xlapp;
                xlapp = new Xl.Application();
                xlapp.Visible = false;
                xlWorkBook = xlapp.Workbooks.Open(xlloc);
                xlWorkSheet = (Xl.Worksheet)xlWorkBook.Sheets[1];
                int lastRow = xlWorkSheet.Cells.SpecialCells(Xl.XlCellType.xlCellTypeLastCell).Row;
                //System.Array MyValues = (System.Array)xlWorkSheet.get_Range("A1", "B" + lastRow.ToString()).Cells.Value;
                System.Array MyValues = (System.Array)xlWorkSheet.get_Range("A1", "F" + lastRow.ToString()).Cells.Value;
                int ros = MyValues.GetLength(0);
                int cos = MyValues.GetLength(1);
                xlapp.Quit();
                xlapp = null;
                GC.Collect();
                GC.WaitForPendingFinalizers();
                foreach (Process P in Process.GetProcessesByName("EXCEL"))
                {
                    try
                    {
                        P.Kill();
                    }
                    catch (Exception e) { }
                }
                //if (MyValues.GetValue(5, 2).ToString().ToLower() != "number")
                //{
                //    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick articleid. Please check its position in excel.", "AIP", true, stage, Zipname);
                //    SaveToReport("Unable to pick articleid. Please check its position in excel: " + Path.GetFileName(Zipname));
                //    //Move to Error
                //    Clear();
                //    return;
                //}
                if (MyValues.GetValue(5, 2).ToString().ToLower() != "number" || MyValues.GetValue(5, 6).ToString().ToLower() != "printed page count")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick articleid/Page number. Please check its position in excel.", "AIP", true, stage, Zipname);
                    SaveToReport("Unable to pick articleid/Page number. Please check its position in excel: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                string values = MyValues.GetValue(1, 1).ToString().Replace("\n", "").Replace("\r", "");
                //string volume = Regex.Match(values, @"Volume ([^\s,]*?), Issue: ([^\s,]*?),").Groups[1].Value, issue = Regex.Match(values, @"Volume ([^\s,]*?), Issue: ([^\s,]*?),").Groups[2].Value, JournalAcronym = "", Journalid = "";
                string volume = Regex.Match(values, @"Volume ([^\s,]*?), Issue: ([^,]*?),").Groups[1].Value, issue = Regex.Match(values, @"Volume ([^\s,]*?), Issue: ([^,]*?),").Groups[2].Value, JournalAcronym = "", Journalid = "";
                System.Collections.ArrayList ArticleID = new System.Collections.ArrayList();
                for (int i = 6; i <= ros; i++)
                {
                    string val = "";
                    try
                    {
                        val = MyValues.GetValue(i, 1).ToString();
                        val = MyValues.GetValue(i, 2).ToString();
                    }
                    catch (Exception e1)
                    {
                        val = "";
                        break;
                    }
                    if (ReturnDetail("Artcl_ArticleId", "article", Db, "Artcl_ArticleId='" + MyValues.GetValue(i, 2).ToString() + "'and Artcl_JrnlId in(select Jrnl_Id from Journal where Jrnl_PublID='99')") != "")
                    {

                        if (Journalid == "") Journalid = ReturnDetail("Artcl_JrnlId", "article", Db, "Artcl_ArticleId='" + MyValues.GetValue(i, 2).ToString() + "' and Artcl_JrnlId in(select Jrnl_Id from Journal where Jrnl_PublID='99')");
                        if (JournalAcronym == "" && Journalid != "") JournalAcronym = ReturnDetail("Jrnl_Acronym", "Journal", Db, "Jrnl_Id='" + Journalid + "' AND Jrnl_PublID='99'");
                        break;
                    }
                }
                if (volume == "" || issue == "" || JournalAcronym == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick Volume/Journal Acronym/Issue. Please check its position in excel.", "AIP", true, stage, Zipname);
                    SaveToReport("Unable to pick Volume/Journal Acronym/Issue. Please check its position in excel: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                int cnt = 1;
                for (int i = 6; i <= ros; i++)
                {
                    string val = "", pno = "";
                    try
                    {
                        val = MyValues.GetValue(i, 1).ToString();
                        val = MyValues.GetValue(i, 2).ToString();
                    }
                    catch (Exception e1)
                    {
                        val = "";
                        break;
                    }
                    try
                    {
                        pno = MyValues.GetValue(i, 6).ToString();
                    }
                    catch (Exception e1)
                    {
                        pno = "";
                    }
                    if (ReturnDetail("Artcl_ArticleId", "article", Db, "Artcl_ArticleId='" + MyValues.GetValue(i, 2).ToString() + "'and Artcl_JrnlId in(select Jrnl_Id from Journal where Jrnl_PublID='99')") != "")
                    {
                        if (ArticleID.Contains(MyValues.GetValue(i, 2).ToString()))
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Duplicate id present in excel." + MyValues.GetValue(i, 2).ToString(), "AIP", true, stage, Zipname);
                            SaveToReport("Duplicate id present in excel." + MyValues.GetValue(i, 2).ToString() + Path.GetFileName(Zipname));
                            //Move to Error
                            Clear();
                            return;
                        }
                        else ArticleID.Add(MyValues.GetValue(i, 2).ToString());
                    }
                    else
                    {
                        SaveToReport("Status: insert dummy FP entry article table " + MyValues.GetValue(i, 2).ToString().ToUpper());
                        Query = "insert into article(Artcl_JrnlId,artcl_articleid,Artcl_Volume,Artcl_Issue,Artcl_UploadedDt,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_Status) values('" + Journalid + "','" + MyValues.GetValue(i, 2).ToString().ToUpper() + "','" + volume + "','" + issue + "',getdate(),getdate(),getdate(),'UL')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query);
                        SaveToReport("Status: insert dummy FP entry trnsjournal table " + MyValues.GetValue(i, 2).ToString().ToUpper());
                        string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + MyValues.GetValue(i, 2).ToString().ToUpper() + "'");
                        Query = "Insert into trnsjournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) Values(" + artid + ",1,'Administration',getdate(),getdate(),'14','Completed','33','Earticle closing','Auto Entry',getdate(),1,'Pending')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query);
                        ArticleID.Add(MyValues.GetValue(i, 2).ToString());
                    }
                    string tit = ReturnDetail("Artcl_Title", "Article", Db, "Artcl_ArticleId='" + MyValues.GetValue(i, 2).ToString() + @"'");
                    if (tit == "")
                    {
                        Query = "update Article set Artcl_ActualSeq='" + cnt + "',Proof_Pages='" + pno + "' where Artcl_ArticleId='" + MyValues.GetValue(i, 2).ToString() + @"'";
                    }
                    else Query = "update Article set Artcl_ActualSeq='" + cnt + "' where Artcl_ArticleId='" + MyValues.GetValue(i, 2).ToString() + @"'";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + stage + " update Article Table file: " + Query);
                    cnt++;
                }
                //ArticleID.Add(JournalAcronym + "_" + volume + "_" + issue + "_TOC");
                //if (!CheckWhetherFileBooked(JournalAcronym + "_" + volume + "_" + issue + "_TOC"))
                //{
                //    SaveToReport("Status: insert dummy FP entry article table " + JournalAcronym + "_" + volume + "_" + issue + "_TOC");
                //    Query = "insert into article(Artcl_JrnlId,artcl_articleid,Artcl_Volume,Artcl_Issue,Artcl_UploadedDt,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_Status) values('" + Journalid + "','" + JournalAcronym + "_" + volume + "_" + issue + "_TOC" + "','" + volume + "','" + issue + "',getdate(),getdate(),getdate(),'UL')";
                //    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                //    Db.OpenConnection();
                //    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                //    Db.SqlReader.Close();
                //    SaveToReport("Status: " + Query);
                //    SaveToReport("Status: insert dummy FP entry trnsjournal table " + JournalAcronym + "_" + volume + "_" + issue + "_TOC");
                //    string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + JournalAcronym + "_" + volume + "_" + issue + "_TOC'");
                //    Query = "Insert into trnsjournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) Values(" + artid + ",1,'Administration',getdate(),getdate(),'14','Completed','33','Earticle closing','Auto Entry',getdate(),1,'Pending')";
                //    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                //    Db.OpenConnection();
                //    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                //    Db.SqlReader.Close();
                //    SaveToReport("Status: " + Query);
                //}
                string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,LastModifiedDate,UsrID,Insert_Date, JRM_Volume, JRM_Issue) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"',getdate(),'1',getdate(),'" + volume + "','" + issue + "')";
                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                if (JRM_Id == "")
                {
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                }
                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=42") != "")
                {
                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=57") != "")
                    {
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=71") != "")
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Printer Files 3: ", "AIP", true, stage, Zipname);
                            SaveToReport("File already booked for Printer Files 3: " + Path.GetFileName(Zipname));
                            //Move to Error
                            Clear();
                            return;
                        }
                        else
                        {
                            stage = "Printer Files 3";
                            stid = "71";
                        }
                    }
                    else
                    {
                        stage = "Printer Files 2";
                        stid = "57";
                    }
                }
                else
                {
                    stage = "Printer Files";
                    stid = "42";
                }
                string Remarks = "", Rdate = DateTime.Today.ToString("MM/dd/yyyy HH:mm:ss"), Sdate = DateTime.Today.ToString("MM/dd/yyyy HH:mm:ss");
                string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stid + "','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                foreach (string Aid in ArticleID)
                {
                    string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                    if (uploaddate == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.: ", "AIP", true, stage, Zipname);
                        SaveToReport("Artcl_UploadedDt not updated: " + Path.GetFileName(Zipname));
                        continue;
                    }
                    //JR_Articles 
                    string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stid + "',getdate(),'1')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + stage + " update JR_Articles Table file: " + Query);
                    //TrnsJournalRev 
                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + stage + " update TrnsJournalRev Table file: " + Query);
                    Query = "update Article set Artcl_Volume='" + volume + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + stage + " update Article Table file: " + Query);
                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage + " Stage");
                }
                SaveToReport("Status: Copy files to " + stage + ": " + Path.GetFileName(Zipname));
                string Outpath = @"\\Techsetserver2\Journal\AIP\" + JournalAcronym + @"\ISSUE\" + volume + "-" + issue + @"\DataSupplied\" + stage + @"\" + Path.GetFileName(Zipname);
                if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                File.Copy(Zipname, Outpath, true);
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                File.Delete(Zipname);
                //SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage + " Stage");
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "AIP", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }

        //***
        public void Book_AIPJPS_Revises(string xlloc, string CL)
        {
            string stage = "Revises 1", stid = "", AUTUStatus = "25";
            DBClass Db = new DBClass();
            try
            {
                Zipname = xlloc;
                string Query = "";
                SaveToReport("Status: Processing excel file: " + xlloc);
                SaveToReport("Status: Collecting data from excel file: " + xlloc);
                Xl.Workbook xlWorkBook;
                Xl.Worksheet xlWorkSheet;
                Xl.Application xlapp;
                xlapp = new Xl.Application();
                xlapp.Visible = false;
                xlWorkBook = xlapp.Workbooks.Open(xlloc);
                xlWorkSheet = (Xl.Worksheet)xlWorkBook.Sheets[1];
                int lastRow = xlWorkSheet.Cells.SpecialCells(Xl.XlCellType.xlCellTypeLastCell).Row;
                //System.Array MyValues = (System.Array)xlWorkSheet.get_Range("A1", "B" + lastRow.ToString()).Cells.Value;
                System.Array MyValues = (System.Array)xlWorkSheet.get_Range("A1", "F" + lastRow.ToString()).Cells.Value;
                int ros = MyValues.GetLength(0);
                int cos = MyValues.GetLength(1);
                xlapp.Quit();
                xlapp = null;
                GC.Collect();
                GC.WaitForPendingFinalizers();
                foreach (Process P in Process.GetProcessesByName("EXCEL"))
                {
                    try
                    {
                        P.Kill();
                    }
                    catch (Exception e) { }
                }
                if (MyValues.GetValue(5, 2).ToString().ToLower() != "number" || MyValues.GetValue(5, 6).ToString().ToLower() != "printed page count")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick articleid/Page number. Please check its position in excel.", "AIP", true, stage, Zipname);
                    SaveToReport("Unable to pick articleid/Page number. Please check its position in excel: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                string values = MyValues.GetValue(1, 1).ToString().Replace("\n", "").Replace("\r", "");
                //string volume = Regex.Match(values, @"Volume ([^\s,]*?), Issue: ([^\s,]*?),").Groups[1].Value, issue = Regex.Match(values, @"Volume ([^\s,]*?), Issue: ([^\s,]*?),").Groups[2].Value, JournalAcronym = "", Journalid = "";
                string volume = Regex.Match(values, @"Volume ([^\s,]*?), Issue: ([^,]*?),").Groups[1].Value, issue = Regex.Match(values, @"Volume ([^\s,]*?), Issue: ([^,]*?),").Groups[2].Value, JournalAcronym = "", Journalid = "";
                System.Collections.ArrayList ArticleID = new System.Collections.ArrayList();
                for (int i = 6; i <= ros; i++)
                {
                    string val = "";
                    try
                    {
                        val = MyValues.GetValue(i, 1).ToString();
                        val = MyValues.GetValue(i, 2).ToString();
                    }
                    catch (Exception e1)
                    {
                        val = "";
                        break;
                    }
                    if (ReturnDetail("Artcl_ArticleId", "article", Db, "Artcl_ArticleId='" + MyValues.GetValue(i, 2).ToString() + "'and Artcl_JrnlId in(select Jrnl_Id from Journal where Jrnl_PublID='99')") != "")
                    {

                        if (Journalid == "") Journalid = ReturnDetail("Artcl_JrnlId", "article", Db, "Artcl_ArticleId='" + MyValues.GetValue(i, 2).ToString() + "' and Artcl_JrnlId in(select Jrnl_Id from Journal where Jrnl_PublID='99')");
                        if (JournalAcronym == "" && Journalid != "") JournalAcronym = ReturnDetail("Jrnl_Acronym", "Journal", Db, "Jrnl_Id='" + Journalid + "' AND Jrnl_PublID='99'");
                        break;
                    }
                }
                if (volume == "" || issue == "" || JournalAcronym == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick Volume/Journal Acronym/Issue. Please check its position in excel.", "AIP", true, stage, Zipname);
                    SaveToReport("Unable to pick Volume/Journal Acronym/Issue. Please check its position in excel: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                int cnt = 1;
                for (int i = 6; i <= ros; i++)
                {
                    string val = "", pno = "";
                    try
                    {
                        val = MyValues.GetValue(i, 1).ToString();
                        val = MyValues.GetValue(i, 2).ToString();
                    }
                    catch (Exception e1)
                    {
                        val = "";
                        break;
                    }
                    try
                    {
                        pno = MyValues.GetValue(i, 6).ToString();
                    }
                    catch (Exception e1)
                    {
                        pno = "";
                    }
                    if (ReturnDetail("Artcl_ArticleId", "article", Db, "Artcl_ArticleId='" + MyValues.GetValue(i, 2).ToString() + "'and Artcl_JrnlId in(select Jrnl_Id from Journal where Jrnl_PublID='99')") != "")
                    {

                        //if (Journalid == "") Journalid = ReturnDetail("Artcl_JrnlId", "article", Db, "Artcl_ArticleId='" + MyValues.GetValue(i, 2).ToString() + "' and Artcl_JrnlId in(select Jrnl_Id from Journal where Jrnl_PublID='99')");
                        //if (JournalAcronym == "" && Journalid != "") JournalAcronym = ReturnDetail("Jrnl_Acronym", "Journal", Db, "Jrnl_Id='" + Journalid + "' AND Jrnl_PublID='99'"); ;

                        if (ArticleID.Contains(MyValues.GetValue(i, 2).ToString()))
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Duplicate id present in excel." + MyValues.GetValue(i, 2).ToString(), "AIP", true, stage, Zipname);
                            SaveToReport("Duplicate id present in excel." + MyValues.GetValue(i, 2).ToString() + Path.GetFileName(Zipname));
                            //Move to Error
                            Clear();
                            return;
                        }
                        else ArticleID.Add(MyValues.GetValue(i, 2).ToString());
                    }
                    else
                    {
                        SaveToReport("Status: insert dummy FP entry article table " + MyValues.GetValue(i, 2).ToString().ToUpper());
                        Query = "insert into article(Artcl_JrnlId,artcl_articleid,Artcl_Volume,Artcl_Issue,Artcl_UploadedDt,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_Status) values('" + Journalid + "','" + MyValues.GetValue(i, 2).ToString().ToUpper() + "','" + volume + "','" + issue + "',getdate(),getdate(),getdate(),'UL')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query);
                        SaveToReport("Status: insert dummy FP entry trnsjournal table " + MyValues.GetValue(i, 2).ToString().ToUpper());
                        string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + MyValues.GetValue(i, 2).ToString().ToUpper() + "'");
                        Query = "Insert into trnsjournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) Values(" + artid + ",1,'Administration',getdate(),getdate(),'14','Completed','33','Earticle closing','Auto Entry',getdate(),1,'Pending')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query);
                        ArticleID.Add(MyValues.GetValue(i, 2).ToString());
                    }
                    string tit = ReturnDetail("Artcl_Title", "Article", Db, "Artcl_ArticleId='" + MyValues.GetValue(i, 2).ToString() + @"'");
                    if (tit == "")
                    {
                        Query = "update Article set Artcl_ActualSeq='" + cnt + "',Proof_Pages='" + pno + "' where Artcl_ArticleId='" + MyValues.GetValue(i, 2).ToString() + @"'";
                    }
                    else Query = "update Article set Artcl_ActualSeq='" + cnt + "' where Artcl_ArticleId='" + MyValues.GetValue(i, 2).ToString() + @"'";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + stage + " update Article Table file: " + Query);
                    cnt++;
                }
                //if (volume == "" || issue == "" || JournalAcronym == "")
                //{
                //    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick Volume/Journal Acronym/Issue. Please check its position in excel.", "AIP", true, stage, Zipname);
                //    SaveToReport("Unable to pick Volume/Journal Acronym/Issue. Please check its position in excel: " + Path.GetFileName(Zipname));
                //    //Move to Error
                //    Clear();
                //    return;
                //}
                //ArticleID.Add(JournalAcronym + "_" + volume + "_" + issue + "_TOC");
                //if (!CheckWhetherFileBooked(JournalAcronym + "_" + volume + "_" + issue + "_TOC"))
                //{
                //    SaveToReport("Status: insert dummy FP entry article table " + JournalAcronym + "_" + volume + "_" + issue + "_TOC");
                //    Query = "insert into article(Artcl_JrnlId,artcl_articleid,Artcl_Volume,Artcl_Issue,Artcl_UploadedDt,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_Status) values('" + Journalid + "','" + JournalAcronym + "_" + volume + "_" + issue + "_TOC" + "','" + volume + "','" + issue + "',getdate(),getdate(),getdate(),'UL')";
                //    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                //    Db.OpenConnection();
                //    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                //    Db.SqlReader.Close();
                //    SaveToReport("Status: " + Query);
                //    SaveToReport("Status: insert dummy FP entry trnsjournal table " + JournalAcronym + "_" + volume + "_" + issue + "_TOC");
                //    string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + JournalAcronym + "_" + volume + "_" + issue + "_TOC'");
                //    Query = "Insert into trnsjournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) Values(" + artid + ",1,'Administration',getdate(),getdate(),'14','Completed','33','Earticle closing','Auto Entry',getdate(),1,'Pending')";
                //    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                //    Db.OpenConnection();
                //    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                //    Db.SqlReader.Close();
                //    SaveToReport("Status: " + Query);
                //}
                string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,LastModifiedDate,UsrID,Insert_Date, JRM_Volume, JRM_Issue) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"',getdate(),'1',getdate(),'" + volume + "','" + issue + "')";
                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                if (JRM_Id == "")
                {
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                }
                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=38") != "")
                {
                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=39") != "")
                    {
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=40") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=99") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=101") != "")
                                {
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Revises 5: ", "GSA", true, stage, Zipname);
                                    SaveToReport("File already booked for Revises 5: " + Path.GetFileName(Zipname));
                                    Clear();
                                    return;
                                }
                                else
                                {
                                    // Revises 5
                                    stage = "Revises 5";
                                    stid = "101";
                                }
                            }
                            else
                            {
                                // Revises 4
                                stage = "Revises 4";
                                stid = "99";
                            }

                        }
                        else
                        {
                            // Revises 3
                            stage = "Revises 3";
                            stid = "40";
                        }
                    }
                    else
                    {
                        // Revises 2                       
                        stage = "Revises 2";
                        stid = "39";
                    }
                }
                else
                {
                    //Revises 1                 
                    stage = "Revises 1";
                    stid = "38";
                }

                string Remarks = "", Rdate = DateTime.Today.ToString("MM/dd/yyyy HH:mm:ss"), Sdate = DateTime.Today.ToString("MM/dd/yyyy HH:mm:ss");
                string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stid + "','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                foreach (string Aid in ArticleID)
                {
                    string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                    if (uploaddate == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.: ", "AIP", true, stage, Zipname);
                        SaveToReport("Artcl_UploadedDt not updated: " + Path.GetFileName(Zipname));
                        continue;
                    }
                    //JR_Articles 
                    string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stid + "',getdate(),'1')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + stage + " update JR_Articles Table file: " + Query);
                    //TrnsJournalRev 
                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + stage + " update TrnsJournalRev Table file: " + Query);
                    Query = "update Article set Artcl_Volume='" + volume + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + stage + " update Article Table file: " + Query);
                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage + " Stage");
                }
                SaveToReport("Status: Copy files to " + stage + ": " + Path.GetFileName(Zipname));
                string Outpath = @"\\Techsetserver2\Journal\AIP\" + JournalAcronym + @"\ISSUE\" + volume + "-" + issue + @"\DataSupplied\" + stage + @"\" + Path.GetFileName(Zipname);
                if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                File.Copy(Zipname, Outpath, true);
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                File.Delete(Zipname);
                //SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage + " Stage");
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "AIP", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }

        //***
        public void Book_STA_AU_Survey(string xlloc, string CL)
        {
            //string xlloc=@"C:\Users\2083\Desktop\Mansoor\NovaTechset_authorsurvey_Jan_2019.xlsx";
            //string CL=@"C:\Users\2083\Desktop\Mansoor\Out\";
            DBClass Db = new DBClass();
            try
            {
                Zipname = xlloc;
                SaveToReport("Status: Processing excel file: " + xlloc);
                SaveToReport("Status: Collecting data from excel file: " + xlloc);
                Xl.Workbook xlWorkBook;
                Xl.Worksheet xlWorkSheet;
                Xl.Application xlapp;
                xlapp = new Xl.Application();
                xlapp.Visible = false;
                xlWorkBook = xlapp.Workbooks.Open(xlloc);
                xlWorkSheet = (Xl.Worksheet)xlWorkBook.Sheets[1];
                int lastRow = xlWorkSheet.Cells.SpecialCells(Xl.XlCellType.xlCellTypeLastCell).Row;
                System.Array MyValues = (System.Array)xlWorkSheet.get_Range("A2", "EE" + lastRow.ToString()).Cells.Value;
                int ros = MyValues.GetLength(0);
                int cos = MyValues.GetLength(1);
                xlapp.Quit();
                xlapp = null;
                GC.Collect();
                GC.WaitForPendingFinalizers();
                foreach (Process P in Process.GetProcessesByName("EXCEL"))
                {
                    try
                    {
                        P.Kill();
                    }
                    catch (Exception e) { }
                }

                for (int i = 1; i <= ros; i++)
                {
                    string str = "insert into sta_author_survey (A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,AA,AB,AC,AD,AE,AF,AG,AH,AI,AJ,AK,AL,AM,AN,AO,AP,AQ,AR,[AS],[AT],AU,AV,AW,AX,AY,AZ,BA,BB,BC,BD,BE,BF,BG,BH,BI,BJ,BK,BL,BM,BN,BO,BP,BQ,BR,BS,BT,BU,BV,BW,BX,[BY],BZ,CA,CB,CC,CD,CE,CF,CG,CH,CI,CJ,CK,CL,CM,CN,CO,CP,CQ,CR,CS,CT,CU,CV,CW,CX,CY,CZ,DA,DB,DC,DD,DE,DF,DG,DH,DI,DJ,DK,DL,DM,DN,DO,DP,DQ,DR,DS,DT,DU,DV,DW,DX,DY,DZ,EA,EB,EC,ED,EE) values (";
                    for (int j = 1; j <= 135; j++)
                    {
                        string val = "";
                        try
                        {
                            val = MyValues.GetValue(i, j).ToString();
                        }
                        catch (Exception e1)
                        {
                            val = "";
                            if (j == 1) goto exitfunc;
                        }
                        val = val.Replace("'", "''");
                        str = str + "'" + val + "',";
                    }
                    str = Regex.Replace(str, ",$", ")");
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(str, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + str);
                }

            exitfunc: SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                File.Delete(Zipname);
                //SendMail(Path.GetFileNameWithoutExtension(Zipname), "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "TnF", false, "AU Survey Report");
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "TnF", true, "AU Survey Report", Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }
        //***

        public void Issue_Publication_Data_FSPM(string xlloc, string CL)
        {
            DBClass Db = new DBClass();
            try
            {
                if (Directory.Exists(Path.GetDirectoryName(xlloc) + @"\Jrnldetails"))
                {
                    foreach (string Z in Directory.GetFiles(Path.GetDirectoryName(xlloc) + @"\Jrnldetails").Where(s => Regex.IsMatch(Path.GetExtension(s).ToLower(), @"\.(xls)")))
                    {
                        SaveToReport("Status: Processing excel file: " + Z);
                        SaveToReport("Status: Collecting data from excel file: " + Z);
                        Xl.Workbook xlWorkBook;
                        Xl.Worksheet xlWorkSheet;
                        Xl.Application xlapp;
                        xlapp = new Xl.Application();
                        xlapp.Visible = false;
                        xlWorkBook = xlapp.Workbooks.Open(Z);
                        xlWorkSheet = (Xl.Worksheet)xlWorkBook.Sheets[1];
                        int lastRow = xlWorkSheet.Cells.SpecialCells(Xl.XlCellType.xlCellTypeLastCell).Row;
                        System.Array MyValues = (System.Array)xlWorkSheet.get_Range("A2", "AM" + lastRow.ToString()).Cells.Value;
                        int ros = MyValues.GetLength(0);
                        int cos = MyValues.GetLength(1);
                        xlapp.Quit();
                        xlapp = null;
                        GC.Collect();
                        GC.WaitForPendingFinalizers();
                        foreach (Process P in Process.GetProcessesByName("EXCEL"))
                        {
                            try
                            {
                                P.Kill();
                            }
                            catch (Exception e) { }
                        }

                        for (int i = 1; i <= ros; i++)
                        {
                            string str = "insert into IPD_FSPM_JrnlDetails (JrnlAcronym,Volume_Budgeted_AL,Issue_budgeted_pages_AM) values (";
                            int[] s = { 1, 35, 36 };
                            foreach (int j in s)
                            {
                                string val = "";
                                try
                                {
                                    val = MyValues.GetValue(i, j).ToString();
                                }
                                catch (Exception e1)
                                {
                                    val = "";
                                    if (j == 1) goto continuehere;
                                }
                                val = val.Replace("'", "''");
                                str = str + "'" + val + "',";
                            }
                            str = Regex.Replace(str, ",$", ")");
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(str, Db.GetConnection());
                            Db.OpenConnection();
                            try
                            {
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                            }
                            catch (Exception e1)
                            {
                                SaveToReport("Status: Error: " + e1.Message);
                            }
                            SaveToReport("Status: " + str);
                        }
                        File.Delete(Z);
                    }
                }
            }
            catch (Exception ee)
            {
            }
        continuehere:
            try
            {
                Zipname = xlloc;
                SaveToReport("Status: Processing excel file: " + xlloc);
                SaveToReport("Status: Collecting data from excel file: " + xlloc);
                Xl.Workbook xlWorkBook;
                Xl.Worksheet xlWorkSheet;
                Xl.Application xlapp;
                xlapp = new Xl.Application();
                xlapp.Visible = false;
                xlWorkBook = xlapp.Workbooks.Open(xlloc);
                xlWorkSheet = (Xl.Worksheet)xlWorkBook.Sheets[1];
                int lastRow = xlWorkSheet.Cells.SpecialCells(Xl.XlCellType.xlCellTypeLastCell).Row;
                System.Array MyValues = (System.Array)xlWorkSheet.get_Range("A2", "S" + lastRow.ToString()).Cells.Value;
                int ros = MyValues.GetLength(0);
                int cos = MyValues.GetLength(1);
                xlapp.Quit();
                xlapp = null;
                GC.Collect();
                GC.WaitForPendingFinalizers();
                foreach (Process P in Process.GetProcessesByName("EXCEL"))
                {
                    try
                    {
                        P.Kill();
                    }
                    catch (Exception e) { }
                }

                for (int i = 1; i <= ros; i++)
                {
                    string str = "insert into Issue_Publication_Data_FSPM (PRODUCTION_EDITOR,ACRONYM,ISSUE_WORKFLOW,ISSUE,MEDIA,ISSUE_YEAR,ISSUE_STATUS,O_PUBLISH_PLAN,O_PUBLISH_ESTIMATED,O_PUBLISH_ACTUAL,ACTUAL_PAGES,LAST_MS_ENT_BUDG,NOTES,ACRONYM_ISSUE) values (";
                    int[] s = { 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 17, 18, 19 };
                    string acro = "", issue = "";
                    foreach (int j in s)
                    {
                        string val = "";
                        try
                        {
                            val = MyValues.GetValue(i, j).ToString();
                            if (j == 5) acro = val;
                            if (j == 7) { issue = val.Replace("\"", ""); val = val.Replace("\"", ""); }
                        }
                        catch (Exception e1)
                        {
                            val = "";
                            if (j == 4) goto exitfunc;
                        }
                        val = val.Replace("'", "''");
                        str = str + "'" + val + "',";
                    }

                    str = str + "'" + acro + issue + "')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(str, Db.GetConnection());
                    Db.OpenConnection();
                    try
                    {
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                    }
                    catch (Exception e1)
                    {
                        SaveToReport("Status: Error: " + e1.Message);
                    }
                    SaveToReport("Status: " + str);
                }

            exitfunc: SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                File.Delete(Zipname);
                //SendMail(Path.GetFileNameWithoutExtension(Zipname), "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "TnF", false, "AU Survey Report");
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "TnF", true, "AU Survey Report", Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }
        //***
        public void Book_ERS(string xlloc, string CL)
        {
            string stage = "Final Web Delivery";
            DBClass Db = new DBClass();
            try
            {
                Zipname = xlloc;
                SaveToReport("Status: Processing excel file: " + xlloc);
                SaveToReport("Status: Collecting data from excel file: " + xlloc);
                Xl.Workbook xlWorkBook;
                Xl.Worksheet xlWorkSheet;
                Xl.Application xlapp;
                xlapp = new Xl.Application();
                xlapp.Visible = false;
                xlWorkBook = xlapp.Workbooks.Open(xlloc);
                xlWorkSheet = (Xl.Worksheet)xlWorkBook.Sheets[1];
                int lastRow = xlWorkSheet.Cells.SpecialCells(Xl.XlCellType.xlCellTypeLastCell).Row;
                System.Array MyValues = (System.Array)xlWorkSheet.get_Range("A1", "C" + lastRow.ToString()).Cells.Value;
                int ros = MyValues.GetLength(0);
                int cos = MyValues.GetLength(1);
                xlapp.Quit();
                xlapp = null;
                GC.Collect();
                GC.WaitForPendingFinalizers();
                foreach (Process P in Process.GetProcessesByName("EXCEL"))
                {
                    try
                    {
                        P.Kill();
                    }
                    catch (Exception e) { }
                }
                if (MyValues.GetValue(1, 1).ToString().Replace("\n", "").Replace("\r", "").ToLower() != "volume")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick volume. Please check its position in excel.", "ERS", true, stage, Zipname);
                    SaveToReport("Unable to pick volume. Please check its position in excel: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                else if (MyValues.GetValue(1, 2).ToString().ToLower() != "issue")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick Issue. Please check its position in excel.", "ERS", true, stage, Zipname);
                    SaveToReport("Unable to pick Issue. Please check its position in excel: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                else if (MyValues.GetValue(1, 3).ToString().ToLower() != "manuscript no.")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick Manuscript no. Please check its position in excel.", "ERS", true, stage, Zipname);
                    SaveToReport("Unable to pick Issue. Please check its position in excel: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                string volume = MyValues.GetValue(2, 1).ToString(), issue = MyValues.GetValue(2, 2).ToString(), JournalAcronym = Path.GetFileNameWithoutExtension(xlloc).Split(' ')[0];
                string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + JournalAcronym + "' AND Jrnl_PublID='80'");
                if (volume == "" || issue == "" || Journalid == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick Volume/Journal Acronym/Issue. Please check its position in excel.", "ERS", true, stage, Zipname);
                    SaveToReport("Unable to pick Volume/Journal Acronym/Issue. Please check its position in excel: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                JournalAcronym = JournalAcronym.ToUpper();
                System.Collections.ArrayList ArticleID = new System.Collections.ArrayList();
                for (int i = 2; i <= ros; i++)
                {
                    string val = "";
                    try
                    {
                        val = MyValues.GetValue(i, 1).ToString();
                    }
                    catch (Exception e1)
                    {
                        val = "";
                        break;
                    }
                    string artid = MyValues.GetValue(i, 3).ToString();
                    if (!Regex.IsMatch(artid, "^e", RegexOptions.IgnoreCase)) artid = JournalAcronym + '-' + artid;
                    if (ArticleID.Contains(artid))
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Duplicate id present in excel." + MyValues.GetValue(i, 3).ToString(), "ERS", true, stage, Zipname);
                        SaveToReport("Duplicate id present in excel." + MyValues.GetValue(i, 3).ToString() + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    else ArticleID.Add(artid);
                }
                if (ArticleID.Count == 0)
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>No articles present.", "ERS", true, stage, Zipname);
                    SaveToReport("No articles present." + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                string list = "";
                foreach (string Aid1 in ArticleID)
                {
                    string Art_JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "JRM_ArticleID='" + Aid1 + "' and JRM_JournalID='" + Journalid + "'");
                    if (Art_JRM_Id != "")
                    {
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID='" + Art_JRM_Id + "'and JRST_JRS_ID in (44,81,80,77,76,53,52,51) and ISNULL(JRST_UploadedDT,'')=''") != "")
                        {
                            list += ", " + Aid1;
                            //SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Final corrections stage not uploaded yet. Article ID: " + Aid1, "ERS", true, stage, Zipname);
                            //SaveToReport("Final corrections stage not uploaded yet. Article ID: " + Aid1 + Path.GetFileName(Zipname));
                            ////Move to Error
                            //Clear();
                            //return;
                        }
                    }
                }
                if (list != "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Final corrections stage not uploaded yet. Article IDs: " + Regex.Replace(list, "^,", ""), "ERS", true, stage, Zipname);
                    SaveToReport("Final corrections stage not uploaded yet. Article ID: " + Regex.Replace(list, "^,", "") + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }

                volume = volume + '-' + issue;
                string iss_JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "isnull(JRM_ArticleID,'')='' and JRM_Volume='" + volume + "' and JRM_JournalID='" + Journalid + "'");
                if (iss_JRM_Id != "")
                {
                    string previssue = ReturnDetail("JRM_Issue", "JR_Main", Db, "JRM_ID='" + iss_JRM_Id + "'");
                    if (previssue != "" && Regex.IsMatch(previssue, @"batch\d+$"))
                    {
                        issue = "batch" + (Convert.ToInt16(Regex.Match(previssue, @"\d+$").Value) + 1);
                        Db.Sqladptr = new SqlDataAdapter(new SqlCommand("select distinct JRA_ArticleID from JR_Main,JR_Stage_Tran,JR_Articles where JRA_JRST_ID=JRST_ID and JRST_JRM_ID=JRM_ID and JRM_Volume='" + volume + "' and JRM_JournalID='" + Journalid + "' and isnull(JRM_ArticleID,'')=''", Db.GetConnection()));
                        Db.dt = new DataTable();
                        Db.Sqladptr.Fill(Db.dt);
                        Db.CloseConnection();
                        DataSet ds = new DataSet("New_DataSet");
                        ds.Tables.Add(Db.dt);
                        var rows = ds.Tables[0].Rows;
                        foreach (DataRow Aid1 in rows)
                        {
                            if (ArticleID.Contains(Aid1[0]))
                            {
                                ArticleID.Remove(Aid1[0]);
                            }
                        }
                        if (ArticleID.Count == 0)
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>No new articles present. All were booked in previous issues.", "ERS", true, stage, Zipname);
                            SaveToReport("No new articles present. All were booked in previous issues. " + Path.GetFileName(Zipname));
                            //Move to Error
                            Clear();
                            return;
                        }
                    }
                    else issue = "batch1";
                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(iss_JRM_Id)) + " AND JRST_JRS_ID=43 and isnull(JRST_UploadedDT,'')=''") != "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Previous issue not uploaded: " + previssue, "ERS", true, stage, Zipname);
                        SaveToReport("Previous issue not uploaded: " + previssue + " " + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                }
                else issue = "batch1";
                string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,LastModifiedDate,UsrID,Insert_Date, JRM_Volume, JRM_Issue) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"',getdate(),'1',getdate(),'" + volume + "','" + issue + "')";
                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                if (JRM_Id == "")
                {
                    JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                }
                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                //if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=43") != "")
                //{
                //    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Web Delivery: ", "ERS", true, stage, Zipname);
                //    SaveToReport("File already booked for Final Web Delivery: " + Path.GetFileName(Zipname));
                //    //Move to Error
                //    Clear();
                //    return;
                //}
                string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','43',getdate(),getdate(),getdate(),getdate(),'21',getdate(),'1','')";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                foreach (string Aid1 in ArticleID)
                {
                    string Aid = Aid1;
                    if (!CheckWhetherFileBooked(Aid))
                    {
                        SaveToReport("Status: insert dummy FP entry article table " + Aid);
                        Query = "insert into article(Artcl_JrnlId,artcl_articleid,Artcl_Volume,Artcl_Issue,Artcl_UploadedDt,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_Status) values('" + Journalid + "','" + Aid + "','" + volume + "','" + issue + "',getdate(),getdate(),getdate(),'UL')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query + Aid);
                        SaveToReport("Status: insert dummy FP entry trnsjournal table " + Aid);
                        string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                        Query = "Insert into trnsjournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) Values(" + artid + ",1,'Administration',getdate(),getdate(),'14','Completed','33','Earticle closing','Auto Entry',getdate(),1,'Pending')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query + " " + Aid);
                    }
                    string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                    if (uploaddate == "")
                    {
                        //SendMail(Aid, "Dear Team,<Br/><Br/>'Artcl_UploadedDt not updated.: ", "COB", true, stage, Zipname);
                        //SaveToReport("Artcl_UploadedDt not updated: " + Aid + " " + Path.GetFileName(Zipname));
                        SaveToReport("Status: Update uploaded date status article table " + Aid);
                        Query = "update Article set Artcl_UploadedDt=getdate(),Artcl_Status='UL' where Artcl_ArticleId='" + Aid + @"'";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query + " " + Aid);
                    }
                    //JR_Articles 
                    string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','21','43',getdate(),'1')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + Path.GetFileName(Zipname));
                    SaveToReport("Status: Final Web delivery update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                    //TrnsJournalRev 
                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','21',getdate(),'1','Final Web Delivery','Pending')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + Path.GetFileName(Zipname));
                    SaveToReport("Status: revises 1 update Article Table file: " + Path.GetFileName(Zipname));
                    Query = "update Article set Artcl_Volume='" + volume + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "COB", false, stage); 
                }
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                //string Outpath = @"\\Techsetserver2\Journal\COB\" + JournalAcronym + @"\ISSUE\" + volume + "-" + issue + @"\DataSupplied\Revises 1\" + Path.GetFileName(Zipname);
                ////if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                ////File.Copy(Zipname, Outpath, true);
                //File.Copy(Zipname, @"D:\WatchTXT\" + Path.GetFileName(Zipname), true);
                //File.WriteAllText(@"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(Zipname) + @".txt", @"D:\WatchTXT\" + Path.GetFileName(Zipname) + @"~" + Outpath);
                File.Delete(Zipname);
                //SendMail(Path.GetFileNameWithoutExtension(Zipname), "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "ERS", false, stage);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "ERS", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }
        //***
        public void Book_APS_Printer(string xlloc, string CL)
        {
            string stage = "Printer Stage";
            DBClass Db = new DBClass();
            try
            {
                Zipname = xlloc;
                SaveToReport("Status: Processing excel file: " + xlloc);
                SaveToReport("Status: Collecting data from excel file: " + xlloc);
                Xl.Workbook xlWorkBook;
                Xl.Worksheet xlWorkSheet;
                Xl.Application xlapp;
                xlapp = new Xl.Application();
                xlapp.Visible = false;
                xlWorkBook = xlapp.Workbooks.Open(xlloc);
                xlWorkSheet = (Xl.Worksheet)xlWorkBook.Sheets[1];
                int lastRow = xlWorkSheet.Cells.SpecialCells(Xl.XlCellType.xlCellTypeLastCell).Row;
                System.Array MyValues = (System.Array)xlWorkSheet.get_Range("A1", "C" + lastRow.ToString()).Cells.Value;
                int ros = MyValues.GetLength(0);
                int cos = MyValues.GetLength(1);
                GC.Collect();
                GC.WaitForPendingFinalizers();
                string AID1 = "";
                System.Collections.ArrayList ArticleID = new System.Collections.ArrayList();
                for (int i = 2; i <= ros; i++)
                {
                    AID1 += "'" + MyValues.GetValue(i, 3).ToString() + "',";
                    if (ArticleID.Contains(MyValues.GetValue(i, 3).ToString()))
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Duplicate id present in excel." + MyValues.GetValue(i, 3).ToString(), "APS Invoice", true, stage, Zipname);
                        SaveToReport("Duplicate id present in excel." + MyValues.GetValue(i, 3).ToString() + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    else ArticleID.Add(MyValues.GetValue(i, 3).ToString());
                }
                string Vol = MyValues.GetValue(2, 1).ToString();
                String Iss = MyValues.GetValue(2, 2).ToString();
                AID1 = Regex.Replace(AID1, ",$", "");
                xlapp.Quit();
                xlapp = null;
                GC.Collect();
                GC.WaitForPendingFinalizers();
                foreach (Process P in Process.GetProcessesByName("EXCEL"))
                {
                    try
                    {
                        P.Kill();
                    }
                    catch (Exception e2) { }
                }
                SaveToReport("Status: " + AID1);
                string[] AID = AID1.Replace(@"'", "").Split(',');
                string Journalid = ReturnDetail("Artcl_JrnlId", "Article", Db, "Artcl_ArticleId='" + AID[0] + @"'");
                string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db);
                string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,LastModifiedDate,UsrID,Insert_Date, JRM_Volume, JRM_Issue) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"',getdate(),'1',getdate(),'" + Vol + "','" + Iss + "')";
                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + Vol + "' AND JRM_Issue='" + Iss + "'");
                if (JRM_Id == "")
                {
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query);
                }
                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + Vol + "' AND JRM_Issue='" + Iss + "'");
                JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=42") != "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Printer: ", "APS Invoice", true, stage, Zipname);
                    SaveToReport("File already booked for Printer: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db);
                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,JRST_UploadedDT) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','42',getdate(),getdate(),getdate(),getdate(),'34',getdate(),'1','',getdate())";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status: " + Query);
                foreach (string Aid in AID)
                {
                    string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db);
                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','34','42',getdate(),'1')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query);
                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','34',getdate(),'1','Printer Files','Pending')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query);
                    Query = "update Article set Artcl_Volume='" + Vol + "',Artcl_Issue='" + Iss + "' where Artcl_ArticleId='" + Aid + @"'";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query);
                }
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                File.Delete(Zipname);
                //SendMail(Path.GetFileNameWithoutExtension(Zipname), "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "APS Invoice", false, stage);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "APS Invoice", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }

        public void View_APS()
        {
            string stage = "First Proof Stage";
            DBClass Db = new DBClass();
            try
            {
                XDocument XDoc = new XDocument();
                SaveToReport("Status: Validating manuscript file: " + Path.GetFileName(Zipname));
                if (File.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\manuscript.json"))
                {
                    try
                    {
                        XmlDocument doc = (XmlDocument)JsonConvert.DeserializeXmlNode(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\manuscript.json"), "Root");
                        File.WriteAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\manuscript.xml", doc.InnerXml.ToString());
                        XDoc = XDocument.Parse(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\manuscript.xml"), LoadOptions.PreserveWhitespace);
                        string v = "";
                        foreach (XElement e in XDoc.Descendants().ToList())
                        {
                            if (e.Name.ToString() != "Root")
                            {
                                v += e.Parent.Name.ToString() + @"\" + e.Name.ToString() + "\n";
                            }
                        }
                        ProcessStartInfo p = new ProcessStartInfo();
                        p.FileName = "" + System.Environment.CurrentDirectory + @"\APS_Meta_Viewer.exe" + "";
                        p.Arguments = "" + Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\manuscript.xml" + "";
                        Process P1 = Process.Start(p);
                        P1.WaitForExit();
                        return;
                    }
                    catch (Exception e)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>manuscript.json file is not valid for APS: ", "APS", true, stage, Zipname);
                        SaveToReport("manuscript.json file is not valid for:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                        //Clear();
                        //Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                        return;
                    }

                }
                else
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>manuscript.json file missing for APS: ", "APS", true, stage, Zipname);
                    SaveToReport("manuscript.json file missing for:  " + Path.GetFileName(Zipname));
                    //Move to Error
                    //Clear();
                    // Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname),true);
                    return;
                }
                //Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                //if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                //{
                //    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                //}
                //File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                //File.Delete(Zipname);
                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "APS", false, stage);
                //SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "APS", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }

        public void SAGE_PIJ_Reminder()
        {
            try
            {
                DBClass Db = new DBClass();
                string Q = "select * from article where Artcl_JrnlId in (select jrnl_id from journal where Jrnl_Acronym not in ('pmx','fty','JOPHON','cin','CWS') and Jrnl_PublID=4 and isnull(Jrnl_UploadType,'')='' and isnull(Jrnl_UploadTypeNew,'')='')and isnull(Artcl_UploadedDt,'')<>'' and isnull(Artcl_AUCorr_RecDT,'')='' and artcl_id>=1531456 and ISNULL(Artcl_NIH,'')='' and isnull(Artcl_PDFToAuthor,'')<>'' and convert(date,Artcl_PDFToAuthor,112)= convert(date,GETDATE(),112)";
                //string Q = "select * from article where Artcl_JrnlId=625 and isnull(Artcl_UploadedDt,'')<>'' and isnull(Artcl_AUCorr_RecDT,'')='' and artcl_id>=1531456 and ISNULL(Artcl_NIH,'')='' and isnull(Artcl_PDFToAuthor,'')<>'' and convert(date,Artcl_PDFToAuthor,112)= convert(date,GETDATE(),112)";
                //string Q = "select * from article where Artcl_JrnlId=625 and isnull(Artcl_UploadedDt,'')<>'' and isnull(Artcl_AUCorr_RecDT,'')='' and ISNULL(Artcl_NIH,'')='' and isnull(Artcl_PDFToAuthor,'')<>'' and convert(date,Artcl_PDFToAuthor,112)= convert(date,GETDATE(),112)";
                Db.Sqladptr = new SqlDataAdapter(new SqlCommand(Q, Db.GetConnection()));
                Db.dt = new DataTable();
                Db.Sqladptr.Fill(Db.dt);
                Db.CloseConnection();
                DataSet ds = new DataSet("New_DataSet");
                ds.Tables.Add(Db.dt);
                var rows = ds.Tables[0].Rows;
                for (int j = 0; j < rows.Count; j++)
                {
                    string aid = rows[j]["Artcl_ArticleId"].ToString();
                    string AUEmail = rows[j]["Artcl_AuthorEmail"].ToString();
                    SaveToReport("Status: SAGE Reminder for --" + aid);
                    try
                    {
                        //string msg = "<p>Dear Author,</p><p>I have not yet received a response on the proofs of your manuscript. So that we may proceed with the production of your article, please let me know within 24 hours that you have received this message or let me know if you need more time.</p><p>Many thanks in advance.</p><p>Yours sincerely,<br>Suriyakumar Damodaran</p>";
                        string jacro = ReturnDetail("jrnl_acronym", "journal", Db, "jrnl_id=" + rows[j]["Artcl_JrnlId"].ToString());
                        if (jacro.ToUpper() == "PMX")
                        {
                            AUEmail = "Linda.Garber@pmi.org";
                        }
                        string msg = "<p>Dear Author,</p><p>I hope you are well. I am emailing to remind you that any corrections for your article are now due. Please check the attached proofs and make sure that you send any corrections as soon as possible or let me know whether the article is approved for publication. This is to ensure timely publication of your article.</p><p>Many thanks in advance.</p><p>Yours sincerely,<br>" + ReturnDetail("Jrnl_Contact", "Journal", Db, "Jrnl_Acronym='" + jacro + "' AND Jrnl_PublID='4'") + "</p>";
                        if (jacro.ToUpper() == "CWS")
                        {
                            msg = "<p>Dear Author,</p><p>I hope you are well. I am emailing to remind you that any corrections for your article are now due. Please check the attached proofs and make sure that you send any corrections to “CWSprod@sagepub.com” as soon as possible or let me know whether the article is approved for publication. This is to ensure timely publication of your article.</p><p>Many thanks in advance.</p><p>Yours sincerely,<br>" + ReturnDetail("Jrnl_Contact", "Journal", Db, "Jrnl_Acronym='" + jacro + "' AND Jrnl_PublID='4'") + "</p><p>Content Manager – Journals Production</p><p>SAGE Publications India Pvt Ltd</p><p>Suite 2426, Doon Express Business Park</p><p>Subhash Nagar (Opp. Transport Nagar)</p><p>Dehradun 248002, INDIA</p><p>www.sagepublishing.com</p>";
                        }
                        MailMessage MM = new MailMessage();
                        string fromid = "sagepub@novatechset.com";
                        if (jacro.ToUpper() == "IJPP") { fromid = "IJP_SAGEpub@novatechset.com"; }
                        else if (jacro.ToUpper() == "RBP") { fromid = "RBPE_SAGEpub@novatechset.com"; }
                        else { fromid = jacro.ToUpper() + "_SAGEpub@novatechset.com"; }
                        //MM = new MailMessage("sagepub@novatechset.com", AUEmail, jacro + " " + aid + " -- Proof corrections Reminder", msg);
                        MM = new MailMessage(fromid, AUEmail, jacro + " " + aid + " -- Proof corrections Reminder", msg);
                        //MM = new MailMessage("sagepub@novatechset.com", "parthiban@novatechset.com", ReturnDetail("jrnl_acronym", "journal", Db, "jrnl_id=" + rows[j]["Artcl_JrnlId"].ToString()) + " " + aid + " -- Proof corrections Reminder", msg);
                        //MM.CC.Add("sagepub@novatechset.com");
                        MM.CC.Add(fromid);
                        //MM.CC.Add("tiworkflow@novatechset.com");
                        SaveToReport("Status: SAGE Reminder From -- " + fromid);
                        SaveToReport("Status: SAGE Reminder To -- " + AUEmail);
                        SaveToReport("Status: SAGE Reminder cc -- " + fromid);// + ";tiworkflow@novatechset.com"
                        SaveToReport("Status: SAGE Reminder Sub -- " + MM.Subject.ToString());
                        SaveToReport("Status: SAGE Reminder Body -- " + msg);
                        SmtpClient client = new SmtpClient(SerializedClass.MailServer);
                        MM.IsBodyHtml = true;
                        if (File.Exists(@"\\techsetserver2\Journal\SAGE\" + jacro + @"\Articles\Pdf\" + aid + ".pdf"))
                        {
                            MM.Attachments.Add(new Attachment(@"\\techsetserver2\Journal\SAGE\" + jacro + @"\Articles\Pdf\" + aid + ".pdf"));
                        }
                        client.Send(MM);
                        try
                        {
                            MM.Attachments.Dispose();
                        }
                        catch (Exception ex1) { SaveToReport(ex1.Message + ex1.StackTrace); }
                    }
                    catch (Exception ex)
                    {
                        SaveToReport(ex.Message + ex.StackTrace);
                        continue;
                    }
                    string Query = "update article set Artcl_NIH='1',Artcl_PDFToAuthor='" + CalculateDueDate("", Db, DateTime.Today, 2).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + "' where Artcl_ArticleId='" + aid + "' and Artcl_JrnlId=" + rows[j]["Artcl_JrnlId"].ToString();
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                }
                //Reminder 2              
                Q = "select * from article where Artcl_JrnlId in (select jrnl_id from journal where Jrnl_Acronym not in('pmx','fty','JOPHON','cin') and Jrnl_PublID=4 and isnull(Jrnl_UploadType,'')='' and isnull(Jrnl_UploadTypeNew,'')='')and isnull(Artcl_UploadedDt,'')<>'' and isnull(Artcl_AUCorr_RecDT,'')='' and artcl_id>=1531456 and ISNULL(Artcl_NIH,'')='1' and isnull(Artcl_PDFToAuthor,'')<>'' and convert(date,Artcl_PDFToAuthor,112)= convert(date,GETDATE(),112)";
                Db.Sqladptr = new SqlDataAdapter(new SqlCommand(Q, Db.GetConnection()));
                Db.dt = new DataTable();
                Db.Sqladptr.Fill(Db.dt);
                Db.CloseConnection();
                ds = new DataSet("New_DataSet");
                ds.Tables.Add(Db.dt);
                rows = ds.Tables[0].Rows;
                for (int j = 0; j < rows.Count; j++)
                {
                    string aid = rows[j]["Artcl_ArticleId"].ToString();
                    string AUEmail = rows[j]["Artcl_AuthorEmail"].ToString();
                    SaveToReport("Status: SAGE Second Reminder for --" + aid);
                    try
                    {
                        string jacron = ReturnDetail("jrnl_acronym", "journal", Db, "jrnl_id=" + rows[j]["Artcl_JrnlId"].ToString());
                        if (jacron.ToUpper() == "PMX")
                        {
                            AUEmail = "Linda.Garber@pmi.org";
                        }
                        string msg = "<p>Dear Author,</p><p>I have not yet received any corrections from you regarding your article. Please send back any corrections you wish to make by " + CalculateDueDate("", Db, DateTime.Today, 2).ToString("MM/dd/yyyy").Replace('-', '/') + " or let me know whether the article is approved for publication. Your article has been placed on hold while we await your response.</p><p>Many thanks in advance.</p><p>Yours sincerely,<br>" + ReturnDetail("Jrnl_Contact", "Journal", Db, "Jrnl_Acronym='" + jacron + "' AND Jrnl_PublID='4'") + "</p>";
                        MailMessage MM = new MailMessage();
                        //MM = new MailMessage("sagepub@novatechset.com", AUEmail, ReturnDetail("jrnl_acronym", "journal", Db, "jrnl_id=" + rows[j]["Artcl_JrnlId"].ToString()) + " " + aid + " -- Proof corrections Reminder", msg);                       
                        string fromid = "sagepub@novatechset.com";
                        if (jacron.ToUpper() == "IJPP") { fromid = "IJP_SAGEpub@novatechset.com"; }
                        else if (jacron.ToUpper() == "RBP") { fromid = "RBPE_SAGEpub@novatechset.com"; }
                        else { fromid = jacron.ToUpper() + "_SAGEpub@novatechset.com"; }
                        MM = new MailMessage(fromid, AUEmail, jacron.ToUpper() + " " + aid + " -- Proof corrections Reminder", msg);
                        //MM = new MailMessage("sagepub@novatechset.com", "parthiban@novatechset.com", ReturnDetail("jrnl_acronym", "journal", Db, "jrnl_id=" + rows[j]["Artcl_JrnlId"].ToString()) + " " + aid + " -- Proof corrections Reminder", msg);
                        //MM.CC.Add("sagepub@novatechset.com");
                        MM.CC.Add(fromid);
                        //MM.CC.Add("tiworkflow@novatechset.com");
                        SaveToReport("Status: SAGE Reminder From -- " + fromid);
                        SaveToReport("Status: SAGE Reminder To -- " + AUEmail);
                        //SaveToReport("Status: SAGE Reminder cc -- sagepub@novatechset.com;tiworkflow@novatechset.com");
                        SaveToReport("Status: SAGE Reminder cc -- " + fromid + ";tiworkflow@novatechset.com");
                        SaveToReport("Status: SAGE Reminder Sub -- " + MM.Subject.ToString());
                        SaveToReport("Status: SAGE Reminder Body -- " + msg);
                        SmtpClient client = new SmtpClient(SerializedClass.MailServer);
                        MM.IsBodyHtml = true;
                        client.Send(MM);
                    }
                    catch (Exception ex)
                    {
                        SaveToReport(ex.Message + ex.StackTrace);
                        continue;
                    }
                    //string Query = "update article set Artcl_NIH='2' where Artcl_ArticleId='" + aid + "' and Artcl_JrnlId=" + rows[j]["Artcl_JrnlId"].ToString();
                    string Query = "update article set Artcl_NIH='2',Artcl_PDFToAuthor='" + CalculateDueDate("", Db, DateTime.Today, 2).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + "' where Artcl_ArticleId='" + aid + "' and Artcl_JrnlId=" + rows[j]["Artcl_JrnlId"].ToString();
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                }
                //Reminder 3             
                Q = "select * from article where Artcl_JrnlId in (select jrnl_id from journal where Jrnl_Acronym not in('pmx','fty','JOPHON','cin') and Jrnl_PublID=4 and isnull(Jrnl_UploadType,'')='' and isnull(Jrnl_UploadTypeNew,'')='')and isnull(Artcl_UploadedDt,'')<>'' and isnull(Artcl_AUCorr_RecDT,'')='' and artcl_id>=1531456 and ISNULL(Artcl_NIH,'')='2' and isnull(Artcl_PDFToAuthor,'')<>'' and convert(date,Artcl_PDFToAuthor,112)= convert(date,GETDATE(),112)";
                Db.Sqladptr = new SqlDataAdapter(new SqlCommand(Q, Db.GetConnection()));
                Db.dt = new DataTable();
                Db.Sqladptr.Fill(Db.dt);
                Db.CloseConnection();
                ds = new DataSet("New_DataSet");
                ds.Tables.Add(Db.dt);
                rows = ds.Tables[0].Rows;
                for (int j = 0; j < rows.Count; j++)
                {
                    string aid = rows[j]["Artcl_ArticleId"].ToString();
                    string AUEmail = rows[j]["Artcl_AuthorEmail"].ToString();
                    SaveToReport("Status: SAGE Third Reminder for --" + aid);
                    try
                    {
                        string jacron = ReturnDetail("jrnl_acronym", "journal", Db, "jrnl_id=" + rows[j]["Artcl_JrnlId"].ToString());
                        if (jacron.ToUpper() == "PMX")
                        {
                            AUEmail = "Linda.Garber@pmi.org";
                        }
                        string msg = "<p>Dear Author,</p><p>I have not yet received any corrections from you regarding your article. Please send back any corrections you wish to make by " + CalculateDueDate("", Db, DateTime.Today, 2).ToString("MM/dd/yyyy").Replace('-', '/') + " or let me know whether the article is approved for publication. Your article has been placed on hold while we await your response.</p><p>Many thanks in advance.</p><p>Yours sincerely,<br>" + ReturnDetail("Jrnl_Contact", "Journal", Db, "Jrnl_Acronym='" + jacron + "' AND Jrnl_PublID='4'") + "</p>";
                        MailMessage MM = new MailMessage();
                        //MM = new MailMessage("sagepub@novatechset.com", AUEmail, ReturnDetail("jrnl_acronym", "journal", Db, "jrnl_id=" + rows[j]["Artcl_JrnlId"].ToString()) + " " + aid + " -- Proof corrections Reminder", msg);                       
                        string fromid = "sagepub@novatechset.com";
                        if (jacron.ToUpper() == "IJPP") { fromid = "IJP_SAGEpub@novatechset.com"; }
                        else if (jacron.ToUpper() == "RBP") { fromid = "RBPE_SAGEpub@novatechset.com"; }
                        else { fromid = jacron.ToUpper() + "_SAGEpub@novatechset.com"; }
                        MM = new MailMessage(fromid, AUEmail, jacron.ToUpper() + " " + aid + " -- Proof corrections Reminder", msg);
                        //MM = new MailMessage("sagepub@novatechset.com", "parthiban@novatechset.com", ReturnDetail("jrnl_acronym", "journal", Db, "jrnl_id=" + rows[j]["Artcl_JrnlId"].ToString()) + " " + aid + " -- Proof corrections Reminder", msg);
                        //MM.CC.Add("sagepub@novatechset.com");
                        MM.CC.Add(fromid);
                        //MM.CC.Add("tiworkflow@novatechset.com");
                        SaveToReport("Status: SAGE Reminder From -- " + fromid);
                        SaveToReport("Status: SAGE Reminder To -- " + AUEmail);
                        //SaveToReport("Status: SAGE Reminder cc -- sagepub@novatechset.com;tiworkflow@novatechset.com");
                        SaveToReport("Status: SAGE Reminder cc -- " + fromid + ";tiworkflow@novatechset.com");
                        SaveToReport("Status: SAGE Reminder Sub -- " + MM.Subject.ToString());
                        SaveToReport("Status: SAGE Reminder Body -- " + msg);
                        SmtpClient client = new SmtpClient(SerializedClass.MailServer);
                        MM.IsBodyHtml = true;
                        client.Send(MM);
                    }
                    catch (Exception ex)
                    {
                        SaveToReport(ex.Message + ex.StackTrace);
                        continue;
                    }
                    string Query = "update article set Artcl_NIH='3' where Artcl_ArticleId='" + aid + "' and Artcl_JrnlId=" + rows[j]["Artcl_JrnlId"].ToString();
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                }
            }
            catch (Exception ex) { SaveToReport(ex.Message + ex.StackTrace); }
        }

        public void OSA_Onshore_Reminder()
        {
            try
            {
                DBClass Db = new DBClass();
                string Q = "select * from article where Artcl_JrnlId in (select jrnl_id from journal where Jrnl_PublID=105 and isnull(Jrnl_UploadType,'')<>'EditGenie' and isnull(Jrnl_UploadTypeNew,'')<>'EditGenie')and isnull(Artcl_UploadedDt,'')='' and Artcl_Status='TU-CE' and ISNULL(Artcl_NIH,'')='' and isnull(Artcl_PDFToAuthor,'')<>'' and convert(date,Artcl_PDFToAuthor,112)= convert(date,GETDATE(),112)";
                Db.Sqladptr = new SqlDataAdapter(new SqlCommand(Q, Db.GetConnection()));
                Db.dt = new DataTable();
                Db.Sqladptr.Fill(Db.dt);
                Db.CloseConnection();
                DataSet ds = new DataSet("New_DataSet");
                ds.Tables.Add(Db.dt);
                var rows = ds.Tables[0].Rows;
                for (int j = 0; j < rows.Count; j++)
                {
                    string aid = rows[j]["Artcl_ArticleId"].ToString();
                    string AUEmail = "tim.williams@sunrise-setting.co.uk";
                    DateTime ddate = Convert.ToDateTime(rows[j]["artcl_CEDuedate"]);
                    SaveToReport("Status: OSA Reminder for --" + aid);
                    try
                    {
                        string jacro = ReturnDetail("jrnl_acronym", "journal", Db, "jrnl_id=" + rows[j]["Artcl_JrnlId"].ToString());
                        string msg = "Hi Tim Williams,<Br/><Br/>We have not received the copyedited manuscript of " + aid.ToUpper() + ".<Br/><Br/>Copyedited Files Due By: <b>" + ddate.ToString("dd-MMM-yyyy  HH:mm:ss") + "(GMT)</b><Br/><Br/>Would request you to check and upload the completed files at the earliest.<Br/><Br/> Regards<Br/> OSA Journals.";
                        MailMessage MM = new MailMessage();
                        string fromid = "osajournals@novatechset.com";
                        MM = new MailMessage(fromid, AUEmail, "OSA (Chaser 1) - Status Request - " + aid, msg);
                        SaveToReport("Status: SAGE Reminder From -- " + fromid + ";admin@sunrise-setting.co.uk");
                        SaveToReport("Status: SAGE Reminder To -- " + AUEmail);
                        SaveToReport("Status: SAGE Reminder cc -- " + fromid + ";tiworkflow@novatechset.com;osajournals@novatechset.com,dataconversion@novatechset.com");
                        SaveToReport("Status: SAGE Reminder Sub -- " + MM.Subject.ToString());
                        SaveToReport("Status: SAGE Reminder Body -- " + msg);
                        MM.To.Add("admin@sunrise-setting.co.uk");
                        MM.CC.Add("osajournals@novatechset.com,dataconversion@novatechset.com");
                        MM.Bcc.Add("tiworkflow@novatechset.com");
                        SmtpClient client = new SmtpClient(SerializedClass.MailServer);
                        MM.IsBodyHtml = true;
                        client.Send(MM);
                    }
                    catch (Exception ex)
                    {
                        SaveToReport(ex.Message + ex.StackTrace);
                        continue;
                    }
                    string Query = "update article set Artcl_NIH='1' where Artcl_ArticleId='" + aid + "' and Artcl_JrnlId=" + rows[j]["Artcl_JrnlId"].ToString();
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                }
            }
            catch (Exception ex) { SaveToReport(ex.Message + ex.StackTrace); }
        }

        public void ASCE_Onshore_Reminder()
        {
            try
            {
                DBClass Db = new DBClass();
                string Q = "select * from article where Artcl_JrnlId in (select jrnl_id from journal where Jrnl_PublID=101 and isnull(Jrnl_UploadType,'')<>'EditGenie' and isnull(Jrnl_UploadTypeNew,'')<>'EditGenie')and isnull(Artcl_UploadedDt,'')='' and Artcl_Status='TU-CE' and ISNULL(Artcl_NIH,'')='' and isnull(Artcl_PDFToAuthor,'')<>'' and convert(date,Artcl_PDFToAuthor,112)= convert(date,GETDATE(),112)";
                Db.Sqladptr = new SqlDataAdapter(new SqlCommand(Q, Db.GetConnection()));
                Db.dt = new DataTable();
                Db.Sqladptr.Fill(Db.dt);
                Db.CloseConnection();
                DataSet ds = new DataSet("New_DataSet");
                ds.Tables.Add(Db.dt);
                var rows = ds.Tables[0].Rows;
                for (int j = 0; j < rows.Count; j++)
                {
                    string aid = rows[j]["Artcl_ArticleId"].ToString();
                    string AUEmail = "bryony.coulson@sunrise-setting.co.uk";
                    //AUEmail = "parthiban@novatechset.com";
                    DateTime ddate = Convert.ToDateTime(rows[j]["artcl_CEDuedate"]);
                    SaveToReport("Status: ASCE Reminder for --" + aid);
                    try
                    {
                        string jacro = ReturnDetail("jrnl_acronym", "journal", Db, "jrnl_id=" + rows[j]["Artcl_JrnlId"].ToString());
                        string msg = "Hi Bryony Coulson,<Br/><Br/>We have not received the copyedited manuscript of " + aid.ToUpper() + ".<Br/><Br/>Copyedited Files Due By: <b>" + ddate.ToString("dd-MMM-yyyy  HH:mm:ss") + "(GMT)</b><Br/><Br/>Would request you to check and upload the completed files at the earliest.<Br/><Br/> Regards<Br/> ASCE Journals.";
                        MailMessage MM = new MailMessage();
                        string fromid = "ascejournals@novatechset.com";
                        MM = new MailMessage(fromid, AUEmail, "ASCE (Chaser 1) - Status Request - " + aid, msg);
                        SaveToReport("Status: SAGE Reminder From -- " + fromid + ";admin@sunrise-setting.co.uk");
                        SaveToReport("Status: SAGE Reminder To -- " + AUEmail);
                        SaveToReport("Status: SAGE Reminder cc -- " + fromid + ";tiworkflow@novatechset.com;");
                        SaveToReport("Status: SAGE Reminder Sub -- " + MM.Subject.ToString());
                        SaveToReport("Status: SAGE Reminder Body -- " + msg);
                        MM.To.Add("admin@sunrise-setting.co.uk");
                        MM.CC.Add("asce@sunrise-setting.co.uk");
                        MM.CC.Add(fromid);
                        //MM.Bcc.Add("tiworkflow@novatechset.com");
                        SmtpClient client = new SmtpClient(SerializedClass.MailServer);
                        MM.IsBodyHtml = true;
                        client.Send(MM);
                    }
                    catch (Exception ex)
                    {
                        SaveToReport(ex.Message + ex.StackTrace);
                        continue;
                    }
                    string Query = "update article set Artcl_NIH='1' where Artcl_ArticleId='" + aid + "' and Artcl_JrnlId=" + rows[j]["Artcl_JrnlId"].ToString();
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                }
            }
            catch (Exception ex) { SaveToReport(ex.Message + ex.StackTrace); }
        }

        public static byte[] ReadFully(Stream input)
        {
            byte[] buffer = new byte[16 * 1024];
            using (MemoryStream ms = new MemoryStream())
            {
                int read;
                while ((read = input.Read(buffer, 0, buffer.Length)) > 0)
                {
                    ms.Write(buffer, 0, read);
                }
                return ms.ToArray();
            }
        }
        //--Added By Kamesh Start
        public void ValidateAPS()
        {
            if (DateTime.Now.Hour == 10 && DateTime.Now.Minute <= 6 && !bIsValidateRun)
            {
                DBClass Db = new DBClass();
                string strMailBody = "";
                string url = "https://api.novatechset.com/api/DailyReport/DataInfo?JrnlCode=PRApplied";
                //string url = "http://localhost:59022/api/DailyReport/DataInfo?JrnlCode=PRApplied";
                HttpWebRequest request = (HttpWebRequest)WebRequest.Create(url);
                request.Timeout = 90000;
                try
                {
                    strMailBody = " Hi,</br></br>This is an auto-generated Message.";
                    using (WebResponse response = (HttpWebResponse)request.GetResponse())
                    {
                        byte[] bytes = ReadFully(response.GetResponseStream());
                        var str = System.Text.Encoding.UTF8.GetString(bytes);
                        XmlDocument doc = (XmlDocument)JsonConvert.DeserializeXmlNode(str, "Root");
                        XmlDocument docIn = (XmlDocument)JsonConvert.DeserializeXmlNode("{\"root\":" + doc.ChildNodes[0].ChildNodes[1].InnerText + "}", "root");
                        strMailBody += "</br></br><table style='border:2px Solid;'><tr><th style='border:2px Solid;'>ArticleID- Stage</th><th style='border:2px Solid;'>Date</th></tr>";
                        Boolean ismissFP = false;
                        if (docIn.ChildNodes[0].HasChildNodes)
                            if (docIn.ChildNodes[0].ChildNodes.Count > 0)
                            {
                                for (int i = 0; i < docIn.ChildNodes[0].ChildNodes.Count; i++)
                                {
                                    Db.Sqladptr = new SqlDataAdapter(new SqlCommand("SELECT * FROM Article WHERE Artcl_Articleid='" + docIn.ChildNodes[0].ChildNodes[i]["accode"].InnerText + "'", Db.GetConnection()));
                                    Db.OpenConnection();
                                    Db.dt = new DataTable();
                                    Db.Sqladptr.Fill(Db.dt);
                                    Db.CloseConnection();
                                    if (Db.dt.Rows.Count == 0)
                                    {
                                        strMailBody += "<tr><td style='border:2px Solid;'>" + docIn.ChildNodes[0].ChildNodes[i]["accode"].InnerText + "- FirstProof</td><td style='border:2px Solid;'>" + docIn.ChildNodes[0].ChildNodes[i]["deadlineDate"].InnerText + "</td>";
                                        ismissFP = true;
                                    }

                                }
                            }
                        if (!ismissFP)
                            strMailBody += "<tr><td style='border:2px Solid;' colspan='2'>No Article Missing in FirstProof Stage </td></tr>";
                        // strMailBody += str;
                    }
                    string strQueryAPS = "SELECT AF.FILENAME,AFP.TYPE FROM APS_FILES AF WITH (NOLOCK) INNER JOIN APS_FILES_PROCESS AFP WITH (NOLOCK) ON AF.FILEID=AFP.FILEID WHERE AFP.STATUS=0 AND AFP.TYPE IN ('VENDORBUNDLE/READY','FILEMANIFEST/UPDATED','MANUSCRIPTDATA/UPDATED') AND CONVERT(VARCHAR,AFP.CREATEDTIME,112)>=CONVERT(VARCHAR,GETDATE()-10,112) AND CONVERT(VARCHAR,AFP.CREATEDTIME,112)<=CONVERT(VARCHAR,GETDATE()-1,112)";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(strQueryAPS, Db.GetConnectionAPS());
                    Db.OpenConnectionAPS();
                    Db.Sqladptr = new SqlDataAdapter(new SqlCommand(strQueryAPS, Db.GetConnectionAPS()));
                    Db.ds = new DataSet();
                    Db.Sqladptr.Fill(Db.ds);
                    Db.CloseConnectionAPS();

                    Boolean ismissAPS = false;
                    if (Db.ds.Tables.Count > 0)
                        if (Db.ds.Tables[0].Rows.Count > 0)
                        {
                            for (int i = 0; i < Db.ds.Tables[0].Rows.Count; i++)
                            {
                                strMailBody += "<tr><td style='border:2px Solid;'>" + Db.ds.Tables[0].Rows[i]["FILENAME"] + "- Download </td><td style='border:2px Solid;'>" + Db.ds.Tables[0].Rows[i]["FILENAME"] + "</td>";
                                ismissAPS = true;
                            }
                        }
                    if (!ismissAPS)
                        strMailBody += "<tr><td style='border:2px Solid;' colspan='2'>No Article Missing in VENDORBUNDLE/READY, FILEMANIFEST/UPDATED, MANUSCRIPTDATA/UPDATED Stage </td></tr>";
                    string strQuery = "exec GETAPSValidateList";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(strQuery, Db.GetConnectionSesame());
                    Db.OpenConnectionSesame();
                    Db.Sqladptr = new SqlDataAdapter(new SqlCommand(strQuery, Db.GetConnectionSesame()));
                    Db.ds = new DataSet();
                    Db.Sqladptr.Fill(Db.ds);
                    Db.CloseConnectionSesame();
                    if (Db.ds.Tables.Count > 3)
                    {
                        //strMailBody += "</br></br><table style='border:2px Solid;'><tr><th style='border:2px Solid;'>ArticleID- Stage</th><th style='border:2px Solid;'>Date</th></tr>";
                        if (Db.ds.Tables[3].Rows.Count > 0)
                        {
                            foreach (DataRow dr in Db.ds.Tables[3].Rows)
                            {
                                strMailBody += "<tr><td style='border:2px Solid;'>" + dr[0].ToString() + " - Details info Missing</td><td style='border:2px Solid;'>" + dr[1].ToString() + "</td>";
                            }
                        }
                        else
                            strMailBody += "<tr><td style='border:2px Solid;' colspan='2'>No Article found in Details info Missing</td></tr>";
                        if (Db.ds.Tables[0].Rows.Count > 0)
                        {
                            foreach (DataRow dr in Db.ds.Tables[0].Rows)
                            {
                                strMailBody += "<tr><td style='border:2px Solid;'>" + dr[0].ToString() + " - AU Correction</td><td style='border:2px Solid;'>" + dr[1].ToString() + "</td>";
                            }
                        }
                        else
                            strMailBody += "<tr><td style='border:2px Solid;' colspan='2'>No Article Missing in Au Correction Stage </td></tr>";
                        if (Db.ds.Tables[1].Rows.Count > 0)
                        {
                            foreach (DataRow dr in Db.ds.Tables[1].Rows)
                            {
                                strMailBody += "<tr><td style='border:2px Solid;'>" + dr[0].ToString() + " - PM Correction</td><td style='border:2px Solid;'>" + dr[1].ToString() + "</td>";
                            }
                        }
                        else
                            strMailBody += "<tr><td style='border:2px Solid;' colspan='2'>No Article Missing in PM Correction Stage </td></tr>";
                        if (Db.ds.Tables[2].Rows.Count > 0)
                        {
                            Boolean IsMissing = false;
                            foreach (DataRow dr in Db.ds.Tables[2].Rows)
                            {
                                Db.Sqladptr = new SqlDataAdapter(new SqlCommand("SELECT * FROM JR_Articles INNER JOIN JR_Stage_Tran ON JRA_JRST_ID=JRST_ID WHERE JRA_ArticleID='" + dr[0].ToString() + "' AND JRA_StageID=58", Db.GetConnection()));
                                Db.OpenConnection();
                                Db.dt = new DataTable();
                                Db.Sqladptr.Fill(Db.dt);
                                Db.CloseConnection();
                                if (Db.dt.Rows.Count == 0)
                                {
                                    strMailBody += "<tr><td style='border:2px Solid;'>" + dr[0].ToString() + " - PAP</td><td style='border:2px Solid;'>" + dr[1].ToString() + "</td>";
                                    IsMissing = true;
                                }
                            }
                            if (!IsMissing)
                                strMailBody += "<tr><td style='border:2px Solid;' colspan='2'>No Article Missing in PAP Stage</td></tr>";
                        }
                        else
                            strMailBody += "<tr><td style='border:2px Solid;' colspan='2'>No Article Missing in PAP Stage</td></tr>";
                    }
                    strMailBody += "</table>";
                    SendMail("", strMailBody, "APS", false, "APSVAL");
                }
                catch (WebException e1)
                {
                    //Console.WriteLine("\"0|" + e1.Message + "\"");
                    SendMail(e1.Message + "\n" + e1.StackTrace, "", "APS", true, "APSVAL");
                }
                bIsValidateRun = true;
            }
            else if (bIsValidateRun && DateTime.Now.Hour > 10)
                bIsValidateRun = false;

        }
        //--Added By Kamesh End
        public void Book_APS(string CL, string ByType = "")
        {
            string stage = "First Proof Stage";
            DBClass Db = new DBClass();
            try
            {
                XDocument XDoc = new XDocument();
                XDocument XDoc1 = new XDocument();
                SaveToReport("Status: Validating ManuScript file: " + Path.GetFileName(Zipname));
                if (ByType == "FileChanged")
                {
                    if (File.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\fileManifest.json"))
                    {
                        SaveToReport("Status: File changed Request for APS: " + Path.GetFileName(Zipname));
                        try
                        {
                            XmlDocument doc = (XmlDocument)JsonConvert.DeserializeXmlNode(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\fileManifest.json"), "Root");
                            File.WriteAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\fileManifest.xml", doc.InnerXml.ToString());
                            XDoc = XDocument.Parse(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\fileManifest.xml"), LoadOptions.PreserveWhitespace);
                        }
                        catch (Exception e)
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>fileManifest.json file is not valid for APS: ", "APS", true, stage, Zipname);
                            SaveToReport("manuscript.json file is not valid for:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                            Clear();
                            return;
                        }
                        SaveToReport("Status: File Copy: " + Zipname + @" to \\techsetserver2\Journal\Aps\PRApplied\Articles\DataSupplied\FileChanged\" + Path.GetFileName(Zipname));
                        File.Copy(Zipname, @"\\techsetserver2\Journal\Aps\PRApplied\Articles\DataSupplied\FileChanged\" + Path.GetFileName(Zipname), true);
                        SaveToReport("Status: File Copy: " + Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\fileManifest.xml to \\techsetserver2\Journal\Aps\PRApplied\Articles\DataSupplied\FileChanged\" + Path.GetFileNameWithoutExtension(Zipname) + "_fileManifest.xml" + Path.GetFileName(Zipname));
                        File.Copy(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\fileManifest.xml", @"\\techsetserver2\Journal\Aps\PRApplied\Articles\DataSupplied\FileChanged\" + Path.GetFileNameWithoutExtension(Zipname) + "_fileManifest.xml", true);
                        SaveToReport(@"Status: Unzipping: to \\techsetserver2\Journal\Aps\PRApplied\Articles\DataSupplied\FileChanged\" + Path.GetFileName(Zipname));
                        //UnZip(@"\\techsetserver2\Journal\Aps\PRApplied\Articles\DataSupplied\FileChanged\" + Path.GetFileName(Zipname), @"\\techsetserver2\Journal\Aps\PRApplied\Articles\DataSupplied\FileChanged\");
                        try
                        {
                            UnZip(@"\\techsetserver2\Journal\Aps\PRApplied\Articles\DataSupplied\FileChanged\" + Path.GetFileName(Zipname), @"\\techsetserver2\Journal\Aps\PRApplied\Articles\DataSupplied\FileChanged\");
                        }
                        catch (Exception e) { }
                        SaveToReport("Status: Send mail " + Path.GetFileName(Zipname));
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Kindly find the file changed request details for APS: " + Zipname + @"<Br/><Br/>Path: \\techsetserver2\Journal\Aps\PRApplied\Articles\DataSupplied\FileChanged", "APS", false, "APS_Changes", Zipname);
                        SaveToReport("Status: Archival " + Path.GetFileName(Zipname));
                        if (Directory.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname))) Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                        if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                        {
                            Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                        }
                        File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                        File.Delete(Zipname);
                        try
                        {
                            Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                        }
                        catch { }
                        ;
                        SaveToReport("Article file changed request processed successfully: Process completed. " + Path.GetFileName(Zipname));
                    }
                    else
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>fileManifest.json file missing for APS: ", "APS", true, stage, Zipname);
                        SaveToReport("fileManifest.json file missing for:  " + Path.GetFileName(Zipname));
                        Clear();
                    }
                    return;
                }
                else if (ByType == "Rescinded")
                {
                    string Aid1 = "NS10138";
                    SaveToReport("Status: File Rescinded Request for APS: " + Path.GetFileName(Zipname));
                    if (CheckWhetherFileBooked(Aid1))
                    {
                        string Atid = ReturnDetail("Artcl_ArticleId", "Article", Db, "Artcl_ArticleId='" + Aid1 + "'");
                        string Query = "INSERT INTO JTS_TrnsJournal SELECT * FROM TrnsJournal where JrnlTrns_ArticleId='" + Atid + "'";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status:" + Query + " " + Path.GetFileName(Zipname));
                        Query = "DELETE FROM TrnsJournal WHERE JrnlTrns_ArticleId='" + Atid + "'";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status:" + Query + " " + Path.GetFileName(Zipname));
                        Query = "INSERT INTO JTS_Article SELECT * FROM Article where Artcl_ArticleId='" + Aid1 + "'";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status:" + Query + " " + Path.GetFileName(Zipname));
                        Query = "DELETE FROM Article WHERE Artcl_ArticleId='" + Aid1 + "'";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status:" + Query + " " + Path.GetFileName(Zipname));
                        if (Directory.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname))) Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                        if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                        {
                            Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                        }
                        File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                        SaveToReport(@"Status: SESAME Signal \\techsetserver2\Upload\TARS\" + Aid1 + "_Article_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt APSArticleRescinded|'" + Aid1 + "' " + Path.GetFileName(Zipname));
                        File.WriteAllText(@"\\techsetserver2\Upload\TARS\" + Aid1 + "_Article_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt", "APSArticleRescinded|'" + Aid1 + "'");
                        SendMail(Aid1, "Dear Team,<Br/><Br/>Article rescinded successfully: " + Path.GetFileName(Zipname), "APS", false, "First Proof Stage");
                        SaveToReport("Article rescinded successfully: Process completed. " + Path.GetFileName(Zipname));
                    }
                    else
                    {
                        SendMail(Aid1, "Dear Team,<Br/><Br/>File not booked for First Proof: " + Path.GetFileName(Zipname), "APS", true, "First Proof Stage");
                        SaveToReport("File not booked for First Proof: " + Path.GetFileName(Zipname));
                        Clear();
                    }
                    return;
                }

                if (File.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\manuscript.json"))
                {
                    try
                    {
                        XmlDocument doc = (XmlDocument)JsonConvert.DeserializeXmlNode(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\manuscript.json"), "Root");
                        File.WriteAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\manuscript.xml", doc.InnerXml.ToString());
                        XDoc = XDocument.Parse(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\manuscript.xml"), LoadOptions.PreserveWhitespace);
                    }
                    catch (Exception e)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>manuscript.json file is not valid for APS: ", "APS", true, stage, Zipname);
                        SaveToReport("manuscript.json file is not valid for:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                        Clear();
                        return;
                    }

                }
                //*** Changed
                else if (File.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @".json"))
                {
                    string fname = "";
                    try
                    {
                        XmlDocument doc = (XmlDocument)JsonConvert.DeserializeXmlNode(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @".json"), "Root");
                        File.WriteAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\manuscript.xml", doc.InnerXml.ToString());
                        XDoc = XDocument.Parse(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\manuscript.xml"), LoadOptions.PreserveWhitespace);
                        //string fname = System.Environment.CurrentDirectory + @"\AIP_Report\AIP_Excel_Report_" + DateTime.Now.ToString("ddMMyyyy_hhmmss") + @".xlsx";
                        fname = Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\manuscript.xml";
                    }
                    catch (Exception e)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>" + Path.GetFileNameWithoutExtension(Zipname) + @".json file is not valid for APS: ", "APS", true, stage, Zipname);
                        SaveToReport("manuscript.json file is not valid for:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                        Clear();
                        //Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                        return;
                    }
                    if (XDoc.XPathSelectElements(@"//data/changeSummary").Count() > 0)
                    {
                        try
                        {
                            /*Added Saravanakumar*/
                            string Articleid = "";
                            Articleid = ReturnDetail("Artcl_ArticleId", "Article", Db, "Artcl_ArticleId like'%" + Path.GetFileNameWithoutExtension(Zipname) + "%'");
                            foreach (XElement e in XDoc.XPathSelectElements(@"//data/changeSummary").ToList())
                            {
                                if (e.Elements("path").Count() > 0)
                                {
                                    string strpath = e.Elements("path").First().Value;

                                    if (strpath.Contains("statusEvents") == true)
                                    {
                                        strpath = "/metadata/statusevents";
                                    }
                                    else if (strpath.Contains("editorialFeatures") == true)
                                    {
                                        strpath = "/metadata/editorialFeatures";
                                    }
                                    else if (strpath.Contains("targetDate") == true)
                                    {
                                        strpath = "/processingInstructions/targetDate";
                                    }
                                    else if (strpath.Contains("productionHolds") == true)
                                    {
                                        strpath = "/processingInstructions/productionHolds";
                                    }
                                    else if (strpath.Contains("figures") == true)
                                    {
                                        strpath = "/processingInstructions/figures/count";
                                    }
                                    else if (strpath.Contains("supplementalMaterial") == true)
                                    {
                                        strpath = "/processingInstructions/supplementalMaterial";
                                    }
                                    else if (strpath.Contains("general") == true)
                                    {
                                        strpath = "/processingInstructions/general/note";
                                    }
                                    else if (strpath.Contains("authorCommunication/memos") == true)
                                    {
                                        strpath = "/processingInstructions/authorCommunication/memos";
                                    }
                                    else if (strpath.Contains("authorCommunication/note") == true)
                                    {
                                        strpath = "/processingInstructions/authorCommunication/note";
                                    }
                                    else if (strpath.Contains("premarkedManuscript") == true)
                                    {
                                        strpath = "/processingInstructions/premarkedManuscript/value";
                                    }
                                    switch (strpath)
                                    {
                                        case "/metadata/title/value":
                                        case "/metadata/identifiers/doi":
                                        case "/metadata/statusevents":
                                        case "/metadata/editorialFeatures":
                                        case "/processingInstructions/targetDate":
                                        case "/processingInstructions/productionHolds":
                                        case "/processingInstructions/figures/count":
                                        case "/processingInstructions/supplementalMaterial":
                                        case "/processingInstructions/general/note":
                                        case "/processingInstructions/authorCommunication/memos":
                                        case "/processingInstructions/authorCommunication/note":
                                        case "/processingInstructions/premarkedManuscript/value":
                                            updateapschanges(strpath, e, Path.GetFileNameWithoutExtension(Zipname), Db, "");
                                            break;
                                        default:
                                            SendMail(Articleid, "Dear APS Team,<Br/><Br/>We have received new change request of existing article : " + Articleid + "<Br/><Br/> " + e + "<Br/><Br/> Kindly check & confirm to procceed further.", "APS", false, "APS_Changes", fname);
                                            continue;
                                    }
                                }
                            }

                            if (Directory.Exists(@"\\Techsetserver2\Journal\APS\PRApplied\Articles\DataSupplied\" + Articleid + @"\First Proof\"))
                            {
                                File.Copy(fname, @"\\Techsetserver2\Journal\APS\PRApplied\Articles\DataSupplied\" + Articleid + @"\First Proof\Changed_" + DateTime.Now.ToString("ddMMyyyyHHmmss") + "_" + Path.GetFileName(fname));
                                //File.Copy(fname, @"D:\Changed_" + DateTime.Now.ToString("ddMMyyyyHHmmss") + "_" + Path.GetFileName(fname));
                            }
                            System.Threading.Thread.Sleep(7000);
                            SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));

                            if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                            {
                                Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                            }
                            File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                            File.Delete(Zipname);

                            try
                            {
                                Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                            }
                            catch { }
                            ;

                            return;
                        }
                        catch (Exception e)
                        {
                            SaveToReport("Error in Changed Article Exception:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                            return;
                        }
                    }
                }
                //***
                else
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>manuscript.json file missing for APS: ", "APS", true, stage, Zipname);
                    SaveToReport("manuscript.json file missing for:  " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    // Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname),true);
                    return;
                }
                if (File.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\fileManifest.json"))
                {
                    try
                    {
                        //JObject obj = JObject.Parse(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\manuscript.json"));
                        //foreach (var jt in obj)
                        //{
                        //    foreach (var jt1 in jt.Value)
                        //    {
                        //        string s = jt1.ToString();
                        //    }
                        //}
                        XmlDocument doc1 = (XmlDocument)JsonConvert.DeserializeXmlNode(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\fileManifest.json"), "Root");
                        File.WriteAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\fileManifest.xml", doc1.InnerXml.ToString());
                        XDoc1 = XDocument.Parse(File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\fileManifest.xml"), LoadOptions.PreserveWhitespace);
                    }
                    catch (Exception e)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>fileManifest.json file is not valid for APS: ", "APS", true, stage, Zipname);
                        SaveToReport("fileManifest.json file is not valid for:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                        Clear();
                        //Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                        return;
                    }

                }
                else
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>fileManifest.json file missing for APS: ", "APS", true, stage, Zipname);
                    SaveToReport("fileManifest.json file missing for:  " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    // Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname),true);
                    return;
                }
                SaveToReport("Status: Validating against Booked Records: " + Path.GetFileName(Zipname));
                if (XDoc.XPathSelectElements(@"//metadata/identifiers/accode_with_transfer").Count() == 0)
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'accode_with_transfer' article id missing in manuscript.json file: for APS: ", "APS", true, stage, Zipname);
                    SaveToReport("'aipid' article id missing in Readme xml file: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                //string Aid = XDoc.Descendants("metadata").First().Elements("id").First().Value;       
                string Aid = XDoc.XPathSelectElements(@"//metadata/identifiers/accode_with_transfer").First().Value;
                if (CheckWhetherFileBooked(Aid))
                {
                    //if (XDoc.Descendants("submission_type").First().Value.ToLower() == "starter")
                    //{
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for First Proof: ", "APS", true, stage, Zipname);
                    SaveToReport("File already booked for First Proof: " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                    //}                 
                }

                SaveToReport(@"Status: Collecting data from manuscript.json file: " + Path.GetFileName(Zipname));
                string Auname = "", Auemail = "", Doi = "", Title = "", Txtfolio = "", TxtElec = "", LineArt = "", ArtElec = "", Rdate = "", Artwork = "", Sdate = "", Srcby = "", Atype = "", atypeval = "";
                string Title_type = "", License_Url = "", License_Type = "", License_P = "", CpyR_Yr = "", CpyR_Stmnt = "", CpyR_Holder_Type = "", CpyR_Holder_Entity_Nme = "", CpyR_Holder_Entity_Type = "", Src_Name = "", Src_Type = "", Src_ID_Jcode = "", Src_AbbName = "", Toc_Lbl = "", Article_Type = "", ID_Accode = "", ID_Accode_Transfer = "", Revised_Date = "", Pub_Date = "", Rel_Item_Accode = "", Rel_Type = "", Rel_Lbl = "", E_flags1 = "", E_flags2 = "", Proces_Ins_Id = "", Proces_Ins_Rush_lbl = "", Proces_Ins_Rush_Val = "", cjkAus_Lbl = "", cjkAus_Val = "", Scoap3Candi_Lbl = "", Scoap3Candi_Val = "", Pmarked_MS_Lbl = "", Pmarked_MS_Val = "", Contact_Person = "", Aps_Contact_Person = "", Ref_Note = "", Artcl_Version = "", CreatedAt = "", targetDate = "",/*add by saravanakumar on 13-06-2018*/ ProductionHoldsId = "", ProductionHoldsLable = "", General_Notes = "", MultiMedia = "", Figures_Note = "", FiguresCount = "", FiguresColorInPrt = "", Length_Note = "", authorCom_Note = "", authorCom_Memos_Id = "", authorCom_Memos_url = "", supplementalMaterial = "", CopyEditLevel_Note = "", CopyEditLevel_Lbl = "", FutureinPhysics = "", Invited = "", Gfm = "", Suggestion = "", qchold = "", payhold = "", Edithold = "", TOCArtclCode = "", PublishWithGroupsPaperIandII = "", PublishWithGroupsBanded = "";
                if (XDoc.XPathSelectElements(@"//metadata/articleType").Count() > 0) Atype = XDoc.XPathSelectElements(@"//metadata/articleType").First().Value;
                if (XDoc.Descendants("doi").Count() > 0) Doi = XDoc.Descendants("doi").First().Value;
                if (XDoc.XPathSelectElements(@"//metadata/title/value").Count() > 0) Title = XDoc.XPathSelectElements(@"//metadata/title/value").First().Value;
                if (XDoc.Descendants("numPages").Count() > 0) Txtfolio = XDoc.Descendants("numPages").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/figures/count").Count() > 0) LineArt = XDoc.XPathSelectElements(@"//processingInstructions/figures/count").First().Value;
                foreach (XElement e in XDoc.XPathSelectElements(@"//metadata//statusEvents").ToList())
                {
                    if (e.Elements("type").Count() > 0 && e.Elements("date").Count() > 0)
                    {
                        switch (e.Elements("type").First().Value.ToLower())
                        {
                            case "received":
                                Rdate = e.Elements("date").First().Value;
                                continue;
                            case "deadlined":
                                Sdate = e.Elements("date").First().Value;
                                continue;
                            case "published":
                                Pub_Date = e.Elements("date").First().Value;
                                continue;
                            case "revised":
                                Revised_Date = e.Elements("date").First().Value;
                                continue;
                        }
                    }
                }
                if (XDoc.XPathSelectElements(@"//processingInstructions/contact/person/name").Count() > 0) Auname = XDoc.XPathSelectElements(@"//processingInstructions/contact/person/name").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/contact/person/email").Count() > 0) Auemail = XDoc.XPathSelectElements(@"//processingInstructions/contact/person/email").First().Value;
                if (XDoc.XPathSelectElements(@"//metadata/title/type").Count() > 0) Title_type = XDoc.XPathSelectElements(@"//metadata/title/type").First().Value;
                if (XDoc.XPathSelectElements(@"//metadata/rights/licenses/url").Count() > 0) License_Url = XDoc.XPathSelectElements(@"//metadata/rights/licenses/url").First().Value;
                if (XDoc.XPathSelectElements(@"//metadata/rights/licenses/type").Count() > 0) License_Type = XDoc.XPathSelectElements(@"//metadata/rights/licenses/type").First().Value;
                if (XDoc.XPathSelectElements(@"//metadata/rights/licenses/usageStatement/value/license-p").Count() > 0) License_P = XDoc.XPathSelectElements(@"//metadata/rights/licenses/usageStatement/value/license-p").First().Value;
                if (XDoc.XPathSelectElements(@"//metadata/rights/copyrightYear").Count() > 0) CpyR_Yr = XDoc.XPathSelectElements(@"//metadata/rights/copyrightYear").First().Value;
                if (XDoc.XPathSelectElements(@"//metadata/rights/rightsStatement").Count() > 0) CpyR_Stmnt = XDoc.XPathSelectElements(@"//metadata/rights/rightsStatement").First().Value;
                if (XDoc.XPathSelectElements(@"//metadata/rights/copyrightHolders/type").Count() > 0) CpyR_Holder_Type = XDoc.XPathSelectElements(@"//metadata/rights/copyrightHolders/type").First().Value;
                if (XDoc.XPathSelectElements(@"//metadata/rights/copyrightHolders/entity/name").Count() > 0) CpyR_Holder_Entity_Nme = XDoc.XPathSelectElements(@"//metadata/rights/copyrightHolders/entity/name").First().Value;
                if (XDoc.XPathSelectElements(@"//metadata/rights/copyrightHolders/entity/type").Count() > 0) CpyR_Holder_Entity_Type = XDoc.XPathSelectElements(@"//metadata/rights/copyrightHolders/entity/type").First().Value;
                if (XDoc.XPathSelectElements(@"//metadata/source/name").Count() > 0) Src_Name = XDoc.XPathSelectElements(@"//metadata/source/name").First().Value;
                if (XDoc.XPathSelectElements(@"//metadata/source/type").Count() > 0) Src_Type = XDoc.XPathSelectElements(@"//metadata/source/type").First().Value;
                if (XDoc.XPathSelectElements(@"//metadata/source/identifiers/jcode").Count() > 0) Src_ID_Jcode = XDoc.XPathSelectElements(@"//metadata/source/identifiers/jcode").First().Value;
                if (XDoc.XPathSelectElements(@"//metadata/source/abbreviatedName").Count() > 0) Src_AbbName = XDoc.XPathSelectElements(@"//metadata/source/abbreviatedName").First().Value;
                if (XDoc.XPathSelectElements(@"//metadata/tocSection/label").Count() > 0) Toc_Lbl = XDoc.XPathSelectElements(@"//metadata/tocSection/label").First().Value;
                //added TOCArtclCode by saravanakumar on 23-08-2018
                if (XDoc.XPathSelectElements(@"//metadata/tocSection/identifiers/articleIdCode").Count() > 0) TOCArtclCode = XDoc.XPathSelectElements(@"//metadata/tocSection//identifiers/articleIdCode").First().Value;

                if (XDoc.XPathSelectElements(@"//metadata/articleType").Count() > 0) Article_Type = XDoc.XPathSelectElements(@"//metadata/articleType").First().Value;
                if (XDoc.XPathSelectElements(@"//metadata/identifiers/accode").Count() > 0) ID_Accode = XDoc.XPathSelectElements(@"//metadata/identifiers/accode").First().Value;
                if (XDoc.XPathSelectElements(@"//metadata/identifiers/accode_with_transfer").Count() > 0) ID_Accode_Transfer = XDoc.XPathSelectElements(@"//metadata/identifiers/accode_with_transfer").First().Value;
                if (XDoc.XPathSelectElements(@"//metadata/relationships/item/identifiers/accode").Count() > 0) Rel_Item_Accode = XDoc.XPathSelectElements(@"//metadata/relationships/item/identifiers/accode").First().Value;
                if (XDoc.XPathSelectElements(@"//metadata/relationships/type").Count() > 0) Rel_Type = XDoc.XPathSelectElements(@"//metadata/relationships/type").First().Value;
                if (XDoc.XPathSelectElements(@"//metadata/relationships/label").Count() > 0) Rel_Lbl = XDoc.XPathSelectElements(@"//metadata/relationships/label").First().Value;


                foreach (XElement ele in XDoc.XPathSelectElements("//processingInstructions/publishWithGroups/items/id").ToList())
                {
                    if (ele.Parent.Parent.Elements("type").Count() > 0 && ele.Parent.Parent.Elements("type").First().Value.ToLower() == "PaperI/II")
                    {
                        PublishWithGroupsPaperIandII += ele.Value + ',';
                    }
                    else if (ele.Parent.Parent.Elements("type").Count() > 0 && ele.Parent.Parent.Elements("type").First().Value.ToLower() == "Banded")
                    {
                        PublishWithGroupsBanded += ele.Value + ',';
                    }
                }

                if (PublishWithGroupsPaperIandII != "") PublishWithGroupsPaperIandII = Regex.Replace(PublishWithGroupsPaperIandII, ",$", "");
                if (PublishWithGroupsBanded != "") PublishWithGroupsBanded = Regex.Replace(PublishWithGroupsBanded, ",$", "");

                //End saravanakumar on 29-05-2019

                //Hashtable Auht = new Hashtable();
                //Hashtable EFht = new Hashtable();
                int i = 1;
                sensau = false;
                if (Auname == "")
                {
                    foreach (XElement ele in XDoc.XPathSelectElements("//processingInstructions/contacts/person").ToList())
                    {
                        if (ele.Parent.Elements("roles").Count() > 0 && ele.Parent.Elements("roles").First().Value.ToLower() == "authors")
                        {
                            if (ele.Elements("email").Count() > 0)
                            {
                                Auname = ele.Elements("name").First().Value;
                                Auemail = ele.Elements("email").First().Value;
                                UpdateAuthors(Db, ele, Aid, 1);
                                //break;
                            }
                            else UpdateAuthors(Db, ele, Aid, 0);
                        }
                    }
                }
                else
                {
                    foreach (XElement ele in XDoc.XPathSelectElements("//processingInstructions/contact/person").ToList())
                    {
                        if (ele.Elements("email").Count() > 0) UpdateAuthors(Db, ele, Aid, 1);
                        else UpdateAuthors(Db, ele, Aid, 0);
                    }
                }
                foreach (XElement ele in XDoc.XPathSelectElements("//metadata/contributorGroups/contributors").ToList())
                {
                    if (ele.Elements("role").Count() > 0 && ele.Elements("role").First().Value.ToLower() == "author" && ele.Elements("person").Count() > 0)
                    {
                        UpdateAuthors(Db, ele.Elements("person").First(), Aid, 0);
                    }
                }
                SaveToReport(@"Status: Update author details in author table file: " + Path.GetFileName(Zipname));
                i = 1;
                foreach (XElement ele in XDoc.XPathSelectElements("//metadata/editorialFeatures/flags").ToList())
                {
                    //switch (i)
                    //{
                    //    case 1:
                    //        E_flags1 = ele.ToString();
                    //        i++; continue;
                    //    case 2:
                    //        E_flags2 = ele.ToString();
                    //        i++; continue;
                    //}   

                    if (ele.Elements("value").Count() > 0)
                    {
                        switch (ele.Elements("value").First().Value.ToUpper())
                        {
                            case "PHYSICS":
                                FutureinPhysics = ele.Elements("value").First().Value;
                                continue;
                            case "INVITED":
                                Invited = ele.Elements("value").First().Value;
                                continue;
                            case "GFM":
                                Gfm = ele.Elements("value").First().Value;
                                continue;
                            case "SUGGESTION":
                                Suggestion = ele.Elements("value").First().Value;
                                continue;
                        }
                    }

                }
                if (XDoc.XPathSelectElements(@"//processingInstructions/id").Count() > 0) Proces_Ins_Id = XDoc.XPathSelectElements(@"//processingInstructions/id").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/rush/label").Count() > 0) Proces_Ins_Rush_lbl = XDoc.XPathSelectElements(@"//processingInstructions/rush/label").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/rush/value").Count() > 0) Proces_Ins_Rush_Val = XDoc.XPathSelectElements(@"//processingInstructions/rush/value").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/cjkAuthors/label").Count() > 0) cjkAus_Lbl = XDoc.XPathSelectElements(@"//processingInstructions/cjkAuthors/label").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/cjkAuthors/value").Count() > 0) cjkAus_Val = XDoc.XPathSelectElements(@"//processingInstructions/cjkAuthors/value").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/scoap3Candidate/label").Count() > 0) Scoap3Candi_Lbl = XDoc.XPathSelectElements(@"//processingInstructions/scoap3Candidate/label").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/scoap3Candidate/value").Count() > 0) Scoap3Candi_Val = XDoc.XPathSelectElements(@"//processingInstructions/scoap3Candidate/value").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/premarkedManuscript/label").Count() > 0) Pmarked_MS_Lbl = XDoc.XPathSelectElements(@"//processingInstructions/premarkedManuscript/label").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/premarkedManuscript/value").Count() > 0) Pmarked_MS_Val = XDoc.XPathSelectElements(@"//processingInstructions/premarkedManuscript/value").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/apsContact/person").Count() > 0) Aps_Contact_Person = XDoc.XPathSelectElements(@"//processingInstructions/apsContact/person").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/references/note").Count() > 0) Ref_Note = XDoc.XPathSelectElements(@"//processingInstructions/references/note").First().Value;
                if (XDoc.XPathSelectElements(@"//version").Count() > 0) Artcl_Version = XDoc.XPathSelectElements(@"//version").First().Value;
                if (XDoc.XPathSelectElements(@"//createdAt").Count() > 0) CreatedAt = XDoc.XPathSelectElements(@"//createdAt").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/targetDate").Count() > 0) targetDate = XDoc.XPathSelectElements(@"//processingInstructions/targetDate").First().Value;

                //add by saravanakumar on 13-06-2018
                if (XDoc.XPathSelectElements(@"//processingInstructions/productionHolds/id").Count() > 0) ProductionHoldsId = XDoc.XPathSelectElements(@"//processingInstructions/productionHolds/id").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/productionHolds/label").Count() > 0) ProductionHoldsLable = XDoc.XPathSelectElements(@"//processingInstructions/productionHolds/label").First().Value;
                i = 1;
                foreach (XElement e in XDoc.XPathSelectElements(@"//processingInstructions/productionHolds").ToList())
                {
                    if (e.Elements("id").Count() > 0)
                    {
                        switch (e.Elements("id").First().Value.ToLower())
                        {
                            case "qchold":
                                qchold = e.Elements("id").First().Value;
                                continue;
                            case "payhold":
                                payhold = e.Elements("id").First().Value;
                                continue;
                            default:
                                Edithold = e.Elements("id").First().Value;
                                continue;
                        }
                    }
                }

                //add by saravanakumar on 13-06-2018
                if (qchold == "" && Edithold == "" && payhold == "")
                {
                    if (XDoc.XPathSelectElements(@"//processingInstructions/productionHolds/qc/id").Count() > 0) qchold = XDoc.XPathSelectElements(@"//processingInstructions/productionHolds/qc/id").First().Value;

                    if (XDoc.XPathSelectElements(@"//processingInstructions/productionHolds/payment/id").Count() > 0) payhold = XDoc.XPathSelectElements(@"//processingInstructions/productionHolds/payment/id").First().Value;

                    if (XDoc.XPathSelectElements(@"//processingInstructions/productionHolds/editorial/id").Count() > 0) Edithold = XDoc.XPathSelectElements(@"//processingInstructions/productionHolds/editorial/id").First().Value;
                }

                if (XDoc.XPathSelectElements(@"//processingInstructions/general/note").Count() > 0) General_Notes = XDoc.XPathSelectElements(@"//processingInstructions/general/note").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/multimedia/urls/base").Count() > 0) MultiMedia = XDoc.XPathSelectElements(@"//processingInstructions/multimedia/urls/base").First().Value;


                ////add by saravanakumar on 28-06-2018
                if (XDoc.XPathSelectElements(@"//processingInstructions/figures/note").Count() > 0) Figures_Note = XDoc.XPathSelectElements(@"//processingInstructions/figures/note").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/figures/count").Count() > 0) FiguresCount = XDoc.XPathSelectElements(@"//processingInstructions/figures/count").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/figures/colorInPrint").Count() > 0) FiguresColorInPrt = XDoc.XPathSelectElements(@"//processingInstructions/figures/colorInPrint").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/length/note").Count() > 0) Length_Note = XDoc.XPathSelectElements(@"//processingInstructions/length/note").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/authorCommunication/note").Count() > 0) authorCom_Note = XDoc.XPathSelectElements(@"//processingInstructions/authorCommunication/note").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/authorCommunication/memos/id").Count() > 0) authorCom_Memos_Id = XDoc.XPathSelectElements(@"//processingInstructions/authorCommunication/memos/id").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/authorCommunication/memos/url").Count() > 0) authorCom_Memos_url = XDoc.XPathSelectElements(@"//processingInstructions/authorCommunication/memos/url").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/supplementalMaterial/urls/base").Count() > 0) supplementalMaterial = XDoc.XPathSelectElements(@"//processingInstructions/supplementalMaterial/urls/base").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/copyEditLevel/note").Count() > 0) CopyEditLevel_Note = XDoc.XPathSelectElements(@"//processingInstructions/copyEditLevel/note").First().Value;
                if (XDoc.XPathSelectElements(@"//processingInstructions/copyEditLevel/label").Count() > 0) CopyEditLevel_Lbl = XDoc.XPathSelectElements(@"//processingInstructions/copyEditLevel/label").First().Value;

                DateTime Artcl_ExpFromTIDt = new DateTime();
                DateTime s1date = CalculateDueDate("APS", Db, Convert.ToDateTime(Sdate));
                if (s1date.ToString() != "")
                {
                    Artcl_ExpFromTIDt = CalculateAIPExpFromTIDt("AIP", Db, s1date);
                }
                DateTime PEduedate = AddDays(Convert.ToDateTime(Sdate), Db, 1);
                if (Txtfolio != "") TxtElec = "1";
                if (Convert.ToInt16(LineArt) > 0) { ArtElec = "1"; Artwork = "T1"; }

                SaveToReport("Status: Booking file: " + Path.GetFileName(Zipname));
                if (Atype == "") Atype = "article";
                atypeval = ReturnDetail("ArtType_ID", "ArticleTypes", Db, "ArtType_Name='" + Atype + "'");
                if (atypeval == "")
                {
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Insert into ArticleTypes(ArtType_Name,LastModifiedDate,UsrID) values('" + Atype + "',getdate(),1)", Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    atypeval = ReturnDetail("ArtType_ID", "ArticleTypes", Db, "ArtType_Name='" + Atype + "'");
                }

                string AJId = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + XDoc.Descendants("jcode").First().Value + "' AND Jrnl_PublID='102'");
                if (AJId == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + XDoc.Descendants("jcode").First().Value + ": ", "AIP", true, stage, Zipname);
                    SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + XDoc.Descendants("jcode").First().Value);
                    //Move to Error
                    Clear();
                    return;
                }
                Auname = Auname.Replace(@"'", @"''");
                Figures_Note = Figures_Note.Replace(@"'", @"''");
                //string book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Title,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_ArtType,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_ExpFromTIDt) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Title + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + DateTime.Now.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + s1date.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Srcby + @"','0','PE','" + atypeval + @"','" + Auname + @"','" + Auemail + @"','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"')";
                //if (LineArt != "")
                //{
                //    book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Title,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_StatusGFX,Artcl_ArtType,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_ExpFromTIDt) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Title + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + DateTime.Now.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + s1date.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Srcby + @"','0','PE','GFXP','" + atypeval + @"','" + Auname + @"','" + Auemail + @"','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"')";
                //}
                if (Directory.GetFiles(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), "*.tex", SearchOption.AllDirectories).Length > 0) Srcby = "Latex";
                string book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Title,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_Platform,Artcl_FolderCreated,Artcl_Status,Artcl_ArtType,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_ExpFromTIDt,artcl_PEDuedate) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Title.Replace(@"'", @"''") + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Convert.ToDateTime(Sdate).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + s1date.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Srcby + @"','0','PE','" + atypeval + @"','" + Auname + @"','" + Auemail + @"','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + PEduedate.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"')";
                if (LineArt != "")
                {
                    book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Title,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_Platform,Artcl_FolderCreated,Artcl_Status,Artcl_StatusGFX,Artcl_ArtType,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_ExpFromTIDt,artcl_PEDuedate) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Title.Replace(@"'", @"''") + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "','" + Convert.ToDateTime(Sdate).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + s1date.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Srcby + @"','0','PE','GFXP','" + atypeval + @"','" + Auname + @"','" + Auemail + @"','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + PEduedate.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"')";
                }
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status: " + book);
                SaveToReport("Status: Update Transaction Details for file: " + Path.GetFileName(Zipname));
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Select Artcl_Id From Article WITH(NOLOCK) Where Artcl_ArticleId = '" + Aid + "'", Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Int64 aaid = 0;

                //Add saravanakumar Article Text file First Creation 28-06-2018
                if (stage == "First Proof Stage")
                {
                    if (LineArt != "")
                    {
                        File.WriteAllText(@"\\techsetserver2\Upload\TARS\" + Aid + "_FP_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt", "INSERT|'" + Aid + "'|'" + AJId + "'|'" + Title + "'|'" + Txtfolio + "'|''|''|'" + Atype + "'|'" + Convert.ToDateTime(Sdate).ToString("yyyy/MM/dd").Replace('/', '-') + "'|'" + s1date.ToString("yyyy/MM/dd").Replace('/', '-') + "'|''|'" + Auname + "'|'" + Auemail + "'|''|''|''|''|'" + LineArt + "'|''|'75'|'22'|'1'|'YES'|'75'|'22'");
                    }
                    else
                    {
                        File.WriteAllText(@"\\techsetserver2\Upload\TARS\" + Aid + "_FP_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt", "INSERT|'" + Aid + "'|'" + AJId + "'|'" + Title + "'|'" + Txtfolio + "'|''|''|'" + Atype + "'|'" + Convert.ToDateTime(Sdate).ToString("yyyy/MM/dd").Replace('/', '-') + "'|'" + s1date.ToString("yyyy/MM/dd").Replace('/', '-') + "'|''|'" + Auname + "'|'" + Auemail + "'|''|''|''|''|'0'|''|'75'|''|'1'|'NO'|'75'|''");
                    }
                }
                //End Add saravanakumar Article Text file First Creation 28-06-2018
                if (Db.SqlReader.Read())
                {
                    aaid = Convert.ToInt64(Db.SqlReader[0]);
                    Db.SqlReader.Close();
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, false, "APS"), Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: Update APS_Article_Details for file: " + Path.GetFileName(Zipname));
                    Ref_Note = Ref_Note.Replace(@"'", @"''");
                    book = @"insert into APS_Article_Details(Article_Artcl_ID,Article_ID,Title_type,License_Url,License_Type,License_P,CpyR_Yr,CpyR_Stmnt,CpyR_Holder_Type,CpyR_Holder_Entity_Nme,CpyR_Holder_Entity_Type,Src_Name,Src_Type,Src_ID_Jcode,Src_AbbName,Toc_Lbl,Article_Type,ID_Accode,ID_Accode_Transfer,Revised_Date,Pub_Date,Rel_Item_Accode,Rel_Type,Rel_Lbl,E_flags1,E_flags2,Proces_Ins_Id,Proces_Ins_Rush_lbl,Proces_Ins_Rush_Val,cjkAus_Lbl,cjkAus_Val,Scoap3Candi_Lbl,Scoap3Candi_Val,Pmarked_MS_Lbl,Pmarked_MS_Val,Aps_Contact_Person,Ref_Note,Artcl_Version,CreatedAt,targetDate,ProductionHoldsId,ProductionHoldsLable,General_Notes,MultiMedia,Figures_Note,Figures_Count,Figures_colorInPrint,authorCom_Note,authorComs_Memos_Id,authorComs_Memos_url,supplementalMaterial,Length_Notes,CopyEditLevel_Note,CopyEditLevel_Lbl,FutureinPhysics,Invited,Gfm,Suggestion,QcHold,PayHold,EditHold,TOCArtclCode,PublishWithGroups_PaperIandII,PublishWithGroups_Banded) values('" + aaid + @"','" + Aid + @"','" + Title_type + @"','" + License_Url + @"','" + License_Type + @"','" + License_P + @"','" + CpyR_Yr + @"','" + CpyR_Stmnt + @"','" + CpyR_Holder_Type + @"','" + CpyR_Holder_Entity_Nme + @"','" + CpyR_Holder_Entity_Type + @"','" + Src_Name + @"','" + Src_Type + @"','" + Src_ID_Jcode + @"','" + Src_AbbName + @"','" + Toc_Lbl + @"','" + Article_Type + @"','" + ID_Accode + @"','" + ID_Accode_Transfer + @"','" + Revised_Date + @"','" + Pub_Date + @"','" + Rel_Item_Accode + @"','" + Rel_Type + @"','" + Rel_Lbl + @"','" + E_flags1 + @"','" + E_flags2 + @"','" + Proces_Ins_Id + @"','" + Proces_Ins_Rush_lbl + @"','" + Proces_Ins_Rush_Val + @"','" + cjkAus_Lbl + @"','" + cjkAus_Val + @"','" + Scoap3Candi_Lbl + @"','" + Scoap3Candi_Val + @"','" + Pmarked_MS_Lbl + @"','" + Pmarked_MS_Val + @"','" + Contact_Person + @"','" + Ref_Note + @"','" + Artcl_Version + @"','" + CreatedAt + @"','" + targetDate + @"','" + ProductionHoldsId + @"','" + ProductionHoldsLable + @"','" + General_Notes + @"','" + MultiMedia + @"','" + Figures_Note + @"','" + FiguresCount + @"','" + FiguresColorInPrt + @"','" + authorCom_Note + @"','" + authorCom_Memos_Id + @"','" + authorCom_Memos_url + @"','" + supplementalMaterial + @"','" + Length_Note + @"','" + CopyEditLevel_Note + @"','" + CopyEditLevel_Lbl + @"','" + FutureinPhysics + @"','" + Invited + @"','" + Gfm + @"','" + Suggestion + @"','" + qchold + @"','" + payhold + @"','" + Edithold + @"','" + TOCArtclCode + @"','" + PublishWithGroupsPaperIandII + @"','" + PublishWithGroupsBanded + @"')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    string refstr = Regex.Replace(Ref_Note, @"\n", @" ");
                    refstr = refstr.Replace("|", @"/");
                    string APS_Artcl_ID = ReturnDetail("APS_Artcl_ID", "APS_Article_Details", Db, "Article_Artcl_ID='" + aaid + "' and Article_ID='" + Aid + "'");

                    if (stage == "First Proof Stage") File.WriteAllText(@"\\techsetserver2\Upload\TARS\" + Aid + "_Article_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt", "APSArticleInsert|'" + APS_Artcl_ID + @"'|'" + Aid + @"'|'" + Title_type + @"'|'" + License_Url + @"'|'" + License_Type + @"'|'" + License_P + @"'|'" + CpyR_Yr + @"'|'" + CpyR_Stmnt + @"'|'" + CpyR_Holder_Type + @"'|'" + CpyR_Holder_Entity_Nme + @"'|'" + CpyR_Holder_Entity_Type + @"'|'" + Src_Name + @"'|'" + Src_Type + @"'|'" + Src_ID_Jcode + @"'|'" + Src_AbbName + @"'|'" + Toc_Lbl + @"'|'" + Article_Type + @"'|'" + ID_Accode + @"'|'" + ID_Accode_Transfer + @"'|'" + Revised_Date + @"'|'" + Pub_Date + @"'|'" + Rel_Item_Accode + @"'|'" + Rel_Type + @"'|'" + Rel_Lbl + @"'|'" + E_flags1 + @"'|'" + E_flags2 + @"'|'" + Proces_Ins_Id + @"'|'" + Proces_Ins_Rush_lbl + @"'|'" + Proces_Ins_Rush_Val + @"'|'" + cjkAus_Lbl + @"'|'" + cjkAus_Val + @"'|'" + Scoap3Candi_Lbl + @"'|'" + Scoap3Candi_Val + @"'|'" + Pmarked_MS_Lbl + @"'|'" + Pmarked_MS_Val + @"'|'" + Contact_Person + @"'|'" + refstr + @"'|'" + Artcl_Version + @"'|'" + Convert.ToDateTime(CreatedAt).ToString("yyyy-MM-dd") + @"'|'" + targetDate + @"'|'" + ProductionHoldsId + @"'|'" + ProductionHoldsLable + @"'|'" + General_Notes + @"'|'" + MultiMedia + @"'|'" + Figures_Note + @"'|'" + FiguresCount + @"'|'" + FiguresColorInPrt + @"'|'" + authorCom_Note + @"'|'" + authorCom_Memos_Id + @"'|'" + authorCom_Memos_url + @"'|'" + supplementalMaterial + @"'|'" + Length_Note + @"'|'" + CopyEditLevel_Note + @"'|'" + CopyEditLevel_Lbl + @"'|'" + FutureinPhysics + @"'|'" + Invited + @"'|'" + Gfm + @"'|'" + Suggestion + @"'|'" + qchold + @"'|'" + payhold + @"'|'" + Edithold + @"'|'" + TOCArtclCode + @"'|'" + PublishWithGroupsPaperIandII + @"'|'" + PublishWithGroupsBanded + @"'");
                    //if (stage == "First Proof Stage") File.WriteAllText(@"G:\PARTHIBAN\ZipExtract_WatchPath4\TXT\" + Aid + "_Article_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt", "APSArticleInsert|'" + APS_Artcl_ID + @"'|'" + Aid + @"'|'" + Title_type + @"'|'" + License_Url + @"'|'" + License_Type + @"'|'" + License_P + @"'|'" + CpyR_Yr + @"'|'" + CpyR_Stmnt + @"'|'" + CpyR_Holder_Type + @"'|'" + CpyR_Holder_Entity_Nme + @"'|'" + CpyR_Holder_Entity_Type + @"'|'" + Src_Name + @"'|'" + Src_Type + @"'|'" + Src_ID_Jcode + @"'|'" + Src_AbbName + @"'|'" + Toc_Lbl + @"'|'" + Article_Type + @"'|'" + ID_Accode + @"'|'" + ID_Accode_Transfer + @"'|'" + Revised_Date + @"'|'" + Pub_Date + @"'|'" + Rel_Item_Accode + @"'|'" + Rel_Type + @"'|'" + Rel_Lbl + @"'|'" + E_flags1 + @"'|'" + E_flags2 + @"'|'" + Proces_Ins_Id + @"'|'" + Proces_Ins_Rush_lbl + @"'|'" + Proces_Ins_Rush_Val + @"'|'" + cjkAus_Lbl + @"'|'" + cjkAus_Val + @"'|'" + Scoap3Candi_Lbl + @"'|'" + Scoap3Candi_Val + @"'|'" + Pmarked_MS_Lbl + @"'|'" + Pmarked_MS_Val + @"'|'" + Contact_Person + @"'|'" + refstr + @"'|'" + Artcl_Version + @"'|'" + CreatedAt + @"'|'" + targetDate + @"'");
                    foreach (XElement ele in XDoc1.XPathSelectElements("//files").ToList())
                    {
                        foreach (XElement ele1 in ele.Elements().ToList())
                        {
                            if (ele1.Elements("filePath").Count() > 0)
                            {
                                string id = "", name = "", sha1 = "", size = "", type = "", _type = "", label = "", filepath = "", updatedAt = "", contentType = "";
                                foreach (XElement ele2 in ele1.Elements().ToList())
                                {
                                    switch (ele2.Name.ToString())
                                    {
                                        case "id":
                                            id = ele2.Value;
                                            break;
                                        case "name":
                                            name = ele2.Value;
                                            break;
                                        case "sha1":
                                            sha1 = ele2.Value;
                                            break;
                                        case "size":
                                            size = ele2.Value;
                                            break;
                                        case "type":
                                            type = ele2.Value;
                                            break;
                                        case "_type":
                                            _type = ele2.Value;
                                            break;
                                        case "label":
                                            label = ele2.Value;
                                            break;
                                        case "filePath":
                                            filepath = ele2.Value;
                                            break;
                                        case "updatedAt":
                                            updatedAt = ele2.Value;
                                            break;
                                        case "contentType":
                                            contentType = ele2.Value;
                                            break;
                                    }
                                }
                                if (ReturnDetail("APS_File_ID", "APS_File_Details", Db, "Article_Artcl_ID='" + aaid + "' and Article_ID='" + Aid + "' and filePath='" + filepath + "'") == "")
                                {
                                    string query = "INSERT INTO APS_File_Details  (Article_Artcl_ID,Article_ID,id,name,sha1,size,type_value,_type,label,filePath,updatedAt,contentType,LastModifiedDate,UsrID) VALUES('" + aaid + "','" + Aid + "','" + id + "','" + name + "','" + sha1 + "','" + size + "','" + type + "','" + _type + "','" + label + "','" + filepath + "','" + updatedAt + "','" + contentType + "',getdate(),1)";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(query, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                }
                                System.Threading.Thread.Sleep(1000);
                                string G_date = ReturnDetail("LastModifiedDate", "APS_File_Details", Db, "Article_Artcl_ID='" + aaid + "' and Article_ID='" + Aid + "' and filePath='" + filepath + "'");
                                string APS_File_ID = ReturnDetail("APS_File_ID", "APS_File_Details", Db, "Article_Artcl_ID='" + aaid + "' and Article_ID='" + Aid + "' and filePath='" + filepath + "'");
                                if (stage == "First Proof Stage") File.WriteAllText(@"\\techsetserver2\Upload\TARS\" + Aid + "_Article_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt", "APSFileInsert|'" + APS_File_ID + "'|'" + Aid + "'|'" + id + "'|'" + name + "'|'" + sha1 + "'|'" + size + "'|'" + type + "'|'" + _type + "'|'" + label + "'|'" + filepath + "'|'" + updatedAt + "'|'" + contentType + "'|'" + G_date + "'|'1'");
                                //if (stage == "First Proof Stage") File.WriteAllText(@"G:\PARTHIBAN\ZipExtract_WatchPath4\TXT\" + Aid + "_Article_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt", "APSFileInsert|'" + APS_File_ID + "'|'" + Aid + "'|'" + id + "'|'" + name + "'|'" + sha1 + "'|'" + size + "'|'" + type + "'|'" + _type + "'|'" + label + "'|'" + filepath + "'|'" + updatedAt + "'|'" + contentType + "'|'" + G_date + "'|'1'");

                            }
                        }
                    }
                    if (LineArt != "")
                    {
                        SaveToReport("Status: Update Artwork Transaction Details for file: " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, true), Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                    }
                    CreateTxtfile(Zipname, Aid, Src_ID_Jcode, "APS");
                    if (sensau) File.WriteAllText(@"\\techsetserver2\Upload\TARS\" + Aid + "_Article_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt", "ArticleUpdate|'" + Aid + @"'|'Sensitive_Author^~YES'");
                    try
                    {
                        ProcessStartInfo p = new ProcessStartInfo();
                        p.FileName = @"""\\techsetserver1\Software\APS\APS_META_VIEWER.exe""";
                        p.Arguments = @"""" + Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\manuscript.xml" + @"""";
                        Process P1 = Process.Start(p);
                        P1.WaitForExit();
                        File.Copy(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\manuscript.html", @"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(Zipname) + "_manuscript.html", true);
                        File.WriteAllText(@"D:\WatchTXT\" + Aid + @"html.txt", @"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(Zipname) + @"_manuscript.html" + @"~\\Techsetserver2\Journal\APS\" + Src_ID_Jcode + @"\Articles\DataSupplied\" + Aid + @"\First Proof\" + Path.GetFileNameWithoutExtension(Zipname) + @"\manuscript.html");
                    }
                    catch (Exception e1) { }
                    File.Copy(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\manuscript.xml", @"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(Zipname) + @"_manuscript.xml", true);
                    File.WriteAllText(@"D:\WatchTXT\" + Aid + @"xml.txt", @"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(Zipname) + @"_manuscript.xml" + @"~\\Techsetserver2\Journal\APS\" + Src_ID_Jcode + @"\Articles\DataSupplied\" + Aid + @"\First Proof\" + Path.GetFileNameWithoutExtension(Zipname) + @"\manuscript.xml");
                }

                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                if (stage == "First Proof Stage")
                {
                    //Commented on saravanakumar Article Text file First Creation 28-06-2018
                    //File.WriteAllText(@"\\techsetserver2\Upload\TARS\APS\" + Aid + "_First_Proof.txt", "FP|" + Aid + '|' + DateTime.Now.ToString("yyyy/MM/dd").Replace('/', '-') + '|' + Auname + '|' + Auemail);
                    //File.WriteAllText(@"\\techsetserver2\Upload\TARS\APS\" + Aid + "_FP_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt", "INSERT|" + Aid + '|' + AJId + '|' + Title + '|' + Rdate + '|' + Sdate + '|' + Auname + "|1|" + aaid.ToString());
                    //if(LineArt!="")
                    //{
                    //    File.WriteAllText(@"\\techsetserver2\Upload\TARS\" + Aid + "_FP_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt", "INSERT|'" + Aid + "'|'" + AJId + "'|'" + Title + "'|'" + Txtfolio + "'|''|''|'" + Atype + "'|'" + DateTime.Now.ToString("yyyy/MM/dd").Replace('/', '-') + "'|'" + s1date.ToString("yyyy/MM/dd").Replace('/', '-') + "'|''|'" + Auname + "'|'" + Auemail + "'|''|''|''|''|'" + LineArt + "'|''|'75'|'22'|'1'|'YES'|'75'|'22'");
                    //}else 
                    //{
                    //    File.WriteAllText(@"\\techsetserver2\Upload\TARS\" + Aid + "_FP_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt", "INSERT|'" + Aid + "'|'" + AJId + "'|'" + Title + "'|'" + Txtfolio + "'|''|''|'" + Atype + "'|'" + DateTime.Now.ToString("yyyy/MM/dd").Replace('/', '-') + "'|'" + s1date.ToString("yyyy/MM/dd").Replace('/', '-') + "'|''|'" + Auname + "'|'" + Auemail + "'|''|''|''|''|'0'|''|'75'|''|'1'|'NO'|'75'|''"); 
                    //}
                    Db.Sqladptr = new SqlDataAdapter(new SqlCommand("SELECT * FROM Authors where Au_ArticleId='" + Aid + "'", Db.GetConnection()));
                    Db.dt = new DataTable();
                    Db.Sqladptr.Fill(Db.dt);
                    Db.CloseConnection();
                    DataSet ds = new DataSet("New_DataSet");
                    ds.Tables.Add(Db.dt);
                    var rows = ds.Tables[0].Rows;
                    for (int j = 0; j < rows.Count; j++)
                    {
                        string str = "";
                        foreach (var v in rows[j].ItemArray)
                        {
                            str = str + "'|'" + v;
                        }
                        str = Regex.Replace(str, "^'", "");
                        System.Threading.Thread.Sleep(1000);
                        File.WriteAllText(@"\\techsetserver2\Upload\TARS\" + Aid + "_Authors_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt", "AuthorInsert" + str + "'");
                        //File.WriteAllText(@"G:\PARTHIBAN\ZipExtract_WatchPath4\TXT\" + Aid + "_Authors_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt", "AuthorInsert" + str + "'"); 
                    }
                }
                File.Delete(Zipname);
                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "APS", false, stage);

                if (PublishWithGroupsPaperIandII != "" || PublishWithGroupsBanded != "")
                {
                    SendMail(Aid, "Dear Team,<Br/><Br/>FYI We have Recieved PublishWithGroups Details: " + Path.GetFileName(Zipname), "APS", false, "APS_PubGrp", "", "PublishWithGroups APS");
                }

                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "APS", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }
        //***
        //***       
        public void Book_ASME(string CL)
        {
            string stage = "First Proof Stage";
            DBClass Db = new DBClass();
            try
            {
                XDocument XDoc = new XDocument();
                SaveToReport("Status: Validating XML file: " + Path.GetFileName(Zipname));
                //string[] XML = Directory.GetFiles(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), "*" + Path.GetFileNameWithoutExtension(Zipname) + ".xml");
                string XML = Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\starter-" + Path.GetFileNameWithoutExtension(Zipname) + ".xml";
                if (!File.Exists(XML)) XML = Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\starter-" + Path.GetFileNameWithoutExtension(Zipname) + ".xml";
                //if (XML.Length > 0)
                if (File.Exists(XML))
                {
                    try
                    {
                        XDoc = XDocument.Parse(File.ReadAllText(XML).Replace("&", "&amp;").Replace("&amp;amp;", "&amp;"), LoadOptions.PreserveWhitespace);
                    }
                    catch (Exception e)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>XML file is not valid for ASME: ", "ASME", true, stage, Zipname);
                        SaveToReport("XML file is not valid for:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                        Clear();
                        return;
                    }
                }
                else
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>XML file missing for ASME: " + Path.GetFileName(Zipname), "ASME", true, stage, Zipname);
                    SaveToReport("XML file missing for:  " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
                SaveToReport("Status: Validating against Booked Records: " + Path.GetFileName(Zipname));
                string Auname = "", Auemail = "", Aid = "", Doi = "", JAcro = "", Volume = "", Issue = "", DD = "", Title = "", Txtfolio = "", TxtElec = "", LineArt = "", ArtElec = "", Artwork = "", Srcby = "", Atype = "article", atypeval = "", tabcnt = "", Artcl_Status = "PE", Authors = "", Cpyt = "", jtitle = "", Au_email = "", nih = "", ArticleTypeSubCode = "", colorfiginfo = "", colorfigcnt = "", supp = "", SI = "N";
                XElement author = null;
                if (File.Exists(Path.GetDirectoryName(XML) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".doc") || File.Exists(Path.GetDirectoryName(XML) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".docx")) Srcby = "WORD";
                if (File.Exists(Path.GetDirectoryName(XML) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".tex")) Srcby = "TEX";
                if (Srcby == "")
                {
                    if (Directory.GetFiles(Path.GetDirectoryName(XML), "*.tex").Count() > 0) Srcby = "TEX";
                    else if (Directory.GetFiles(Path.GetDirectoryName(XML), "*.doc*").Count() > 0) Srcby = "WORD";
                    else if (Directory.GetFiles(Path.GetDirectoryName(XML), "*.pdf").Count() > 0) Srcby = "PDF";
                }
                if (Srcby == "") SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to identify srcby type for ASME  article: ", "ASMESRC", true, stage, Zipname);
                if (XDoc.XPathSelectElements(@"//corresponding_author/author").ToList().Count > 0)
                {
                    author = XDoc.XPathSelectElements(@"//corresponding_author/author").ToList().First();
                    foreach (XElement e in author.Elements().ToList())
                    {
                        switch (e.Name.ToString().ToLower())
                        {
                            case "fname":
                                Auname = e.Value.TrimEnd() + " ";
                                break;
                            case "middlename":
                                Auname = Auname.TrimStart() + e.Value.TrimEnd() + " ";
                                break;
                            case "surname":
                                Auname = Auname.TrimStart() + e.Value.TrimEnd();
                                break;
                        }
                    }
                }
                if (XDoc.XPathSelectElements(@"//corresponding_author/email").ToList().Count > 0)
                {
                    Auemail = XDoc.XPathSelectElements(@"//corresponding_author/email").ToList().First().Value;
                }
                foreach (XElement e in XDoc.XPathSelectElements(@"//authgrp/email").ToList())
                {
                    Au_email = Au_email + ";" + e.Value;
                }
                if (Au_email != "") Au_email = Au_email.Replace(@"'", @"''"); Au_email = Au_email.TrimStart(';');

                if (XDoc.Descendants("arttype").Count() > 0 && XDoc.Descendants("arttype").Attributes().Count() > 0 && XDoc.Descendants("arttype").Attributes("type").Count() > 0) Atype = XDoc.Descendants("arttype").Attributes("type").First().Value;
                if (XDoc.Descendants("doi").Count() > 0) Doi = XDoc.Descendants("doi").First().Value;
                if (XDoc.Descendants("volume").Count() > 0) Volume = XDoc.Descendants("volume").First().Value;
                if (XDoc.Descendants("issue").Count() > 0) Issue = XDoc.Descendants("issue").First().Value;
                if (XDoc.Descendants("title").Count() > 0) Title = XDoc.Descendants("title").First().Value;
                Title = Title.Replace(@"'", @"''");
                Auname = Auname.Replace(@"'", @"''");
                if (XDoc.Descendants("pages").Count() > 0) Txtfolio = XDoc.Descendants("pages").First().Value;
                if (XDoc.Descendants("total_figs").Count() > 0) LineArt = XDoc.Descendants("total_figs").First().Value;
                if (XDoc.Descendants("tables").Count() > 0) tabcnt = XDoc.Descendants("tables").First().Value;
                if (XDoc.Descendants("msnumber").Count() > 0) Aid = XDoc.Descendants("msnumber").First().Value;
                if (XDoc.Descendants("authors").Count() > 0) Authors = XDoc.Descendants("authors").First().Value;
                Authors = Authors.Replace(@"'", @"''");
                Authors = Regex.Replace(Authors, @",\s*", ", ");
                if (XDoc.Descendants("cpyrt").Count() > 0) Cpyt = XDoc.Descendants("cpyrt").First().Value;
                Cpyt = Cpyt.Replace(@"'", @"''");
                if (XDoc.Descendants("jtitle").Count() > 0) jtitle = XDoc.Descendants("jtitle").First().Value;
                jtitle = jtitle.Replace(@"'", @"''");
                if (XDoc.Descendants("nih").Count() > 0) nih = XDoc.Descendants("nih").First().Value;
                if (nih != "1") nih = "0";
                if (XDoc.Descendants("tocsec").Count() > 0 && XDoc.Descendants("tocsec").Attributes().Count() > 0 && XDoc.Descendants("tocsec").Attributes("code").Count() > 0) ArticleTypeSubCode = XDoc.Descendants("tocsec").Attributes("code").First().Value;
                if (XDoc.XPathSelectElements(@"//additional-manuscript-detail/amd-description").ToList().Count > 0 && XDoc.XPathSelectElements(@"//additional-manuscript-detail/amd-value").ToList().Count > 0 && XDoc.XPathSelectElements(@"//additional-manuscript-detail/amd-description").ToList().First().Value.ToLower() == "supplemental data")
                {
                    if (XDoc.XPathSelectElements(@"//additional-manuscript-detail/amd-value").ToList().First().Value.ToLower() == "yes") supp = "Y";
                    else if (XDoc.XPathSelectElements(@"//additional-manuscript-detail/amd-value").ToList().First().Value.ToLower() == "no") supp = "N";
                }

                if (XDoc.XPathSelectElements(@"//production/comments/general").ToList().Count > 0)
                {
                    colorfiginfo = XDoc.XPathSelectElements(@"//production/comments/general").ToList().First().Value;
                    if (colorfiginfo != "" && Regex.IsMatch(colorfiginfo, "Figures to print in color:", RegexOptions.IgnoreCase))
                    {
                        colorfigcnt = colorfiginfo.Split(',').Count().ToString();
                        colorfiginfo = colorfiginfo.Replace(@"'", @"''");
                    }
                    else colorfiginfo = "";
                }
                if (XDoc.Descendants("production").Count() > 0 && XDoc.Descendants("production").Attributes().Count() > 0 && XDoc.Descendants("production").Attributes("special_issue").Count() > 0) SI = XDoc.Descendants("production").Attributes("special_issue").First().Value;
                if (SI != "" && SI.ToUpper() == "Y") SI = "Yes";
                else SI = "No";
                JAcro = Aid.Split('-')[0];
                if (Aid == "" || Doi == "" || JAcro == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>manuscript-number or DOI or journal code or production-task-name information missing in go xml for ASME: ", "ASME", true, stage, Zipname);
                    SaveToReport("manuscript-number or DOI or journal code or production-task-name information missing in go xml for ASME: " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
                atypeval = ReturnDetail("ArtType_ID", "ArticleTypes", Db, "ArtType_Name='" + Atype + "'");
                JAcro = JAcro.ToLower();
                //bool FP = false, AU = false, FWD = false;
                if (!CheckWhetherFileBooked(Aid))
                {
                    SaveToReport("Status: Booking file for First Proof: " + Path.GetFileName(Zipname));
                    string AJId = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + JAcro + "' AND Jrnl_PublID='104'");
                    if (AJId == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for " + JAcro + ": ", "ASME", true, stage, Zipname);
                        SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + JAcro);
                        Clear();
                        return;
                    }
                    DD = CalculateDueDate("ASME", Db, DateTime.Today, 5).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    //string EGScheduledDt = CalculateDueDate("", Db, AddDays(DateTime.Today, Db, 7)).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    string EGScheduledDt = DD;
                    string EGScheduledCompletedDt = CalculateDueDate("ASME", Db, DateTime.Today, 7).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    string CorrectionScheduleDate = CalculateDueDate("ASME", Db, DateTime.Today, 9).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    string ApprovalScheduleDate = CalculateDueDate("ASME", Db, DateTime.Today, 10).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    string PublishScheduleDate = CalculateDueDate("ASME", Db, DateTime.Today, 11).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    string AMODate = CalculateDueDate("ASME", Db, DateTime.Today, 1).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');

                    DateTime Artcl_ExpFromTIDt = new DateTime();
                    DateTime Artcl_ScheduledDt = new DateTime();
                    DateTime artcl_CEDuedate = new DateTime();
                    DateTime artcl_PEDuedate = new DateTime();
                    //string Remarks = "";

                    var culture = System.Globalization.CultureInfo.InvariantCulture;
                    DateTime ddate = DateTime.ParseExact(DD, "MM/dd/yyyy HH:mm:ss", culture);
                    Artcl_ExpFromTIDt = CalculateAIPExpFromTIDt("AIP", Db, ddate);
                    Artcl_ScheduledDt = Artcl_ExpFromTIDt;
                    Artcl_ExpFromTIDt = CalculateAIPExpFromTIDt("AIP", Db, Artcl_ExpFromTIDt);
                    //culture = System.Globalization.CultureInfo.InvariantCulture;
                    //DateTime ddate1 = DateTime.ParseExact(DateTime.Now.ToString("MM/dd/yyyy HH:mm:ss"), "MM/dd/yyyy HH:mm:ss", culture);
                    //double days = Math.Round(ReturnDays(DateTime.Now, Db, Artcl_ScheduledDt) * 0.6);
                    artcl_PEDuedate = CalculateDueDate("ASME", Db, DateTime.Today, 1);
                    artcl_CEDuedate = CalculateDueDate("ASME", Db, DateTime.Today, 3);
                    string book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_ArtType,Artcl_ExpFromTIDt,Artcl_DueDtCats,artcl_CEDuedate,Artcl_StatusSGML,Artcl_ReceivedSGML,Artcl_ScheduledSGML,artcl_PEDuedate,Artcl_NIH,Artcl_ColorFig,Artcl_Type) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "',getdate(),'" + Artcl_ScheduledDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Srcby + @"','0','" + Artcl_Status + "','" + atypeval + "','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + DD + @"','" + artcl_CEDuedate.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','DC',getdate(),'" + AMODate + "','" + artcl_PEDuedate.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + "','" + nih + "','" + colorfiginfo + "','" + ArticleTypeSubCode + "')";
                    if (LineArt != "" && LineArt != "0")
                    {
                        book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Volume,Artcl_Issue,Artcl_Title,Artcl_AuthorName,Artcl_AuthorEmail,Artcl_TextFolios,Artcl_TextElectronic,Artcl_ArtLineArt,Artcl_ArtElectronic,Artcl_ArtReceivedDt,Artcl_ArtWork,Artcl_ReceivedDt,Artcl_ScheduledDt,artcl_SourceBy,Artcl_FolderCreated,Artcl_Status,Artcl_StatusGFX,Artcl_ArtType,Artcl_ExpFromTIDt,Artcl_DueDtCats,artcl_CEDuedate,Artcl_StatusSGML,Artcl_ReceivedSGML,Artcl_ScheduledSGML,artcl_PEDuedate,Artcl_NIH,Artcl_ColorFig,Artcl_Type) values('" + AJId + @"','" + Aid + @"','" + Doi + @"','" + Volume + @"','" + Issue + @"','" + Title + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"','" + TxtElec + "','" + LineArt + @"','" + ArtElec + "',getdate(),'" + Artwork + "',getdate(),'" + Artcl_ScheduledDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Srcby + @"','0','" + Artcl_Status + "','GFXP','" + atypeval + "','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + DD + @"','" + artcl_CEDuedate.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','DC',getdate(),'" + AMODate + "','" + artcl_PEDuedate.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + "','" + nih + "','" + colorfiginfo + "','" + ArticleTypeSubCode + "')";
                    }
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + book);
                    if (Au_email != "")
                    {
                        string query = "  INSERT INTO Authors  (Au_ArticleId,Au_Email) VALUES('" + Aid + "','" + Au_email + "')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + query);
                    }
                    book = @"insert INTO asme_article([ArticleId],[Title],[ArticleType],[DOI],[JrnlId],[Jrnl_Acronym],[AuthorGroup],[AuthorName],[AuthorEmail],[MSPages],[ReceivedDt],[ScheduledDt],[Volume],[Issue],[Status],[DueDate],[Copyright],[Stage],[LastModifiedDate],[JrnlTitle],[EGScheduledDt],[EGScheduledCompletedDt],[CorrectionScheduleDate],[ApprovalScheduleDate],[PublishScheduleDate],[AMOScheduleDate],[NIH],[ArticleTypeSubCode],[Position],[ColorFigures],[ColorFigDetails],[PublisherDescription],[Supplementary_Material],[SI]) VALUES( '" + Aid + @"','" + Title + @"','" + Atype + @"','" + Doi + @"','" + AJId + @"','" + JAcro + @"','" + Authors + @"','" + Auname + @"','" + Auemail + @"','" + Txtfolio + @"',getdate(),'" + DD + @"','" + Volume + @"','" + Issue + @"','Proof Creation','" + DD + @"','" + Cpyt + @"','Proof',GETDATE(),'" + jtitle + "','" + EGScheduledDt + "','" + EGScheduledCompletedDt + "','" + CorrectionScheduleDate + "','" + ApprovalScheduleDate + "','" + PublishScheduleDate + "','" + AMODate + "','" + nih + "','" + ArticleTypeSubCode + "','8','" + colorfigcnt + "','" + colorfiginfo + "','The American Society of Mechanical Engineers','" + supp + "','" + SI + "')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book, Db.GetConnection("ASME"));
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + book);
                    SaveToReport("Status: Update Transaction Details for file: " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Select Artcl_Id From Article WITH(NOLOCK) Where Artcl_ArticleId = '" + Aid + "'", Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    if (Db.SqlReader.Read())
                    {
                        Int64 aaid = Convert.ToInt64(Db.SqlReader[0]);
                        Db.SqlReader.Close();
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, false, "ASME", Artcl_Status), Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        string trns = "Insert into TrnsJournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) values(" + @"'" + aaid + @"','1','Admin',getdate(),getdate(),'14','Completed','21','AMO','Auto Entry',getdate(),1,'Pending')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(trns, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + trns);
                        CreateTxtfile(Zipname, Aid, JAcro, "ASME");
                        if (LineArt != "" && LineArt != "0")
                        {
                            SaveToReport("Status: Update Artwork Transaction Details for file: " + Path.GetFileName(Zipname));
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, true), Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }
                    }
                    try
                    {
                        book = @"Insert into ASME_API_Call(ArticleId,EventType,EventValue,IsAPITriggered,LastModifiedDate) values('" + Aid + @"','MSatCENVEO', getdate(),0,getdate())";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book, Db.GetConnection("ASME"));
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + book);
                    }
                    catch (Exception ex) { SaveToReport("Status: " + ex.Message); }
                }
                else
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for First Proof stage: ", "ASME", true, stage, Zipname);
                    SaveToReport("File already booked for First Proof stage for ASME: " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }

                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                File.Delete(Zipname);
                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "ASME", false, stage);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "ASME", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }

        public void Book_ASME_Corrections(string CL, string file, string from = "EPT")
        {
            Zipname = file;
            DBClass Db = new DBClass();
            string pos = "0";
            string stage = "Author Correction Stage", Aid = Path.GetFileNameWithoutExtension(file).Split('_')[0], JAcro = Aid.Split('-')[0], corr = "PC Correction due from NT";
            try
            {
                string sche = CalculateDueDate("ASME", Db, DateTime.Today, 2).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                if (uploaddate == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "ASME", true, stage, Zipname);
                    SaveToReport("Artcl_UploadedDt not updated " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
                SaveToReport("Status: Author Correction update JR_Main Table file: " + Path.GetFileName(Zipname));
                string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + JAcro + "' AND Jrnl_PublID='104'");
                string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                {
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                }
                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                string JRA_ID = "", corrname = "Final", corrname1 = "FC";
                string id = "", stageid = "", AUTUStatus = "97";
                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35") != "")
                {
                    //if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=109") != "")
                    //{
                    //    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=110") != "")
                    //    {
                    //        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=111") != "")
                    //        {
                    //            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=112") != "")
                    //            {
                    //                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=113") != "")
                    //                {
                    //                   SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for PM Correction 4: ", "ASME", true, stage, Zipname);
                    //                    SaveToReport("File already booked for PM Correction 4: " + Path.GetFileName(Zipname));
                    //                    //Move to Error
                    //                    Clear();
                    //                    return;
                    //                }
                    //                else
                    //                {
                    //                    // PM Correction 5
                    //                    stage = "PM Correction 4 Stage";
                    //                    id = "4"; stageid = "113"; corr = "PC Correction4 due from NT";
                    //                }
                    //            }
                    //            else
                    //            {
                    //                // PM Correction 4
                    //                stage = "PM Correction 3 Stage";
                    //                id = "3"; stageid = "112"; corr = "PC Correction3 due from NT";
                    //            }
                    //        }
                    //        else
                    //        {
                    //            // PM Correction 3
                    //            stage = "PM Correction 2 Stage";
                    //            id = "2"; stageid = "111"; corr = "PC Correction2 due from NT";
                    //        }
                    //    }
                    //    else
                    //    {
                    //        // PM Correction 2
                    //        stage = "PM 1 Stage";
                    //        id = "1"; stageid = "110"; corr = "PC Correction1 due from NT";
                    //    }
                    //}
                    //else
                    //{
                    //    // PM Correction 1                        
                    //    stage = "PM Correction Stage";                       
                    //    id = ""; stageid = "109";
                    //}
                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=44") != "")
                    {
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=51") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=52") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=53") != "")
                                {
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=76") != "")
                                    {
                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=77") != "")
                                        {
                                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=80") != "")
                                            {
                                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=81") != "")
                                                {
                                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Correction 7: ", "ASME", true, stage, Zipname);
                                                    SaveToReport("File already booked for Final Correction 7: " + Path.GetFileName(Zipname));
                                                    //Move to Error
                                                    Clear();
                                                    return;
                                                }
                                                else
                                                {
                                                    // Final Correction 8
                                                    stage = "Final Correction 7 Stage";
                                                    id = "7"; stageid = "81"; corr = "PC Correction7 due from NT";
                                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=80 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                                    {
                                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Corrections 6 Stage and not yet closed Previous stage. Kindly check.", "ASME", true, stage, Zipname);
                                                        SaveToReport("Unclosed stage Final Corrections 6:" + Path.GetFileName(Zipname));
                                                        Clear();
                                                        return;
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                // Final Correction 7
                                                stage = "Final Correction 6 Stage";
                                                id = "6"; stageid = "80"; corr = "PC Correction6 due from NT";
                                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=77 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                                {
                                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Corrections 5 Stage and not yet closed Previous stage. Kindly check.", "ASME", true, stage, Zipname);
                                                    SaveToReport("Unclosed stage Final Corrections 5:" + Path.GetFileName(Zipname));
                                                    Clear();
                                                    return;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            // Final Correction 6
                                            stage = "Final Correction 5 Stage";
                                            id = "5"; stageid = "77"; corr = "PC Correction5 due from NT";
                                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=76 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                            {
                                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Corrections 4 Stage and not yet closed Previous stage. Kindly check.", "ASME", true, stage, Zipname);
                                                SaveToReport("Unclosed stage Final Corrections 4:" + Path.GetFileName(Zipname));
                                                Clear();
                                                return;
                                            }
                                        }
                                    }
                                    else
                                    {
                                        // Final Correction 5
                                        stage = "Final Correction 4 Stage";
                                        id = "4"; stageid = "76"; corr = "PC Correction4 due from NT";
                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=53 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                        {
                                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Corrections 3 Stage and not yet closed Previous stage. Kindly check.", "ASME", true, stage, Zipname);
                                            SaveToReport("Unclosed stage Final Corrections 3:" + Path.GetFileName(Zipname));
                                            Clear();
                                            return;
                                        }
                                    }
                                }
                                else
                                {
                                    // Final Correction 4
                                    stage = "Final Correction 3 Stage";
                                    id = "3"; stageid = "53"; corr = "PC Correction3 due from NT";
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=52 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                    {
                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Corrections 2 Stage and not yet closed Previous stage. Kindly check.", "ASME", true, stage, Zipname);
                                        SaveToReport("Unclosed stage Final Corrections 2:" + Path.GetFileName(Zipname));
                                        Clear();
                                        return;
                                    }
                                }
                            }
                            else
                            {
                                // Final Correction 3
                                stage = "Final Correction 2 Stage";
                                id = "2"; stageid = "52"; corr = "PC Correction2 due from NT";
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=51 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                {
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Corrections 1 Stage and not yet closed Previous stage. Kindly check.", "ASME", true, stage, Zipname);
                                    SaveToReport("Unclosed stage Final Corrections 1:" + Path.GetFileName(Zipname));
                                    Clear();
                                    return;
                                }
                            }
                        }
                        else
                        {
                            // Final Correction 2
                            stage = "Final Correction 1 Stage";
                            id = "1"; stageid = "51"; corr = "PC Correction1 due from NT";
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=44 AND isnull(JRST_UploadedDT ,'')=''") != "")
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Corrections Stage and not yet closed Previous stage. Kindly check.", "ASME", true, stage, Zipname);
                                SaveToReport("Unclosed stage Final Corrections:" + Path.GetFileName(Zipname));
                                Clear();
                                return;
                            }
                        }
                    }
                    else
                    {
                        // Final Correction 1                        
                        stage = "Final Corrections Stage";
                        id = ""; stageid = "44";
                    }
                }
                else
                {
                    // Author Correction
                    corrname1 = "AU";
                    corrname = "Author";
                    stage = "AU Correction Stage";
                    corr = "EG Link Submitted";
                    id = ""; stageid = "35"; //sche = CalculateDueDate("", Db, AddDays(DateTime.Today, Db, 2)).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                }
                if (from == "EG") corr = "Correction due from NT"; pos = "5";
                if (from == "EPT")
                {
                    string val = ConvertNumbertoWords(Convert.ToInt64(ReturnDetail("ReviewCount", "asme_article", Db, "ArticleId='" + Aid + "'", "ASME")));
                    corr = val + " Proof Correction at NT";
                }
                SaveToReport("Status:  " + stage + " update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stageid + "','" + sche + "',getdate(),'" + sche + "','" + sche + "','" + AUTUStatus + "',getdate(),'1','')";
                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status: " + stage + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                //JR_Articles 
                JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stageid + "',getdate(),'1')";
                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status:  " + stage + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                //TrnsJournalRev 
                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage.Replace(" Stage", "") + "','Pending')";
                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                string query = @"UPDATE asme_article SET CorrectionFrom= '" + from + @"',Status='" + corr + "',CorrectionDate='" + sche + "' Where ArticleId='" + Aid + "'";
                if (pos == "5") query = @"UPDATE asme_article SET CorrectionFrom= '" + from + @"',Status='" + corr + "',CorrectionDate='" + sche + "',Position='" + pos + "' Where ArticleId='" + Aid + "'";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(query, Db.GetConnection("ASME"));
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status: " + query + " " + Path.GetFileName(Zipname));
                if (from == "EG" && stage == "AU Correction Stage")
                {
                    try
                    {
                        query = @"Insert into ASME_API_Call(ArticleId,EventType,EventValue,IsAPITriggered,LastModifiedDate) values('" + Aid + @"','AuthorApprovesCorrs', getdate(),0,getdate())";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(query, Db.GetConnection("ASME"));
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + query);
                    }
                    catch (Exception ex) { SaveToReport("Status: " + ex.Message); }
                }
                SaveToReport("Status: Upload files to  " + stage + " file: " + Path.GetFileName(Zipname));
                if (corrname1 == "AU") CreateTxtfile(Zipname, Aid, JAcro, "ASME", "AC" + id);
                else CreateTxtfile(Zipname, Aid, JAcro, "ASME", "FC" + id);
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                if (Directory.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname)) == true) Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                File.Delete(Zipname);
                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "ASME", false, stage);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "ASME", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                Clear();
            }
            finally { Db.CloseConnection(); }
        }

        public void Book_ASME_HoldUnHold(string CL, string file)
        {
            Zipname = file;
            string Reason = File.ReadAllText(file);
            DBClass Db = new DBClass();
            string stage = Path.GetFileNameWithoutExtension(file).Split('_')[2], Type = Path.GetFileNameWithoutExtension(file).Split('_')[1], Aid = Path.GetFileNameWithoutExtension(file).Split('_')[0], JAcro = Aid.Split('-')[0];
            try
            {
                string Artid = ReturnDetail("Artcl_ID", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                if (Artid == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Article not available @ JTS.", "ASME", true, stage, Zipname);
                    SaveToReport(">Article not available @ JTS " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
                string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + JAcro + "' AND Jrnl_PublID='104'");
                string JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                string Query = "";
                Boolean FP = false, Revises = false;
                if (JRM_Id == "") FP = true;
                else Revises = true;
                if (Revises)
                {
                    string JRST_ID = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + Convert.ToInt64(JRM_Id));
                    string JRA_ID = ReturnDetail("JRA_ID", "JR_Articles", Db, "JRA_JRST_ID=" + Convert.ToInt64(JRST_ID));
                    string JrnlTrns_ID = ReturnDetail("max(JrnlTrns_Id) as id", "TrnsJournalRev", Db, "JrnlTrns_ArticleId=" + Convert.ToInt64(JRA_ID));
                    string Stage = ReturnDetail("JrnlTrns_JType", "TrnsJournalRev", Db, "JrnlTrns_Id=" + Convert.ToInt64(JrnlTrns_ID));
                    if (Type == "UnHold")
                    {
                        string nxtstatus = ReturnDetail("JrnlTrns_ProcessCd", "TrnsJournalRev", Db, "JrnlTrns_Id=" + Convert.ToInt64(JrnlTrns_ID));
                        Query = "update JR_Stage_Tran set JRST_Status='" + nxtstatus + "'  where jrst_id=" + Convert.ToInt64(JRST_ID);
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        Query = "update JR_Articles set JRA_Status ='" + nxtstatus + "'  where JRA_JRST_ID=" + Convert.ToInt64(JRST_ID);
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID)) + @"','1','Administration',getdate(),getdate(),'36','Completed','" + Reason + "','" + nxtstatus + "',getdate(),'1','" + Stage + "','Pending')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                    }
                    else if (Type == "Hold")
                    {
                        string Currstatus = ReturnDetail("JrnlTrns_NextProcessID", "TrnsJournalRev", Db, "JrnlTrns_Id=" + Convert.ToInt64(JrnlTrns_ID));
                        Query = "update JR_Stage_Tran set JRST_Status='36'  where jrst_id=" + Convert.ToInt64(JRST_ID);
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        Query = "update JR_Articles set JRA_Status ='36'  where JRA_JRST_ID=" + Convert.ToInt64(JRST_ID);
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID)) + @"','1','Administration',getdate(),getdate(),'" + Currstatus + "','Completed','" + Reason + "','36',getdate(),'1','" + Stage + "','Pending')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                    }
                }
                else if (FP)
                {
                    string JrnlTrns_ID = ReturnDetail("max(JrnlTrns_Id) as id", "TrnsJournal", Db, "JrnlTrns_ArticleId=" + Convert.ToInt64(Artid) + "and JrnlTrns_JType='Article'");
                    if (Type == "UnHold")
                    {
                        string nxtstatus = ReturnDetail("JrnlTrns_ProcessCd", "TrnsJournal", Db, "JrnlTrns_Id=" + Convert.ToInt64(JrnlTrns_ID));
                        string statusname = ReturnDetail("PrcsMst_name", "ProcessMst", Db, "PrcsMst_Id=" + nxtstatus);
                        Query = "update article set Artcl_Status='" + statusname + "' where Artcl_Id=" + Artid;
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        Query = "Insert into TrnsJournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) values(" + @"'" + Artid + @"','1','Admin',getdate(),getdate(),'36','Completed','" + nxtstatus + "','Article','" + Reason + "',getdate(),1,'Pending')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                    }
                    else if (Type == "Hold")
                    {
                        string Currstatus = ReturnDetail("JrnlTrns_NextProcessID", "TrnsJournal", Db, "JrnlTrns_Id=" + Convert.ToInt64(JrnlTrns_ID));
                        string statusname = ReturnDetail("PrcsMst_name", "ProcessMst", Db, "PrcsMst_Id=" + Currstatus);
                        Query = "update article set Artcl_Status='Hold' where Artcl_Id=" + Artid;
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        Query = "Insert into TrnsJournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) values(" + @"'" + Artid + @"','1','Admin',getdate(),getdate(),'" + Currstatus + "','Completed','36','Article','" + Reason + "',getdate(),1,'Pending')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                    }
                }

                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                if (Directory.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname)) == true) Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                File.Delete(Zipname);
                if (Type == "Hold")
                {
                    SendMail(Aid, "Dear Team,<Br/><Br/>Hold status updated for file: " + Path.GetFileName(Zipname) + "<Br/><Br/>Reason: <Br/><Br/>" + Reason, "ASME", false, stage, "", "ASME: Article kept on Hold: Status Success for " + Aid);
                }
                else if (Type == "UnHold")
                {
                    SendMail(Aid, "Dear Team,<Br/><Br/>Hold released for file: " + Path.GetFileName(Zipname) + "<Br/><Br/>Reason: <Br/><Br/>" + Reason, "ASME", false, stage, "", "ASME: Article Released from Hold: Status Success for " + Aid);
                }
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "ASME", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                Clear();
            }
            finally { Db.CloseConnection(); }
        }

        public void Book_ASME_Preview(string CL, string file)
        {
            Zipname = file;
            string CID = File.ReadAllText(file);
            DBClass Db = new DBClass();
            string stage = "PAP Stage", Aid = Path.GetFileNameWithoutExtension(file).Split('_')[0], JAcro = Aid.Split('-')[0];
            try
            {
                //string sche = CalculateDueDate("ASME", Db, AddDays(DateTime.Today, Db,1)).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/'); 
                string sche = CalculateDueDate("ASME", Db, DateTime.Today, 1).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                if (uploaddate == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "ASME", true, stage, Zipname);
                    SaveToReport("Artcl_UploadedDt not updated " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
                SaveToReport("Status:PAP update JR_Main Table file: " + Path.GetFileName(Zipname));
                string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + JAcro + "' AND Jrnl_PublID='104'");
                string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                {
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                }
                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                string JRA_ID = "";
                string id = "", stageid = "", AUTUStatus = "25";
                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=58") != "")
                {
                    //if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=59") != "")
                    //{
                    //    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=60") != "")
                    //    {
                    //        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=114") != "")
                    //        {
                    //SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for PAP III: ", "ASME", true, stage, Zipname);
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for PAP stage: ", "ASME", true, stage, Zipname);
                    SaveToReport("File already booked for PAP: " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
                //            else
                //            {
                //                // PAP3
                //                stage = "PAP III Stage";
                //                id = "III"; stageid = "114";
                //            }

                //        }
                //        else
                //        {
                //            // PAP2
                //            stage = "PAP II Stage";
                //            id = "II"; stageid = "60"; 
                //        }
                //    }
                //    else
                //    {
                //        // PAP1                       
                //        stage = "PAP I Stage";
                //        id = "I"; stageid = "59";
                //    }
                //}
                else
                {
                    //PAP                 
                    stage = "PAP Stage";
                    id = ""; stageid = "58";
                }

                SaveToReport("Status:  " + stage + " update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stageid + "','" + sche + "',getdate(),'" + sche + "','" + sche + "','" + AUTUStatus + "',getdate(),'1','')";
                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status: " + stage + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                //JR_Articles 
                JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stageid + "',getdate(),'1')";
                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status:  " + stage + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                //TrnsJournalRev 
                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage.Replace(" Stage", "") + "','Pending')";
                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                string vol = ReturnDetail("Volume", "asme_article", Db, "ArticleId='" + Aid + "'", "ASME");
                string iss = ReturnDetail("Issue", "asme_article", Db, "ArticleId='" + Aid + "'", "ASME");
                Query = @"UPDATE article SET Artcl_PII= '" + CID + @"',Artcl_Volume= '" + vol + @"',Artcl_Issue= '" + iss + @"' Where Artcl_ArticleId='" + Aid + "'";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                //SaveToReport("Status: Upload files to  " + stage + " file: " + Path.GetFileName(Zipname));
                //if (corrname1 == "AU") CreateTxtfile(Zipname, Aid, JAcro, "ASME", "AC" + id);
                //else CreateTxtfile(Zipname, Aid, JAcro, "ASME", "PM" + id);
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                if (Directory.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname)) == true) Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                File.Delete(Zipname);
                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "ASME", false, stage);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "ASME", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                Clear();
            }
            finally { Db.CloseConnection(); }
        }

        public void Book_ASME_Revises(string CL, bool corr = false, string sts = "Rev", string filenm = "")
        {
            DBClass Db = new DBClass();
            if (sts == "Rev")
            {
                string stage = "Revises Stage", volume = "", issue = "", JournalAcronym = "";
                System.Collections.ArrayList ArticleID = new System.Collections.ArrayList();
                try
                {
                    if (!corr)
                    {
                        string file = Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".xls";
                        if (!File.Exists(file))
                        {
                            file = Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + ".xlsx";
                        }
                        if (!File.Exists(file))
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Excel file missing in issue package.", "ASME", true, stage, Zipname);
                            SaveToReport("Excel file missing in issue package: " + Path.GetFileName(Zipname));
                            //Move to Error
                            Clear();
                            return;
                        }
                        SaveToReport("Status: Processing excel file: " + file);
                        SaveToReport("Status: Collecting data from excel file: " + file);
                        Xl.Workbook xlWorkBook;
                        Xl.Worksheet xlWorkSheet;
                        Xl.Application xlapp;
                        xlapp = new Xl.Application();
                        xlapp.Visible = false;
                        xlWorkBook = xlapp.Workbooks.Open(file);
                        xlWorkSheet = (Xl.Worksheet)xlWorkBook.Sheets[1];
                        int lastRow = xlWorkSheet.Cells.SpecialCells(Xl.XlCellType.xlCellTypeLastCell).Row;
                        System.Array MyValues = (System.Array)xlWorkSheet.get_Range("A1", "F" + lastRow.ToString()).Cells.Value;
                        int ros = MyValues.GetLength(0);
                        int cos = MyValues.GetLength(1);
                        xlapp.Quit();
                        xlapp = null;
                        GC.Collect();
                        GC.WaitForPendingFinalizers();
                        foreach (Process P in Process.GetProcessesByName("EXCEL"))
                        {
                            try
                            {
                                P.Kill();
                            }
                            catch (Exception e) { }
                        }
                        if (!Regex.IsMatch(MyValues.GetValue(1, 1).ToString().Replace("\n", "").Replace("\r", ""), "Journal : ([A-Z]+)", RegexOptions.IgnoreCase))
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick journal acronym. Please check its position in excel.", "ASME", true, stage, Zipname);
                            SaveToReport("Unable to pick journal acronym. Please check its position in excel: " + Path.GetFileName(Zipname));
                            //Move to Error
                            Clear();
                            return;
                        }
                        else if (!Regex.IsMatch(MyValues.GetValue(3, 1).ToString().Replace("\n", "").Replace("\r", ""), @"Volume : (\d+)", RegexOptions.IgnoreCase))
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick Volume. Please check its position in excel.", "ASME", true, stage, Zipname);
                            SaveToReport("Unable to pick Volume. Please check its position in excel: " + Path.GetFileName(Zipname));
                            //Move to Error
                            Clear();
                            return;
                        }
                        else if (!Regex.IsMatch(MyValues.GetValue(4, 1).ToString().Replace("\n", "").Replace("\r", ""), @"Issue : (\d+)", RegexOptions.IgnoreCase))
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick Issue. Please check its position in excel.", "ASME", true, stage, Zipname);
                            SaveToReport("Unable to pick Issue. Please check its position in excel: " + Path.GetFileName(Zipname));
                            //Move to Error
                            Clear();
                            return;
                        }
                        volume = Regex.Match(MyValues.GetValue(3, 1).ToString().Replace("\n", "").Replace("\r", ""), @"Volume : (\d+)", RegexOptions.IgnoreCase).Groups[1].Value;
                        issue = Regex.Match(MyValues.GetValue(4, 1).ToString().Replace("\n", "").Replace("\r", ""), @"Issue : (\d+)", RegexOptions.IgnoreCase).Groups[1].Value;
                        JournalAcronym = Regex.Match(MyValues.GetValue(1, 1).ToString().Replace("\n", "").Replace("\r", ""), "Journal : ([A-Z]+)", RegexOptions.IgnoreCase).Groups[1].Value;
                        JournalAcronym = JournalAcronym.ToUpper();
                        if (volume == "" || issue == "" || JournalAcronym == "")
                        {
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Unable to pick Volume/Journal Acronym/Issue. Please check its position in excel.", "ASME", true, stage, Zipname);
                            SaveToReport("Unable to pick Volume/Journal Acronym/Issue. Please check its position in excel: " + Path.GetFileName(Zipname));
                            //Move to Error
                            Clear();
                            return;
                        }
                        for (int i = 16; i < ros; i++)
                        {
                            if (ArticleID.Contains(MyValues.GetValue(i, 2).ToString()))
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Duplicate id present in excel." + MyValues.GetValue(i, 2).ToString(), "ASME", true, stage, Zipname);
                                SaveToReport("Duplicate id present in excel." + MyValues.GetValue(i, 2).ToString() + Path.GetFileName(Zipname));
                                //Move to Error
                                Clear();
                                return;
                            }
                            else ArticleID.Add(MyValues.GetValue(i, 2).ToString());
                        }
                    }
                    else//revises 2,3,4,5
                    {
                        JournalAcronym = Path.GetFileNameWithoutExtension(Zipname).Split('_')[0].ToUpper();
                        volume = Path.GetFileNameWithoutExtension(Zipname).Split('_')[1];
                        issue = Path.GetFileNameWithoutExtension(Zipname).Split('_')[2];
                        string Q = "select JRA_ArticleID from JR_Articles left outer join JR_Stage_Tran on JRA_JRST_ID=JRST_ID left outer join   JR_Main on  JRST_JRM_ID=JRM_ID where JRM_Volume='" + volume + "' and JRM_Issue='" + issue + "' and isnull(JRM_ArticleID,'')='' and JRM_JournalID =(select jrnl_id from journal where Jrnl_Acronym='" + JournalAcronym + "' and Jrnl_PublID='104') and JRA_StageID='38'";
                        Db.Sqladptr = new SqlDataAdapter(new SqlCommand(Q, Db.GetConnection()));
                        Db.dt = new DataTable();
                        Db.Sqladptr.Fill(Db.dt);
                        Db.CloseConnection();
                        DataSet ds = new DataSet("New_DataSet");
                        ds.Tables.Add(Db.dt);
                        var rows = ds.Tables[0].Rows;
                        for (int j = 0; j < rows.Count; j++)
                        {
                            ArticleID.Add(rows[j][0].ToString());
                        }
                    }
                    if (ArticleID.Count == 0)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Revises 1 stage not booked: ", "ASME", true, stage, Zipname);
                        SaveToReport("Revises 1 stage not booked: " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    //string sche = CalculateDueDate("ASME", Db, AddDays(DateTime.Today, Db, 1)).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    string sche = CalculateDueDate("ASME", Db, DateTime.Today, 1).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    SaveToReport("Status:Revises update JR_Main Table file: " + Path.GetFileName(Zipname));
                    string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + JournalAcronym + "' AND Jrnl_PublID='104'");
                    string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                    string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,LastModifiedDate,UsrID,Insert_Date, JRM_Volume, JRM_Issue) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"',getdate(),'1',getdate(),'" + volume + "','" + issue + "')";
                    JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                    if (JRM_Id == "")
                    {
                        JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query);
                    }
                    JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                    JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                    string JRA_ID = "";
                    string id = "", stageid = "", AUTUStatus = "25";
                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=38") != "")
                    {
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=39") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=40") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=99") != "")
                                {
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=101") != "")
                                    {
                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Revises 5: ", "ASME", true, stage, Zipname);
                                        SaveToReport("File already booked for Revises 5: " + Path.GetFileName(Zipname));
                                        Clear();
                                        return;
                                    }
                                    else
                                    {
                                        // Revises 5
                                        stage = "Revises 5 Stage";
                                        id = "5"; stageid = "101";
                                    }
                                }
                                else
                                {
                                    // Revises 4
                                    stage = "Revises 4 Stage";
                                    id = "4"; stageid = "99";
                                }

                            }
                            else
                            {
                                // Revises 3
                                stage = "Revises 3 Stage";
                                id = "3"; stageid = "40";
                            }
                        }
                        else
                        {
                            // Revises 2                       
                            stage = "Revises 2 Stage";
                            id = "2"; stageid = "39";
                        }
                    }
                    else
                    {
                        //Revises 1                 
                        stage = "Revises 1 Stage";
                        id = "1"; stageid = "38";
                    }

                    SaveToReport("Status:  " + stage + " update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                    string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stageid + "','" + sche + "',getdate(),'" + sche + "','" + sche + "','" + AUTUStatus + "',getdate(),'1','')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    foreach (string Aid in ArticleID)
                    {
                        if (!CheckWhetherFileBooked(Aid))
                        {
                            SaveToReport("Status: insert dummy FP entry article table " + Aid);
                            Query = "insert into article(Artcl_JrnlId,artcl_articleid,Artcl_Volume,Artcl_Issue,Artcl_UploadedDt,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_Status) values('" + Journalid + "','" + Aid + "','" + volume + "','" + issue + "',getdate(),getdate(),getdate(),'UL')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: " + Query);
                            SaveToReport("Status: insert dummy FP entry trnsjournal table " + Aid);
                            string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                            Query = "Insert into trnsjournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) Values(" + artid + ",1,'Administration',getdate(),getdate(),'14','Completed','33','Earticle closing','Auto Entry',getdate(),1,'Pending')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: " + Query);
                        }
                        SaveToReport("Status: " + stage + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                        //JR_Articles 
                        JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stageid + "',getdate(),'1')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status:  " + stage + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                        //TrnsJournalRev 
                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage.Replace(" Stage", "") + "','Pending')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        //string vol = ReturnDetail("Volume", "asme_article", Db, "ArticleId='" + Aid + "'", "ASME");
                        //string iss = ReturnDetail("Issue", "asme_article", Db, "ArticleId='" + Aid + "'", "ASME");
                        Query = @"UPDATE article SET Artcl_Volume= '" + volume + @"',Artcl_Issue= '" + issue + @"' Where Artcl_ArticleId='" + Aid + "'";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        if (!Regex.IsMatch(Aid, "_[a-zA-Z]+$"))
                        {
                            try
                            {
                                //Query = @"Insert into ASME_API_Call(ArticleId,EventType,EventValue,IsAPITriggered,LastModifiedDate) values('" + Aid + @"','Volume', getdate(),0,getdate()) Insert into ASME_API_Call(ArticleId,EventType,EventValue,IsAPITriggered,LastModifiedDate) values('" + Aid + @"','Issue', getdate(),0,getdate())";
                                Query = @"Insert into ASME_API_Call(ArticleId,EventType,EventValue,IsAPITriggered,LastModifiedDate,Volume,Issue) values('" + Aid + @"','VolumeIssue', getdate(),0,getdate(),'" + volume + @"','" + issue + @"')";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection("ASME"));
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: " + Query);
                            }
                            catch (Exception ex) { SaveToReport("Status: " + ex.Message); }
                        }
                    }
                    if (stage == "Revises 1 Stage")
                    {
                        Query = @"UPDATE IssueScheduler SET CompletionDate=getdate() Where  Volume= '" + volume + @"''and Issue=case when ISNUMERIC('" + issue + @"')>0 then '" + issue + @"' else 0 end and isnull(SpecialIssue,'')=case when ISNUMERIC('" + issue + @"')>0 then '' else '" + issue + @"' end and JournalID='" + JournalAcronym + "' and TaskName='To NT Production'";
                        //else if (stage == "Revises 2 Stage") Query = @"UPDATE IssueArticle_Corrections SET CompletedDate=getdate() Where  Volume= '" + volume + @"'and Issue= '" + issue + @"' and JournalID='" + JournalAcronym + "' and CorrectionsType='PC Correction Booked'";
                        //else if (stage == "Revises 3 Stage") Query = @"UPDATE IssueScheduler SET IssueArticle_Corrections=getdate() Where  Volume= '" + volume + @"'and Issue= '" + issue + @"' and JournalID='" + JournalAcronym + "'";
                        //else if (stage == "Revises 4 Stage") Query = @"UPDATE IssueScheduler SET IssueArticle_Corrections=getdate() Where  Volume= '" + volume + @"'and Issue= '" + issue + @"' and JournalID='" + JournalAcronym + "'";
                        //else if (stage == "Revises 5 Stage") Query = @"UPDATE IssueScheduler SET IssueArticle_Corrections=getdate() Where  Volume= '" + volume + @"'and Issue= '" + issue + @"' and JournalID='" + JournalAcronym + "'";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection("ASME"));
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                    }
                    SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                    if (Directory.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname)) == true) Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                    if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                    {
                        Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                    }
                    File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                    string Outpath = @"\\Techsetserver2\Journal\ASME\" + JournalAcronym + @"\ISSUE\" + volume + "-" + issue + @"\DataSupplied\" + stage.Replace(" Stage", "") + @"\" + Path.GetFileName(Zipname);
                    File.Copy(Zipname, @"D:\WatchTXT\" + Path.GetFileName(Zipname), true);
                    File.WriteAllText(@"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(Zipname) + @".txt", @"D:\WatchTXT\" + Path.GetFileName(Zipname) + @"~" + Outpath);
                    File.Delete(Zipname);
                    //SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "ASME", false, stage);
                    SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
                }
                catch (Exception e)
                {
                    Db.CloseConnection();
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "ASME", true, stage, Zipname);
                    SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                    Clear();
                }
                finally
                {
                    Db.CloseConnection();
                }
            }
            else//Printer
            {
                Zipname = filenm;
                string stage = "Printer Files Stage", volume = "", issue = "", JournalAcronym = "";
                System.Collections.ArrayList ArticleID = new System.Collections.ArrayList();
                try
                {
                    JournalAcronym = Path.GetFileNameWithoutExtension(Zipname).Split('_')[0].ToUpper();
                    volume = Path.GetFileNameWithoutExtension(Zipname).Split('_')[1];
                    issue = Path.GetFileNameWithoutExtension(Zipname).Split('_')[2];
                    string Q = "select JRA_ArticleID from JR_Articles left outer join JR_Stage_Tran on JRA_JRST_ID=JRST_ID left outer join   JR_Main on  JRST_JRM_ID=JRM_ID where JRM_Volume='" + volume + "' and JRM_Issue='" + issue + "' and isnull(JRM_ArticleID,'')='' and JRM_JournalID =(select jrnl_id from journal where Jrnl_Acronym='" + JournalAcronym + "' and Jrnl_PublID='104') and JRA_StageID='38'";
                    Db.Sqladptr = new SqlDataAdapter(new SqlCommand(Q, Db.GetConnection()));
                    Db.dt = new DataTable();
                    Db.Sqladptr.Fill(Db.dt);
                    Db.CloseConnection();
                    DataSet ds = new DataSet("New_DataSet");
                    ds.Tables.Add(Db.dt);
                    var rows = ds.Tables[0].Rows;
                    for (int j = 0; j < rows.Count; j++)
                    {
                        ArticleID.Add(rows[j][0].ToString());
                    }
                    if (ArticleID.Count == 0)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Revises 1 stage not booked: ", "ASME", true, stage, Zipname);
                        SaveToReport("Revises 1 stage not booked: " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    //string sche = CalculateDueDate("ASME", Db, AddDays(DateTime.Today, Db, 1)).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    string sche = CalculateDueDate("ASME", Db, DateTime.Today, 1).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    SaveToReport("Status:Printer stage update JR_Main Table file: " + Path.GetFileName(Zipname));
                    string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + JournalAcronym + "' AND Jrnl_PublID='104'");
                    string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                    string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,LastModifiedDate,UsrID,Insert_Date, JRM_Volume, JRM_Issue) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"',getdate(),'1',getdate(),'" + volume + "','" + issue + "')";
                    JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                    if (JRM_Id == "")
                    {
                        JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query);
                    }
                    JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                    JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                    string JRA_ID = "";
                    string id = "", stageid = "", AUTUStatus = "30";
                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=42") != "")
                    {
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=57") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=71") != "")
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Printer Files 3: ", "ASME", true, stage, Zipname);
                                SaveToReport("File already booked for Printer Files 3: " + Path.GetFileName(Zipname));
                                //Move to Error
                                Clear();
                                return;
                            }

                            else
                            {
                                // Printer 3
                                stage = "Printer Files 3 Stage";
                                id = "3"; stageid = "71";
                            }
                        }
                        else
                        {
                            // Printer 2                       
                            stage = "Printer Files 2 Stage";
                            id = "2"; stageid = "57";
                        }
                    }
                    else
                    {
                        //Printer 1                 
                        stage = "Printer Files Stage";
                        id = "1"; stageid = "42";
                    }

                    SaveToReport("Status:  " + stage + " update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                    string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stageid + "','" + sche + "',getdate(),'" + sche + "','" + sche + "','" + AUTUStatus + "',getdate(),'1','')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    foreach (string Aid in ArticleID)
                    {
                        if (!CheckWhetherFileBooked(Aid))
                        {
                            SaveToReport("Status: insert dummy FP entry article table " + Aid);
                            Query = "insert into article(Artcl_JrnlId,artcl_articleid,Artcl_Volume,Artcl_Issue,Artcl_UploadedDt,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_Status) values('" + Journalid + "','" + Aid + "','" + volume + "','" + issue + "',getdate(),getdate(),getdate(),'UL')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: " + Query);
                            SaveToReport("Status: insert dummy FP entry trnsjournal table " + Aid);
                            string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                            Query = "Insert into trnsjournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) Values(" + artid + ",1,'Administration',getdate(),getdate(),'14','Completed','33','Earticle closing','Auto Entry',getdate(),1,'Pending')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: " + Query);
                        }
                        SaveToReport("Status: " + stage + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                        //JR_Articles 
                        JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stageid + "',getdate(),'1')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status:  " + stage + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                        //TrnsJournalRev 
                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage.Replace(" Stage", "") + "','Pending')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        //string vol = ReturnDetail("Volume", "asme_article", Db, "ArticleId='" + Aid + "'", "ASME");
                        //string iss = ReturnDetail("Issue", "asme_article", Db, "ArticleId='" + Aid + "'", "ASME");
                        Query = @"UPDATE article SET Artcl_Volume= '" + volume + @"',Artcl_Issue= '" + issue + @"' Where Artcl_ArticleId='" + Aid + "'";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                    }
                    //Final Web Delivery Parallel booking
                    SaveToReport("Status:  Final Web Delivery update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=43") != "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Final Web Delivery: ", "ASME", true, stage, Zipname);
                        SaveToReport("File already booked for Final Web Delivery: " + Path.GetFileName(Zipname));
                        ////Move to Error
                        //Clear();
                        //return;
                    }
                    else
                    {
                        //// Printer 3
                        //stage = "Printer Files 3 Stage";
                        //id = "3"; stageid = "71";                  
                        JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                        Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','43','" + sche + "',getdate(),'" + sche + "','" + sche + "','21',getdate(),'1','')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        foreach (string Aid in ArticleID)
                        {
                            SaveToReport("Status: Final Web Delivery update JR_Articles Table file: " + Path.GetFileName(Zipname));
                            //JR_Articles 
                            JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                            Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','21','43',getdate(),'1')";
                            SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status:  Final Web Delivery update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                            //TrnsJournalRev 
                            Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','21',getdate(),'1','Final Web Delivery','Pending')";
                            SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }
                    }
                    SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                    if (Directory.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname)) == true) Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                    if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                    {
                        Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                    }
                    File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                    string Outpath = @"\\Techsetserver2\Journal\ASME\" + JournalAcronym + @"\ISSUE\" + volume + "-" + issue + @"\DataSupplied\" + stage.Replace(" Stage", "") + @"\" + Path.GetFileName(Zipname);
                    File.Copy(Zipname, @"D:\WatchTXT\" + Path.GetFileName(Zipname), true);
                    File.WriteAllText(@"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(Zipname) + @".txt", @"D:\WatchTXT\" + Path.GetFileName(Zipname) + @"~" + Outpath);
                    File.Delete(Zipname);
                    //SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "ASME", false, stage);
                    SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
                }
                catch (Exception e)
                {
                    Db.CloseConnection();
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "ASME", true, stage, Zipname);
                    SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                    Clear();
                }
                finally
                {
                    Db.CloseConnection();
                }
            }
        }

        //***
        //public void updateapschanges(string val, XElement e,string articleid, DBClass Db, string condition = "")
        //{
        //    try
        //    {
        //        string fname = "", Articleid = "", msgcontant = "", AddRemove = "", OldVal = "", Newvalue = "", tablecolumn = "", tablename = "", seType = "", pholdstype = "", efflags = "";

        //        if (e.Elements("op").Count() > 0) AddRemove = e.Elements("op").First().Value;
        //        if (e.Elements("value").Count() > 0) Newvalue = e.Elements("value").First().Value;

        //        if (val.Contains("doi") == true)
        //        {
        //            tablecolumn = "Artcl_DOI";
        //            tablename = "Article";
        //        }
        //        else if (val.Contains("title") == true)
        //        {
        //            tablecolumn = "Artcl_Title";
        //            tablename = "Article";
        //        }
        //        else if (val.Contains("figures") == true)
        //        {
        //            tablecolumn = "Artcl_ArtLineArt";
        //            tablename = "Article";
        //        }
        //        else if (val.Contains("editorialFeatures") == true)
        //        {
        //            if (e.XPathSelectElements(@"//data/changeSummary/value/flags/label").Count() > 0) efflags = e.XPathSelectElements(@"//data/changeSummary/value/flags/label").First().Value;
        //            if (e.XPathSelectElements(@"//data/changeSummary/value/flags/value").Count() > 0) Newvalue = e.XPathSelectElements(@"//data/changeSummary/value/flags/value").First().Value;
        //            if (efflags.Contains("Physics") == true)
        //            {
        //                tablecolumn = "FutureinPhysics";
        //            }
        //            else if (efflags.Contains("Invited") == true)
        //            {
        //                tablecolumn = "Invited";
        //            }
        //            else if (efflags.Contains("Invited") == true)
        //            {
        //                tablecolumn = "Gfm";
        //            }
        //            else if (efflags.Contains("Suggestion") == true)
        //            {
        //                tablecolumn = "Suggestion";
        //            }
        //            tablename = "APS_Article_Details";
        //        }
        //        else if (val.Contains("supplementalMaterial") == true)
        //        {
        //            if (e.XPathSelectElements(@"//data/changeSummary/value/urls/base").Count() > 0) Newvalue = e.XPathSelectElements(@"//data/changeSummary/value/urls/base").First().Value;

        //            tablecolumn = "supplementalMaterial";
        //            tablename = "APS_Article_Details";
        //        }
        //        else if (val.Contains("targetDate") == true)
        //        {
        //            tablecolumn = "Targetdate";
        //            tablename = "APS_Article_Details";
        //        }
        //        else if (val.Contains("productionHolds") == true)
        //        {
        //            if (e.Descendants("id").Count() > 0) pholdstype = e.Descendants("id").First().Value;
        //            Newvalue = pholdstype;
        //            if (pholdstype.Contains("qc") == true)
        //            {
        //                tablecolumn = "QcHold";
        //            }
        //            else if (pholdstype.Contains("pay") == true)
        //            {
        //                tablecolumn = "PayHold";
        //            }
        //            else if (pholdstype.Contains("edit") == true)
        //            {
        //                tablecolumn = "EditHold";
        //            }
        //            tablename = "APS_Article_Details";
        //        }
        //        else if (val.Contains("statusevents") == true)
        //        {
        //            if (e.XPathSelectElements(@"//data/changeSummary/value/type").Count() > 0) seType = e.XPathSelectElements(@"//data/changeSummary/value/type").First().Value;
        //            if (e.XPathSelectElements(@"//data/changeSummary/value/date").Count() > 0) Newvalue = e.XPathSelectElements(@"//data/changeSummary/value/date").First().Value;
        //            if (seType.Contains("published") == true)
        //            {
        //                tablecolumn = "Pub_Date";
        //                tablename = "APS_Article_Details";
        //            }
        //            else if (seType.Contains("revised") == true)
        //            {
        //                tablecolumn = "Revised_Date";
        //                tablename = "APS_Article_Details";
        //            }
        //        }

        //        if (tablecolumn != "")
        //        {
        //            if (tablename == "Article")
        //            {
        //                OldVal = ReturnDetail(tablecolumn, tablename, Db, "Artcl_ArticleId like'%" + Path.GetFileNameWithoutExtension(Zipname) + "%'");
        //            }
        //            else if (tablename == "APS_Article_Details")
        //            {
        //                OldVal = ReturnDetail(tablecolumn, tablename, Db, "Article_ID like'%" + Path.GetFileNameWithoutExtension(Zipname) + "%'");
        //            }
        //        }

        //        if (tablename != "" && tablecolumn != "" && articleid != "")
        //        {
        //            string query = "";
        //            if (tablename == "Article")
        //            {
        //                query = @"UPDATE " + tablename + " SET " + tablecolumn + "= '" + Newvalue + @"' Where Artcl_ArticleId like '%" + articleid + "%'";
        //            }
        //            else if (tablename == "APS_Article_Details")
        //            {
        //                query = @"UPDATE " + tablename + " SET " + tablecolumn + "= '" + Newvalue + @"' Where Article_ID like '%" + articleid + "%'";
        //            }
        //            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(query, Db.GetConnection());
        //            Db.OpenConnection();
        //            Db.SqlReader = Db.SqlCmd.ExecuteReader();
        //            Db.SqlReader.Close();
        //        }
        //        if(AddRemove == "remove" && val.Contains("productionHolds") == true)
        //        {
        //            string query = @"UPDATE APS_Article_Details SET QcHold= '',PayHold='',EditHold='' Where Article_ID like '%" + articleid + "%'";
        //            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(query, Db.GetConnection());
        //            Db.OpenConnection();
        //            Db.SqlReader = Db.SqlCmd.ExecuteReader();
        //            Db.SqlReader.Close();
        //        }

        //        if (Newvalue != "" && OldVal != "") msgcontant = "<b>Old " + tablecolumn + ":</b>" + OldVal + "<Br/><Br/><b>New " + tablecolumn + ":</b>" + Newvalue;
        //        if (Newvalue != "" && OldVal == "") msgcontant = "<b>New " + tablecolumn + ":</b>" + Newvalue;

        //        Articleid = ReturnDetail("Artcl_ArticleId", "Article", Db, "Artcl_ArticleId like'%" + Path.GetFileNameWithoutExtension(Zipname) + "%'");
        //        fname = Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\manuscript.xml";

        //        if (tablename == "Article")
        //        {
        //            File.WriteAllText(@"\\techsetserver2\Upload\TARS\" + Articleid + "_Article_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt", "ArticleUpdate|'" + Articleid + @"'|'" + tablecolumn + "^~" + Newvalue + @"'");
        //        }
        //        else if (tablename == "APS_Article_Details")
        //        {
        //            if (AddRemove == "remove" && val.Contains("productionHolds") == true)
        //            {
        //                File.WriteAllText(@"\\techsetserver2\Upload\TARS\" + Articleid + "_Article_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt", "APSArticleUpdate|'" + Articleid + @"'|'QcHold^~'|'PayHold^~'|'EditHold^~'");
        //            }
        //            else
        //            {
        //                File.WriteAllText(@"\\techsetserver2\Upload\TARS\" + Articleid + "_Article_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt", "APSArticleUpdate|'" + Articleid + @"'|'" + tablecolumn + "^~" + Newvalue + @"'");
        //            }
        //        }

        //        if (msgcontant != "")
        //        {
        //            SendMail(articleid, "Dear APS Team,<Br/><Br/>We have received new change request of existing article : " + Articleid + "<Br/><Br/> " + msgcontant + "<Br/><Br/> Kindly check & confirm to procceed further.", "APS", false, "APS_Changes", fname);
        //        }
        //        else
        //        {
        //           SendMail(Articleid, "Dear APS Team,<Br/><Br/>We have received new change request of existing article : " + Articleid + "<Br/><Br/> " + e.XPathSelectElements(@"//data/changeSummary").First().ToString().Replace("\r\n", "<Br/>") + "<Br/><Br/> Kindly check & confirm to procceed further.", "APS", false, "APS_Changes", fname);
        //        }
        //    }
        //    catch (Exception e1)
        //    {
        //        Db.CloseConnection();
        //       SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while update apschanges : " + Path.GetFileName(Zipname) + "<Br/>" + e1.Message, "APS", true, "", "");
        //        SaveToReport("Error while update apschanges : " + Path.GetFileName(Zipname) + "\n" + e1.Message + "\n" + e1.StackTrace);
        //    }
        //}

        public void updateapschanges(string val, XElement e, string articleid, DBClass Db, string condition = "")
        {
            try
            {
                string fname = "", Articleid = "", msgcontant = "", AddRemove = "", OldVal = "", Newvalue = "", tablecolumn = "", tablename = "", seType = "", pholdstype = "", efflags = "", Newid = "";

                if (e.Elements("op").Count() > 0) AddRemove = e.Elements("op").First().Value;
                if (e.Elements("value").Count() > 0) Newvalue = e.Elements("value").First().Value;

                if (val.Contains("doi") == true)
                {
                    tablecolumn = "Artcl_DOI";
                    tablename = "Article";
                }
                else if (val.Contains("title") == true)
                {
                    tablecolumn = "Artcl_Title";
                    tablename = "Article";
                }
                else if (val.Contains("figures") == true)
                {
                    tablecolumn = "Artcl_ArtLineArt";
                    tablename = "Article";
                }
                else if (val.Contains("editorialFeatures") == true)
                {
                    if (e.XPathSelectElements(@"//data/changeSummary/value/flags/label").Count() > 0) efflags = e.XPathSelectElements(@"//data/changeSummary/value/flags/label").First().Value;
                    if (e.XPathSelectElements(@"//data/changeSummary/value/flags/value").Count() > 0) Newvalue = e.XPathSelectElements(@"//data/changeSummary/value/flags/value").First().Value;

                    if (efflags == "")
                    {
                        if (e.XPathSelectElements(@"//data/changeSummary/value/label").Count() > 0) efflags = e.XPathSelectElements(@"//data/changeSummary/value/label").First().Value;
                        if (e.XPathSelectElements(@"//data/changeSummary/value/value").Count() > 0) Newvalue = e.XPathSelectElements(@"//data/changeSummary/value/value").First().Value;
                    }


                    if (efflags.Contains("Physics") == true)
                    {
                        tablecolumn = "FutureinPhysics";
                    }
                    else if (efflags.Contains("Invited") == true)
                    {
                        tablecolumn = "Invited";
                    }
                    else if (efflags.Contains("Gfm") == true)
                    {
                        tablecolumn = "Gfm";
                    }
                    else if (efflags.Contains("Suggestion") == true)
                    {
                        tablecolumn = "Suggestion";
                    }
                    tablename = "APS_Article_Details";
                }
                else if (val.Contains("supplementalMaterial") == true)
                {
                    if (e.XPathSelectElements(@"//data/changeSummary/value/urls/base").Count() > 0) Newvalue = e.XPathSelectElements(@"//data/changeSummary/value/urls/base").First().Value;

                    tablecolumn = "supplementalMaterial";
                    tablename = "APS_Article_Details";
                }
                else if (val.Contains("general/note") == true)
                {
                    tablecolumn = "General_Notes";
                    tablename = "APS_Article_Details";
                }
                else if (val.Contains("authorCommunication/memos") == true && e.XPathSelectElements(@"//data/changeSummary/value/id").Count() > 0)
                {
                    if (e.XPathSelectElements(@"//data/changeSummary/value/id").Count() > 0) Newid = e.XPathSelectElements(@"//data/changeSummary/value/id").First().Value;
                    if (e.XPathSelectElements(@"//data/changeSummary/value/url").Count() > 0) Newvalue = e.XPathSelectElements(@"//data/changeSummary/value/url").First().Value;
                    tablename = "APS_Article_Details";
                }
                else if (val.Contains("authorCommunication/note") == true)
                {
                    tablecolumn = "authorCom_Note";
                    tablename = "APS_Article_Details";
                }
                else if (val.Contains("premarkedManuscript") == true)
                {
                    tablecolumn = "Pmarked_MS_Val";
                    tablename = "APS_Article_Details";
                }
                else if (val.Contains("targetDate") == true)
                {
                    tablecolumn = "Targetdate";
                    tablename = "APS_Article_Details";
                }
                else if (val.Contains("productionHolds") == true)
                {
                    if (e.Descendants("id").Count() > 0) pholdstype = e.Descendants("id").First().Value;
                    Newvalue = pholdstype;
                    if (pholdstype.Contains("qc") == true)
                    {
                        tablecolumn = "QcHold";
                    }
                    else if (pholdstype.Contains("payment") == true)
                    {
                        tablecolumn = "PayHold";
                    }
                    else if (pholdstype.Contains("editorial") == true)
                    {
                        tablecolumn = "EditHold";
                    }
                    tablename = "APS_Article_Details";
                }
                else if (val.Contains("statusevents") == true)
                {
                    if (e.XPathSelectElements(@"//data/changeSummary/value/type").Count() > 0) seType = e.XPathSelectElements(@"//data/changeSummary/value/type").First().Value;
                    if (e.XPathSelectElements(@"//data/changeSummary/value/date").Count() > 0) Newvalue = e.XPathSelectElements(@"//data/changeSummary/value/date").First().Value;
                    if (seType.Contains("published") == true)
                    {
                        tablecolumn = "Pub_Date";
                        tablename = "APS_Article_Details";
                    }
                    else if (seType.Contains("revised") == true)
                    {
                        tablecolumn = "Revised_Date";
                        tablename = "APS_Article_Details";
                    }
                }

                if (tablecolumn != "")
                {
                    if (tablename == "Article")
                    {
                        OldVal = ReturnDetail(tablecolumn, tablename, Db, "Artcl_ArticleId like'%" + Path.GetFileNameWithoutExtension(Zipname) + "%'");
                    }
                    else if (tablename == "APS_Article_Details")
                    {
                        OldVal = ReturnDetail(tablecolumn, tablename, Db, "Article_ID like'%" + Path.GetFileNameWithoutExtension(Zipname) + "%'");
                    }
                }

                if (tablename != "" && tablecolumn != "" && articleid != "")
                {
                    string query = "";
                    if (tablename == "Article")
                    {
                        query = @"UPDATE " + tablename + " SET " + tablecolumn + "= '" + Newvalue + @"' Where Artcl_ArticleId like '%" + articleid + "%'";
                    }
                    else if (tablename == "APS_Article_Details")
                    {
                        query = @"UPDATE " + tablename + " SET " + tablecolumn + "= '" + Newvalue + @"' Where Article_ID like '%" + articleid + "%'";
                    }
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                }
                else
                {
                    if (tablename == "APS_Article_Details" && val.Contains("authorCommunication/memos") == true)
                    {
                        string query = "";
                        query = @"UPDATE APS_Article_Details SET authorComs_Memos_Id='" + Newid + @"',authorComs_Memos_url= '" + Newvalue + @"' Where Article_ID like '%" + articleid + "%'";

                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                    }
                }
                if (AddRemove == "remove" && val.Contains("productionHolds") == true)
                {
                    string query = @"UPDATE APS_Article_Details SET QcHold= '',PayHold='',EditHold='' Where Article_ID like '%" + articleid + "%'";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                }
                if (AddRemove == "remove" && val.Contains("editorialFeatures") == true)
                {
                    string query = @"UPDATE APS_Article_Details SET FutureinPhysics='',Invited='',Gfm= '',Suggestion='' Where Article_ID like '%" + articleid + "%'";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                }
                if (Newvalue != "" && OldVal != "") msgcontant = "<b>Old " + tablecolumn + ":</b>" + OldVal + "<Br/><Br/><b>New " + tablecolumn + ":</b>" + Newvalue;
                if (Newvalue != "" && OldVal == "" && Newid == "") msgcontant = "<b>New " + tablecolumn + ":</b>" + Newvalue;
                if (Newvalue != "" && OldVal == "" && Newid != "") msgcontant = "<b>New authorComs_Memos_Id:</b>" + Newid + "<Br/><b>New authorComs_Memos_url:</b>" + Newvalue + "";

                Articleid = ReturnDetail("Artcl_ArticleId", "Article", Db, "Artcl_ArticleId like'%" + Path.GetFileNameWithoutExtension(Zipname) + "%'");
                fname = Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\manuscript.xml";

                if (tablename == "Article")
                {
                    System.Threading.Thread.Sleep(1000);
                    File.WriteAllText(@"\\techsetserver2\Upload\TARS\" + Articleid + "_Article_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt", "ArticleUpdate|'" + Articleid + @"'|'" + tablecolumn + "^~" + Newvalue + @"'");
                }
                else if (tablename == "APS_Article_Details")
                {
                    if (AddRemove == "remove" && val.Contains("productionHolds") == true)
                    {
                        System.Threading.Thread.Sleep(1000);
                        File.WriteAllText(@"\\techsetserver2\Upload\TARS\" + Articleid + "_Article_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt", "APSArticleUpdate|'" + Articleid + @"'|'QcHold^~'|'PayHold^~'|'EditHold^~'");
                    }
                    else if (AddRemove == "remove" && val.Contains("editorialFeatures") == true)
                    {
                        System.Threading.Thread.Sleep(1000);
                        File.WriteAllText(@"\\techsetserver2\Upload\TARS\" + Articleid + "_Article_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt", "APSArticleUpdate|'" + Articleid + @"'|'FutureinPhysics^~'|'Invited^~'|'Gfm^~'|'Suggestion^~'");
                    }
                    else if (val.Contains("authorCommunication/memos") == true)
                    {
                        System.Threading.Thread.Sleep(1000);
                        File.WriteAllText(@"\\techsetserver2\Upload\TARS\" + Articleid + "_Article_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt", "APSArticleUpdate|'" + Articleid + @"'|'authorComs_Memos_Id^~" + Newid + @"'|'authorComs_Memos_url^~" + Newvalue + @"'");
                    }
                    else
                    {
                        System.Threading.Thread.Sleep(1000);
                        File.WriteAllText(@"\\techsetserver2\Upload\TARS\" + Articleid + "_Article_" + DateTime.Now.ToString("ddMMyyyy_HHmmss") + ".txt", "APSArticleUpdate|'" + Articleid + @"'|'" + tablecolumn + "^~" + Newvalue + @"'");
                    }
                }

                if (msgcontant != "")
                {
                    SendMail(articleid, "Dear APS Team,<Br/><Br/>We have received new change request of existing article : " + Articleid + "<Br/><Br/> " + msgcontant + "<Br/><Br/> Kindly check & confirm to procceed further.", "APS", false, "APS_Changes", fname);
                }
                else
                {
                    SendMail(Articleid, "Dear APS Team,<Br/><Br/>We have received new change request of existing article : " + Articleid + "<Br/><Br/> " + e.XPathSelectElements(@"//data/changeSummary").First().ToString().Replace("\r\n", "<Br/>") + "<Br/><Br/> Kindly check & confirm to procceed further.", "APS", false, "APS_Changes", fname);
                }
            }
            catch (Exception e1)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while update apschanges : " + Path.GetFileName(Zipname) + "<Br/>" + e1.Message, "APS", true, "", "");
                SaveToReport("Error while update apschanges : " + Path.GetFileName(Zipname) + "\n" + e1.Message + "\n" + e1.StackTrace);
            }
        }

        public static string ConvertNumbertoWords(long number)
        {
            if (number == 0) return "ZERO";
            if (number < 0) return "minus " + ConvertNumbertoWords(Math.Abs(number));
            string words = "";
            if ((number / 1000000) > 0)
            {
                words += ConvertNumbertoWords(number / 100000) + " LAKES ";
                number %= 1000000;
            }
            if ((number / 1000) > 0)
            {
                words += ConvertNumbertoWords(number / 1000) + " THOUSAND ";
                number %= 1000;
            }
            if ((number / 100) > 0)
            {
                words += ConvertNumbertoWords(number / 100) + " HUNDRED ";
                number %= 100;
            }
            //if ((number / 10) > 0)  
            //{  
            // words += ConvertNumbertoWords(number / 10) + " RUPEES ";  
            // number %= 10;  
            //}  
            if (number > 0)
            {
                if (words != "") words += "AND ";
                var unitsMap = new[]
                {
            "ZERO", "First", "Second", "Third", "Fourth", "Fifth", "Sixth", "Seventh", "Eighth ", "Ninth", "Tenth", "Eleventh", "Twelveth", "Thirteenth", "Fourteenth", "Fifteenth", "Sixteenth", "Seventeenth", "Eigteenth", "Nineteenth"
        };
                var tensMap = new[]
                {
            "ZERO", "TEN", "TWENTY", "THIRTY", "FORTY", "FIFTY", "SIXTY", "SEVENTY", "EIGHTY", "NINETY"
        };
                if (number < 20) words += unitsMap[number];
                else
                {
                    words += tensMap[number / 10];
                    if ((number % 10) > 0) words += " " + unitsMap[number % 10];
                }
            }
            return words;
        }


        public string ReturnDetail(string data, string tablename, DBClass db, string condition = "", string sesame = "")
        {
            string value = "";
            string query = @"SELECT " + data + " FROM " + tablename + @" WHERE " + condition;
            if (condition == "") query = @"SELECT " + data + " FROM " + tablename;
            if (sesame == "ASME") db.SqlCmd = new System.Data.SqlClient.SqlCommand(query, db.GetConnection("ASME"));
            else db.SqlCmd = new System.Data.SqlClient.SqlCommand(query, db.GetConnection());
            db.OpenConnection();
            db.SqlReader = db.SqlCmd.ExecuteReader();
            if (db.SqlReader.Read() == true)
            {
                if (data.Contains(" as "))
                {
                    value = db.SqlReader["id"].ToString();
                }
                else
                {
                    value = db.SqlReader[data].ToString();
                }
            }
            db.SqlReader.Close();
            db.CloseConnection();
            return value;
        }
        //***
        public void UpdateAuthors(DBClass db, XElement au, string Au_ArticleId, int Au_Corresponding = 0)
        {
            string Au_Salutation = "", Au_FirstName = "", Au_MiddleName = "", Au_LastName = "", Au_Email = "", Au_Telephone = "", suff = "";
            foreach (XElement ele in au.Elements().ToList())
            {
                switch (ele.Name.ToString())
                {
                    case "email":
                        Au_Email = ele.Value;
                        break;
                    case "surname":
                        Au_LastName = ele.Value;
                        if (Au_LastName != "") Au_LastName = Au_LastName.Replace(@"'", @"''");
                        break;
                    case "firstName":
                        Au_FirstName = ele.Value;
                        if (Au_FirstName != "") Au_FirstName = Au_FirstName.Replace(@"'", @"''");
                        break;
                    case "phoneNumber":
                        Au_Telephone = ele.Value;
                        break;
                    case "suffix":
                        suff = ele.Value;
                        if (suff != "") suff = suff.Replace(@"'", @"''");
                        break;
                    case "prefix":
                        Au_Salutation = ele.Value;
                        if (Au_Salutation != "") Au_Salutation = Au_Salutation.Replace(@"'", @"''");
                        break;
                    case "middleNames":
                        Au_MiddleName = ele.Value;
                        if (Au_MiddleName != "") Au_MiddleName = Au_MiddleName.Replace(@"'", @"''");
                        break;
                }
            }
            if (ReturnDetail("Au_Id", "Authors", db, "Au_ArticleId='" + Au_ArticleId + "' and Au_Corresponding=" + Au_Corresponding + " and Au_FirstName='" + Au_FirstName + "' and Au_LastName='" + Au_LastName + "'") == "")
            {
                string query = "  INSERT INTO Authors  (Au_ArticleId,Au_Corresponding,Au_Salutation,Au_FirstName,Au_MiddleName,Au_LastName,Au_Email,Au_Telephone,AffiliationID,Au_Suffix) VALUES('" + Au_ArticleId + "'," + Au_Corresponding + ",'" + Au_Salutation + "','" + Au_FirstName + "','" + Au_MiddleName + "','" + Au_LastName + "','" + Au_Email + "','" + Au_Telephone + "',null,'" + suff + "')";
                db.SqlCmd = new System.Data.SqlClient.SqlCommand(query, db.GetConnection());
                db.OpenConnection();
                db.SqlReader = db.SqlCmd.ExecuteReader();
                string[] senslist = File.ReadAllLines(System.Environment.CurrentDirectory + @"\APS_Sensitive_Authorlist.ini");
                //if (!sensau && (Regex.IsMatch(senslist, Regex.Escape(Au_FirstName) + "([^<>]*?)" + Regex.Escape(Au_LastName), RegexOptions.IgnoreCase) || Regex.IsMatch(senslist, Regex.Escape(Au_LastName) + "([^<>]*?)" + Regex.Escape(Au_FirstName), RegexOptions.IgnoreCase)))
                if (!sensau)
                {
                    foreach (string li in senslist)
                    {
                        if (Regex.IsMatch(li, "^" + Regex.Escape(Au_FirstName) + "([^<>]*?)" + Regex.Escape(Au_LastName), RegexOptions.IgnoreCase) || Regex.IsMatch(li, "^" + Regex.Escape(Au_LastName) + "([^<>]*?)" + Regex.Escape(Au_FirstName), RegexOptions.IgnoreCase))
                        {
                            MailMessage MM = new MailMessage();
                            MM = new MailMessage("automailer@novatechset.com", "apspmteam@novatechset.com", "APS: Sensitive Author Alert for: " + Au_ArticleId, "Hi Team,<Br/><Br/>Sensitive author found for Article " + Au_ArticleId.ToUpper() + "<Br/>Author in List:  " + li + "<Br/>Author in XML:  " + au.ToString() + "<Br/><Br/> Regards<Br/> TechSupport.");
                            MM.CC.Add("tiworkflow@novatechset.com");
                            MM.CC.Add("saravanakumar@novatechset.com");
                            SmtpClient client = new SmtpClient(SerializedClass.MailServer);
                            MM.IsBodyHtml = true;
                            try
                            {
                                client.Send(MM);
                                sensau = true;
                                break;
                            }
                            catch (Exception ex) { }
                        }
                    }
                }
            }
        }
        //***
        public string UpdateTransaction(Int64 Aid, bool art = false, string Artpub = "AIP", string status = "")
        {
            if (art)
            {
                if (Artpub == "VeruScript" || Artpub == "GSL")
                {
                    return "Insert into TrnsJournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) values(" + @"'" + Aid + @"','1','Admin',getdate(),getdate(),'14','Completed','122','Artwork','Auto Entry',getdate(),1,'Pending')";
                }
                else
                {
                    return "Insert into TrnsJournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) values(" + @"'" + Aid + @"','1','Admin',getdate(),getdate(),'14','Completed','22','Artwork','Auto Entry',getdate(),1,'Pending')";
                }
            }
            else
            {
                if (Artpub == "AIP" || Artpub == "OSA" || Artpub == "GSL" || Artpub == "ASME" || Artpub == "GSA" || Artpub == "Frontiers")
                {
                    if (status == "DP") return "Insert into TrnsJournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) values(" + @"'" + Aid + @"','1','Admin',getdate(),getdate(),'14','Completed','20','Article','Auto Entry',getdate(),1,'Pending')";
                    else if (status == "PE") return "Insert into TrnsJournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) values(" + @"'" + Aid + @"','1','Admin',getdate(),getdate(),'14','Completed','75','Article','Auto Entry',getdate(),1,'Pending')";
                    else return "Insert into TrnsJournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) values(" + @"'" + Aid + @"','1','Admin',getdate(),getdate(),'14','Completed','171','Article','Auto Entry',getdate(),1,'Pending')";
                }
                else if (Artpub == "APS")
                {
                    return "Insert into TrnsJournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) values(" + @"'" + Aid + @"','1','Admin',getdate(),getdate(),'14','Completed','75','Article','Auto Entry',getdate(),1,'Pending')";
                }
                else
                {
                    return "Insert into TrnsJournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) values(" + @"'" + Aid + @"','1','Admin',getdate(),getdate(),'14','Completed','15','Article','Auto Entry',getdate(),1,'Pending')";
                }
            }
        }
        //***
        public void Clear()
        {
            if (Directory.Exists(Path.GetDirectoryName(Zipname) + @"\Error\" + SerializedClass.month + @"\" + SerializedClass.Date) == false)
            {
                Directory.CreateDirectory(Path.GetDirectoryName(Zipname) + @"\Error\" + SerializedClass.month + @"\" + SerializedClass.Date);
            }
            if (Directory.Exists(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname)))
            {
                Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
            }
            File.Copy(Zipname, Path.GetDirectoryName(Zipname) + @"\Error\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileName(Zipname), true);
            if (File.Exists(Zipname.Replace(".zip", ".go.xml"))) File.Copy(Zipname.Replace(".zip", ".go.xml"), Path.GetDirectoryName(Zipname) + @"\Error\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileName(Zipname.Replace(".zip", ".go.xml")), true);
            System.Threading.Thread.Sleep(5000);
            try
            {
                File.Delete(Zipname);
                if (File.Exists(Zipname.Replace(".zip", ".go.xml"))) File.Delete(Zipname.Replace(".zip", ".go.xml"));
            }
            catch (Exception e) { SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace); }
        }
        //***



        public void SendMail(string AID, string msg, string pub, bool error, string stage, string attachment1 = "", string sub = "")
        {
            if (stage != "AIP_Report" && stage != "APS_Changes" && stage != "IWAP_report" && stage != "CUP_report" && stage != "SAGE_Report" && stage != "SAGE_PM_Report" && stage != "SAGE_TempReport" && stage != "Frontiers_report")
            {
                attachment1 = "";
            }
            if (msg.Contains(@"Articles\DataSupplied\FileChanged")) attachment1 = "";
            MailMessage MM = new MailMessage();
            if (stage == "APSHIT")
            {
                msg = "https://api.novatechset.com/api/manuscripts/watch" + " Result: " + AID;
                AID = "";
            }
            if (Regex.IsMatch(msg, @"readme\.XML file is not valid for AIP:")) msg += @"<Br/>Error Package Path: \\techsetserver2\Download\AIP_Error\" + Path.GetFileName(Zipname) + "<Br/>";
            if (pub != "NotifyGSL") msg += "<Br/><Br/>Regards,<Br/>TechSupport.";
            //if (error)
            //{
            //    MM = new MailMessage("automailer@novatechset.com", "parthiban@novatechset.com", pub + ": " + stage + " Booking Status for " + AID + ": Failure", msg);
            //    MM.CC.Add("parthiban@novatechset.com");
            //}
            switch (pub)
            {
                case @"ASMESRC":
                    MM = new MailMessage("automailer@novatechset.com", "asmejournals@novatechset.com", pub + ": Srcby information for Article: " + AID, msg);
                    //MM.CC.Add("tiworkflow@novatechset.com");
                    //MM.CC.Add("saravanakumar@novatechset.com");
                    break;
                case @"ASME":
                    if (sub == "") sub = pub + ": " + stage + " Booking Status for " + AID + ": Success";
                    if (error)
                    {
                        MM = new MailMessage("automailer@novatechset.com", "asmejournals@novatechset.com", sub, msg);
                    }
                    else
                    {
                        MM = new MailMessage("automailer@novatechset.com", "santhosh@novatechset.com", sub, msg);
                        MM.To.Add("gnarayani@novatechset.com");
                        MM.To.Add("murugaraj@novatechset.com");
                        MM.CC.Add("rajaram@novatechset.com");
                        MM.CC.Add("RaajeshKannan@novatechset.com");
                    }
                    //MM.CC.Add("tiworkflow@novatechset.com");
                    //MM.CC.Add("saravanakumar@novatechset.com");
                    if (stage.Contains(@"PAP"))
                    {
                        MM.CC.Add("books3b2@novatechset.com");
                    }
                    break;
                case @"TNF_Abs":
                    MM = new MailMessage("automailer@novatechset.com", "tiworkflow@novatechset.com", "ABCats Notification: Success", msg);
                    //MM.CC.Add("rajasekar@novatechset.com");
                    //MM.CC.Add("tiworkflow@novatechset.com");
                    break;
                case @"NotifyGSL":
                    MM = new MailMessage("gsl_autodownload@novatechset.com", stage, AID, msg);
                    MM.Bcc.Add("ramesh@novatechset.com");
                    MM.Bcc.Add("key1_techsetindia@novatechset.com");
                    //MM.Bcc.Add("tiworkflow@novatechset.com");
                    break;
                case @"AIP":
                    if (stage == "AIP_Report")
                    {
                        MM = new MailMessage("aipjournals@novatechset.com", "rajeshkannah@novatechset.com", "AIP Report " + DateTime.Now, msg);
                        MM.CC.Add("tiworkflow@novatechset.com");
                        MM.CC.Add("rajasekar@novatechset.com");
                        //MM.CC.Add("saravanakumar@novatechset.com");
                        //MM.CC.Add("senthilkumaran@novatechset.com");
                        MM.CC.Add("AIPP-Productionteam@novatechset.com");
                        break;
                    }
                    if (stage == "Additional_Correction")
                    {
                        MM = new MailMessage("aipjournals@novatechset.com", "AIPP-Productionteam@novatechset.com", pub + ": " + stage + " Booking Status for " + AID + ": Success", msg);
                        MM.To.Add("aip-xml@novatechset.com");
                        //MM.To.Add("productionteam@novatechset.com");
                        //MM.CC.Add("tiworkflow@novatechset.com");
                        //MM.CC.Add("saravanakumar@novatechset.com");
                        //MM.CC.Add("rajeshkannah@novatechset.com");
                        break;
                    }
                    if (stage == "AIP_Merging")
                    {
                        MM = new MailMessage("aipjournals@novatechset.com", "aip3b2@novatechset.com", "AIP Printer stage File missing Details: " + AID, msg);
                        //MM.CC.Add("tiworkflow@novatechset.com");
                        //MM.CC.Add("saravanakumar@novatechset.com");
                        break;
                    }
                    MM = new MailMessage("aipjournals@novatechset.com", "AIPP-Productionteam@novatechset.com", pub + ": " + stage + " Booking Status for " + AID + ": Success", msg);
                    //MM.To.Add("key1_techsetindia@novatechset.com");                  
                    //MM.CC.Add("tiworkflow@novatechset.com");
                    //MM.CC.Add("saravanakumar@novatechset.com");
                    break;
                case @"GSL":
                    MM = new MailMessage("gsl_autodownload@novatechset.com", "ramesh@novatechset.com", pub + ": " + stage + " Booking Status for " + AID + ": Success", msg);
                    MM.To.Add("key1_techsetindia@novatechset.com");
                    //MM.CC.Add("tiworkflow@novatechset.com");
                    //MM.CC.Add("saravanakumar@novatechset.com");
                    break;
                case "Frontiers":
                    if (stage == "Frontiers_report")
                    {
                        MM = new MailMessage("rajasekar@novatechset.com", "benedict@novatechset.com", sub, msg);
                        MM.CC.Add("saravanakumar@novatechset.com");
                        MM.CC.Add("dataconversion@novatechset.com");
                        break;
                    }
                    else
                    {
                        MM = new MailMessage("automailer@novatechset.com", "ramesh@novatechset.com", pub + ": " + stage + " Booking Status for " + AID + ": Success", msg);
                        MM.CC.Add("rajeshkannah@novatechset.com");
                        MM.CC.Add("tiworkflow@novatechset.com");
                        // MM.CC.Add("rajasekar@novatechset.com");
                        MM.CC.Add("saravanakumar@novatechset.com");
                        MM.CC.Add("Frontierscore@katalysttech.com");
                        break;
                    }
                case @"APS Invoice":
                    MM = new MailMessage("apspmteam@novatechset.com", "ramesh@novatechset.com", pub + ": " + stage + " Booking Status for " + AID + ": Success", msg);
                    //MM.CC.Add("tiworkflow@novatechset.com");
                    //MM.CC.Add("saravanakumar@novatechset.com");
                    break;
                case @"APS":
                    MM = new MailMessage("apspmteam@novatechset.com", "ramesh@novatechset.com", pub + ": " + stage + " Booking Status for " + AID + ": Success", msg);
                    MM.To.Add("key1_techsetindia@novatechset.com");
                    //MM.CC.Add("tiworkflow@novatechset.com");
                    //MM.CC.Add("saravanakumar@novatechset.com");
                    //MM.CC.Add("antonykingbright@novatechset.com");
                    if (stage == "APSHIT")
                    {
                        MM = new MailMessage("apspmteam@novatechset.com", "kameshwaran@novatechset.com", pub + ": " + "API/MANIUSCRIPTS/WATCH" + " Error", msg);
                        //MM.CC.Add("tiworkflow@novatechset.com");
                        //MM.CC.Add("rajasekar@novatechset.com");
                        //MM.CC.Add("saravanakumar@novatechset.com");
                        break;
                    }
                    if (stage == "APSVAL")
                    {
                        MM = new MailMessage("apspmteam@novatechset.com", "tiworkflow@novatechset.com", pub + ": " + "Validation with Smart ", msg);
                        MM.CC.Add("rageshnair@novatechset.com");
                        MM.CC.Add("ramesh@novatechset.com");
                        MM.CC.Add("rajasekar@novatechset.com");
                        break;
                    }
                    if (stage == "APS_Changes")
                    {
                        MM = new MailMessage("apspmteam@novatechset.com", "rahul@novatechset.com", pub + ": APS Changes/File changed " + AID, msg);
                        //MM.CC.Add("tiworkflow@novatechset.com");
                        MM.To.Add("ramesh@novatechset.com");
                        MM.To.Add("rageshnair@novatechset.com");
                        //MM.CC.Add("saravanakumar@novatechset.com");
                        //MM.CC.Add("antonykingbright@novatechset.com");
                        //MM.CC.Add("kameshwaran@novatechset.com");
                        break;
                    }
                    if (stage == "APS_PubGrp")
                    {
                        MM = new MailMessage("apspmteam@novatechset.com", "saravanakumar@novatechset.com", pub + ": APS Bookin " + AID, msg);
                        //MM.CC.Add("tiworkflow@novatechset.com");
                        //MM.CC.Add("saravanakumar@novatechset.com");
                        //MM.CC.Add("kameshwaran@novatechset.com");
                        break;
                    }
                    break;
                case @"VeruScript":
                    MM = new MailMessage("automailer@novatechset.com", "vijayarajan@novatechset.com", pub + ": " + stage + " Booking Status for " + AID + ": Success", msg);
                    MM.To.Add("key1_techsetindia@novatechset.com");
                    //MM.CC.Add("tiworkflow@novatechset.com");
                    //MM.CC.Add("saravanakumar@novatechset.com");
                    break;
                case @"ASCE":
                    MM = new MailMessage("automailer@novatechset.com", "padmashanthi@novatechset.com", pub + ": " + stage + " Booking Status for " + AID + ": Success", msg);
                    MM.To.Add("preediting@novatechset.com");
                    //MM.CC.Add("tiworkflow@novatechset.com");
                    //MM.CC.Add("saravanakumar@novatechset.com");
                    break;
                case @"OSA":
                    if (stage == "OSAHIT")
                    {
                        MM = new MailMessage("automailer@novatechset.com", "tiworkflow@novatechset.com", pub + ": " + "OSA FTP Upload for Tracking (html upload)" + " Error", msg);
                        MM.CC.Add("tiworkflow@novatechset.com");
                        break;
                    }
                    MM = new MailMessage("automailer@novatechset.com", "benedict@novatechset.com", pub + ": " + stage + " Booking Status for " + AID + ": Success", msg);
                    MM.To.Add("dataconversion@novatechset.com");
                    MM.To.Add("osajournals@novatechset.com");
                    //MM.CC.Add("tiworkflow@novatechset.com");
                    //MM.CC.Add("saravanakumar@novatechset.com");
                    break;
                case @"IWAP":
                    MM = new MailMessage("automailer@novatechset.com", "xmlteam@novatechset.com", pub + ": IWAP Today's Report Generation : Success", msg);
                    MM.CC.Add("tiworkflow@novatechset.com");
                    //MM.CC.Add("saravanakumar@novatechset.com");
                    break;
                case @"COB":
                    MM = new MailMessage("automailer@novatechset.com", "cobteam@novatechset.com", pub + ": " + stage + " Booking Status for " + AID + ": Success", msg);
                    MM.CC.Add("tiworkflow@novatechset.com");
                    //MM.CC.Add("saravanakumar@novatechset.com");
                    break;
                case @"GSA":
                    MM = new MailMessage("automailer@novatechset.com", "gsa-productionteam@novatechset.com", pub + ": " + stage + " Booking Status for " + AID + ": Success", msg);
                    MM.CC.Add("gsajournals@novatechset.com");
                    //MM.CC.Add("parthiban@novatechset.com");
                    //MM.CC.Add("tiworkflow@novatechset.com");
                    break;
                case @"SAGE":
                    if (stage == "SAGE DOI update")
                    {
                        MM = new MailMessage("sagepub@novatechset.com", "benedict@novatechset.com", pub + ": " + stage + " Booking Status for " + AID + ": Success", msg);
                        //MM.To.Add("rajeshkannah@novatechset.com");
                        //MM.To.Add("gayathri@novatechset.com");
                        //MM.CC.Add("tiworkflow@novatechset.com");
                        MM.CC.Add("sagepub@novatechset.com");
                    }
                    else if (stage == "SAGE_Report")
                    {
                        MM = new MailMessage("sagepub@novatechset.com", "Sage_production@novatechset.com", "SAGE Report " + DateTime.Now, msg);
                        MM.CC.Add("tiworkflow@novatechset.com");
                        //MM.CC.Add("sagepub@novatechset.com");
                        MM.CC.Add("balaji@novatechset.com");
                        MM.CC.Add("aip-xml@novatechset.com");
                        MM.CC.Add("mastercopy_sage@novatechset.com");
                        //MM.CC.Add("mastercopy_team@novatechset.com");
                        MM.CC.Add("Thiyagarajant@novatechset.com");
                        break;
                    }
                    else if (stage == "SAGE_TempReport")
                    {
                        MM = new MailMessage("sagepub@novatechset.com", "Thiyagarajant@novatechset.com", "SAGE OA Report " + DateTime.Now, msg);   //Mastercopy_team@novatechset.com
                        MM.CC.Add("tiworkflow@novatechset.com");
                        //MM.CC.Add("rajeshkannah@novatechset.com");
                        MM.CC.Add("gayathri@novatechset.com");
                        MM.CC.Add("suriyakumar@novatechset.com");
                        MM.CC.Add("jabez@novatechset.com");
                        MM.CC.Add("ietpreediting@novatechset.com");
                        MM.CC.Add("vasantha@novatechset.com");
                        MM.CC.Add("prakash@novatechset.com");
                        MM.CC.Add("aip-xml@novatechset.com");
                        break;
                    }
                    else if (stage == "SPS_Report")
                    {
                        MM = new MailMessage("suriyakumar@novatechset.com", "gayathri@novatechset.com", "SAGE TTP Report " + DateTime.Now, msg);
                        MM.CC.Add("tiworkflow@novatechset.com");
                        MM.CC.Add("saravanakumar@novatechset.com");
                        break;
                    }
                    else if (stage == "SAGE_PM_Report")
                    {
                        MM = new MailMessage("sagepub@novatechset.com", "sagepub@novatechset.com", "SAGE PM Report " + DateTime.Now, msg);
                        MM.CC.Add("tiworkflow@novatechset.com");
                        //MM.CC.Add("rajeshkannah@novatechset.com");
                        break;
                    }
                    else
                    {
                        MM = new MailMessage("sagepub@novatechset.com", "automailer@novatechset.com", pub + ": " + stage + " Booking Status for " + AID + ": Success", msg);
                        //MM.CC.Add("rajeshkannah@novatechset.com");
                        //MM.CC.Add("gayathri@novatechset.com");
                        //MM.CC.Add("tiworkflow@novatechset.com");
                    }
                    break;
                case @"CUP":
                    MM = new MailMessage("automailer@novatechset.com", "viji@novatechset.com", pub + ": " + stage + " Booking Status for " + Path.GetFileName(AID) + ": Success", msg);
                    if (error) MM = new MailMessage("CUP_Booking-in_Failure@novatechset.com", "viji@novatechset.com", "Log-in Failure: " + pub + " " + stage + " Booking Status for " + Path.GetFileName(AID) + ": Success", msg);

                    if (cuppmjrnl == true && cupjrnl != "") MM.To.Add(cupjrnl.ToLower().Replace("cup", "") + "_cuppmteam@novatechset.com");
                    MM.CC.Add("key2_techsetindia@novatechset.com");
                    if (MM.Body.Contains("EG article Author not submitted yet. Author Correction not booked but Revises requested")) MM.To.Add("EGSupport@novatechset.com");
                    //MM.CC.Add("tiworkflow@novatechset.com");
                    //MM.CC.Add("saravanakumar@novatechset.com");                   
                    break;
                case @"CUPM":
                    MM = new MailMessage("rajasekar@novatechset.com", "kalaivani@novatechset.com", "CUP Report Generation for SunriseSettings : Success", msg);
                    MM.CC.Add("tiworkflow@novatechset.com");
                    MM.CC.Add("rajasekar@novatechset.com");
                    break;
                case @"CUP RCP":
                    MM = new MailMessage("rajasekar@novatechset.com", "viji@novatechset.com", sub, msg);
                    MM.CC.Add("kalaivani@novatechset.com");
                    MM.CC.Add("tiworkflow@novatechset.com");
                    MM.CC.Add("rajasekar@novatechset.com");
                    break;
                case @"CUP PM":
                    if (error) { MM = new MailMessage("automailer@novatechset.com", "tiworkflow@novatechset.com", sub, msg); }
                    else
                    {
                        MM = new MailMessage("rajasekar@novatechset.com", "cambridgeproduction@novatechset.com", sub, msg);
                        MM.To.Add("tiworkflow@novatechset.com");
                        ////MM.To.Add("sabisheka@novatechset.com");
                        //// MM.To.Add("abdulk@novatechset.com");
                        ////MM.To.Add("selvakumar@novatechset.com");
                        ////MM.To.Add("muniasamy@novatechset.com");
                        ////MM.To.Add("sgayathree@novatechset.com");
                        MM.To.Add("kalaivani@novatechset.com");
                        ////MM.To.Add("rahul@novatechset.com");
                        MM.To.Add("rajeshkannah@novatechset.com");
                        MM.To.Add("cup_firstproof@novatechset.com");
                        MM.To.Add("cup_revises@novatechset.com");
                        MM.To.Add("viji@novatechset.com");
                        MM.To.Add("PM_CUP@novatechset.com");
                        MM.To.Add("CUP_mastercopier@novatechset.com");
                    }
                    break;
                case @"ERS":
                case @"GSLR":
                    // if (sub == "") 
                    MM = new MailMessage("automailer@novatechset.com", "dataconversion@novatechset.com", pub.Replace("GSLR", "GSL") + ": " + stage + " Booking Status for " + AID + ": Success", msg);
                    //else MM = new MailMessage("automailer@novatechset.com", "parthiban@novatechset.com", sub, msg);
                    //MM.CC.Add("tiworkflow@novatechset.com");
                    //MM.CC.Add("saravanakumar@novatechset.com");
                    break;
                default:
                    if (sub == "") MM = new MailMessage("automailer@novatechset.com", "tiworkflow@novatechset.com", pub + ": " + stage + " Booking Status for " + AID + ": Success", msg);
                    else MM = new MailMessage("automailer@novatechset.com", "tiworkflow@novatechset.com", sub, msg);
                    //MM.CC.Add("parthiban@novatechset.com");
                    //MM.CC.Add("saravanakumar@novatechset.com");
                    break;
            }
            if (error)
            {
                MM.Subject = MM.Subject.Replace(": Success", ": Failure");
                //MM.CC.Add("rajasekar@novatechset.com");
                MM.CC.Add("tiworkflow@novatechset.com");
                if (pub == "AIP")
                {
                    MM.To.Add("rajeshkannah@novatechset.com");
                    MM.To.Add("AIPP-Productionteam@novatechset.com");
                }
                if (pub == "SAGE")
                {
                    //MM.CC.Add("rajeshkannah@novatechset.com");
                    if (!MM.CC.ToString().Contains("sagepub@novatechset.com"))
                        MM.CC.Add("sagepub@novatechset.com");
                    MM.CC.Add("gayathri@novatechset.com");
                }
            }
            //SmtpClient client = new SmtpClient("10.0.1.184");
            SmtpClient client = new SmtpClient(SerializedClass.MailServer);
            MM.IsBodyHtml = true;
            if (attachment1 != "") MM.Attachments.Add(new Attachment(attachment1));
            try
            {
                client.Send(MM);
            }
            catch (Exception ex) { SaveToReport(ex.Message + ex.StackTrace); }
        }
        //***
        public DateTime CalculateAIPExpFromTIDt(string pub, DBClass db, DateTime ddate)
        {
            int tat = 1;
            switch (pub)
            {

                case @"VeruScript":
                    tat = 10;
                    break;
                case @"ASCE":
                    tat = 5;
                    break;
                default:
                    break;
            }
            ArrayList alist = new ArrayList();
            //db.OpenConnection();
            //db.Sqladptr = new SqlDataAdapter(new SqlCommand("SELECT CONVERT(date,Leave_Date) leavedt FROM Holidays where YEAR(Leave_Date)=YEAR(GETDATE())", db.GetConnection()));
            db.Sqladptr = new SqlDataAdapter(new SqlCommand("SELECT CONVERT(date,Leave_Date) leavedt FROM Holidays where YEAR(Leave_Date)=YEAR(GETDATE()) or YEAR(Leave_Date)=YEAR(GETDATE())+1", db.GetConnection()));
            db.dt = new DataTable();
            db.Sqladptr.Fill(db.dt);
            db.CloseConnection();
            for (int i = 0; i < db.dt.Rows.Count; i++)
            {
                alist.Add(Convert.ToDateTime(db.dt.Rows[i]["leavedt"]).ToString("yyyy-MM-dd"));
            }
            for (int i = 1; i <= tat; i++)
            {
                do
                {
                    ddate = ddate.AddDays(-1);
                }
                while (ddate.DayOfWeek == DayOfWeek.Saturday || ddate.DayOfWeek == DayOfWeek.Sunday || alist.Contains(ddate.Date.ToString("yyyy-MM-dd")));
            }
            return ddate;

        }
        public DateTime CalculateDueDate(string pub, DBClass db, DateTime ddate, int tat = 0)
        {
            //int tat = 0;
            //DateTime ddate = DateTime.Today;
            switch (pub)
            {

                case @"VeruScript":
                    tat = 10;
                    break;
                case @"ASCE":
                    tat = 5;
                    break;
                case @"APS":
                    tat = 6;
                    break;
                default:
                    break;
            }
            ArrayList alist = new ArrayList();
            //db.OpenConnection();
            //db.Sqladptr = new SqlDataAdapter(new SqlCommand("SELECT CONVERT(date,Leave_Date) leavedt FROM Holidays where YEAR(Leave_Date)=YEAR(GETDATE())", db.GetConnection()));
            db.Sqladptr = new SqlDataAdapter(new SqlCommand("SELECT CONVERT(date,Leave_Date) leavedt FROM Holidays where YEAR(Leave_Date)=YEAR(GETDATE()) or YEAR(Leave_Date)=YEAR(GETDATE())+1", db.GetConnection()));

            db.dt = new DataTable();
            db.Sqladptr.Fill(db.dt);
            db.CloseConnection();
            for (int i = 0; i < db.dt.Rows.Count; i++)
            {
                alist.Add(Convert.ToDateTime(db.dt.Rows[i]["leavedt"]).ToString("yyyy-MM-dd"));
            }
            if (pub == "ASME")
            {
                //US holidays
                try
                {
                    db.Sqladptr = new SqlDataAdapter(new SqlCommand("SELECT CONVERT(date,Leave_Date) leavedt FROM UkHolidays where (YEAR(Leave_Date)=YEAR(GETDATE()) or YEAR(Leave_Date)=YEAR(GETDATE())+1) and LeaveForUS='1'", db.GetConnection()));
                    db.dt = new DataTable();
                    db.Sqladptr.Fill(db.dt);
                    db.CloseConnection();
                    for (int i = 0; i < db.dt.Rows.Count; i++)
                    {
                        if (!alist.Contains(Convert.ToDateTime(db.dt.Rows[i]["leavedt"]).ToString("yyyy-MM-dd")))
                        {
                            alist.Add(Convert.ToDateTime(db.dt.Rows[i]["leavedt"]).ToString("yyyy-MM-dd"));
                        }
                    }
                }
                catch (Exception e) { }
                while (ddate.DayOfWeek == DayOfWeek.Saturday || ddate.DayOfWeek == DayOfWeek.Sunday || alist.Contains(ddate.Date.ToString("yyyy-MM-dd")))
                {
                    ddate = ddate.AddDays(1);
                }
            }
            while (ddate.DayOfWeek == DayOfWeek.Saturday || ddate.DayOfWeek == DayOfWeek.Sunday)
            {
                ddate = ddate.AddDays(1);
            }
            for (int i = 1; i <= tat; i++)
            {
                do
                {
                    ddate = ddate.AddDays(1);
                }
                while (ddate.DayOfWeek == DayOfWeek.Saturday || ddate.DayOfWeek == DayOfWeek.Sunday || alist.Contains(ddate.Date.ToString("yyyy-MM-dd")));
            }
            if (tat == 0)
            {
                while (ddate.DayOfWeek == DayOfWeek.Saturday || ddate.DayOfWeek == DayOfWeek.Sunday || alist.Contains(ddate.Date.ToString("yyyy-MM-dd")))
                {
                    ddate = ddate.AddDays(1);
                }
            }
            return ddate;

        }
        //***
        public int ReturnDays(DateTime sdate, DBClass db, DateTime edate)
        {
            int days = 0;
            ArrayList alist = new ArrayList();
            //db.Sqladptr = new SqlDataAdapter(new SqlCommand("SELECT CONVERT(date,Leave_Date) leavedt FROM Holidays where YEAR(Leave_Date)=YEAR(GETDATE())", db.GetConnection()));
            db.Sqladptr = new SqlDataAdapter(new SqlCommand("SELECT CONVERT(date,Leave_Date) leavedt FROM Holidays where YEAR(Leave_Date)=YEAR(GETDATE()) or YEAR(Leave_Date)=YEAR(GETDATE())+1", db.GetConnection()));
            db.dt = new DataTable();
            db.Sqladptr.Fill(db.dt);
            db.CloseConnection();
            for (int i = 0; i < db.dt.Rows.Count; i++)
            {
                alist.Add(Convert.ToDateTime(db.dt.Rows[i]["leavedt"]).ToString("yyyy-MM-dd"));
            }
            int tat = (edate - sdate).Days + 1;
            for (int i = 1; i <= tat; i++)
            {
                sdate = sdate.AddDays(1);
                if (sdate.DayOfWeek != DayOfWeek.Saturday && sdate.DayOfWeek != DayOfWeek.Sunday && !alist.Contains(sdate.Date.ToString("yyyy-MM-dd")))
                {
                    days++;
                }
            }
            return days;

        }
        //***
        public DateTime AddDays(DateTime sdate, DBClass db, int days)
        {
            ArrayList alist = new ArrayList();
            //db.Sqladptr = new SqlDataAdapter(new SqlCommand("SELECT CONVERT(date,Leave_Date) leavedt FROM Holidays where YEAR(Leave_Date)=YEAR(GETDATE())", db.GetConnection()));
            db.Sqladptr = new SqlDataAdapter(new SqlCommand("SELECT CONVERT(date,Leave_Date) leavedt FROM Holidays where YEAR(Leave_Date)=YEAR(GETDATE()) or YEAR(Leave_Date)=YEAR(GETDATE())+1", db.GetConnection()));
            db.dt = new DataTable();
            db.Sqladptr.Fill(db.dt);
            db.CloseConnection();
            for (int i = 0; i < db.dt.Rows.Count; i++)
            {
                alist.Add(Convert.ToDateTime(db.dt.Rows[i]["leavedt"]).ToString("yyyy-MM-dd"));
            }
            while (days != 0)
            {
                //sdate = sdate.AddDays(1);
                //if (sdate.DayOfWeek == DayOfWeek.Saturday || sdate.DayOfWeek == DayOfWeek.Sunday || alist.Contains(sdate.Date.ToString("yyyy-MM-dd")))
                //{
                //    sdate = sdate.AddDays(1);
                //}
                //else days--;  
                sdate = sdate.AddDays(1);
                if (sdate.DayOfWeek != DayOfWeek.Saturday && sdate.DayOfWeek != DayOfWeek.Sunday && !alist.Contains(sdate.Date.ToString("yyyy-MM-dd")))
                {
                    days--;
                }
            }
            return sdate;

        }
        //***
        public void SaveToReport(string ErrorData, string watch = "")
        {
            string loc = SerializedClass.CurrentLocation1;
            if (watch != "") loc = watch;
            string ErrorData1 = "";
            try
            {
                //string Logname = SerializedClass.Date + @".htm";
                //if (Directory.Exists(loc+ @"\Logs\" + SerializedClass.month) == false)
                //{
                //    Directory.CreateDirectory(loc + @"\Logs\" + SerializedClass.month);
                //}
                //if (File.Exists(loc + @"\Logs\" + SerializedClass.month + @"\" + Logname))
                //{
                //    ErrorData1 = File.ReadAllText(loc + @"\Logs\" + SerializedClass.month + @"\" + Logname);
                //    ErrorData1 = ErrorData1.Replace("</Table>", "");
                //}
                string Logname = SerializedClass.ErrDate + @".htm";
                if (Directory.Exists(loc + @"\Logs\") == false)
                {
                    Directory.CreateDirectory(loc + @"\Logs\");
                }
                if (File.Exists(loc + @"\Logs\" + Logname))
                {
                    ErrorData1 = File.ReadAllText(loc + @"\Logs\" + Logname);
                    ErrorData1 = ErrorData1.Replace("</Table>", "");
                }
                else
                {
                    ErrorData1 = ErrorData1 + "<Table width=100% Border=1 BorderColor=black Cellspacing=0><TR><TD align=center width=100% colspan=3><Font Face=Calibri Size=3 color=orange><B>Auto Report Tool</TD></TR><TR><TD align=center width=10%><Font Face=Calibri Size=3 color=orange><B>Date</TD><TD align=center width=15%><Font Face=Calibri Size=3 color=orange><B>&nbsp;&nbsp;&nbsp;&nbsp;Time&nbsp;&nbsp;</TD><TD align=center><B><Font Face=Calibri Size=3 color=orange>Message</TD></TR>";
                }
                if (ErrorData.Contains("Status:"))
                {
                    ErrorData1 = ErrorData1 + "<TR><TD style='padding-bottom:10px;'><Font Face=Calibri Size=3 color=blue>" + DateTime.Today.Day.ToString() + @"." + DateTime.Today.Month.ToString() + @"." + DateTime.Today.Year.ToString() + @"</TD><TD style='padding-bottom:10px;'><Font Face=Calibri Size=3 color=blue>" + DateTime.Now.ToLongTimeString() + @"&nbsp;</TD><TD style='padding-bottom:10px;'><Font Face=Calibri Size=3 color=blue>" + ErrorData + @"</TD></TR></Table>";
                }
                else if (ErrorData.Contains("Process completed."))
                {
                    ErrorData1 = ErrorData1 + "<TR><TD style='padding-bottom:10px;'><Font Face=Calibri Size=3 color=green>" + DateTime.Today.Day.ToString() + @"." + DateTime.Today.Month.ToString() + @"." + DateTime.Today.Year.ToString() + @"</TD><TD style='padding-bottom:10px;'><Font Face=Calibri Size=3 color=green>" + DateTime.Now.ToLongTimeString() + @"&nbsp;</TD><TD style='padding-bottom:10px;'><Font Face=Calibri Size=3 color=green>" + ErrorData + @"</TD></TR></Table>";
                }
                else
                {
                    ErrorData1 = ErrorData1 + "<TR><TD style='padding-bottom:10px;'><Font Face=Calibri Size=3 color=red>" + DateTime.Today.Day.ToString() + @"." + DateTime.Today.Month.ToString() + @"." + DateTime.Today.Year.ToString() + @"</TD><TD style='padding-bottom:10px;'><Font Face=Calibri Size=3 color=red>" + DateTime.Now.ToLongTimeString() + @"&nbsp;</TD><TD style='padding-bottom:10px;'><Font Face=Calibri Size=3 color=red>" + ErrorData + @"</TD></TR></Table>";
                }

                File.WriteAllText(loc + @"\Logs\" + Logname, ErrorData1);

            }
            catch (Exception e) { }

        }

        public static void CopyFilesRecursively(DirectoryInfo source, DirectoryInfo target)
        {
            foreach (DirectoryInfo dir in source.GetDirectories())
                CopyFilesRecursively(dir, target.CreateSubdirectory(dir.Name));
            foreach (FileInfo file in source.GetFiles())
                file.CopyTo(Path.Combine(target.FullName, file.Name), true);
        }

        public void DownloadSAGEEmail_old()
        {
            Zipname = "SAGE_Mail_Download";
            if (!Directory.Exists(Environment.CurrentDirectory + @"\Emails\Sage")) Directory.CreateDirectory(Environment.CurrentDirectory + @"\Emails\Sage");
            string corrfolder = Environment.CurrentDirectory + @"\Emails\Sage\";
            try
            {
                OpenPop.Pop3.Pop3Client pop = new OpenPop.Pop3.Pop3Client();
                pop.Connect("pop3.live.com", 995, true);
                //pop.Authenticate("parthiban@novatechset.com", "Parthi#2710");
                pop.Authenticate("tsautosage@novatechset.com", "Raw93364");
                for (int i = 1; i <= pop.GetMessageCount(); i++)
                {
                    string sub = pop.GetMessage(i).Headers.Subject.ToString();
                    try
                    {
                        string Aid = sub.Split(' ')[sub.Split(' ').Length - 1].Trim();
                        Zipname = Aid;
                        if (!Regex.IsMatch(Aid.ToUpper(), @"^[A-Z]+\d+$")) { Aid = Regex.Match(sub.ToUpper(), @"( |^)([A-Z]+\d+)( |$)").Groups[2].Value; }
                        //if (sub.Contains("Page proofs for Journal of Proceedings of the Institution of Mechanical Engineers, Part J: Journal of Engineering Tribology PIJ") && Aid != "" && CheckWhetherFileBooked(Aid))
                        if (sub.Contains("SMART Journals XML Importer run - "))
                        {
                            DBClass Db = new DBClass();
                            string doi = Regex.Match(sub, @" DOI(:)?\s*([\.\/0-9]+)").Groups[2].Value;
                            string msg = "";
                            try
                            {
                                msg = pop.GetMessage(i).FindFirstPlainTextVersion().GetBodyAsText();
                            }
                            catch (Exception e1)
                            {
                                if (msg == "")
                                {
                                    msg = pop.GetMessage(i).FindFirstHtmlVersion().GetBodyAsText();
                                }
                            }
                            Aid = Regex.Match(msg, @"Inserted article as ID: (\d+)").Groups[1].Value;
                            //if (Regex.IsMatch(msg, "Journal Title: (<[^<>]*>)*Proceedings of the Institution of Mechanical Engineers, Part J: Journal of Engineering Tribology", RegexOptions.IgnoreCase)) Aid = "PIJ" + Aid;
                            //if (Regex.IsMatch(msg, "Journal Title: (<[^<>]*>)*International Journal of Surgical Pathology", RegexOptions.IgnoreCase)) Aid = "IJSP" + Aid;
                            Aid = ReturnDetail("Artcl_ArticleId", "Article", Db, "Artcl_JrnlId in (select Jrnl_Id from Journal where Jrnl_PublID='4') and Artcl_ArticleId like'%" + Aid + "'");
                            if (doi != "" && Aid != "" && CheckWhetherFileBooked(Aid))
                            {
                                string Query = @"UPDATE article SET Artcl_doi='" + doi + "' Where Artcl_ArticleId='" + Aid + "'";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                SaveToReport("Status: " + Query + " " + Aid);
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + Aid + "_DOI.eml"));
                                pop.DeleteMessage(i);
                                SendMail(Aid, "Dear Team,<Br/><Br/>SAGE DOI updated: Article ID:" + Aid + "<Br/>DOI:" + doi + "<Br/>", "SAGE", false, "SAGE DOI update", Aid);
                            }
                            else
                            {
                                try
                                {
                                    pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "").Replace("/", "") + ".eml"));
                                }
                                catch (Exception ee)
                                {
                                    SaveToReport("Error while SAGE DOI update:  " + ee.Message + @"\n" + sub);
                                    pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + Aid + "_DOI.eml"));
                                }
                                pop.DeleteMessage(i);
                                SendMail(Aid, "Dear Team,<Br/><Br/>SAGE DOI update error: <Br/>Article not found in DB or DOI or id not found <Br/>" + sub + "<Br/>Article ID:" + Aid + "<Br/>DOI:" + doi + "<Br/>", "SAGE", true, "SAGE DOI update", Zipname);
                                SaveToReport("Error while SAGE DOI update:  " + Aid + @"\n" + sub);
                            }
                        }
                        else if (Aid != "" && CheckWhetherFileBooked(Aid))
                        {
                            DBClass Db = new DBClass();
                            string stage, jacro = Regex.Match(Aid.ToUpper(), @"^(([A-Z]*?)+)\d+$").Groups[1].Value;
                            //{
                            Zipname = Aid;
                            //string sche = AddDays(DateTime.Today, Db, 3).ToString("MM/dd/yyyy");
                            //string intdt1 = AddDays(DateTime.Today, Db, 2).ToString("MM/dd/yyyy"); ;
                            DateTime dt = DateTime.Today;
                            if (dt.DayOfWeek == DayOfWeek.Sunday) dt = dt.AddDays(1);
                            string sche = AddDays(dt, Db, 3).ToString("MM/dd/yyyy");
                            string intdt1 = AddDays(dt, Db, 2).ToString("MM/dd/yyyy");
                            stage = "Author Correction";
                            string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                            if (uploaddate == "")
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "SAGE", true, stage, Zipname);
                                SaveToReport("Artcl_UploadedDt not updated " + Path.GetFileName(Zipname));
                                continue;
                            }
                            corrfolder = Environment.CurrentDirectory + @"\Emails\Sage\";
                            //if (!Directory.Exists(corrfolder)) Directory.Delete(corrfolder, true);
                            if (!Directory.Exists(corrfolder)) Directory.CreateDirectory(corrfolder);
                            try
                            {
                                pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                            }
                            catch (Exception ee)
                            {
                                SaveToReport("Error while correction mail save:  " + ee.Message + @"\n" + sub);
                                pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + Aid + "_Correction.eml"));
                            }
                            SaveToReport("Status: Author Correction update JR_Main Table file: " + Path.GetFileName(Zipname));
                            string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + jacro + "' AND Jrnl_PublID='4'");
                            string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                            string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                            if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                            {
                                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                            }
                            JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                            JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                            string JRA_ID = "";
                            string id = "", stageid = "", AUTUStatus = "97";
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=36") != "")
                                {
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=37") != "")
                                    {
                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=78") != "")
                                        {
                                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=97") != "")
                                            {
                                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=98") != "")
                                                {
                                                    SaveToReport("Unclosed stage Author Correction 5: booked as additional correction. " + Path.GetFileName(Zipname));
                                                    corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction 5\Additional_correction\" + Aid + @"\";
                                                    if (!Directory.Exists(corrfolder)) Directory.CreateDirectory(corrfolder);
                                                    //pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                                                    try
                                                    {
                                                        pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                                                    }
                                                    catch (Exception ee)
                                                    {
                                                        SaveToReport("Error while correction mail save:  " + ee.Message + @"\n" + sub);
                                                        pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + Aid + "_Correction.eml"));
                                                    }
                                                    for (int j = 0; j < pop.GetMessage(i).FindAllAttachments().ToList().Count; j++)
                                                    {
                                                        //pop.GetMessage(i).FindAllAttachments().ToList()[j].Save(new System.IO.FileInfo(corrfolder + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName));
                                                        try
                                                        {
                                                            pop.GetMessage(i).FindAllAttachments().ToList()[j].Save(new System.IO.FileInfo(corrfolder + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName));
                                                        }
                                                        catch (Exception ee)
                                                        {
                                                            SaveToReport("Error while attachment save:  " + ee.Message + @"\n" + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName);
                                                        }
                                                    }
                                                    pop.DeleteMessage(i);
                                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 5. Kindly check for additional corrections from Additional_correction folder.", "SAGE", true, "Additional_Correction", Zipname);
                                                    continue;
                                                }
                                                else
                                                {
                                                    // AU Correction 5
                                                    stage = "AU Correction 5";
                                                    id = "5"; stageid = "98";
                                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=97 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                                    {
                                                        SaveToReport("Unclosed stage Author Correction 4: booked as additional correction. " + Path.GetFileName(Zipname));
                                                        corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction 4\Additional_correction\" + Aid + @"\";
                                                        if (!Directory.Exists(corrfolder)) Directory.CreateDirectory(corrfolder);
                                                        //pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                                                        try
                                                        {
                                                            pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                                                        }
                                                        catch (Exception ee)
                                                        {
                                                            SaveToReport("Error while correction mail save:  " + ee.Message + @"\n" + sub);
                                                            pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + Aid + "_Correction.eml"));
                                                        }
                                                        for (int j = 0; j < pop.GetMessage(i).FindAllAttachments().ToList().Count; j++)
                                                        {
                                                            //pop.GetMessage(i).FindAllAttachments().ToList()[j].Save(new System.IO.FileInfo(corrfolder + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName));
                                                            try
                                                            {
                                                                pop.GetMessage(i).FindAllAttachments().ToList()[j].Save(new System.IO.FileInfo(corrfolder + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName));
                                                            }
                                                            catch (Exception ee)
                                                            {
                                                                SaveToReport("Error while attachment save:  " + ee.Message + @"\n" + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName);
                                                            }
                                                        }
                                                        pop.DeleteMessage(i);
                                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 4. Kindly check for additional corrections from Additional_correction folder.", "SAGE", true, "Additional_Correction", Zipname);
                                                        continue;
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                // AU Correction 4
                                                stage = "AU Correction 4";
                                                id = "4"; stageid = "97";
                                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=78 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                                {
                                                    SaveToReport("Unclosed stage Author Correction 3: booked as additional correction. " + Path.GetFileName(Zipname));
                                                    corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction 3\Additional_correction\" + Aid + @"\";
                                                    if (!Directory.Exists(corrfolder)) Directory.CreateDirectory(corrfolder);
                                                    //pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                                                    try
                                                    {
                                                        pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                                                    }
                                                    catch (Exception ee)
                                                    {
                                                        SaveToReport("Error while correction mail save:  " + ee.Message + @"\n" + sub);
                                                        pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + Aid + "_Correction.eml"));
                                                    }
                                                    for (int j = 0; j < pop.GetMessage(i).FindAllAttachments().ToList().Count; j++)
                                                    {
                                                        //pop.GetMessage(i).FindAllAttachments().ToList()[j].Save(new System.IO.FileInfo(corrfolder + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName));
                                                        try
                                                        {
                                                            pop.GetMessage(i).FindAllAttachments().ToList()[j].Save(new System.IO.FileInfo(corrfolder + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName));
                                                        }
                                                        catch (Exception ee)
                                                        {
                                                            SaveToReport("Error while attachment save:  " + ee.Message + @"\n" + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName);
                                                        }
                                                    }
                                                    pop.DeleteMessage(i);
                                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 3. Kindly check for additional corrections from Additional_correction folder.", "SAGE", true, "Additional_Correction", Zipname);
                                                    continue;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            // AU Correction 3
                                            stage = "AU Correction 3";
                                            id = "3"; stageid = "78";
                                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=37 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                            {
                                                SaveToReport("Unclosed stage Author Correction 2: booked as additional correction. " + Path.GetFileName(Zipname));
                                                corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction 2\Additional_correction\" + Aid + @"\";
                                                if (!Directory.Exists(corrfolder)) Directory.CreateDirectory(corrfolder);
                                                //pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                                                try
                                                {
                                                    pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                                                }
                                                catch (Exception ee)
                                                {
                                                    SaveToReport("Error while correction mail save:  " + ee.Message + @"\n" + sub);
                                                    pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + Aid + "_Correction.eml"));
                                                }
                                                for (int j = 0; j < pop.GetMessage(i).FindAllAttachments().ToList().Count; j++)
                                                {
                                                    //pop.GetMessage(i).FindAllAttachments().ToList()[j].Save(new System.IO.FileInfo(corrfolder + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName));
                                                    try
                                                    {
                                                        pop.GetMessage(i).FindAllAttachments().ToList()[j].Save(new System.IO.FileInfo(corrfolder + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName));
                                                    }
                                                    catch (Exception ee)
                                                    {
                                                        SaveToReport("Error while attachment save:  " + ee.Message + @"\n" + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName);
                                                    }
                                                }
                                                pop.DeleteMessage(i);
                                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 2. Kindly check for additional corrections from Additional_correction folder.", "SAGE", true, "Additional_Correction", Zipname);
                                                continue;
                                            }
                                        }
                                    }
                                    else
                                    {
                                        // AU Correction 3
                                        stage = "AU Correction 2";
                                        id = "2"; stageid = "37";
                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=36 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                        {
                                            SaveToReport("Unclosed stage Author Correction 1: booked as additional correction. " + Path.GetFileName(Zipname));
                                            corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction 1\Additional_correction\" + Aid + @"\";
                                            if (!Directory.Exists(corrfolder)) Directory.CreateDirectory(corrfolder);
                                            //pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                                            try
                                            {
                                                pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                                            }
                                            catch (Exception ee)
                                            {
                                                SaveToReport("Error while correction mail save:  " + ee.Message + @"\n" + sub);
                                                pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + Aid + "_Correction.eml"));
                                            }
                                            for (int j = 0; j < pop.GetMessage(i).FindAllAttachments().ToList().Count; j++)
                                            {
                                                //pop.GetMessage(i).FindAllAttachments().ToList()[j].Save(new System.IO.FileInfo(corrfolder + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName));
                                                try
                                                {
                                                    pop.GetMessage(i).FindAllAttachments().ToList()[j].Save(new System.IO.FileInfo(corrfolder + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName));
                                                }
                                                catch (Exception ee)
                                                {
                                                    SaveToReport("Error while attachment save:  " + ee.Message + @"\n" + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName);
                                                }
                                            }
                                            pop.DeleteMessage(i);
                                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 1. Kindly check for additional corrections from Additional_correction folder.", "SAGE", true, "Additional_Correction", Zipname);
                                            continue;
                                        }
                                    }
                                }
                                else
                                {
                                    stage = "AU Correction 1";
                                    id = "1"; stageid = "36";
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                    {
                                        SaveToReport("Unclosed stage Author Correction: booked as additional correction. " + Path.GetFileName(Zipname));
                                        corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\Additional_correction\" + Aid + @"\";
                                        if (!Directory.Exists(corrfolder)) Directory.CreateDirectory(corrfolder);
                                        //pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                                        try
                                        {
                                            pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                                        }
                                        catch (Exception ee)
                                        {
                                            SaveToReport("Error while correction mail save:  " + ee.Message + @"\n" + sub);
                                            pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + Aid + "_Correction.eml"));
                                        }

                                        for (int j = 0; j < pop.GetMessage(i).FindAllAttachments().ToList().Count; j++)
                                        {
                                            //pop.GetMessage(i).FindAllAttachments().ToList()[j].Save(new System.IO.FileInfo(corrfolder + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName));
                                            try
                                            {
                                                pop.GetMessage(i).FindAllAttachments().ToList()[j].Save(new System.IO.FileInfo(corrfolder + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName));
                                            }
                                            catch (Exception ee)
                                            {
                                                SaveToReport("Error while attachment save:  " + ee.Message + @"\n" + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName);
                                            }
                                        }
                                        pop.DeleteMessage(i);
                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction. Kindly check for additional corrections from Additional_correction folder.", "SAGE", true, "Additional_Correction", Zipname);
                                        continue;
                                    }
                                }
                            }
                            else
                            {
                                stage = "AU Correction";
                                id = ""; stageid = "35";
                            }

                            //if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35") != "")
                            //{
                            //    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for AU Correction stage: ", "SAGE", true, stage, Zipname);
                            //    SaveToReport("File already booked for AU Correction: " + Path.GetFileName(Zipname));
                            //    continue;
                            //}
                            //else
                            //{
                            //    stage = "AU Correction";
                            //    id = ""; stageid = "35";
                            //}
                            SaveToReport("Status: Author Correction " + id + " update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                            string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                            Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stageid + "','" + sche + "',getdate(),'" + intdt1 + "','" + intdt1 + "','" + AUTUStatus + "',getdate(),'1','','" + Path.GetFileNameWithoutExtension(Zipname) + "','0')";
                            SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: " + Query);
                            SaveToReport("Status: Author Correction " + id + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                            //JR_Articles 
                            JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                            Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stageid + "',getdate(),'1','0')";
                            SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: " + Query);
                            SaveToReport("Status: Author Correction " + id + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                            //TrnsJournalRev 
                            Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                            SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: " + Query);
                            if (id == "")
                            {
                                Query = @"UPDATE article SET Artcl_AUCorr_RecDT=getdate() Where Artcl_ArticleId='" + Aid + "'";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                            }
                            SaveToReport("Status: Upload files to Author Correction " + id + " file: " + Path.GetFileName(Zipname));
                            //CreateTxtfile(Zipname, Aid, jacro, "SAGE", "AC" + id);   
                            corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\" + Aid + @"\";
                            if (id != "") corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction " + id + @"\" + Aid + @"\";
                            if (!Directory.Exists(corrfolder)) Directory.CreateDirectory(corrfolder);
                            //pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                            try
                            {
                                pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                            }
                            catch (Exception ee)
                            {
                                SaveToReport("Error while correction mail save:  " + ee.Message + @"\n" + sub);
                                pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + Aid + "_Correction.eml"));
                            }

                            for (int j = 0; j < pop.GetMessage(i).FindAllAttachments().ToList().Count; j++)
                            {
                                //pop.GetMessage(i).FindAllAttachments().ToList()[j].Save(new System.IO.FileInfo(corrfolder + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName));
                                try
                                {
                                    pop.GetMessage(i).FindAllAttachments().ToList()[j].Save(new System.IO.FileInfo(corrfolder + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName));
                                }
                                catch (Exception ee)
                                {
                                    SaveToReport("Error while attachment save:  " + ee.Message + @"\n" + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName);
                                }
                            }

                            //}
                            pop.DeleteMessage(i);
                            //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "SAGE", false, stage);
                            SaveToReport("Process completed. File: " + Aid);
                        }
                        else
                        {
                            //pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                            try
                            {
                                pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                            }
                            catch (Exception ee)
                            {
                                SaveToReport("Error while correction mail save:  " + ee.Message + @"\n" + sub);
                                pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + Aid + "_Correction or Doi.eml"));
                            }
                            pop.DeleteMessage(i);
                            SendMail(Aid, "Dear Team,<Br/><Br/>Subject line not matched for SAGE correction booking or DOI update. <Br/>" + sub + "<Br/>", "SAGE", true, "Correction/SAGE DOI update", Zipname);
                            SaveToReport("Subject line not matched for SAGE correction booking or DOI update.:  " + @"\n" + sub);
                        }
                    }
                    catch (Exception e)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking SAGE correction: <Br/>" + e.Message + "<Br/>" + e.StackTrace, "SAGE", true, "Correction", Zipname);
                        SaveToReport("Error while booking SAGE correction:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                    }

                }
                pop.Disconnect();
            }
            catch (Exception e)
            {
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking SAGE correction: <Br/>" + e.Message + "<Br/>" + e.StackTrace, "", true, "Correction", Zipname);
                SaveToReport("Error while booking SAGE correction:  " + e.Message + @"\n" + e.StackTrace);
            }
        }
        public void DownloadSAGEEmailNew()
        {
            Zipname = "SAGE_Mail_Download";
            if (!Directory.Exists(Environment.CurrentDirectory + @"\Emails\Sage")) Directory.CreateDirectory(Environment.CurrentDirectory + @"\Emails\Sage");
            string corrfolder = Environment.CurrentDirectory + @"\Emails\Sage\";
            try
            {
                DBClass Db = new DBClass();
                string Q = "SELECT * FROM HandShakeEmail_Sage INNER JOIN Article ON Artcl_ManuScriptID=ManuscriptNumber INNER JOIN Journal ON Jrnl_Id=Artcl_JrnlId WHERE Isupdated=0";
                Db.Sqladptr = new SqlDataAdapter(new SqlCommand(Q, Db.GetConnection()));
                Db.dt = new DataTable();
                Db.Sqladptr.Fill(Db.dt);
                Db.CloseConnection();
                DataSet ds = new DataSet("New_DataSet");
                ds.Tables.Add(Db.dt);
                var rows = ds.Tables[0].Rows;
                for (int j = 0; j < rows.Count; j++)
                {
                    if (File.Exists(rows[j]["FilePath"].ToString()))
                    {
                        string Aid = rows[j]["Articleid"].ToString();

                    }
                }
            }
            catch (Exception e)
            {
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking SAGE correction: <Br/>" + e.Message + "<Br/>" + e.StackTrace, "", true, "Correction", Zipname);
                SaveToReport("Error while booking SAGE correction:  " + e.Message + @"\n" + e.StackTrace);
            }

        }
        public void DownloadSAGEEmail()
        {
            Zipname = "SAGE_Mail_Download";
            if (!Directory.Exists(Environment.CurrentDirectory + @"\Emails\Sage")) Directory.CreateDirectory(Environment.CurrentDirectory + @"\Emails\Sage");
            string corrfolder = Environment.CurrentDirectory + @"\Emails\Sage\";
            try
            {
                OpenPop.Pop3.Pop3Client pop = new OpenPop.Pop3.Pop3Client();
                try
                {
                    pop.Connect("pop3.live.com", 995, true);
                    //pop.Authenticate("parthiban@novatechset.com", "Parthi#2710");
                    pop.Authenticate("tsautosage@novatechset.com", "Raw93364");
                }
                catch (Exception ed)
                {
                    SaveToReport(ed.Message + @"\n" + ed.StackTrace);
                    return;
                }
                for (int i = 1; i <= pop.GetMessageCount(); i++)
                {
                    string sub = pop.GetMessage(i).Headers.Subject.ToString();
                    string msg = "";
                    try
                    {
                        msg = pop.GetMessage(i).FindFirstHtmlVersion().GetBodyAsText();
                    }
                    catch (Exception e1)
                    {
                        if (msg == "")
                        {
                            try
                            {
                                msg = pop.GetMessage(i).FindFirstPlainTextVersion().GetBodyAsText();
                            }
                            catch (Exception e11)
                            {
                                msg = "";
                            }
                        }
                    }
                    try
                    {
                        string Aid = sub.Replace("ED CXN", "").Replace("AU CXN", "").Replace("-", "").Replace("_", "").Trim().Split(' ')[sub.Replace("ED CXN", "").Replace("AU CXN", "").Replace("-", "").Replace("_", "").Trim().Split(' ').Length - 1].Trim();
                        Zipname = Aid;
                        if (!Regex.IsMatch(Aid.ToUpper(), @"^[A-Z]+\d+$")) { Aid = Regex.Match(sub.Replace("ED CXN", "").Replace("AU CXN", "").Replace("-", "").Replace("_", "").Trim().ToUpper(), @"( |^)([A-Z]+\d+)( |$)").Groups[2].Value; }
                        //if (sub.Contains("Page proofs for Journal of Proceedings of the Institution of Mechanical Engineers, Part J: Journal of Engineering Tribology PIJ") && Aid != "" && CheckWhetherFileBooked(Aid))
                        if (sub.Contains("SMART Journals XML Importer run - "))
                        {
                            DBClass Db = new DBClass();
                            string doi = Regex.Match(sub, @" DOI(:)?\s*([\.\/0-9]+)").Groups[2].Value;
                            Aid = Regex.Match(msg, @"Inserted article as ID: (\d+)").Groups[1].Value;
                            //if (Regex.IsMatch(msg, "Journal Title: (<[^<>]*>)*Proceedings of the Institution of Mechanical Engineers, Part J: Journal of Engineering Tribology", RegexOptions.IgnoreCase)) Aid = "PIJ" + Aid;
                            //if (Regex.IsMatch(msg, "Journal Title: (<[^<>]*>)*International Journal of Surgical Pathology", RegexOptions.IgnoreCase)) Aid = "IJSP" + Aid;
                            Aid = ReturnDetail("Artcl_ArticleId", "Article", Db, "Artcl_JrnlId in (select Jrnl_Id from Journal where Jrnl_PublID='4') and Artcl_ArticleId like'%" + Aid + "'");
                            if (doi != "" && Aid != "" && CheckWhetherFileBooked(Aid))
                            {
                                string Query = @"UPDATE article SET Artcl_doi='" + doi + "' Where Artcl_ArticleId='" + Aid + "'";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                SaveToReport("Status: " + Query + " " + Aid);
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + Aid + "_DOI.eml"));
                                pop.DeleteMessage(i);
                                SendMail(Aid, "Dear Team,<Br/><Br/>SAGE DOI updated: Article ID:" + Aid + "<Br/>DOI:" + doi + "<Br/>", "SAGE", false, "SAGE DOI update", Aid);
                            }
                            else
                            {
                                try
                                {
                                    pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "").Replace("/", "") + ".eml"));
                                }
                                catch (Exception ee)
                                {
                                    SaveToReport("Error while SAGE DOI update:  " + ee.Message + @"\n" + sub);
                                    try
                                    {
                                        pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + Aid + "_DOI.eml"));
                                    }
                                    catch (Exception e11)
                                    {
                                    }
                                }
                                pop.DeleteMessage(i);
                                SendMail(Aid, "Dear Team,<Br/><Br/>SAGE DOI update error: <Br/>Article not found in DB or DOI or id not found <Br/>" + sub + "<Br/>Article ID:" + Aid + "<Br/>DOI:" + doi + "<Br/>", "SAGE", true, "SAGE DOI update", Zipname);
                                SaveToReport("Error while SAGE DOI update:  " + Aid + @"\n" + sub);
                            }
                        }
                        else if (Aid != "" && CheckWhetherFileBooked(Aid))
                        {
                            DBClass Db = new DBClass();
                            string stage, jacro = Regex.Match(Aid.ToUpper(), @"^(([A-Z]*?)+)\d+$").Groups[1].Value;
                            //{
                            Zipname = Aid;
                            //string sche = AddDays(DateTime.Today, Db, 3).ToString("MM/dd/yyyy");
                            //string intdt1 = AddDays(DateTime.Today, Db, 2).ToString("MM/dd/yyyy"); ;                          
                            stage = "AU Correction";
                            string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                            Boolean bookrev = false;
                            string bb = ReturnDetail("ArtType_Name", "Article,ArticleTypes", Db, "ArtType_ID=Artcl_ArtType and Artcl_ArticleId='" + Aid + @"'");
                            if (bb != "" && bb.ToLower().Contains("book") && bb.ToLower().Contains("review")) bookrev = true;
                            if (uploaddate == "")
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "SAGE", true, stage, Zipname);
                                SaveToReport("Artcl_UploadedDt not updated " + Path.GetFileName(Zipname));
                                continue;
                            }
                            corrfolder = Environment.CurrentDirectory + @"\Emails\Sage\";
                            //if (!Directory.Exists(corrfolder)) Directory.Delete(corrfolder, true);
                            if (!Directory.Exists(corrfolder)) Directory.CreateDirectory(corrfolder);
                            try
                            {
                                pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                            }
                            catch (Exception ee)
                            {
                                SaveToReport("Error while correction mail save:  " + ee.Message + @"\n" + sub);
                                try
                                {
                                    pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + Aid + "_Correction.eml"));
                                }
                                catch (Exception e11)
                                {
                                }
                            }
                            SaveToReport("Status: Author Correction update JR_Main Table file: " + Path.GetFileName(Zipname));
                            string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + jacro + "' AND Jrnl_PublID='4'");
                            if (Journalid == "")
                            {
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for " + jacro + ": ", "SAGE", true, stage, Zipname);
                                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + jacro);
                                continue;
                            }
                            string strUploadType = ReturnDetail("Jrnl_UploadTypeNew", "Journal", Db, "Jrnl_Acronym='" + jacro + "' AND Jrnl_PublID='4'");
                            DateTime dt = DateTime.Today;
                            if (dt.DayOfWeek == DayOfWeek.Sunday) dt = dt.AddDays(1);
                            string sche = AddDays(dt, Db, 3).ToString("MM/dd/yyyy");
                            string intdt1 = AddDays(dt, Db, 2).ToString("MM/dd/yyyy");
                            if (jacro.ToUpper() == "FTY")
                            {
                                sche = AddDays(dt, Db, 5).ToString("MM/dd/yyyy");
                                intdt1 = AddDays(dt, Db, 4).ToString("MM/dd/yyyy");
                            }
                            string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                            string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                            if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                            {
                                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                            }
                            JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                            JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                            string JRA_ID = "", JRS_Id = "";
                            string id = "", stageid = "35", AUTUStatus = "97";
                            bool edcorr = false, aucorr = false;
                            if (jacro == "CWS")
                                AUTUStatus = "25";
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                {
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35 and JRST_Status='36' AND isnull(JRST_UploadedDT ,'')=''") != "")
                                    {
                                        //if (Regex.IsMatch(jacro, "^(JTT|TTJ|PEC|JOPON|MRJ|PRB)$"))
                                        if (Regex.IsMatch(jacro, "^(ACR|CHS|CIN|EPE|EUP|IES|INI|IPE|JIR|JOPHON|JTH|JTT|LAH|NAD|NCT|OBM|PEC|PFR|PPN|PRB|PSG|SPO|TBT|TDO|TTJ|EPT|TPS|FTY|LRX|SEL|PWQ)$"))
                                        {
                                            if (sub.Contains("ED CXN"))
                                            {
                                                edcorr = true;
                                            }
                                            else if (sub.Contains("AU CXN"))
                                            {
                                                aucorr = true;
                                            }
                                        }
                                        else if (Regex.IsMatch(jacro, "^(JSW|PSM)$") && !bookrev)
                                        {
                                            edcorr = true;
                                        }
                                        else if (Regex.IsMatch(jacro, "^(RAS|JOM)$"))
                                        {
                                            aucorr = true;
                                        }
                                    }
                                    if (edcorr || aucorr)
                                    {
                                        SaveToReport("Status: Author Correction " + id + " update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                        JRS_Id = ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35");
                                        Query = "update JR_Stage_Tran set JRST_JRS_ID='" + stageid + "', JRST_DueDtCats='" + sche + "', JRST_ReceivedDt=getdate(), JRST_ScheduledDt='" + intdt1 + "',JRST_ExpectedDt='" + intdt1 + "',JRST_Status='" + AUTUStatus + "', LastModifiedDate=getdate() where JRST_ID ='" + JRS_Id + @"'";
                                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: " + Query);
                                        SaveToReport("Status: Author Correction " + id + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                        //JR_Articles 
                                        JRA_ID = ReturnDetail("JRA_ID", "JR_Articles", Db, "JRA_JRST_ID=" + JRS_Id + " AND JRA_StageID=35");
                                        Query = "update JR_Articles set JRA_Status='" + AUTUStatus + @"',LastModifiedDate=getdate() where JRA_ID=" + JRA_ID;
                                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: " + Query);
                                        SaveToReport("Status: Author Correction " + id + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                        //TrnsJournalRev 
                                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + JRA_ID + @"','1','Administration',getdate(),getdate(),'36','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: " + Query);
                                        if (id == "")
                                        {
                                            Query = @"UPDATE article SET Artcl_AUCorr_RecDT=getdate() Where Artcl_ArticleId='" + Aid + "'";
                                            if (edcorr) Query = @"UPDATE article SET Artcl_EDCorr_RecDT=getdate() Where Artcl_ArticleId='" + Aid + "'";
                                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                            SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                            Db.OpenConnection();
                                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                            Db.SqlReader.Close();
                                        }
                                        SaveToReport("Status: Upload files to Author Correction " + id + " file: " + Path.GetFileName(Zipname));
                                        //CreateTxtfile(Zipname, Aid, jacro, "SAGE", "AC" + id);   
                                        corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\" + Aid + @"\";
                                        if (id != "") corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction " + id + @"\" + Aid + @"\";
                                        if (edcorr)
                                        {
                                            corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\ED Correction\" + Aid + @"\";
                                            if (id != "") corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction " + id + @"\ED Correction\" + Aid + @"\";
                                        }
                                        if (!Directory.Exists(corrfolder)) Directory.CreateDirectory(corrfolder);
                                        //pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                                        try
                                        {
                                            pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                                            if (msg != "") File.WriteAllText(corrfolder + Aid + "_Emailbody.htm", msg);
                                        }
                                        catch (Exception ee)
                                        {
                                            SaveToReport("Error while correction mail save:  " + ee.Message + @"\n" + sub);
                                            //pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + Aid + "_Correction.eml"));
                                            try
                                            {
                                                pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + Aid + "_Correction.eml"));
                                            }
                                            catch (Exception e11)
                                            {
                                            }
                                            if (msg != "") File.WriteAllText(corrfolder + Aid + "_Emailbody.htm", msg);
                                        }
                                        try
                                        {
                                            for (int j = 0; j < pop.GetMessage(i).FindAllAttachments().ToList().Count; j++)
                                            {
                                                //pop.GetMessage(i).FindAllAttachments().ToList()[j].Save(new System.IO.FileInfo(corrfolder + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName));
                                                try
                                                {
                                                    pop.GetMessage(i).FindAllAttachments().ToList()[j].Save(new System.IO.FileInfo(corrfolder + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName));
                                                }
                                                catch (Exception ee)
                                                {
                                                    SaveToReport("Error while attachment save:  " + ee.Message + @"\n" + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName);
                                                }
                                            }
                                        }
                                        catch (Exception ee1)
                                        {
                                            SaveToReport("Error while attachment save:  " + ee1.Message);
                                        }
                                        //}
                                        pop.DeleteMessage(i);

                                        //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "SAGE", false, stage);
                                        SaveToReport("Process completed. File: " + Aid);
                                        continue;
                                    }
                                    else
                                    {
                                        SaveToReport("Unclosed stage Author Correction: booked as additional correction. " + Path.GetFileName(Zipname));
                                        corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\Additional_correction\" + Aid + @"\";
                                        if (!Directory.Exists(corrfolder)) Directory.CreateDirectory(corrfolder);
                                        //pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                                        try
                                        {
                                            pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                                            if (msg != "") File.WriteAllText(corrfolder + Aid + "_Emailbody.htm", msg);
                                        }
                                        catch (Exception ee)
                                        {
                                            SaveToReport("Error while correction mail save:  " + ee.Message + @"\n" + sub);
                                            //pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + Aid + "_Correction.eml"));
                                            try
                                            {
                                                pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + Aid + "_Correction.eml"));
                                            }
                                            catch (Exception e11)
                                            {
                                            }
                                            if (msg != "") File.WriteAllText(corrfolder + Aid + "_Emailbody.htm", msg);
                                        }
                                        try
                                        {
                                            for (int j = 0; j < pop.GetMessage(i).FindAllAttachments().ToList().Count; j++)
                                            {
                                                //pop.GetMessage(i).FindAllAttachments().ToList()[j].Save(new System.IO.FileInfo(corrfolder + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName));
                                                try
                                                {
                                                    pop.GetMessage(i).FindAllAttachments().ToList()[j].Save(new System.IO.FileInfo(corrfolder + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName));
                                                }
                                                catch (Exception ee)
                                                {
                                                    SaveToReport("Error while attachment save:  " + ee.Message + @"\n" + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName);
                                                }
                                            }
                                        }
                                        catch (Exception ee1)
                                        {
                                            SaveToReport("Error while attachment save:  " + ee1.Message);
                                        }
                                        pop.DeleteMessage(i);
                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction. Kindly check for additional corrections from Additional_correction folder.", "SAGE", true, "Additional_Correction", Zipname);
                                        continue;
                                    }
                                }
                                else
                                {
                                    pop.DeleteMessage(i);
                                    SaveToReport("Already closed stage Author Correction " + Path.GetFileName(Zipname));
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already closed for Author Correction.", "SAGE", true, stage, Zipname);
                                    continue;
                                }
                            }
                            //else
                            //{
                            //    stage = "AU Correction";
                            //    id = ""; stageid = "35";
                            //}

                            //if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35") != "")
                            //{
                            //    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for AU Correction stage: ", "SAGE", true, stage, Zipname);
                            //    SaveToReport("File already booked for AU Correction: " + Path.GetFileName(Zipname));
                            //    continue;
                            //}
                            //else
                            //{
                            //    stage = "AU Correction";
                            //    id = ""; stageid = "35";
                            //}
                            //if (Regex.IsMatch(jacro, "^(JTT|TTJ|PEC|JOPON|MRJ|PRB)$"))
                            if (Regex.IsMatch(jacro, "^(ACR|CHS|CIN|EPE|EUP|IES|INI|IPE|JIR|JOPHON|JTH|JTT|LAH|NAD|NCT|OBM|PEC|PFR|PPN|PRB|PSG|SPO|TBT|TDO|TTJ|EPT|TPS|FTY|LRX|SEL|PWQ)$"))
                            {
                                if (sub.Contains("ED CXN"))
                                {
                                    edcorr = true;
                                }
                                else if (sub.Contains("AU CXN"))
                                {
                                    aucorr = true;
                                }
                                AUTUStatus = "36";
                            }
                            else if (Regex.IsMatch(jacro, "^(JSW|PSM|LRX)$") && !bookrev)
                            {
                                edcorr = true;
                                AUTUStatus = "36";
                            }
                            else if (Regex.IsMatch(jacro, "^(RAS|JOM)$"))
                            {
                                aucorr = true;
                                AUTUStatus = "36";
                            }
                            //if (jacro == "SEL")
                            //    strUploadType = "PartialEPT";
                            if (strUploadType != "EPT")
                            {
                                SaveToReport("Status: Author Correction " + id + " update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stageid + "','" + sche + "',getdate(),'" + intdt1 + "','" + intdt1 + "','" + AUTUStatus + "',getdate(),'1','','" + Path.GetFileNameWithoutExtension(Zipname) + "','0')";
                                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: " + Query);
                                SaveToReport("Status: Author Correction " + id + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                //JR_Articles 
                                JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stageid + "',getdate(),'1','0')";
                                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: " + Query);
                                SaveToReport("Status: Author Correction " + id + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                //TrnsJournalRev 
                                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: " + Query);
                            }
                            if (id == "")
                            {
                                Query = @"UPDATE article SET Artcl_AUCorr_RecDT=getdate() Where Artcl_ArticleId='" + Aid + "'";
                                if (edcorr) Query = @"UPDATE article SET Artcl_EDCorr_RecDT=getdate() Where Artcl_ArticleId='" + Aid + "'";
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                            }
                            SaveToReport("Status: Upload files to Author Correction " + id + " file: " + Path.GetFileName(Zipname));
                            //CreateTxtfile(Zipname, Aid, jacro, "SAGE", "AC" + id);   
                            corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\" + Aid + @"\";
                            if (id != "") corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction " + id + @"\" + Aid + @"\";
                            if (edcorr)
                            {
                                corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\ED Correction\" + Aid + @"\";
                                if (id != "") corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction " + id + @"\ED Correction\" + Aid + @"\";
                            }
                            if (!Directory.Exists(corrfolder)) Directory.CreateDirectory(corrfolder);
                            //pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                            try
                            {
                                pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                                if (msg != "") File.WriteAllText(corrfolder + Aid + "_Emailbody.htm", msg);
                            }
                            catch (Exception ee)
                            {
                                SaveToReport("Error while correction mail save:  " + ee.Message + @"\n" + sub);
                                //pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + Aid + "_Correction.eml"));
                                try
                                {
                                    pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + Aid + "_Correction.eml"));
                                }
                                catch (Exception e11)
                                {
                                }
                                if (msg != "") File.WriteAllText(corrfolder + Aid + "_Emailbody.htm", msg);
                            }
                            try
                            {
                                for (int j = 0; j < pop.GetMessage(i).FindAllAttachments().ToList().Count; j++)
                                {
                                    //pop.GetMessage(i).FindAllAttachments().ToList()[j].Save(new System.IO.FileInfo(corrfolder + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName));
                                    try
                                    {
                                        pop.GetMessage(i).FindAllAttachments().ToList()[j].Save(new System.IO.FileInfo(corrfolder + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName));
                                    }
                                    catch (Exception ee)
                                    {
                                        SaveToReport("Error while attachment save:  " + ee.Message + @"\n" + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName);
                                    }
                                }
                            }
                            catch (Exception ee1)
                            {
                                SaveToReport("Error while attachment save:  " + ee1.Message);
                            }
                            //}
                            pop.DeleteMessage(i);
                            //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "SAGE", false, stage);
                            SaveToReport("Process completed. File: " + Aid);
                        }
                        else
                        {
                            //pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                            try
                            {
                                pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + sub.Replace(":", "") + ".eml"));
                            }
                            catch (Exception ee)
                            {
                                SaveToReport("Error while correction mail save:  " + ee.Message + @"\n" + sub);
                                try
                                {
                                    pop.GetMessage(i).Save(new System.IO.FileInfo(corrfolder + Aid + "_Correction or Doi.eml"));
                                }
                                catch (Exception e11)
                                {
                                }
                            }
                            pop.DeleteMessage(i);
                            SendMail(Aid, "Dear Team,<Br/><Br/>Subject line not matched for SAGE correction booking or DOI update. <Br/>" + sub + "<Br/>", "SAGE", true, "Correction/SAGE DOI update", Zipname);
                            SaveToReport("Subject line not matched for SAGE correction booking or DOI update.:  " + @"\n" + sub);
                        }
                    }
                    catch (Exception e)
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking SAGE correction: <Br/>" + e.Message + "<Br/>" + e.StackTrace, "SAGE", true, "Correction", Zipname);
                        SaveToReport("Error while booking SAGE correction:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                    }

                }
                pop.Disconnect();
            }
            catch (Exception e)
            {
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking SAGE correction: <Br/>" + e.Message + "<Br/>" + e.StackTrace, "", true, "Correction", Zipname);
                SaveToReport("Error while booking SAGE correction:  " + e.Message + @"\n" + e.StackTrace);
            }
        }

        public void SAGEEGCorrection_Old(string CL, string f)
        {
            Zipname = f;
            string stage = "AU Correction";
            string Aid = Path.GetFileNameWithoutExtension(Zipname).Split('_')[0];
            try
            {
                if (CheckWhetherFileBooked(Aid))
                {
                    DBClass Db = new DBClass();
                    string jacro = Regex.Match(Aid.ToUpper(), @"^(([A-Z]*?)+)\d+$").Groups[1].Value;
                    DateTime dt = DateTime.Today;
                    if (dt.DayOfWeek == DayOfWeek.Sunday) dt = dt.AddDays(1);
                    //string sche = AddDays(DateTime.Today, Db, 3).ToString("MM/dd/yyyy");
                    //string intdt1 = AddDays(DateTime.Today, Db, 2).ToString("MM/dd/yyyy"); ;
                    string sche = AddDays(dt, Db, 3).ToString("MM/dd/yyyy");
                    string intdt1 = AddDays(dt, Db, 2).ToString("MM/dd/yyyy");
                    stage = "Author Correction";
                    string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                    if (uploaddate == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "SAGE", true, stage, Zipname);
                        SaveToReport("Artcl_UploadedDt not updated " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    SaveToReport("Status: Author Correction update JR_Main Table file: " + Path.GetFileName(Zipname));
                    string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + jacro + "' AND Jrnl_PublID='4'");
                    string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                    string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                    if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                    {
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                    }
                    JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                    JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                    string JRA_ID = "";
                    string id = "", stageid = "", AUTUStatus = "97";
                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35") != "")
                    {
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=36") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=37") != "")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=78") != "")
                                {
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=97") != "")
                                    {
                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=98") != "")
                                        {
                                            SaveToReport("Unclosed stage Author Correction 5" + Path.GetFileName(Zipname));
                                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 5.", "SAGE", true, stage, Zipname);
                                            Clear();
                                            return;
                                        }
                                        else
                                        {
                                            // AU Correction 5
                                            stage = "AU Correction 5";
                                            id = "5"; stageid = "98";
                                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=97 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                            {
                                                SaveToReport("Unclosed stage Author Correction 4" + Path.GetFileName(Zipname));
                                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 4.", "SAGE", true, stage, Zipname);
                                                Clear();
                                                return;
                                            }
                                        }
                                    }
                                    else
                                    {
                                        // AU Correction 4
                                        stage = "AU Correction 4";
                                        id = "4"; stageid = "97";
                                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=78 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                        {
                                            SaveToReport("Unclosed stage Author Correction 3" + Path.GetFileName(Zipname));
                                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 3.", "SAGE", true, stage, Zipname);
                                            Clear();
                                            return;
                                        }
                                    }
                                }
                                else
                                {
                                    // AU Correction 3
                                    stage = "AU Correction 3";
                                    id = "3"; stageid = "78";
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=37 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                    {
                                        SaveToReport("Unclosed stage Author Correction 2" + Path.GetFileName(Zipname));
                                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 2.", "SAGE", true, stage, Zipname);
                                        Clear();
                                        return;
                                    }
                                }
                            }
                            else
                            {
                                // AU Correction 3
                                stage = "AU Correction 2";
                                id = "2"; stageid = "37";
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=36 AND isnull(JRST_UploadedDT ,'')=''") != "")
                                {
                                    SaveToReport("Unclosed stage Author Correction 1 " + Path.GetFileName(Zipname));
                                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction 1.", "SAGE", true, stage, Zipname);
                                    Clear();
                                    return;
                                }
                            }
                        }
                        else
                        {
                            stage = "AU Correction 1";
                            id = "1"; stageid = "36";
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35 AND isnull(JRST_UploadedDT ,'')=''") != "")
                            {
                                SaveToReport("Unclosed stage Author Correction " + Path.GetFileName(Zipname));
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction.", "SAGE", true, stage, Zipname);
                                Clear();
                                return;
                            }
                        }
                    }
                    else
                    {
                        stage = "AU Correction";
                        id = ""; stageid = "35";
                    }

                    SaveToReport("Status: Author Correction " + id + " update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                    string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stageid + "','" + sche + "',getdate(),'" + intdt1 + "','" + intdt1 + "','" + AUTUStatus + "',getdate(),'1','','" + Path.GetFileNameWithoutExtension(Zipname) + "','0')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query);
                    SaveToReport("Status: Author Correction " + id + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                    //JR_Articles 
                    JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stageid + "',getdate(),'1','0')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query);
                    SaveToReport("Status: Author Correction " + id + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                    //TrnsJournalRev 
                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query);
                    SaveToReport("Status: Upload files to Author Correction " + id + " file: " + Path.GetFileName(Zipname));
                    //CreateTxtfile(Zipname, Aid, jacro, "SAGE", "AC" + id);   
                    string corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\" + Aid + @"\";
                    if (id != "") corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction " + id + @"\" + Aid + @"\";
                    if (!Directory.Exists(corrfolder)) Directory.CreateDirectory(corrfolder);
                    File.Copy(Zipname, corrfolder + @"\" + Path.GetFileName(Zipname));
                    File.Delete(Zipname);
                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "SAGE", false, stage);
                    SaveToReport("Process completed. File: " + Aid);
                }
                else
                {

                    SaveToReport("First proof not booked but correction received. " + Path.GetFileName(Zipname)); SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>First proof not booked but correction received..", "SAGE", true, stage, Zipname);
                    Clear();
                    return;
                }
            }
            catch (Exception e)
            {
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking SAGE EG correction: <Br/>" + e.Message + "<Br/>" + e.StackTrace, "", true, "Correction", Zipname);
                SaveToReport("Error while booking EG SAGE correction:  " + e.Message + @"\n" + e.StackTrace);
            }
        }

        public void AIPEGCorrection(string CL, string f)
        {
            Zipname = f;
            string stage = "AU Correction";
            string Aid = Path.GetFileNameWithoutExtension(Zipname).Split('_')[0];
            try
            {

                DBClass Db = new DBClass();
                stage = "Author Correction Stage";
                string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                if (uploaddate == "")//|| CheckWhetherFileBooked(Aid,"AC"))
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "AIP", true, stage, Zipname);
                    SaveToReport("Artcl_UploadedDt not updated " + Path.GetFileName(Zipname));
                    //Move to Error
                    Clear();
                    return;
                }
                SaveToReport("Status: Author Correction update JR_Main Table file: " + Path.GetFileName(Zipname));
                // Author Correction   
                //JR_Main 
                string Journalid = ReturnDetail("Artcl_jrnlid", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                string jacro = ReturnDetail("Jrnl_Acronym", "Journal", Db, "Jrnl_Id='" + Journalid + "' AND Jrnl_PublID='99'");
                string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                {
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: Author Correction update Jr_main Table file: " + Query);
                }
                JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                //JR_Stage_Tran  
                string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                string JRA_ID = "";
                string Sdate = CalculateDueDate("", Db, AddDays(DateTime.Now, Db, 2)).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                string Rdate = DateTime.Now.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                if (DateTime.Now.Hour < 6)
                {
                    Sdate = CalculateDueDate("", Db, AddDays(DateTime.Now, Db, 1)).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    Rdate = DateTime.Now.AddDays(-1).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                }
                string id = "", AUTUStatus = "25";
                if (jacro.ToLower() == "cha") AUTUStatus = "102";
                //if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35") != "")
                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35") == "")
                {
                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','35','" + Sdate + "','" + Rdate + "','" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','')";
                    SaveToReport("Status: Author Correction update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: Author Correction update JR_Articles Table file: " + Path.GetFileName(Zipname));
                    SaveToReport("Status: Author Correction update JR_Stage_Tran Table file: " + Query);

                    //JR_Articles 
                    JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','35',getdate(),'1')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: Author Correction update JR_Articles Table file: " + Query);
                    SaveToReport("Status: Author Correction update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));


                    //TrnsJournalRev 
                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction','Pending')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: Author Correction update TrnsJournalRev Table file: " + Query);
                    SaveToReport("Status: Upload files to Author Correction file: " + Path.GetFileName(Zipname));
                }
                else
                {
                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35 AND isnull(JRST_UploadedDT ,'')=''") != "")
                    {
                        string Outpath = @"\\Techsetserver2\Journal\AIP\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\Additional_correction\" + Path.GetFileName(Zipname);
                        if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                        File.Copy(Zipname, Outpath, true);
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction. Kindly check for additional corrections from Additional_correction folder.", "AIP", true, "Additional_Correction", Zipname);
                        try
                        {
                            string strFile = Directory.GetDirectories(@"\\techsetserver2\Journal\AIP\" + jacro.Trim() + @"\Articles\DataSupplied\" + Aid + @"\First Proof\EG\", Aid + "*")[0] + @"\readme.xml";

                            if (File.Exists(strFile))
                            {
                                string strPrPage = ReturnDetail("Proof_Pages", "Article", Db, "Artcl_ArticleId='" + Aid + "'");
                                string strReadme = File.ReadAllText(strFile);
                                string strCollections = strReadme.Substring(strReadme.IndexOf("<collections")).Substring(0, strReadme.Substring(strReadme.IndexOf("<collections")).LastIndexOf("</collections>") + 14);
                                File.WriteAllText(@"\\Techsetserver2\Journal\AIP\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\EDITOR_" + Aid + @"_EG\" + "readme.xml", @"<?xml version=""1.0"" encoding=""UTF-8""?><aip_submission><submission_metadata><submission_type>RevisionsToVendor</submission_type><submission_date>" + DateTime.Now.ToString("MM/dd/yyyy HH:mm:ss") + "</submission_date><submission_request><type>AAProof</type><due_date>" + Sdate + "</due_date></submission_request></submission_metadata><article_metadata><coden3>BMF</coden3><edcode>" + Aid + @"</edcode><num_proof_pages>" + strPrPage + @"</num_proof_pages>" + strCollections + @"<copyright_type>Regular</copyright_type><read_publish>no</read_publish><read_publish_institution></read_publish_institution><read_publish_ringgold></read_publish_ringgold></article_metadata><files_submitted><file name=""readme.xml""/></files_submitted></aip_submission> ");
                            }
                        }
                        catch (Exception ex)
                        { SaveToReport("Error while booking EG AIP correction Readme XML:  " + ex.Message + @"\n" + ex.StackTrace); }
                        SaveToReport("Unclosed stage Author Correction: booked as additional correction. " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                }
                SaveToReport("Status: Upload files to Author Correction " + id + " file: " + Path.GetFileName(Zipname));
                File.Copy(Zipname, @"\\Techsetserver2\Journal\AIP\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\" + Path.GetFileName(Zipname), true);
                try
                {
                    string strFile = Directory.GetDirectories(@"\\techsetserver2\Journal\AIP\" + jacro.Trim() + @"\Articles\DataSupplied\" + Aid + @"\First Proof\EG\", Aid + "*")[0] + @"\readme.xml";

                    if (File.Exists(strFile))
                    {
                        string strPrPage = ReturnDetail("Proof_Pages", "Article", Db, "Artcl_ArticleId='" + Aid + "'");
                        string strReadme = File.ReadAllText(strFile);
                        string strCollections = strReadme.Substring(strReadme.IndexOf("<collections")).Substring(0, strReadme.Substring(strReadme.IndexOf("<collections")).LastIndexOf("</collections>") + 14);
                        File.WriteAllText(@"\\Techsetserver2\Journal\AIP\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\EDITOR_" + Aid + @"_EG\" + "readme.xml", @"<?xml version=""1.0"" encoding=""UTF-8""?><aip_submission><submission_metadata><submission_type>RevisionsToVendor</submission_type><submission_date>" + DateTime.Now.ToString("MM/dd/yyyy HH:mm:ss") + "</submission_date><submission_request><type>AAProof</type><due_date>" + Sdate + "</due_date></submission_request></submission_metadata><article_metadata><coden3>BMF</coden3><edcode>" + Aid + @"</edcode><num_proof_pages>" + strPrPage + @"</num_proof_pages>" + strCollections + @"<copyright_type>Regular</copyright_type><read_publish>no</read_publish><read_publish_institution></read_publish_institution><read_publish_ringgold></read_publish_ringgold></article_metadata><files_submitted><file name=""readme.xml""/></files_submitted></aip_submission> ");
                    }
                }
                catch (Exception ex)
                { SaveToReport("Error while booking EG AIP correction Readme XML:  " + ex.Message + @"\n" + ex.StackTrace); }
                File.Delete(Zipname);
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                File.Delete(Zipname);
                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "AIP", false, stage);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking AIP EG correction: <Br/>" + e.Message + "<Br/>" + e.StackTrace, "", true, "Correction", Zipname);
                SaveToReport("Error while booking EG AIP correction:  " + e.Message + @"\n" + e.StackTrace);
            }
        }
        public void RCSEGCorrection(string CL, string f)
        {
            Zipname = f;
            string stage = "AU Correction";
            string Aid = Path.GetFileNameWithoutExtension(Zipname).Split('_')[0];
            try
            {
                if (CheckWhetherFileBooked(Aid))
                {
                    DBClass Db = new DBClass();
                    string jacro = "ANNALS";
                    DateTime dt = DateTime.Today;
                    if (dt.DayOfWeek == DayOfWeek.Sunday) dt = dt.AddDays(1);
                    string sche = AddDays(dt, Db, 3).ToString("MM/dd/yyyy");
                    string intdt1 = AddDays(dt, Db, 2).ToString("MM/dd/yyyy");
                    string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                    if (uploaddate == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "SAGE", true, stage, Zipname);
                        SaveToReport("Artcl_UploadedDt not updated " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    SaveToReport("Status: Author Correction update JR_Main Table file: " + Path.GetFileName(Zipname));
                    string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + jacro + "' AND Jrnl_PublID='110'");
                    if (Journalid == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for " + jacro + ": ", "SAGE", true, stage, Zipname);
                        SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + jacro);
                        Clear();
                        return;
                    }
                    string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                    string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                    if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                    {
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: Author Correction update JR_Main Table file: " + Query);

                    }
                    JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                    JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                    string JRA_ID = "", JRS_Id = "", corrfolder = "";
                    string id = "", stageid = "35", AUTUStatus = "97";
                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35") != "")
                    {
                        SaveToReport("Unclosed stage Author Correction " + Path.GetFileName(Zipname));
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction.", "SAGE", true, stage, Zipname);
                        Clear();
                        return;
                    }
                    SaveToReport("Status: Author Correction " + id + " update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                    JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stageid + "','" + sche + "',getdate(),'" + intdt1 + "','" + intdt1 + "','" + AUTUStatus + "',getdate(),'1','','" + Path.GetFileNameWithoutExtension(Zipname) + "','0')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query);
                    SaveToReport("Status: Author Correction " + id + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                    //JR_Articles 
                    JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stageid + "',getdate(),'1','0')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query);
                    SaveToReport("Status: Author Correction " + id + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                    //TrnsJournalRev 
                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query);
                    SaveToReport("Status: Upload files to Author Correction " + id + " file: " + Path.GetFileName(Zipname));

                    string query = @"UPDATE asme_article SET CorrectionFrom= 'EG',Status='Correction due from NT',CorrectionDate='" + sche + "' Where ArticleId='" + Aid + "'";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(query, Db.GetConnection("ASME"));
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + query + " " + Path.GetFileName(Zipname));

                    corrfolder = @"\\Techsetserver2\Journal\RCS\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\" + Aid + @"\";
                    if (id != "") corrfolder = @"\\Techsetserver2\Journal\RCS\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction " + id + @"\" + Aid + @"\";
                    if (!Directory.Exists(corrfolder)) Directory.CreateDirectory(corrfolder);
                    File.Copy(Zipname, corrfolder + @"\" + Path.GetFileName(Zipname));
                    File.Delete(Zipname);
                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "RCS", false, stage);
                    SaveToReport("Process completed. File: " + Aid);
                }
                else
                {

                    SaveToReport("First proof not booked but correction received. " + Path.GetFileName(Zipname)); SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>First proof not booked but correction received..", "RCS", true, stage, Zipname);
                    Clear();
                    return;
                }
            }
            catch (Exception e)
            {
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking SAGE EG correction: <Br/>" + e.Message + "<Br/>" + e.StackTrace, "", true, "Correction", Zipname);
                SaveToReport("Error while booking EG SAGE correction:  " + e.Message + @"\n" + e.StackTrace);
            }
        }
        public void SagePDFCorrection(string CL, string f)
        {
            Zipname = f;
            string stage = "AU Correction";
            string Aid = Path.GetFileNameWithoutExtension(Zipname).Split('_')[0];
            try
            {
                if (CheckWhetherFileBooked(Aid))
                {
                    DBClass Db = new DBClass();
                    string jacro = Regex.Match(Aid.ToUpper(), @"^(([A-Z]*?)+)\d+$").Groups[1].Value;
                    DateTime dt = DateTime.Today;
                    if (dt.DayOfWeek == DayOfWeek.Sunday) dt = dt.AddDays(1);
                    string sche = AddDays(dt, Db, 3).ToString("MM/dd/yyyy");
                    string intdt1 = AddDays(dt, Db, 2).ToString("MM/dd/yyyy");
                    string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                    if (uploaddate == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "SAGE", true, stage, Zipname);
                        SaveToReport("Artcl_UploadedDt not updated " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    SaveToReport("Status: Author Correction update JR_Main Table file: " + Path.GetFileName(Zipname));
                    string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + jacro + "' AND Jrnl_PublID='4'");
                    if (Journalid == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for " + jacro + ": ", "SAGE", true, stage, Zipname);
                        SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + jacro);
                        Clear();
                        return;
                    }
                    string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                    string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                    if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                    {
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                    }
                    JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                    JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                    string JRA_ID = "", JRS_Id = "", corrfolder = "";
                    string id = "", stageid = "35", AUTUStatus = "97";
                    if (AUTUStatus == "97" && jacro == "CWS")
                        AUTUStatus = "25";
                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35") != "")
                    {
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35 AND isnull(JRST_UploadedDT ,'')=''") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35 and JRST_Status='36' AND isnull(JRST_UploadedDT ,'')=''") != "")
                            {
                                SaveToReport("Status: Author Correction " + id + " update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                JRS_Id = ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35");
                                Query = "update JR_Stage_Tran set JRST_JRS_ID='" + stageid + "', JRST_DueDtCats='" + sche + "', JRST_ReceivedDt=getdate(), JRST_ScheduledDt='" + intdt1 + "',JRST_ExpectedDt='" + intdt1 + "',JRST_Status='" + AUTUStatus + "', LastModifiedDate=getdate() where JRST_ID ='" + JRS_Id + @"'";
                                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: " + Query);
                                SaveToReport("Status: Author Correction " + id + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                //JR_Articles 
                                JRA_ID = ReturnDetail("JRA_ID", "JR_Articles", Db, "JRA_JRST_ID=" + JRS_Id + " AND JRA_StageID=35");
                                Query = "update JR_Articles set JRA_Status='" + AUTUStatus + @"',LastModifiedDate=getdate() where JRA_ID=" + JRA_ID;
                                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: " + Query);
                                SaveToReport("Status: Author Correction " + id + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                //TrnsJournalRev 
                                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + JRA_ID + @"','1','Administration',getdate(),getdate(),'36','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: " + Query);
                                if (Zipname.ToLower().Contains("_ed"))
                                {
                                    Query = @"UPDATE article SET Artcl_EDCorr_RecDT=getdate() Where Artcl_ArticleId='" + Aid + "'";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\ED Correction\" + Aid + @"\";
                                }
                                if (Zipname.ToLower().Contains("_au"))
                                {
                                    Query = @"UPDATE article SET Artcl_AUCorr_RecDT=getdate() Where Artcl_ArticleId='" + Aid + "'";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\" + Aid + @"\";
                                }
                                SaveToReport("Status: Upload files to Author Correction " + id + " file: " + Path.GetFileName(Zipname));
                                //corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\PR Correction\" + Aid + @"\";
                                if (!Directory.Exists(corrfolder)) Directory.CreateDirectory(corrfolder);
                                File.Copy(Zipname, corrfolder + Path.GetFileName(Zipname));
                                //ExtractZip(corrfolder + @"\" + Path.GetFileName(Zipname));                              
                                File.Delete(Zipname);
                                //Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                                UnZip(corrfolder + Path.GetFileName(Zipname), corrfolder);
                                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "SAGE", false, "PR Correction");
                                if (AUTUStatus != "36")
                                {
                                    try
                                    {
                                        Query = @"UPDATE ASME_Article SET Status='Correction due from NT',AuthorProofComplete=GETDATE() WHERE ArticleId='" + Aid + "'";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection("ASME"));
                                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                    }
                                    catch (Exception e)
                                    {
                                        SaveToReport("Error while updating in Sesame EG SAGE correction:  " + e.Message + @"\n" + e.StackTrace);
                                    }
                                }
                                SaveToReport("Process completed. File: " + Aid);
                                return;
                            }
                            else
                            {
                                SaveToReport("Unclosed stage Author Correction " + Path.GetFileName(Zipname));
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction.", "SAGE", true, stage, Zipname);
                                Clear();
                                return;
                            }
                        }
                        else
                        {
                            SaveToReport("Already closed stage Author Correction " + Path.GetFileName(Zipname));
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already closed for Author Correction.", "SAGE", true, stage, Zipname);
                            Clear();
                            return;
                        }
                    }
                    if (Regex.IsMatch(jacro, "^(ACR|CHS|CIN|EPE|EUP|IES|INI|IPE|JIR|JOPHON|JTH|JTT|LAH|NAD|NCT|OBM|PEC|PFR|PPN|PRB|PSG|SPO|TBT|TDO|TTJ|EPT|TPS|FTY|LRX|SEL|PWQ)$"))
                        AUTUStatus = "36";
                    else
                        AUTUStatus = "97";
                    if (AUTUStatus == "97" && jacro == "CWS")
                        AUTUStatus = "25";
                    SaveToReport("Status: Author Correction " + id + " update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                    JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stageid + "','" + sche + "',getdate(),'" + intdt1 + "','" + intdt1 + "','" + AUTUStatus + "',getdate(),'1','','" + Path.GetFileNameWithoutExtension(Zipname) + "','0')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query);
                    SaveToReport("Status: Author Correction " + id + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                    //JR_Articles 
                    JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stageid + "',getdate(),'1','0')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query);
                    SaveToReport("Status: Author Correction " + id + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                    //TrnsJournalRev 
                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query);
                    if (Zipname.ToLower().Contains("_ed"))
                    {
                        Query = @"UPDATE article SET Artcl_EDCorr_RecDT=getdate() Where Artcl_ArticleId='" + Aid + "'";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\ED Correction\" + Aid + @"\";
                    }
                    if (Zipname.ToLower().Contains("_au"))
                    {
                        Query = @"UPDATE article SET Artcl_AUCorr_RecDT=getdate() Where Artcl_ArticleId='" + Aid + "'";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\" + Aid + @"\";
                    }
                    SaveToReport("Status: Upload files to Author Correction " + id + " file: " + Path.GetFileName(Zipname));
                    //corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\" + Aid + @"\";
                    if (!Directory.Exists(corrfolder)) Directory.CreateDirectory(corrfolder);
                    File.Copy(Zipname, corrfolder + Path.GetFileName(Zipname));
                    // ExtractZip(corrfolder + @"\" + Path.GetFileName(Zipname));
                    File.Delete(Zipname);
                    //Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                    UnZip(corrfolder + Path.GetFileName(Zipname), corrfolder);
                    try { }
                    catch (Exception exAPI) { }
                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "SAGE", false, "AU Correction");
                    SaveToReport("Process completed. File: " + Aid);
                    if (AUTUStatus != "36")
                    {
                        try
                        {
                            Query = @"UPDATE ASME_Article SET Status='Correction due from NT',AuthorProofComplete=GETDATE() WHERE ArticleId='" + Aid + "'";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection("ASME"));
                            SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }
                        catch (Exception e)
                        {
                            SaveToReport("Error while updating in Sesame EG SAGE correction:  " + e.Message + @"\n" + e.StackTrace);
                        }
                    }
                }
                else
                {
                    SaveToReport("First proof not booked but correction received. " + Path.GetFileName(Zipname)); SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>First proof not booked but correction received..", "SAGE", true, stage, Zipname);
                    Clear();
                    return;
                }
            }
            catch (Exception e)
            {
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking SAGE EG correction: <Br/>" + e.Message + "<Br/>" + e.StackTrace, "", true, "Correction", Zipname);
                SaveToReport("Error while booking EG SAGE correction:  " + e.Message + @"\n" + e.StackTrace);
            }


        }
        public void SAGEEGCorrection(string CL, string f)
        {
            Zipname = f;
            string stage = "AU Correction";
            string Aid = Path.GetFileNameWithoutExtension(Zipname).Split('_')[0];
            try
            {
                if (CheckWhetherFileBooked(Aid))
                {
                    DBClass Db = new DBClass();
                    string jacro = Regex.Match(Aid.ToUpper(), @"^(([A-Z]*?)+)\d+$").Groups[1].Value;
                    DateTime dt = DateTime.Today;
                    if (dt.DayOfWeek == DayOfWeek.Sunday) dt = dt.AddDays(1);
                    //string sche = AddDays(DateTime.Today, Db, 3).ToString("MM/dd/yyyy");
                    //string intdt1 = AddDays(DateTime.Today, Db, 2).ToString("MM/dd/yyyy"); ;
                    string sche = AddDays(dt, Db, 3).ToString("MM/dd/yyyy");
                    string intdt1 = AddDays(dt, Db, 2).ToString("MM/dd/yyyy");
                    string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                    if (uploaddate == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "SAGE", true, stage, Zipname);
                        SaveToReport("Artcl_UploadedDt not updated " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    SaveToReport("Status: Author Correction update JR_Main Table file: " + Path.GetFileName(Zipname));
                    string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + jacro + "' AND Jrnl_PublID='4'");
                    if (Journalid == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for " + jacro + ": ", "SAGE", true, stage, Zipname);
                        SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + jacro);
                        Clear();
                        return;
                    }
                    if (jacro.ToUpper() == "FTY")
                    {
                        sche = AddDays(dt, Db, 5).ToString("MM/dd/yyyy");
                        intdt1 = AddDays(dt, Db, 4).ToString("MM/dd/yyyy");
                    }
                    string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                    string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                    if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                    {
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: Author Correction update JR_Main Table file: " + Query);

                    }
                    JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                    JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                    string JRA_ID = "", JRS_Id = "", corrfolder = "";
                    bool aucorr = false;
                    string id = "", stageid = "35", AUTUStatus = "97";
                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35") != "")
                    {
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35 AND isnull(JRST_UploadedDT ,'')=''") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35 and JRST_Status='36' AND isnull(JRST_UploadedDT ,'')=''") != "")
                            {
                                if (Regex.IsMatch(jacro, "^(JSW|PSM|LRX)$"))
                                {
                                    aucorr = true;
                                }
                            }
                            if (aucorr)
                            {
                                SaveToReport("Status: Author Correction " + id + " update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                JRS_Id = ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35");
                                Query = "update JR_Stage_Tran set JRST_JRS_ID='" + stageid + "', JRST_DueDtCats='" + sche + "', JRST_ReceivedDt=getdate(), JRST_ScheduledDt='" + intdt1 + "',JRST_ExpectedDt='" + intdt1 + "',JRST_Status='" + AUTUStatus + "', LastModifiedDate=getdate() where JRST_ID ='" + JRS_Id + @"'";
                                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: " + Query);
                                SaveToReport("Status: Author Correction " + id + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                //JR_Articles 
                                JRA_ID = ReturnDetail("JRA_ID", "JR_Articles", Db, "JRA_JRST_ID=" + JRS_Id + " AND JRA_StageID=35");
                                Query = "update JR_Articles set JRA_Status='" + AUTUStatus + @"',LastModifiedDate=getdate() where JRA_ID=" + JRA_ID;
                                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: " + Query);
                                SaveToReport("Status: Author Correction " + id + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                //TrnsJournalRev 
                                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + JRA_ID + @"','1','Administration',getdate(),getdate(),'36','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: " + Query);
                                if (id == "")
                                {
                                    Query = @"UPDATE article SET Artcl_AUCorr_RecDT=getdate() Where Artcl_ArticleId='" + Aid + "'";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                }
                                if (AUTUStatus != "36")
                                {
                                    try
                                    {
                                        Query = @"UPDATE ASME_Article SET Status='Correction due from NT',AuthorProofComplete=GETDATE() WHERE ArticleId='" + Aid + "'";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection("ASME"));
                                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                    }
                                    catch (Exception e)
                                    {
                                        SaveToReport("Error while updating in Sesame EG SAGE correction:  " + e.Message + @"\n" + e.StackTrace);
                                    }
                                }
                                SaveToReport("Status: Upload files to Author Correction " + id + " file: " + Path.GetFileName(Zipname));
                                corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\" + Aid + @"\";
                                if (id != "") corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction " + id + @"\" + Aid + @"\";
                                if (!Directory.Exists(corrfolder)) Directory.CreateDirectory(corrfolder);
                                File.Copy(Zipname, corrfolder + @"\" + Path.GetFileName(Zipname));
                                File.Delete(Zipname);
                                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "SAGE", false, stage);
                                SaveToReport("Process completed. File: " + Aid);
                                return;
                            }
                            else
                            {
                                SaveToReport("Unclosed stage Author Correction " + Path.GetFileName(Zipname));
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction.", "SAGE", true, stage, Zipname);
                                Clear();
                                return;
                            }
                        }
                        else
                        {
                            SaveToReport("Already closed stage Author Correction " + Path.GetFileName(Zipname));
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already closed for Author Correction.", "SAGE", true, stage, Zipname);
                            Clear();
                            return;
                        }
                    }
                    //else
                    //{
                    //    stage = "AU Correction";
                    //    id = ""; stageid = "35";
                    //}
                    if (Regex.IsMatch(jacro, "^(JSW|PSM|LRX)$"))
                    {
                        AUTUStatus = "36";
                    }
                    SaveToReport("Status: Author Correction " + id + " update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                    JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stageid + "','" + sche + "',getdate(),'" + intdt1 + "','" + intdt1 + "','" + AUTUStatus + "',getdate(),'1','','" + Path.GetFileNameWithoutExtension(Zipname) + "','0')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query);
                    SaveToReport("Status: Author Correction " + id + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                    //JR_Articles 
                    JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stageid + "',getdate(),'1','0')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query);
                    SaveToReport("Status: Author Correction " + id + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                    //TrnsJournalRev 
                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query);
                    SaveToReport("Status: Upload files to Author Correction " + id + " file: " + Path.GetFileName(Zipname));
                    if (AUTUStatus != "36")
                    {
                        try
                        {
                            Query = @"UPDATE ASME_Article SET Status='Correction due from NT',AuthorProofComplete=GETDATE() WHERE ArticleId='" + Aid + "'";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection("ASME"));
                            SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }
                        catch (Exception e)
                        {
                            SaveToReport("Error while updating in Sesame EG SAGE correction:  " + e.Message + @"\n" + e.StackTrace);
                        }
                    }

                    //CreateTxtfile(Zipname, Aid, jacro, "SAGE", "AC" + id);   
                    corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\" + Aid + @"\";
                    if (id != "") corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction " + id + @"\" + Aid + @"\";
                    if (!Directory.Exists(corrfolder)) Directory.CreateDirectory(corrfolder);
                    File.Copy(Zipname, corrfolder + @"\" + Path.GetFileName(Zipname));
                    File.Delete(Zipname);
                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "SAGE", false, stage);
                    SaveToReport("Process completed. File: " + Aid);
                }
                else
                {

                    SaveToReport("First proof not booked but correction received. " + Path.GetFileName(Zipname)); SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>First proof not booked but correction received..", "SAGE", true, stage, Zipname);
                    Clear();
                    return;
                }
            }
            catch (Exception e)
            {
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking SAGE EG correction: <Br/>" + e.Message + "<Br/>" + e.StackTrace, "", true, "Correction", Zipname);
                SaveToReport("Error while booking EG SAGE correction:  " + e.Message + @"\n" + e.StackTrace);
            }
        }

        public void SAGEPRCorrection(string CL)
        {
            string stage = "AU Correction";
            string Aid = Path.GetFileNameWithoutExtension(Zipname);
            try
            {
                if (CheckWhetherFileBooked(Aid))
                {
                    DBClass Db = new DBClass();
                    string jacro = Regex.Match(Aid.ToUpper(), @"^(([A-Z]*?)+)\d+$").Groups[1].Value;
                    DateTime dt = DateTime.Today;
                    if (dt.DayOfWeek == DayOfWeek.Sunday) dt = dt.AddDays(1);
                    string sche = AddDays(dt, Db, 3).ToString("MM/dd/yyyy");
                    string intdt1 = AddDays(dt, Db, 2).ToString("MM/dd/yyyy");
                    string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                    if (uploaddate == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "SAGE", true, stage, Zipname);
                        SaveToReport("Artcl_UploadedDt not updated " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    SaveToReport("Status: Author Correction update JR_Main Table file: " + Path.GetFileName(Zipname));
                    string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + jacro + "' AND Jrnl_PublID='4'");
                    if (Journalid == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for " + jacro + ": ", "SAGE", true, stage, Zipname);
                        SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + jacro);
                        Clear();
                        return;
                    }
                    string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                    string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                    if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                    {
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                    }
                    JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                    JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                    string JRA_ID = "", JRS_Id = "", corrfolder = "";
                    string id = "", stageid = "35", AUTUStatus = "97";
                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35") != "")
                    {
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35 AND isnull(JRST_UploadedDT ,'')=''") != "")
                        {
                            if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35 and JRST_Status='36' AND isnull(JRST_UploadedDT ,'')=''") != "")
                            {
                                SaveToReport("Status: Author Correction " + id + " update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                                JRS_Id = ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35");
                                Query = "update JR_Stage_Tran set JRST_JRS_ID='" + stageid + "', JRST_DueDtCats='" + sche + "', JRST_ReceivedDt=getdate(), JRST_ScheduledDt='" + intdt1 + "',JRST_ExpectedDt='" + intdt1 + "',JRST_Status='" + AUTUStatus + "', LastModifiedDate=getdate() where JRST_ID ='" + JRS_Id + @"'";
                                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: " + Query);
                                SaveToReport("Status: Author Correction " + id + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                                //JR_Articles 
                                JRA_ID = ReturnDetail("JRA_ID", "JR_Articles", Db, "JRA_JRST_ID=" + JRS_Id + " AND JRA_StageID=35");
                                Query = "update JR_Articles set JRA_Status='" + AUTUStatus + @"',LastModifiedDate=getdate() where JRA_ID=" + JRA_ID;
                                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: " + Query);
                                SaveToReport("Status: Author Correction " + id + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                                //TrnsJournalRev 
                                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + JRA_ID + @"','1','Administration',getdate(),getdate(),'36','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                                SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                                SaveToReport("Status: " + Query);
                                if (id == "")
                                {
                                    Query = @"UPDATE article SET Artcl_EDCorr_RecDT=getdate() Where Artcl_ArticleId='" + Aid + "'";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                }
                                SaveToReport("Status: Upload files to Author Correction " + id + " file: " + Path.GetFileName(Zipname));
                                corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\PR Correction\" + Aid + @"\";
                                if (!Directory.Exists(corrfolder)) Directory.CreateDirectory(corrfolder);
                                File.Copy(Zipname, corrfolder + Path.GetFileName(Zipname));
                                //ExtractZip(corrfolder + @"\" + Path.GetFileName(Zipname));                              
                                File.Delete(Zipname);
                                Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                                UnZip(corrfolder + Path.GetFileName(Zipname), corrfolder);
                                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "SAGE", false, "PR Correction");
                                if (AUTUStatus != "36")
                                {
                                    try
                                    {
                                        Query = @"UPDATE ASME_Article SET Status='Correction due from NT',AuthorProofComplete=GETDATE() WHERE ArticleId='" + Aid + "'";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection("ASME"));
                                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                    }
                                    catch (Exception e)
                                    {
                                        SaveToReport("Error while updating in Sesame EG SAGE correction:  " + e.Message + @"\n" + e.StackTrace);
                                    }
                                }
                                SaveToReport("Process completed. File: " + Aid);
                                return;
                            }
                            else
                            {
                                SaveToReport("Unclosed stage Author Correction " + Path.GetFileName(Zipname));
                                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction.", "SAGE", true, stage, Zipname);
                                Clear();
                                return;
                            }
                        }
                        else
                        {
                            SaveToReport("Already closed stage Author Correction " + Path.GetFileName(Zipname));
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already closed for Author Correction.", "SAGE", true, stage, Zipname);
                            Clear();
                            return;
                        }
                    }
                    AUTUStatus = "36";
                    SaveToReport("Status: Author Correction " + id + " update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                    JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stageid + "','" + sche + "',getdate(),'" + intdt1 + "','" + intdt1 + "','" + AUTUStatus + "',getdate(),'1','','" + Path.GetFileNameWithoutExtension(Zipname) + "','0')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query);
                    SaveToReport("Status: Author Correction " + id + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                    //JR_Articles 
                    JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stageid + "',getdate(),'1','0')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query);
                    SaveToReport("Status: Author Correction " + id + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                    //TrnsJournalRev 
                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + Query);
                    Query = @"UPDATE article SET Artcl_EDCorr_RecDT=getdate() Where Artcl_ArticleId='" + Aid + "'";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: Upload files to Author Correction " + id + " file: " + Path.GetFileName(Zipname));
                    corrfolder = @"\\Techsetserver2\Journal\SAGE\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\PR Correction\" + Aid + @"\";
                    if (!Directory.Exists(corrfolder)) Directory.CreateDirectory(corrfolder);
                    File.Copy(Zipname, corrfolder + Path.GetFileName(Zipname));
                    // ExtractZip(corrfolder + @"\" + Path.GetFileName(Zipname));
                    File.Delete(Zipname);
                    Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                    UnZip(corrfolder + Path.GetFileName(Zipname), corrfolder);
                    try { }
                    catch (Exception exAPI) { }
                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "SAGE", false, "PR Correction");
                    SaveToReport("Process completed. File: " + Aid);
                    if (AUTUStatus != "36")
                    {
                        try
                        {
                            Query = @"UPDATE ASME_Article SET Status='Correction due from NT',AuthorProofComplete=GETDATE() WHERE ArticleId='" + Aid + "'";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection("ASME"));
                            SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }
                        catch (Exception e)
                        {
                            SaveToReport("Error while updating in Sesame EG SAGE correction:  " + e.Message + @"\n" + e.StackTrace);
                        }
                    }
                }
                else
                {

                    SaveToReport("First proof not booked but correction received. " + Path.GetFileName(Zipname)); SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>First proof not booked but correction received..", "SAGE", true, stage, Zipname);
                    Clear();
                    return;
                }

            }
            catch (Exception e)
            {
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking SAGE EG correction: <Br/>" + e.Message + "<Br/>" + e.StackTrace, "", true, "Correction", Zipname);
                SaveToReport("Error while booking EG SAGE correction:  " + e.Message + @"\n" + e.StackTrace);
            }
        }

        public void SAGEEPTCorrection(string CL, string f)
        {
            Zipname = f;
            string stage = "AU Correction";
            string Aid = Path.GetFileNameWithoutExtension(Zipname).Split('_')[0];
            try
            {
                if (CheckWhetherFileBooked(Aid))
                {
                    DBClass Db = new DBClass();
                    string jacro = Regex.Match(Aid.ToUpper(), @"^(([A-Z]*?)+)\d+$").Groups[1].Value;
                    DateTime dt = DateTime.Today;
                    if (dt.DayOfWeek == DayOfWeek.Sunday) dt = dt.AddDays(1);
                    string sche = AddDays(dt, Db, 3).ToString("MM/dd/yyyy");
                    string intdt1 = AddDays(dt, Db, 2).ToString("MM/dd/yyyy");
                    string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                    if (uploaddate == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "SAGE", true, stage, Zipname);
                        SaveToReport("Artcl_UploadedDt not updated " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    SaveToReport("Status: Author Correction update JR_Main Table file: " + Path.GetFileName(Zipname));
                    string Journalid = ReturnDetail("Jrnl_Id", "Journal", Db, "Jrnl_Acronym='" + jacro + "' AND Jrnl_PublID='4'");
                    string IsProofReadJournal = ReturnDetail("CASE WHEN Flow_Type2='ProofReader' OR Flow_Type3='ProofReader' THEN 1 ELSE 0 END as ID", "EPTWorkFlowJournal", Db, "Flow_JrnlID='" + Journalid + "'");
                    //if (jacro == "SEL")
                    //    IsProofReadJournal = "1";
                    if (Journalid == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for " + jacro + ": ", "SAGE", true, stage, Zipname);
                        SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + jacro);
                        Clear();
                        return;
                    }
                    if (jacro.ToUpper() == "FTY")
                    {
                        sche = AddDays(dt, Db, 5).ToString("MM/dd/yyyy");
                        intdt1 = AddDays(dt, Db, 4).ToString("MM/dd/yyyy");
                    }
                    string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                    string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                    if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                    {
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                    }
                    JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                    JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                    string JRA_ID = "", JRS_Id = "", corrfolder = "";
                    string id = "", stageid = "35", AUTUStatus = "97";

                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35") != "" && IsProofReadJournal != "1")
                    {
                        SaveToReport("Already booked stage Author Correction " + Path.GetFileName(Zipname));
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>File already booked for Author Correction.", "SAGE", true, stage, Zipname);
                        Clear();
                        return;
                    }
                    JRS_Id = ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35 and JRST_Status=36");
                    if (JRS_Id != "" && IsProofReadJournal == "1")
                    {
                        Query = "UPDATE JR_Stage_Tran SET JRST_Status='" + AUTUStatus + "' WHERE JRST_ID='" + JRS_Id + "' UPDATE JR_Articles SET JRA_Status='" + AUTUStatus + "' WHERE JRA_JRST_ID='" + JRS_Id + "'";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query);
                        SaveToReport("Status: Author Correction " + id + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                        JRA_ID = ReturnDetail("JRA_ID", "JR_Articles", Db, " JRA_JRST_ID='" + JRS_Id + "'");
                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + JRA_ID + @"','1','Administration',getdate(),getdate(),'36','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query);
                        SaveToReport("Status: Upload files to Author Correction " + id + " file: " + Path.GetFileName(Zipname));
                    }
                    else
                    {
                        if (IsProofReadJournal == "1")
                            AUTUStatus = "36";
                        SaveToReport("Status: Author Correction " + id + " update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                        JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                        Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks,Jrst_CupCams,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + stageid + "','" + sche + "',getdate(),'" + intdt1 + "','" + intdt1 + "','" + AUTUStatus + "',getdate(),'1','','" + Path.GetFileNameWithoutExtension(Zipname) + "','0')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query);
                        SaveToReport("Status: Author Correction " + id + " update JR_Articles Table file: " + Path.GetFileName(Zipname));
                        //JR_Articles 
                        JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID,JRST_MoveFiles) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','" + stageid + "',getdate(),'1','0')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query);
                        SaveToReport("Status: Author Correction " + id + " update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                        //TrnsJournalRev 
                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query);
                        SaveToReport("Status: Upload files to Author Correction " + id + " file: " + Path.GetFileName(Zipname));
                        //if (IsProofReadJournal == "1")
                        //    AUTUStatus = "97";
                        //AUTUStatus = "97";
                    }

                    CreateTxtfile(Zipname, Aid, jacro, "SAGE", "AC" + id);
                    if (AUTUStatus == "97")
                    {
                        try
                        {
                            Query = @"UPDATE ASME_Article SET Status='Correction due from NT',AuthorProofComplete=GETDATE() WHERE ArticleId='" + Aid + "'";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection("ASME"));
                            SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }
                        catch (Exception e)
                        {
                            SaveToReport("Error while updating in Sesame EPT SAGE correction:  " + e.Message + @"\n" + e.StackTrace);
                        }
                    }
                    if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                    {
                        Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                    }
                    File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                    File.Delete(Zipname);
                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "SAGE", false, stage);
                    SaveToReport("Process completed. File: " + Aid);
                }
                else
                {

                    SaveToReport("First proof not booked but correction received. " + Path.GetFileName(Zipname)); SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>First proof not booked but correction received..", "SAGE", true, stage, Zipname);
                    Clear();
                    return;
                }
            }
            catch (Exception e)
            {
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking SAGE EG correction: <Br/>" + e.Message + "<Br/>" + e.StackTrace, "", true, "Correction", Zipname);
                SaveToReport("Error while booking EG SAGE correction:  " + e.Message + @"\n" + e.StackTrace);
            }
        }


        public void Book_Frontiersrevisesbooking(string CL, string file)
        {
            //string stagename;
            //string str = File.ReadAllText(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\readme.xml");
            //if (Regex.IsMatch(str.ToLower(), @"<file( [^<>]*?)? name=""([^<>]*?)\.doc(x)?""")) stagename = "ePub";
            //else if (Regex.IsMatch(str.ToLower(), @"<file( [^<>]*?)? name=""([^<>]*?)\.pdf""")) stagename = "XML";

            //DBClass Db = new DBClass();
            //string Aid = "";
            //int tat = 1;
            //string jrnlid = ReturnDetail("Artcl_ArticleId", "Article", Db, "Artcl_ArticleId='" + Aid + @"' and Artcl_jrnlid in (select jrnl_id from journal with(nolock) where Jrnl_PublID=113)");
            //string pubid = "113";
            //string  oldjrmcntid = "0",newstagename = "", nextprocessid="";
            //string jrnlname = ReturnDetail("jrnl_Acronym", "journal", Db, "jrnl_id='" + jrnlid + @"' select jrnl_Acronym from journal with(nolock) where Jrnl_PublID=113)");
            //string Artcl_ExpFromTIDt = CalculateDueDate("FRONTIERS", Db, DateTime.Today, tat).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
            //string Artcl_ScheduledDt = CalculateDueDate("FRONTIERS", Db, DateTime.Today, tat).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
            //string Artcl_ReceivedDt = CalculateDueDate("FRONTIERS", Db, DateTime.Today, 0).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
            // newstagename = "Epub";
            // nextprocessid = "21";
            //// @JrmArticleId varchar(200),
            ////@JournalName varchar(50),
            ////@Received_Date Varchar(50),
            ////@Scheduled_Date Varchar(50),
            ////@Expected_Date Varchar(50),
            ////@Comments Varchar(500),
            ////@publisherid varchar(50),
            ////@Volume varchar(50),
            ////@issue varchar(50),
            ////@OldJrmcntId varchar(250),
            ////@newstagename varchar(250),
            ////@TrnsJrnlTrnsId varchar(20)
            //Db.OpenConnection();
            //SqlCommand sql_cmnd = new SqlCommand("commonInsert", Db.GetConnection());
            //sql_cmnd.CommandType = CommandType.StoredProcedure;
            //sql_cmnd.Parameters.AddWithValue("@JrmArticleId", SqlDbType.NVarChar).Value = Aid;
            //sql_cmnd.Parameters.AddWithValue("@JournalName", SqlDbType.NVarChar).Value = jrnlname;
            //sql_cmnd.Parameters.AddWithValue("@Received_Date", SqlDbType.NVarChar).Value = Artcl_ReceivedDt;
            //sql_cmnd.Parameters.AddWithValue("@Scheduled_Date", SqlDbType.NVarChar).Value = Artcl_ScheduledDt;
            //sql_cmnd.Parameters.AddWithValue("@Expected_Date", SqlDbType.NVarChar).Value = Artcl_ExpFromTIDt;
            //sql_cmnd.Parameters.AddWithValue("@Comments", SqlDbType.NVarChar).Value ="";
            //sql_cmnd.Parameters.AddWithValue("@publisherid", SqlDbType.NVarChar).Value = pubid;
            //sql_cmnd.Parameters.AddWithValue("@Volume", SqlDbType.NVarChar).Value = "";
            //sql_cmnd.Parameters.AddWithValue("@issue", SqlDbType.NVarChar).Value = "";
            //sql_cmnd.Parameters.AddWithValue("@OldJrmcntId", SqlDbType.NVarChar).Value = oldjrmcntid;
            //sql_cmnd.Parameters.AddWithValue("@newstagename", SqlDbType.NVarChar).Value = newstagename;
            //sql_cmnd.Parameters.AddWithValue("@TrnsJrnlTrnsId", SqlDbType.NVarChar).Value = nextprocessid;
            //sql_cmnd.ExecuteNonQuery();
            //Db.CloseConnection();
            Zipname = file;

            //string JournalAcronym = Path.GetFileNameWithoutExtension(Zipname).Split('_')[0].ToUpper();
            //string volume = Path.GetFileNameWithoutExtension(Zipname).Split('_')[1];
            //string issue = Path.GetFileNameWithoutExtension(Zipname).Split('_')[2];
            //System.Collections.ArrayList ArticleID = new System.Collections.ArrayList();

            string Articleid = Path.GetFileNameWithoutExtension(Zipname).ToLower().Replace(".txt", "");


            string stage = "Final Web Delivery";
            DBClass Db = new DBClass();
            string Remarks = "";
            string Aid = "";
            Aid = Articleid;
            int tat = 2;
            string jrnlid = ReturnDetail("Artcl_JrnlId", "Article", Db, "Artcl_ArticleId='" + Aid + @"' and Artcl_jrnlid in (select jrnl_id from journal with(nolock) where Jrnl_PublID=113)");
            string jrnlname = ReturnDetail("jrnl_Acronym", "journal", Db, "jrnl_id='" + jrnlid + @"' select jrnl_Acronym from journal with(nolock) where Jrnl_PublID=113");
            string Artcl_ExpFromTIDt = CalculateDueDate("FRONTIERS", Db, DateTime.Today, tat).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
            string Artcl_ScheduledDt = CalculateDueDate("FRONTIERS", Db, DateTime.Today, tat).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
            string Artcl_ReceivedDt = CalculateDueDate("FRONTIERS", Db, DateTime.Today, 0).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
            string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, " JRM_ArticleID ='" + Aid + "' and JRM_JournalID ='" + jrnlid + "'");
            try
            {

                //string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + jrnlid + @"','" + Aid + "',getdate(),'1',getdate())";
                //if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + jrnlid + "'") == "")
                //{
                //    SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                //    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                //    Db.OpenConnection();
                //    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                //    Db.SqlReader.Close();
                //}

                string Query = "";
                if (JRM_Id == "")
                {

                    SendMail(Zipname, "Dear Team,<Br/><Br/>Au correction not booked: ", "FRONTIERS", true, stage, Zipname);
                    SaveToReport("Au correction not booked: " + Path.GetFileName(Zipname));
                    File.Delete(@"\\techsetserver2\Upload\Customer_Uploads\FRONTIERS\" + Zipname);
                    return;

                    // JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                    // Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,LastModifiedDate,UsrID,Insert_Date,JRM_ArticleID ) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + jrnlid + @"',getdate(),'1',getdate(),'" + Aid + "')";
                    //// JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID ='" + jrnlid + "' AND JRM_ArticleID='" + Aid + "' ");

                    //    JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                    //    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    //    Db.OpenConnection();
                    //    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    //    Db.SqlReader.Close();

                }
                //and JRST_UploadedDT is null

                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + JRM_Id + " AND JRST_JRS_ID=35  and JRST_UploadedDT is null ") != "")
                {
                    SendMail(Zipname, "Dear Team,<Br/><Br/>Au correction not uploaded so Final web delivery not booked: ", "FRONTIERS", true, stage, Zipname);
                    SaveToReport("Au correction not uploaded so Final web delivery not booked: " + Path.GetFileName(Zipname));
                    File.Delete(@"\\techsetserver2\Upload\Customer_Uploads\FRONTIERS\" + Zipname);
                    return;
                }
                // '(Convert.ToInt64(JRM_Id) + 1)

                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + JRM_Id + " AND JRST_JRS_ID=43") != "")
                {
                    SendMail(Zipname, "Dear Team,<Br/><Br/>File already booked for Final web delivery: ", "FRONTIERS", true, stage, Zipname);
                    SaveToReport("File already booked for Final web delivery: " + Path.GetFileName(Zipname));
                    File.Delete(@"\\techsetserver2\Upload\Customer_Uploads\FRONTIERS\" + Zipname);
                    return;
                }

                string JRA_ID = "";
                string AUTUStatus = "21";
                string JRS_Id = "";
                JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                stage = "Final Web Delivery";
                SaveToReport("Status: " + stage + "   update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id)) + @"','43','" + Artcl_ExpFromTIDt + "','" + Artcl_ReceivedDt + "','" + Artcl_ScheduledDt + "','" + Artcl_ScheduledDt + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status:  " + stage + "  update JR_Articles Table file: " + Path.GetFileName(Zipname));
                //JR_Articles 
                JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','43',getdate(),'1')";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status: Upload files to : " + stage + "update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                //TrnsJournalRev 
                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status: Upload files to : " + stage + Path.GetFileName(Zipname));
                //second one 
                stage = "ePub";
                SaveToReport("Status: " + stage + "   update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id)) + @"','139','" + Artcl_ExpFromTIDt + "','" + Artcl_ReceivedDt + "','" + Artcl_ScheduledDt + "','" + Artcl_ScheduledDt + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status:  " + stage + "  update JR_Articles Table file: " + Path.GetFileName(Zipname));
                //JR_Articles 
                JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','139',getdate(),'1')";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status: Upload files to : " + stage + "update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                //TrnsJournalRev 
                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status: Upload files to : " + stage + Path.GetFileName(Zipname));

                //third one
                stage = "XML";
                SaveToReport("Status: " + stage + "   update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id)) + @"','140','" + Artcl_ExpFromTIDt + "','" + Artcl_ReceivedDt + "','" + Artcl_ScheduledDt + "','" + Artcl_ScheduledDt + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status:  " + stage + "  update JR_Articles Table file: " + Path.GetFileName(Zipname));
                //JR_Articles 
                JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','140',getdate(),'1')";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status: Upload files to : " + stage + "update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                //TrnsJournalRev 
                Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                Db.OpenConnection();
                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                Db.SqlReader.Close();
                SaveToReport("Status: Upload files to : " + stage + Path.GetFileName(Zipname));
                File.Delete(@"\\techsetserver2\Upload\Customer_Uploads\FRONTIERS\" + Zipname);
                //@"\\techsetserver2\Upload\Customer_Uploads\FRONTIERS"
                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "Frontiers", false, stage);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e1)
            {
                SendMail(Zipname, "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e1.Message, "Frontiers", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e1.Message + "\n" + e1.StackTrace);
            }


        }

        public void Book_FrontiersrevisesbookingNew(string CL, string file)
        {
            Zipname = file;

            string Articleid = Path.GetFileNameWithoutExtension(Zipname).ToLower().Replace(".txt", "");

            string stage = "Final Web Delivery";
            DBClass Db = new DBClass();
            string Remarks = "";
            string Aid = "";
            Aid = Articleid;
            int tat = 2;
            string jrnlid = ReturnDetail("Artcl_JrnlId", "Article", Db, "Artcl_ArticleId='" + Aid + @"' and Artcl_jrnlid in (select jrnl_id from journal with(nolock) where Jrnl_PublID=113)");
            string jrnlname = ReturnDetail("jrnl_Acronym", "journal", Db, "jrnl_id='" + jrnlid + @"' select jrnl_Acronym from journal with(nolock) where Jrnl_PublID=113");
            string Artcl_ExpFromTIDt = CalculateDueDate("FRONTIERS", Db, DateTime.Today, tat - 1).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
            string Artcl_ScheduledDt = CalculateDueDate("FRONTIERS", Db, DateTime.Today, tat - 1).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
            string Artcl_ReceivedDt = CalculateDueDate("FRONTIERS", Db, DateTime.Today, 0).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
            string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, " JRM_ArticleID ='" + Aid + "' and JRM_JournalID ='" + jrnlid + "'");
            try
            {
                string Query = "";
                if (JRM_Id == "")
                {
                    SendMail(Zipname, "Dear Team,<Br/><Br/>Au correction not booked: ", "FRONTIERS", true, stage, Zipname);
                    SaveToReport("Au correction not booked: " + Path.GetFileName(Zipname));
                    File.Delete(@"\\techsetserver2\Upload\Customer_Uploads\FRONTIERS\" + Zipname);
                    return;
                }

                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + JRM_Id + " AND JRST_JRS_ID=35  and JRST_UploadedDT is null ") != "")
                {
                    SendMail(Zipname, "Dear Team,<Br/><Br/>Au correction not uploaded so Final web delivery not booked: ", "FRONTIERS", true, stage, Zipname);
                    SaveToReport("Au correction not uploaded so Final web delivery not booked: " + Path.GetFileName(Zipname));
                    File.Delete(@"\\techsetserver2\Upload\Customer_Uploads\FRONTIERS\" + Zipname);
                    return;
                }

                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + JRM_Id + " AND JRST_JRS_ID=43") != "")
                {
                    //SendMail(Zipname, "Dear Team,<Br/><Br/>File already booked for Final web delivery so will book for Final web Resupply1 ,EPub Resupply1 & XML Resupply1: ", "FRONTIERS", true, stage, Zipname);
                    SaveToReport("File already booked for Final web delivery so will book for Final web Resupply1: " + Path.GetFileName(Zipname));
                    //File.Delete(@"\\techsetserver2\Upload\Customer_Uploads\FRONTIERS\" + Zipname);
                    //return;
                    stage = "Final Web Resupply1";

                    Query = "SSP_Insert 2,'" + Aid + @"','" + jrnlid + @"','" + Artcl_ReceivedDt + "','" + Artcl_ScheduledDt + "','" + Artcl_ScheduledDt + "','" + Artcl_ExpFromTIDt + "'";
                    SaveToReport("Query: " + Query);
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status:  " + stage + " ,EPub Resupply1 & XML Resupply1 stage Booked " + Path.GetFileName(Zipname));

                    SaveToReport("Status: Upload files to : " + stage + Path.GetFileName(Zipname));
                    File.Delete(@"\\techsetserver2\Upload\Customer_Uploads\FRONTIERS\" + Zipname);
                    //@"\\techsetserver2\Upload\Customer_Uploads\FRONTIERS"
                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "Frontiers", false, stage);
                    SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
                }
                else
                {
                    /*
                    string JRA_ID = "";
                    string AUTUStatus = "21";
                    string JRS_Id = "";
                    JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                    stage = "Final Web Delivery";
                    SaveToReport("Status: " + stage + "   update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id)) + @"','43','" + Artcl_ExpFromTIDt + "','" + Artcl_ReceivedDt + "','" + Artcl_ScheduledDt + "','" + Artcl_ScheduledDt + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status:  " + stage + "  update JR_Articles Table file: " + Path.GetFileName(Zipname));
                    //JR_Articles 
                    JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','43',getdate(),'1')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: Upload files to : " + stage + "update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                    //TrnsJournalRev 
                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: Upload files to : " + stage + Path.GetFileName(Zipname));
                    //second one 
                    stage = "ePub";
                    SaveToReport("Status: " + stage + "   update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                    JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id)) + @"','139','" + Artcl_ExpFromTIDt + "','" + Artcl_ReceivedDt + "','" + Artcl_ScheduledDt + "','" + Artcl_ScheduledDt + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status:  " + stage + "  update JR_Articles Table file: " + Path.GetFileName(Zipname));
                    //JR_Articles 
                    JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','139',getdate(),'1')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: Upload files to : " + stage + "update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                    //TrnsJournalRev 
                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: Upload files to : " + stage + Path.GetFileName(Zipname));

                    //third one
                    stage = "XML";
                    SaveToReport("Status: " + stage + "   update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                    JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id)) + @"','140','" + Artcl_ExpFromTIDt + "','" + Artcl_ReceivedDt + "','" + Artcl_ScheduledDt + "','" + Artcl_ScheduledDt + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status:  " + stage + "  update JR_Articles Table file: " + Path.GetFileName(Zipname));
                    //JR_Articles 
                    JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                    Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','140',getdate(),'1')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: Upload files to : " + stage + "update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                    //TrnsJournalRev 
                    Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','" + stage + "','Pending')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();

                   */

                    //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id)) + @"','43','" + Artcl_ExpFromTIDt + "','" + Artcl_ReceivedDt + "','" + Artcl_ScheduledDt + "','" + Artcl_ScheduledDt + "','" + AUTUStatus + "',getdate(),'1','" + Remarks + "')";
                    Query = "SSP_Insert 1,'" + Aid + @"','" + jrnlid + @"','" + Artcl_ReceivedDt + "','" + Artcl_ScheduledDt + "','" + Artcl_ScheduledDt + "','" + Artcl_ExpFromTIDt + "'";
                    SaveToReport("Query: " + Query);
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status:  " + stage + " ,EPub & XML stage Booked " + Path.GetFileName(Zipname));

                    SaveToReport("Status: Upload files to : " + stage + Path.GetFileName(Zipname));
                    File.Delete(@"\\techsetserver2\Upload\Customer_Uploads\FRONTIERS\" + Zipname);
                    //@"\\techsetserver2\Upload\Customer_Uploads\FRONTIERS"
                    //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "Frontiers", false, stage);

                    SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
                }
            }
            catch (Exception e1)
            {
                SendMail(Zipname, "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e1.Message, "Frontiers", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e1.Message + "\n" + e1.StackTrace);
            }
        }

        public void Book_FrontiersRepublish(string CL, string file)
        {
            Zipname = file;

            string Articleid = Path.GetFileNameWithoutExtension(Zipname).ToLower().Replace(".txt", "");

            string stage = "Republish";
            DBClass Db = new DBClass();
            string Remarks = "";
            string Aid = "";
            Aid = Articleid;
            int tat = 2;
            string jrnlid = ReturnDetail("Artcl_JrnlId", "Article", Db, "Artcl_ArticleId='" + Aid + @"' and Artcl_jrnlid in (select jrnl_id from journal with(nolock) where Jrnl_PublID=113)");
            string jrnlname = ReturnDetail("jrnl_Acronym", "journal", Db, "jrnl_id='" + jrnlid + @"' select jrnl_Acronym from journal with(nolock) where Jrnl_PublID=113");
            string Artcl_ExpFromTIDt = CalculateDueDate("FRONTIERS", Db, DateTime.Today, tat - 1).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
            string Artcl_ScheduledDt = CalculateDueDate("FRONTIERS", Db, DateTime.Today, tat - 1).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
            string Artcl_ReceivedDt = CalculateDueDate("FRONTIERS", Db, DateTime.Today, 0).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
            string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, " JRM_ArticleID ='" + Aid + "' and JRM_JournalID ='" + jrnlid + "'");
            try
            {
                string Query = "";
                if (JRM_Id == "")
                {
                    SendMail(Zipname, "Dear Team,<Br/><Br/>Au correction not booked: ", "FRONTIERS", true, stage, Zipname);
                    SaveToReport("Au correction not booked: " + Path.GetFileName(Zipname));
                    File.Delete(@"\\techsetserver2\Download\Frontiers\Republish\" + Zipname);
                    return;
                }

                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + JRM_Id + " AND JRST_JRS_ID=35  and JRST_UploadedDT is null ") != "")
                {
                    SendMail(Zipname, "Dear Team,<Br/><Br/>Au correction not uploaded so Final web delivery not booked: ", "FRONTIERS", true, stage, Zipname);
                    SaveToReport("Au correction not uploaded so Final web delivery not booked: " + Path.GetFileName(Zipname));
                    File.Delete(@"\\techsetserver2\Download\Frontiers\Republish\" + Zipname);
                    return;
                }

                if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + JRM_Id + " AND JRST_JRS_ID=43") != "")
                {
                    SaveToReport("File already booked for Final web delivery so will book for Republish: " + Path.GetFileName(Zipname));
                    stage = "Republish";

                    Query = "SSP_Insert 3,'" + Aid + @"','" + jrnlid + @"','" + Artcl_ReceivedDt + "','" + Artcl_ScheduledDt + "','" + Artcl_ScheduledDt + "','" + Artcl_ExpFromTIDt + "'";
                    SaveToReport("Query: " + Query);
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status:  " + stage + " stage Booked " + Path.GetFileName(Zipname));

                    SaveToReport("Status: Upload files to : " + stage + Path.GetFileName(Zipname));
                    File.Delete(@"\\techsetserver2\Download\Frontiers\Republish\" + Zipname);
                    SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
                }
            }
            catch (Exception e1)
            {
                SendMail(Zipname, "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e1.Message, "Frontiers", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e1.Message + "\n" + e1.StackTrace);
            }
        }

        public void Book_Frontiers(string CL)
        {
            string stage = "First Proof Stage";
            DBClass Db = new DBClass();
            try
            {
                XDocument XDoc = new XDocument();
                SaveToReport("Status: Validating XML file: " + Path.GetFileName(Zipname));
                string XML = "";
                extractzipsuccess = true;
                Recursive_ExtractZip(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                if (!extractzipsuccess)
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while extracting zip file: " + Path.GetFileName(Zipname), "Frontiers", true, stage, Zipname);
                    SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Error while extracting zip file");
                    Clear();
                    return;
                }
                foreach (string f in Directory.GetFiles(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), "*.xml", SearchOption.AllDirectories))
                {
                    XML = f;
                }
                if (XML == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Meta XML file missing for Frontiers: " + Path.GetFileName(Zipname), "Frontiers", true, stage, Zipname);
                    SaveToReport("Meta XML file missing for:  " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
                try
                {
                    XDoc = XDocument.Parse(File.ReadAllText(XML), LoadOptions.PreserveWhitespace);
                }
                catch (Exception e)
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Meta XML file is not valid for Frontiers: ", "Frontiers", true, stage, Zipname);
                    SaveToReport("Meta XML file is not valid for:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                    Clear();
                    return;
                }
                SaveToReport("Status: Validating against Booked Records: " + Path.GetFileName(Zipname));
                string JSubtitle = "", Auname = "", Auemail = "", Aid = "", Doi = "", JAcro = "", Volume = "", Issue = "", DD = "", Title = "", Txtfolio = "", Txtfolio1 = "0", TxtElec = "", LineArt = "", ArtElec = "", Artwork = "", Srcby = "", Atype = "article", atypeval = "", tabcnt = "", Artcl_P = "", Artcl_Status = "PE_SRV", directTS = "", PEOnly = "", priority = "", pdate = "", cntry = "";
                XElement author = null;
                if (Srcby == "")
                {
                    if (Directory.GetFiles(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), "*.tex", SearchOption.AllDirectories).Count() > 0) Srcby = "TEX";
                    else if (Directory.GetFiles(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), "*.doc*", SearchOption.AllDirectories).Count() > 0) Srcby = "WORD";
                    else if (Directory.GetFiles(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), "*.pdf", SearchOption.AllDirectories).Count() > 0) Srcby = "PDF";
                }

                if (XDoc.XPathSelectElements(@"//author_list/author").ToList().Count > 0)
                {
                    foreach (XElement e in XDoc.XPathSelectElements(@"//author_list/author").ToList())
                    {
                        if (e.Attributes("corr").Count() > 0 && e.Attributes("corr").First().Value == "true")
                        {
                            foreach (XElement e1 in e.Elements().ToList())
                            {
                                switch (e1.Name.ToString().ToLower())
                                {
                                    case "salutation":
                                        Auname = e1.Value.TrimEnd() + " ";
                                        break;
                                    case "first_name":
                                        Auname = Auname.TrimStart() + e1.Value.TrimEnd() + " ";
                                        break;
                                    case "last_name":
                                        Auname = Auname.TrimStart() + e1.Value.TrimEnd();
                                        break;
                                    case "email":
                                        if (e1.Attributes().Count() > 0 && e1.Attributes("addr_type").Count() > 0 && e1.Attributes("addr_type").First().Value == "primary")
                                        {
                                            Auemail = e1.Value.TrimEnd();
                                        }
                                        break;
                                }
                            }
                            break;
                        }
                    }
                }
                if (Auname == "" && Auemail == "")
                {
                    string pr = "", sr = "", gn = "";
                    if (XDoc.XPathSelectElements(@"//contrib-group/contrib").ToList().Count > 0)
                    {
                        foreach (XElement e in XDoc.XPathSelectElements(@"//contrib-group/contrib").ToList())
                        {
                            if (e.Attributes("contrib-type").Count() > 0 && e.Attributes("contrib-type").First().Value == "author" && e.Attributes("corresp").Count() > 0 && e.Attributes("corresp").First().Value == "yes")
                            {
                                foreach (XElement e1 in e.Descendants().ToList())
                                {
                                    switch (e1.Name.ToString().ToLower())
                                    {
                                        case "prefix":
                                            pr = e1.Value.Trim();
                                            break;
                                        case "surname":
                                            sr = e1.Value.Trim();
                                            break;
                                        case "given-names":
                                            gn = e1.Value.Trim();
                                            break;
                                        case "email":
                                            Auemail = e1.Value.TrimEnd();
                                            break;
                                    }
                                }
                                break;
                            }
                        }
                    }
                    if (pr != "") Auname = pr + " ";
                    if (sr != "") Auname = Auname + sr + " ";
                    if (gn != "") Auname = Auname + gn;
                }
                //if (XDoc.XPathSelectElements(@"//author-notes/corresp/email").ToList().Count > 0)
                //{
                //    Auemail = XDoc.XPathSelectElements(@"//author-notes/corresp/email").ToList().First().Value;
                //}
                //if (XDoc.Root.Attributes().Count() > 0 && XDoc.Root.Attributes("article-type").Count() > 0) Atype = XDoc.Root.Attributes("article-type").First().Value;
                //if (XDoc.XPathSelectElements(@"//publication_type").ToList().Count > 0) Atype = XDoc.XPathSelectElements(@"//publication_type").ToList().First().Value;
                foreach (XElement e in XDoc.XPathSelectElements(@"//article-meta/article-id").ToList())
                {
                    if (e.Attributes().Count() > 0 && e.Attributes("pub-id-type").Count() > 0 && e.Attributes("pub-id-type").First().Value == "doi")
                    {
                        Doi = e.Value;
                    }
                }
                //if (Atype == "")
                //{
                //    foreach (XAttribute a in MetaXDoc.Root.Attributes().ToList())
                //    {
                //        if (a.Name == "article-type")
                //        {
                //            Atype = a.Value;
                //            break;
                //        }
                //    }
                //}
                //if (XDoc.XPathSelectElements(@"//article-meta/volume").ToList().Count > 0) Volume = XDoc.XPathSelectElements(@"//article-meta/volume").ToList().First().Value;
                //if (XDoc.XPathSelectElements(@"//article-meta/issue").ToList().Count > 0) Issue = XDoc.XPathSelectElements(@"//article-meta/issue").ToList().First().Value;
                //if (XDoc.XPathSelectElements(@"//article_title").ToList().Count > 0) Title = XDoc.XPathSelectElements(@"//article_title").First().Value;
                //if (Title == "" && XDoc.XPathSelectElements(@"//article-title").ToList().Count > 0) Title = XDoc.XPathSelectElements(@"//article-title").First().Value;
                //Title = Title.Replace(@"'", @"''").Trim();
                Auname = Auname.Replace(@"'", @"''");
                if (XDoc.XPathSelectElements(@"//content/total_pages_calc").ToList().Count > 0) Txtfolio = XDoc.XPathSelectElements(@"//content/total_pages_calc").First().Value.Split('.')[0];
                if (Txtfolio == "" && XDoc.XPathSelectElements(@"//page-count").ToList().Count > 0) Txtfolio = XDoc.XPathSelectElements(@"//page-count").First().Value;
                if (XDoc.XPathSelectElements(@"//content/total_figures").ToList().Count > 0) LineArt = XDoc.XPathSelectElements(@"//content/total_figures").First().Value;
                if (XDoc.XPathSelectElements(@"//content/total_tables").ToList().Count > 0) tabcnt = XDoc.XPathSelectElements(@"//content/total_tables").First().Value;
                //if (XDoc.Descendants("fig").ToList().Count > 0) LineArt = XDoc.Descendants("fig").ToList().Count.ToString();
                //if (XDoc.Descendants("table-wrap").ToList().Count > 0) tabcnt = XDoc.Descendants("table-wrap").ToList().Count.ToString();
                //foreach (XElement e in MetaXDoc.XPathSelectElements(@"//journal-meta/journal-id").ToList())
                //{
                //    if (e.Attributes().Count() > 0 && e.Attributes("journal-id-type").Count() > 0 && e.Attributes("journal-id-type").First().Value == "acronym")
                //    {
                //        JAcro = e.Value;
                //        break;
                //    }
                //}
                //if (XDoc.XPathSelectElements(@"//journal/journal_abbreviation").ToList().Count > 0) JAcro = XDoc.XPathSelectElements(@"//journal/journal_abbreviation").First().Value;
                //JAcro = JAcro.ToUpper();
                //if (JAcro == "JERHRE") JAcro = "JRE";
                //if (JAcro == "RBPE") JAcro = "RBP";
                //if (JAcro == "JETS") JAcro = "ETS";
                //if (JAcro == "IJL") JAcro = "IJLEW";

                if (XDoc.XPathSelectElements(@"//front/journal-meta/journal-title-group/journal-subtitle").ToList().Count > 0) JSubtitle = XDoc.XPathSelectElements(@"//front/journal-meta/journal-title-group/journal-subtitle").First().Value;

                if (XDoc.XPathSelectElements(@"//OnlyTypesetting").ToList().Count > 0) directTS = XDoc.XPathSelectElements(@"//OnlyTypesetting").First().Value;
                if (XDoc.XPathSelectElements(@"//OnlyPE").ToList().Count > 0) PEOnly = XDoc.XPathSelectElements(@"//OnlyPE").First().Value;
                if (XDoc.XPathSelectElements(@"//Priority").ToList().Count > 0) priority = XDoc.XPathSelectElements(@"//Priority").First().Value;
                if (XDoc.XPathSelectElements(@"//PDate").ToList().Count > 0) pdate = XDoc.XPathSelectElements(@"//PDate").First().Value;
                //if (Doi != "" && JAcro != "") Aid = JAcro + Regex.Match(Doi, @"[\d]{6}$").Value;     
                Aid = Doi.Split('/')[Doi.Split('/').Length - 1];
                Aid = Aid.Replace(".", "");
                if (Aid == "" || Doi == "")
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>manuscript-number or DOI missing in xml for Frontiers: ", "Frontiers", true, stage, Zipname);
                    SaveToReport("manuscript-number or DOI missing in xml for Frontiers: " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
                if (!Regex.IsMatch(LineArt.Trim(), @"^\d+$")) LineArt = "";
                if (LineArt == "" || LineArt == "0")
                {
                    int MaxFig = 0;
                    try
                    {
                        foreach (String f in Directory.GetFiles(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname) + @"\", "*.doc*", SearchOption.AllDirectories))
                        {
                            foreach (Process P in Process.GetProcessesByName("WINWORD"))
                            {
                                try
                                {
                                    P.Kill();
                                }
                                catch (Exception e1) { }
                            }
                            Word.Application WordApp = new Microsoft.Office.Interop.Word.Application();
                            object fileName = f;
                            object readOnly = false;
                            object isVisible = false;
                            object missing = System.Reflection.Missing.Value;
                            //WordApp.Options.ConfirmConversions = false;
                            Word.Document aDoc = WordApp.Documents.Open(ref fileName,
                                                    ref missing, ref readOnly, ref missing,
                                                    ref missing, ref missing, ref missing,
                                                    ref missing, ref missing, ref missing,
                                                     ref missing, ref isVisible);
                            //WordApp.ActiveDocument.ShowRevisions = false;
                            string maintext = aDoc.Content.Text;
                            Word.WdStatistic stat = Word.WdStatistic.wdStatisticPages;
                            Txtfolio1 = (Convert.ToInt32(Txtfolio1) + aDoc.ComputeStatistics(stat, missing)).ToString();
                            foreach (Match m in Regex.Matches(maintext, @"Fig[\.ure]+\s+(\d+)", RegexOptions.IgnoreCase))
                            {
                                if (MaxFig < Convert.ToInt32(m.Groups[1].Value))
                                {
                                    MaxFig = Convert.ToInt32(m.Groups[1].Value);
                                }
                            }
                            foreach (Match m in Regex.Matches(maintext, @"Fig[\.ures]+\s+\d+[a-z]?(?:\s+and\s+|\s*-\s*|\s*\x2013\s*)(\d+)", RegexOptions.IgnoreCase))
                            {
                                if (MaxFig < Convert.ToInt32(m.Groups[1].Value))
                                {
                                    MaxFig = Convert.ToInt32(m.Groups[1].Value);
                                }
                            }
                            try
                            {
                                aDoc.Close();
                            }
                            catch (Exception e)
                            {
                                foreach (Process P in Process.GetProcessesByName("WINWORD"))
                                {
                                    try
                                    {
                                        P.Kill();
                                    }
                                    catch (Exception e1) { }
                                }
                            }
                        }
                        if (MaxFig > 0) LineArt = MaxFig.ToString();
                    }
                    catch (Exception tt) { SaveToReport(tt.Message + tt.StackTrace); }
                }
                if (CheckWhetherFileBooked(Aid))
                {
                    SaveToReport("Status: Booking file for First Proof: " + Path.GetFileName(Zipname));
                    string Dupid = ReturnDetail("Artcl_ArticleId", "Article", Db, "Artcl_ArticleId='" + Aid + @"' and Artcl_status='PT' and Artcl_jrnlid in (select jrnl_id from journal where Jrnl_PublID=113)");
                    if (Dupid == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Article not booked or not in PT @ First Proof stage", "Frontiers", true, stage, Zipname);
                        SaveToReport("Article not booked or not in PT @ First Proof stage " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    DD = CalculateDueDate("", Db, DateTime.Today, 9).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');

                    DateTime Artcl_ExpFromTIDt = new DateTime();
                    DateTime Artcl_ScheduledDt = new DateTime();
                    DateTime artcl_CEDuedate = new DateTime();
                    DateTime artcl_PEDuedate = new DateTime();

                    var culture = System.Globalization.CultureInfo.InvariantCulture;
                    DateTime ddate = DateTime.ParseExact(DD, "MM/dd/yyyy HH:mm:ss", culture);
                    Artcl_ExpFromTIDt = CalculateAIPExpFromTIDt("AIP", Db, ddate);
                    Artcl_ScheduledDt = Artcl_ExpFromTIDt;
                    Artcl_ExpFromTIDt = CalculateAIPExpFromTIDt("AIP", Db, Artcl_ExpFromTIDt);
                    artcl_PEDuedate = CalculateDueDate("", Db, DateTime.Today, 1);
                    artcl_CEDuedate = CalculateDueDate("", Db, DateTime.Today, 3);
                    if (pdate != "" && priority != "" && priority.ToUpper() == "YES")
                    {
                        Artcl_ScheduledDt = DateTime.ParseExact(pdate, "MM/dd/yyyy HH:mm:ss", culture);
                        //Artcl_ScheduledDt = CalculateAIPExpFromTIDt("AIP", Db, ddate);
                    }
                    if (Txtfolio == "") Txtfolio = Txtfolio1;
                    if (Txtfolio != "") TxtElec = "1";
                    if (LineArt == "" || LineArt == "0") LineArt = "1";
                    if (LineArt != "" && LineArt != "0") { ArtElec = "1"; Artwork = "T1"; }
                    if (directTS != "" && directTS.ToUpper() == "YES")
                    {
                        Artcl_Status = "DP";
                        artcl_CEDuedate = artcl_PEDuedate;
                        DD = CalculateDueDate("", Db, DateTime.Today, 2).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    }
                    if (priority != "" && priority.ToUpper() == "YES") Artcl_P = "1";
                    string book = @"update Article set Artcl_SpecInst='" + JSubtitle + @"',Artcl_AuthorName='" + Auname + @"',Artcl_AuthorEmail='" + Auemail + @"',Artcl_TextFolios='" + Txtfolio + @"',Artcl_TextElectronic='" + TxtElec + "',Artcl_ArtLineArt='" + LineArt + @"',Artcl_ArtElectronic='" + ArtElec + "',artcl_SourceBy='" + Srcby + @"',Artcl_Status='" + Artcl_Status + "' where artcl_articleid='" + Aid + @"'";
                    if (LineArt != "" && LineArt != "0")
                    {
                        book = @"update Article set Artcl_SpecInst='" + JSubtitle + @"',Artcl_AuthorName='" + Auname + @"',Artcl_AuthorEmail='" + Auemail + @"',Artcl_TextFolios='" + Txtfolio + @"',Artcl_TextElectronic='" + TxtElec + "',Artcl_ArtLineArt='" + LineArt + @"',Artcl_ArtElectronic='" + ArtElec + "',artcl_SourceBy='" + Srcby + @"',Artcl_Status='" + Artcl_Status + "',Artcl_StatusGFX='GFXP',Artcl_ArtReceivedDt=getdate(),Artcl_ArtWork='" + Artwork + "' where artcl_articleid='" + Aid + @"'";
                    }
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + book);
                    SaveToReport("Status: Update Transaction Details for file: " + Path.GetFileName(Zipname));
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Select Artcl_Id From Article WITH(NOLOCK) Where Artcl_ArticleId = '" + Aid + "'", Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    if (Db.SqlReader.Read())
                    {
                        Int64 aaid = Convert.ToInt64(Db.SqlReader[0]);
                        Db.SqlReader.Close();
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Insert into TrnsJournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) values(" + @"'" + aaid + @"','1','Admin',getdate(),getdate(),'15','Completed','171','Article','Auto Entry',getdate(),1,'Pending')", Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        string jid = ReturnDetail("Artcl_jrnlId", "Article", Db, "Artcl_ArticleId='" + Aid + @"' and Artcl_jrnlid in (select jrnl_id from journal where Jrnl_PublID=113)");
                        if (jid == "2323") { JAcro = "FSURG"; }
                        if (jid == "2092") { JAcro = "FNUT"; }
                        if (jid == "2336") { JAcro = "FDMED"; }
                        if (jid == "2335") { JAcro = "FDGTH"; }
                        if (jid == "2334") { JAcro = "FALGY"; }
                        if (jid == "2333") { JAcro = "FRESC"; }
                        if (jid == "2345") { JAcro = "FMEDT"; }
                        if (jid == "2348") { JAcro = "FRPH"; }
                        if (jid == "2343") { JAcro = "FROH"; }
                        if (jid == "2344") { JAcro = "FNUME"; }
                        if (jid == "2346") { JAcro = "FPAIN"; }
                        if (jid == "2347") { JAcro = "FRADI"; }

                        if (jid == "2348") { JAcro = "FRPH"; }
                        if (jid == "2357") { JAcro = "FPED"; }
                        if (jid == "2358") { JAcro = "FGWH"; }

                        if (jid == "2380") { JAcro = "FSPOR"; }
                        if (jid == "2381") { JAcro = "FRCHA"; }
                        if (jid == "2382") { JAcro = "FEPID"; }
                        if (jid == "2383") { JAcro = "FRHS"; }
                        if (jid == "2384") { JAcro = "FRTRA"; }

                        CreateTxtfile(Zipname, Aid, JAcro, "Frontiers");
                        if (LineArt != "" && LineArt != "0")
                        {
                            SaveToReport("Status: Update Artwork Transaction Details for file: " + Path.GetFileName(Zipname));
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(UpdateTransaction(aaid, true), Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                        }
                    }
                }
                else
                {
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>First Proof stage article not found: ", "Frontiers", true, stage, Zipname);
                    SaveToReport("File already booked for First Proof stage for Frontiers: " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
                SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                File.Delete(Zipname);
                //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "Frontiers", false, stage);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "Frontiers", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }

        public void Book_FrontiersNew(string CL)
        {
            string stage = "First Proof stage";
            DBClass Db = new DBClass();
            try
            {
                string Aid = "", JAcro = "", DD = "", Artcl_Status = "PE";

                SaveToReport("Status: Due date & Article Status with file movement update file for First Proof: " + Path.GetFileName(CL));
                if (Path.GetFileNameWithoutExtension(CL).Split('_').Length > 0)
                {
                    if (Path.GetFileNameWithoutExtension(CL).Split('_')[1].Split('-').Length > 0)
                    {
                        Aid = Path.GetFileNameWithoutExtension(CL).Split('_')[1].Split('-')[1].Replace(".", "");
                    }
                }

                if (CheckWhetherFileBooked(Aid))
                {
                    SaveToReport("Status:File movement for First Proof PE: " + Path.GetFileName(CL));
                    string Dupid = ReturnDetail("Artcl_ArticleId", "Article", Db, "Artcl_ArticleId='" + Aid + @"' and Artcl_status='PT' and Artcl_jrnlid in (select jrnl_id from journal where Jrnl_PublID=113)");
                    if (Dupid == "")
                    {
                        SendMail(Path.GetFileName(CL), "Dear Team,<Br/><Br/>Article not booked or not in PT @ First Proof stage", "Frontiers", true, stage, Path.GetFileName(CL));
                        SaveToReport("Article not booked or not in PT @ First Proof stage " + Path.GetFileName(CL));
                        Zipname = CL;
                        Clear();
                        return;
                    }
                    int tatdays = 0;

                    string jid = ReturnDetail("Artcl_jrnlId", "Article", Db, "Artcl_ArticleId='" + Aid + @"' and Artcl_jrnlid in (select jrnl_id from journal where Jrnl_PublID=113)");
                    JAcro = ReturnDetail("Jrnl_Acronym", "journal", Db, "Jrnl_PublID = '113' and Jrnl_Id=" + jid + @"");

                    tatdays = DownloadFrontiersEmailTAT(Aid, JAcro);

                    DateTime Artcl_ExpFromTIDt = new DateTime();
                    DateTime Artcl_ScheduledDt = new DateTime();
                    DateTime Artcl_DueDtCats = new DateTime();

                    if (tatdays != 0)
                    {
                        DD = CalculateDueDate("", Db, DateTime.Today, tatdays).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');

                        var culture = System.Globalization.CultureInfo.InvariantCulture;
                        DateTime ddate = DateTime.ParseExact(DD, "MM/dd/yyyy HH:mm:ss", culture);
                        Artcl_ExpFromTIDt = CalculateDueDate("", Db, DateTime.Today, tatdays - 2);
                        Artcl_ScheduledDt = CalculateDueDate("", Db, DateTime.Today, tatdays - 1);
                        Artcl_DueDtCats = CalculateDueDate("", Db, DateTime.Today, tatdays);
                    }
                    string TITU = "";
                    if (tatdays == 7) { TITU = "TI"; }
                    else if (tatdays == 9) { TITU = "TU"; }
                    string book = "SSP_FPArticlestusupdate 1,'" + Aid + @"','" + Artcl_Status + "'," + tatdays + ",'" + Artcl_DueDtCats.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Artcl_ScheduledDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + TITU + @"'";

                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    SaveToReport("Status: " + book);
                    SaveToReport("Status: Status Moved To PE Transaction Details for file: " + Path.GetFileName(CL));

                }
                else
                {
                    SendMail(Path.GetFileName(CL), "Dear Team,<Br/><Br/>First Proof stage article not found: ", "Frontiers", true, stage, CL);
                    SaveToReport("First Proof stage article not found for Frontiers: " + Path.GetFileName(CL));
                    Zipname = CL;
                    Clear();
                    return;
                }

                SaveToReport("Status:file moved to production datasupply folder: " + Path.GetFileName(CL) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(CL));
                if (Directory.Exists(Path.GetDirectoryName(CL) + @"\Successs\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                {
                    Directory.CreateDirectory(Path.GetDirectoryName(CL) + @"\Successs\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                }
                File.Copy(CL, Path.GetDirectoryName(CL) + @"\Successs\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(CL), true);
                File.Copy(CL, @"\\Techsetserver2\Journal\Frontiers\" + JAcro + @"\Articles\DataSupplied\" + Aid + @"\First Proof\" + Path.GetFileName(CL), true);
                ExtractZip(@"\\Techsetserver2\Journal\Frontiers\" + JAcro + @"\Articles\DataSupplied\" + Aid + @"\First Proof\" + Path.GetFileName(CL));
                File.Delete(CL);
                SendMail(Aid, "Dear Team,<Br/><Br/>Article PT status updated to PE successfully for file: " + Path.GetFileName(CL), "Frontiers", false, stage);
                SaveToReport("Process completed. File: " + Path.GetFileName(CL));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Path.GetFileName(CL), "Dear Team,<Br/><Br/>Error while Moving Due date & PE Status update file: " + Path.GetFileName(CL) + "<Br/>" + e.Message, "Frontiers", true, stage, Path.GetFileName(CL));
                SaveToReport("Error Moving Due date & PE Status update file: " + Path.GetFileName(CL) + "\n" + e.Message + "\n" + e.StackTrace);
                Zipname = CL;
                Clear();
            }
            finally { Db.CloseConnection(); }
        }

        public void Book_FrontiersAU(string CL, string f)
        {

            SaveToReport("AU Correction Bookin for" + f);
            string stage = "AU Correction";
            Zipname = f;
            string Aid = "";
            Aid = Path.GetFileNameWithoutExtension(Zipname).ToLower().Replace(".zip", "").Replace(".", "");
            SaveToReport("AU Correction Bookin for article id:" + f);
            try
            {

                if (CheckWhetherFileBooked(Aid))
                {
                    DBClass Db = new DBClass();
                    string jacro = Regex.Match(Aid.ToUpper(), @"^(([A-Z]*?)+)\d+$").Groups[1].Value;

                    if (jacro == "")
                    {
                        jacro = ReturnDetail("Jrnl_Acronym", "Journal", Db, "Jrnl_Id in (select artcl_jrnlid from article where artcl_articleid='" + Aid + "')");
                    }
                    DateTime dt = DateTime.Today;
                    if (dt.DayOfWeek == DayOfWeek.Sunday) dt = dt.AddDays(1);
                    string sche = AddDays(dt, Db, 2).ToString("MM/dd/yyyy");
                    string intdt1 = AddDays(dt, Db, 2).ToString("MM/dd/yyyy");
                    int tat = 2;
                    string Artcl_ExpFromTIDt = CalculateDueDate("FRONTIERS", Db, DateTime.Today, tat).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    string Artcl_ScheduledDt = CalculateDueDate("FRONTIERS", Db, DateTime.Today, tat).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    string Artcl_ReceivedDt = CalculateDueDate("FRONTIERS", Db, DateTime.Today, 0).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');


                    string uploaddate = ReturnDetail("Artcl_uploadedDt", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                    if (uploaddate == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "Frontiers", true, stage, Zipname);
                        SaveToReport("Artcl_uploadedDt not updated" + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }

                    SaveToReport("Status: Author Correction update JR_Main table file:" + Path.GetFileName(Zipname));
                    string Journalid = ReturnDetail("jrnl_id", "Journal", Db, "Jrnl_Acronym='" + jacro + "' and Jrnl_PublId = '113'");
                    if (Journalid == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for " + jacro + ": ", "Frontiers", true, stage, Zipname);
                        SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + jacro);
                        Clear();
                        return;
                    }
                    string Ojrmid = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, " JRM_ArticleID ='" + Aid + "' and JRM_JournalID ='" + Journalid + "'");
                    if (Ojrmid != "")
                    {
                        if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + Ojrmid + " AND JRST_JRS_ID=35") != "")
                        {
                            SendMail(Zipname, "Dear Team,<Br/><Br/>File already booked for AU Correction: ", "FRONTIERS", true, stage, Zipname);
                            SaveToReport("File already booked for AU Correction: " + Path.GetFileName(Zipname));
                            Clear();
                            return;
                        }
                    }

                    string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                    string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                    if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                    {
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: Author Correction update Jr_main Table file: " + Query);
                    }
                    JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                    JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                    //JR_Stage_Tran  
                    string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                    string JRA_ID = "";
                    string Sdate = CalculateDueDate("", Db, AddDays(DateTime.Now, Db, 2)).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    string AUTUStatus = "15";
                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35") == "")
                    {
                        Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','35','" + Artcl_ExpFromTIDt + "','" + Artcl_ReceivedDt + "','" + Artcl_ScheduledDt + "','" + Artcl_ScheduledDt + "','" + AUTUStatus + "',getdate(),'1','')";
                        SaveToReport("Status: Author Correction update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: Author Correction update JR_Articles Table file: " + Path.GetFileName(Zipname));
                        SaveToReport("Status: Author Correction update JR_Stage_Tran Table file: " + Query);

                        //JR_Articles 
                        JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','35',getdate(),'1')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: Author Correction update JR_Articles Table file: " + Query);
                        SaveToReport("Status: Author Correction update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));

                        //TrnsJournalRev 
                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction','Pending')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();

                        Query = @"UPDATE article SET Artcl_AUCorr_RecDT=getdate() Where Artcl_ArticleId='" + Aid + "'";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();

                        SaveToReport("Status: Author Correction update TrnsJournalRev Table file: " + Query);
                        SaveToReport("Status: Upload files to Author Correction file: " + Path.GetFileName(Zipname));

                        //-----
                        SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                        //Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                        if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                        {
                            Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                        }
                        File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                        //----

                        string Outpath = @"\\Techsetserver2\Journal\Frontiers\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\" + Path.GetFileName(Zipname);
                        File.Copy(Zipname, Outpath, true);

                        ExtractZip(Outpath);
                        File.Delete(f);

                        //SendMail(Aid, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for AU Correction stage file: " + Path.GetFileName(Zipname), "Frontiers", false, stage);
                        SaveToReport("Author Correction Booked with PT status successfully for this File: " + Path.GetFileName(Zipname));
                        int s = DownloadFrontiersEmailTAT(Aid, jacro, "AU");
                    }
                }
                else
                {
                    SaveToReport("First proof not booked but correction received. " + Path.GetFileName(Zipname));
                    SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>First proof not booked but correction received..", "Frontiers", true, stage, Zipname);
                    Clear();
                    return;
                }
            }
            catch (Exception e1)
            {
                SendMail(Zipname, "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e1.Message, "Frontiers", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e1.Message + "\n" + e1.StackTrace);
            }
        }

        public void Boo_FrontiersPAP(string CL, string f)
        {

            string stage = "PAP";
            Zipname = f;
            string Aid = Path.GetFileNameWithoutExtension(Zipname).Replace(".", "");
            try
            {
                if (CheckWhetherFileBooked(Aid))
                {
                    DBClass Db = new DBClass();
                    string jacro = Regex.Match(Aid.ToUpper(), @"^(([A-Z]*?)+)\d+$").Groups[1].Value;

                    if (jacro != "")
                    {
                        jacro = ReturnDetail("Jrnl_Acronym", "Journal", Db, "Jrnl_Id in (select artcl_jrnlid from article where artcl_articleid='" + Aid + "')");
                    }
                    DateTime dt = DateTime.Today;
                    if (dt.DayOfWeek == DayOfWeek.Sunday) dt = dt.AddDays(1);
                    string sche = AddDays(dt, Db, 2).ToString("MM/dd/yyyy");
                    string intdt1 = AddDays(dt, Db, 2).ToString("MM/dd/yyyy");
                    string uploaddate = ReturnDetail("Artcl_uploadedDt", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                    if (uploaddate == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>'Artcl_UploadedDt' not updated.", "Frontiers", true, stage, Zipname);
                        SaveToReport("Artcl_uploadedDt not updated" + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }

                    SaveToReport("Status: PAP update JR_Main table file:" + Path.GetFileName(Zipname));
                    string Journalid = ReturnDetail("jrnl_id", "Journal", Db, "Jrnl_Acronym='" + jacro + "' and Jrnl_PublId = '113'");
                    if (Journalid == "")
                    {
                        SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for " + jacro + ": ", "Frontiers", true, stage, Zipname);
                        SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n Journal ID missing for" + jacro);
                        Clear();
                        return;
                    }

                    string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                    string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,JRM_ArticleID,LastModifiedDate,UsrID,Insert_Date) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"','" + Aid + "',getdate(),'1',getdate())";
                    if (ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'") == "")
                    {
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: PAP update Jr_main Table file: " + Query);
                    }
                    JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID='" + Aid + "' AND JRM_JournalID='" + Journalid + "'");
                    JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                    //JR_Stage_Tran  
                    string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                    string JRA_ID = "";
                    string Sdate = CalculateDueDate("", Db, AddDays(DateTime.Now, Db, 2)).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    string id = "", AUTUStatus = "25";
                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=35") == "")
                    {
                        Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','35','" + Sdate + "',getdate(),'" + Sdate + "','" + Sdate + "','" + AUTUStatus + "',getdate(),'1','')";
                        SaveToReport("Status: PAP update JR_Stage_Tran Table file: " + Path.GetFileName(Zipname));
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: PAP update JR_Articles Table file: " + Path.GetFileName(Zipname));
                        SaveToReport("Status: PAP update JR_Stage_Tran Table file: " + Query);

                        //JR_Articles 
                        JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + AUTUStatus + "','35',getdate(),'1')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: PAP update JR_Articles Table file: " + Query);
                        SaveToReport("Status: PAP update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));


                        //TrnsJournalRev 
                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + AUTUStatus + "',getdate(),'1','AU Correction','Pending')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: PAP update TrnsJournalRev Table file: " + Query);
                        SaveToReport("Status: Upload files to PAP file: " + Path.GetFileName(Zipname));
                    }
                }
            }
            catch (Exception e1) { }
        }

        public void DownloadFrontiersEmail()
        {
            if (!Directory.Exists(Environment.CurrentDirectory + @"\Emails\Frontier")) Directory.CreateDirectory(Environment.CurrentDirectory + @"\Emails\Frontier");
            try
            {
                OpenPop.Pop3.Pop3Client pop = new OpenPop.Pop3.Pop3Client();
                //pop.Connect("pop3.live.com", 995, true);
                pop.Connect("pop.rediffmail.com", 995, true);
                //pop.Authenticate("parthiban@novatechset.com", "Parthi&2710");
                //pop.Authenticate("frontiers_booking@novatechset.com", "Run747961");
                pop.Authenticate("Neilakandan1@rediffmail.com", "Techset@123");
                //for (int i = 1; i <= pop.GetMessageCount(); i++)
                for (int i = pop.GetMessageCount() - 1; i > 0; i--)
                {
                    string sub = pop.GetMessage(i).Headers.Subject.ToString();
                    DateTime dt = pop.GetMessage(i).Headers.DateSent.Date;
                    if (dt.Date == DateTime.Now.Date || dt.Date == DateTime.Now.AddDays(-1).Date)
                    {
                        if (sub != "" && Regex.IsMatch(sub, "Frontiers: Article Production", RegexOptions.IgnoreCase))
                        {
                            string msg = "";
                            try
                            {
                                msg = pop.GetMessage(i).FindFirstHtmlVersion().GetBodyAsText();
                            }
                            catch (Exception e1)
                            {
                                if (msg == "")
                                {
                                    try
                                    {
                                        msg = pop.GetMessage(i).FindFirstPlainTextVersion().GetBodyAsText();
                                    }
                                    catch (Exception e11)
                                    {
                                        msg = "";
                                    }
                                }
                            }
                            if (msg == "") continue;
                            DBClass Db = new DBClass();
                            string doi = Regex.Match(msg, @"Article DOI:\s*(.*)", RegexOptions.IgnoreCase).Groups[1].Value;
                            string journal = Regex.Match(msg, @"Journal:\s*(.*)", RegexOptions.IgnoreCase).Groups[1].Value;
                            string field = Regex.Match(msg, @"Field:\s*(.*)", RegexOptions.IgnoreCase).Groups[1].Value;
                            string atype = Regex.Match(msg, @"Article type:\s*(.*)", RegexOptions.IgnoreCase).Groups[1].Value;
                            string title = Regex.Match(msg, @"Title:\s*(.*)", RegexOptions.IgnoreCase).Groups[1].Value;
                            string au = Regex.Match(msg, @"Authors:\s*(.*)", RegexOptions.IgnoreCase).Groups[1].Value;
                            string cepefp = Regex.Match(msg, @"requesttype:\s*(.*)", RegexOptions.IgnoreCase).Groups[1].Value;
                            string jid = "", jacro = "", atypeval = "";
                            if (doi != "" && field != "")
                            {
                                doi = doi.Replace("<br>", "").Trim();
                                journal = journal.Replace("<br>", "").Trim();
                                field = field.Replace("<br>", "").Trim();
                                atype = atype.Replace("<br>", "").Trim();
                                title = title.Replace("<br>", "").Trim();
                                au = au.Replace("<br>", "").Trim();
                                cepefp = cepefp.Replace("<br>", "").Trim();

                                journal = journal.Replace("'", "''").Trim();
                                field = field.Replace("'", "''").Trim();
                                atype = atype.Replace("'", "''").Trim();
                                title = title.Replace("'", "''").Trim();
                                au = au.Replace("'", "''").Trim();
                                cepefp = cepefp.Replace("'", "''").Trim();

                                string Aid = doi.Split('/')[doi.Split('/').Length - 1];
                                Aid = Aid.Replace(".", "");
                                if (Regex.IsMatch(field, "Surgery", RegexOptions.IgnoreCase)) { jid = "2323"; jacro = "FSURG"; }
                                if (Regex.IsMatch(field, "Nutrition", RegexOptions.IgnoreCase)) { jid = "2092"; jacro = "FNUT"; }
                                if (Regex.IsMatch(field, "Dental", RegexOptions.IgnoreCase)) { jid = "2336"; jacro = "FDMED"; }
                                if (Regex.IsMatch(field, "Digital", RegexOptions.IgnoreCase)) { jid = "2335"; jacro = "FDGTH"; }
                                if (Regex.IsMatch(field, "Allergy", RegexOptions.IgnoreCase)) { jid = "2334"; jacro = "FALGY"; }
                                if (Regex.IsMatch(field, "Rehabilitation Sciences", RegexOptions.IgnoreCase)) { jid = "2333"; jacro = "FRESC"; }
                                if (Regex.IsMatch(field, "Medical Technology", RegexOptions.IgnoreCase)) { jid = "2345"; jacro = "FMEDT"; }
                                if (Regex.IsMatch(field, "Reproductive Health", RegexOptions.IgnoreCase)) { jid = "2348"; jacro = "FRPH"; }

                                if (Regex.IsMatch(field, "Oral Health", RegexOptions.IgnoreCase)) { jid = "2343"; jacro = "FROH"; }
                                if (Regex.IsMatch(field, "Nuclear Medicine", RegexOptions.IgnoreCase)) { jid = "2344"; jacro = "FNUME"; }
                                if (Regex.IsMatch(field, "Pain Research", RegexOptions.IgnoreCase)) { jid = "2346"; jacro = "FPAIN"; }
                                if (Regex.IsMatch(field, "Radiology", RegexOptions.IgnoreCase)) { jid = "2347"; jacro = "FRADI"; }


                                if (Regex.IsMatch(field, "Reproductive Health", RegexOptions.IgnoreCase)) { jid = "2348"; jacro = "FRPH"; }
                                if (Regex.IsMatch(field, "Pediatrics", RegexOptions.IgnoreCase)) { jid = "2357"; jacro = "FPED"; }
                                if (Regex.IsMatch(field, "Global Women''s Health", RegexOptions.IgnoreCase)) { jid = "2358"; jacro = "FGWH"; }
                                if (Regex.IsMatch(field, "Sports and Active living", RegexOptions.IgnoreCase)) { jid = "2380"; jacro = "FSPOR"; }
                                if (Regex.IsMatch(field, "Child and Adolescent Psychiatry", RegexOptions.IgnoreCase)) { jid = "2381"; jacro = "FRCHA"; }
                                if (Regex.IsMatch(field, "Epidemiology", RegexOptions.IgnoreCase)) { jid = "2382"; jacro = "FEPID"; }
                                if (Regex.IsMatch(field, "Health Services", RegexOptions.IgnoreCase)) { jid = "2383"; jacro = "FRHS"; }
                                if (Regex.IsMatch(field, "Transplantation", RegexOptions.IgnoreCase)) { jid = "2384"; jacro = "FRTRA"; }

                                if (doi != "" && jid != "" && Aid != "" && !CheckWhetherFileBooked(Aid))
                                {
                                    int tat = 4;
                                    DateTime Artcl_ExpFromTIDt = new DateTime();
                                    DateTime Artcl_ScheduledDt = new DateTime();
                                    DateTime artcl_CEDuedate = new DateTime();
                                    DateTime artcl_PEDuedate = new DateTime();
                                    DateTime Artcl_ScheduledSGML = new DateTime();
                                    string DD = CalculateDueDate("", Db, DateTime.Today, tat).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                                    var culture = System.Globalization.CultureInfo.InvariantCulture;
                                    DateTime ddate = DateTime.ParseExact(DD, "MM/dd/yyyy HH:mm:ss", culture);
                                    Artcl_ExpFromTIDt = CalculateAIPExpFromTIDt("AIP", Db, ddate);
                                    Artcl_ScheduledDt = Artcl_ExpFromTIDt;
                                    Artcl_ExpFromTIDt = CalculateAIPExpFromTIDt("AIP", Db, Artcl_ExpFromTIDt);
                                    if (atype != "") atypeval = ReturnDetail("ArtType_ID", "ArticleTypes", Db, "ArtType_Name='" + atype.Replace("'", "''") + "'");
                                    if (atype != "" && atypeval == "")
                                    {
                                        SaveToReport("Status: Article Type -- " + atype);
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand("INSERT INTO ArticleTypes VALUES('" + atype + "',GETDATE(),1,NULL)", Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: " + "INSERT INTO ArticleTypes VALUES('" + atype + "',GETDATE(),1,NULL)");
                                        atypeval = ReturnDetail("ArtType_ID", "ArticleTypes", Db, "ArtType_Name='" + atype.Replace("'", "''") + "'");
                                    }
                                    string book = @"insert into Article(Artcl_JrnlId,Artcl_ArticleId,Artcl_DOI,Artcl_Title,Artcl_AuthorName,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_FolderCreated,Artcl_Status,Artcl_ArtType,Artcl_ExpFromTIDt,Artcl_DueDtCats,artcl_CEDuedate,artcl_PEDuedate,Artcl_SpecInst) values('" + jid + @"','" + Aid.ToLower() + @"','" + doi + @"','" + title + @"','" + au + @"',getdate(),'" + Artcl_ScheduledDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','0','PT','" + atypeval + "','" + Artcl_ExpFromTIDt.ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/') + @"','" + DD + @"',null,null,'" + journal + @"')";
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book, Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    Db.SqlReader.Close();
                                    SaveToReport("Status: " + book);
                                    SaveToReport("Status: Update Transaction Details for file: " + Path.GetFileName(Zipname));
                                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Select Artcl_Id From Article WITH(NOLOCK) Where Artcl_ArticleId = '" + Aid + "'", Db.GetConnection());
                                    Db.OpenConnection();
                                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                    if (Db.SqlReader.Read())
                                    {
                                        Int64 aaid = Convert.ToInt64(Db.SqlReader[0]);
                                        Db.SqlReader.Close();
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand("Insert into TrnsJournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) values(" + @"'" + aaid + @"','1','Admin',getdate(),getdate(),'14','Completed','15','Article','Auto Entry',getdate(),1,'Pending')", Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                    }
                                    pop.GetMessage(i).Save(new System.IO.FileInfo(@"D:\WatchTXT\" + Aid + "_" + sub.Replace(":", "").Replace("\t", "") + ".eml"));
                                    File.WriteAllText(@"D:\WatchTXT\" + Aid + @"_HsEml.txt", @"D:\WatchTXT\" + Aid + "_" + sub.Replace(":", "").Replace("\t", "") + @".eml~\\Techsetserver2\Journal\Frontiers\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\First Proof\" + Aid + "_" + sub.Replace(":", "").Replace("\t", "") + @".eml");
                                    //File.Copy(@"D:\WatchTXT\" + Aid + "_" + sub.Replace(":", "").Replace("\t", "") + ".eml", @"\\Techsetserver2\Journal\Frontiers\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\First Proof\" + Aid + "_" + sub.Replace(":", "").Replace("\t", "") + @".eml",true);
                                    pop.DeleteMessage(i);
                                    SendMail(Aid, "Dear Team,<Br/><Br/>Frontiers Booking: Article ID:" + Aid + "<Br/>DOI:" + doi + "<Br/>Status: PT", "Frontiers", false, "First Proof");
                                    SaveToReport("Process completed. File: " + Aid);
                                    try
                                    {
                                        string book1 = "SSP_EmailNotification '', '" + Aid + "' ,'" + jacro + "' , '" + field + "', '" + sub.Replace("'", "''") + "' , '' ,'' , '" + msg.Replace("'", "''") + "'";
                                        SaveToReport("Process completed. File: " + book1);
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book1, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                    }
                                    catch (Exception e)
                                    {
                                        SaveToReport("Process completed. File: " + e.Message);
                                    }

                                }
                            }
                            //SaveToReport("Process completed. File: " + Aid);
                        }
                    }
                    else break;
                }
                pop.Disconnect();
            }
            catch (Exception e)
            {
                //SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while OUP hanshake update: <Br/>" + e.Message + "<Br/>" + e.StackTrace, "OUP", true, "FP", Zipname);
                SaveToReport("Error while Frontiers hanshake update::  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
            }
        }

        public void DownloadFrontiersEmailDelete()
        {

            string TOF = "", doi = "", journal = "", field = "", msg = "";
            if (!Directory.Exists(Environment.CurrentDirectory + @"\Emails\Frontier")) Directory.CreateDirectory(Environment.CurrentDirectory + @"\Emails\Frontier");
            try
            {
                OpenPop.Pop3.Pop3Client pop = new OpenPop.Pop3.Pop3Client();
                pop.Connect("pop3.live.com", 995, true);
                pop.Authenticate("frontiers_booking@novatechset.com", "Run747961");
                for (int i = pop.GetMessageCount() - 1; i > 0; i--)
                {
                    string sub = pop.GetMessage(i).Headers.Subject.ToString();
                    DateTime dt = pop.GetMessage(i).Headers.DateSent.Date;
                    SaveToReport("Email Subject " + sub);
                    if (sub != "" && Regex.IsMatch(sub, "^(Frontiers: Article Production|Frontiers: Author's Proof Corrections Submitted|Frontiers: Author's Proof Corrections Submitted|Frontiers: New Files Assigned|Frontiers: Files Submitted|Frontiers: Request for Another Author's Proof|Frontiers: Author's Proof Approved|Frontiers: New Comments in Private Proof Discussion|Frontiers: New Comments in Proof Discussion)$", RegexOptions.IgnoreCase)) { }
                    else
                    {

                        SaveToReport("Email Subject " + sub);

                        try
                        {
                            msg = pop.GetMessage(i).FindFirstHtmlVersion().GetBodyAsText();
                        }
                        catch (Exception e1)
                        {
                            SaveToReport("Download Frontiers email delete msg e1" + e1.Message);
                            if (msg == "")
                            {
                                try
                                {
                                    msg = pop.GetMessage(i).FindFirstPlainTextVersion().GetBodyAsText();
                                }
                                catch (Exception e2)
                                {
                                    SaveToReport("Download Frontiers email delete msg e2" + e2.Message);
                                    msg = "";
                                }
                            }
                        }
                        if (msg == "") continue;
                        DBClass Db = new DBClass();
                        //TOF = Regex.Match(msg, @"@TOF:\s*(.*)", RegexOptions.IgnoreCase).Groups[1].Value;
                        doi = Regex.Match(msg, @"Article DOI:\s*(.*)", RegexOptions.IgnoreCase).Groups[1].Value;
                        journal = Regex.Match(msg, @"Journal:\s*(.*)", RegexOptions.IgnoreCase).Groups[1].Value;
                        field = Regex.Match(msg, @"Field:\s*(.*)", RegexOptions.IgnoreCase).Groups[1].Value;
                        SaveToReport("journal:" + journal + " field:" + field + " doi:" + doi);

                        pop.GetMessage(i).Save(new System.IO.FileInfo(@"D:\WatchTXTDel\" + i + "_" + sub.Replace(":", "").Replace("\t", "") + ".eml"));
                        pop.DeleteMessage(i);
                        if (doi != "")
                        {
                            doi = doi.Replace("<br>", "").Trim();
                            string Aid = doi.Split('/')[doi.Split('/').Length - 1];
                            Aid = Aid.Replace(".", "");
                            string jid = ReturnDetail("Artcl_jrnlId", "Article", Db, "Artcl_ArticleId='" + Aid + @"' and Artcl_jrnlid in (select jrnl_id from journal where Jrnl_PublID=113)");
                            string JAcro = ReturnDetail("Jrnl_Acronym", "journal", Db, "Jrnl_PublID = '113' and Jrnl_Id=" + jid);

                            SaveToReport("Aid " + Aid);
                            SaveToReport("jacro " + JAcro);

                            try
                            {
                                string book1 = "SSP_EmailNotification '', '" + Aid + "' ,'" + JAcro + "' , '" + field + "', '" + sub.Replace("'", "''") + "' , '' ,'' , '" + msg.Replace("'", "''") + "'";
                                SaveToReport("Process completed. File: " + book1);
                                Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book1, Db.GetConnection());
                                Db.OpenConnection();
                                Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                Db.SqlReader.Close();
                            }
                            catch (Exception e)
                            {
                                SaveToReport("Error while Frontiers hanshake update::  " + e.Message + @"\n" + e.StackTrace);
                            }
                        }
                    }
                }
                pop.Disconnect();
            }
            catch (Exception e)
            {
                SaveToReport("Error while Frontiers hanshake update::  " + e.Message + @"\n" + e.StackTrace);
            }
        }

        public void DownloadGeoEmail()
        {
            DBClass Db = new DBClass();
            try
            {
                OpenPop.Pop3.Pop3Client pop = new OpenPop.Pop3.Pop3Client();
                try
                {
                    pop.Connect("pop3.live.com", 995, true);
                    //pop.Authenticate("parthiban@novatechset.com", "Parthi#2710");
                    pop.Authenticate("geolsocteam@novatechset.com", "G60l5o20!9");
                }
                catch (Exception ed)
                {
                    SaveToReport(ed.Message + @"\n" + ed.StackTrace);
                    return;
                }
                for (int i = pop.GetMessageCount(); i >= 1; i--)
                {
                    string sub = pop.GetMessage(i).Headers.Subject.ToString();
                    DateTime dt = pop.GetMessage(i).Headers.DateSent.Date;
                    if (dt.Date == DateTime.Now.Date)
                    {
                        //if (sub.Contains("ready for upload to HWX") && sub.Split('-').Length > 2)
                        if (sub.Contains("ready for upload to Atypon") && sub.Split('-').Length > 2)
                        {
                            string chap = sub.Split('-')[1] + '-' + sub.Split('-')[2];
                            chap = Regex.Replace(chap.Trim(), @"(R\d+\s*)ready for upload to Atypon", "", RegexOptions.IgnoreCase);
                            if (ReturnDetail("chapter_id", "Chapter", Db, "chapter_chapno='" + chap + "'") != "")
                            {
                                if (ReturnDetail("BRST_ID", "BR_Main,BR_Stage_Tran", Db, "BRST_BRM_ID=BRM_ID and  BRM_ChapterNo='" + chap + "' and BRST_BRS_ID='25'") == "" && !File.Exists(@"\\techsetserver2\Download\GEODownload\NewPAP\" + chap + ".txt"))
                                {
                                    pop.GetMessage(i).Save(new System.IO.FileInfo(@"\\techsetserver2\Download\GEODownload\NewPAP\" + chap + ".eml"));
                                    if (sub.Contains("minor amends"))
                                    {
                                        File.WriteAllText(@"\\techsetserver2\Download\GEODownload\NewPAP\" + chap + ".txt", "PAP Received with Minor Amends");
                                    }
                                    else
                                    {
                                        File.WriteAllText(@"\\techsetserver2\Download\GEODownload\NewPAP\" + chap + ".txt", "");
                                    }
                                    SaveToReport("Process completed. File: " + chap);
                                }
                            }
                            //else
                            //{
                            //    System.Net.Mail.MailMessage MM = new System.Net.Mail.MailMessage("tiworkflow@novatechset.com", "geolsocteam@novatechset.com", "GEO PAP Booking Error", @"Dear Team,<Br/><Br/>Chapter not found for PAP booking. " + chap + "<Br/>Regards,<Br/>TechSupport.");
                            //    MM.CC.Add("tiworkflow@novatechset.com");
                            //    MM.To.Add("prodnasst_books@novatechset.com");
                            //    System.Net.Mail.SmtpClient client = new System.Net.Mail.SmtpClient(SerializedClass.MailServer);
                            //    MM.IsBodyHtml = true;
                            //    client.Send(MM);
                            //}
                        }
                    }
                    else
                    {
                        pop.Disconnect();
                        return;
                    }
                }
                pop.Disconnect();
            }
            catch (Exception e)
            {
                System.Net.Mail.MailMessage MM = new System.Net.Mail.MailMessage("tiworkflow@novatechset.com", "tiworkflow@novatechset.com", "GEO PAP Booking Error", @"Dear Team,<Br/><Br/>" + e.Message + @"\n" + e.StackTrace + "<Br/>Regards,<Br/>TechSupport.");
                System.Net.Mail.SmtpClient client = new System.Net.Mail.SmtpClient(SerializedClass.MailServer);
                MM.IsBodyHtml = true;
                client.Send(MM);
                SaveToReport("GEO PAP mail:  " + e.Message + @"\n" + e.StackTrace);
            }
        }

        public void DownloadEmail()
        {
            if (!Directory.Exists(Environment.CurrentDirectory + @"\Emails")) Directory.CreateDirectory(Environment.CurrentDirectory + @"\Emails");
            try
            {
                OpenPop.Pop3.Pop3Client pop = new OpenPop.Pop3.Pop3Client();
                try
                {
                    pop.Connect("pop3.live.com", 995, true);
                    //pop.Authenticate("parthiban@novatechset.com", "Parthi#2710");
                    pop.Authenticate("tsautoabcats@novatechset.com", "Techset@1234");
                }
                catch (Exception ed)
                {
                    SaveToReport(ed.Message + @"\n" + ed.StackTrace);
                    return;
                }
                for (int i = 1; i <= pop.GetMessageCount(); i++)
                {
                    if (pop.GetMessage(i).Headers.Subject.ToString().Contains("To Keyboarder, Job"))
                    {
                        pop.GetMessage(i).Save(new System.IO.FileInfo(Environment.CurrentDirectory + @"\Emails\" + pop.GetMessage(i).Headers.Subject.Replace(":", "") + ".eml"));
                        for (int j = 0; j < pop.GetMessage(i).FindAllAttachments().ToList().Count; j++)
                        {
                            pop.GetMessage(i).FindAllAttachments().ToList()[j].Save(new System.IO.FileInfo(Environment.CurrentDirectory + @"\Emails\" + pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName));
                            string fname = pop.GetMessage(i).FindAllAttachments().ToList()[j].FileName;
                            SaveToReport("Status: Processing AbCATS " + fname);
                            string body = pop.GetMessage(i).FindFirstPlainTextVersion().GetBodyAsText();
                            if (body == "")
                            {
                                body = pop.GetMessage(i).FindFirstHtmlVersion().GetBodyAsText();
                            }
                            string dd = Regex.Match(body, @"due\s*date\s*:\s*([a-zA-Z0-9-]*)", RegexOptions.IgnoreCase).Groups[1].Value;
                            string Url = Regex.Match(body, @"URL\s*:\s*([^\s]*)", RegexOptions.IgnoreCase).Groups[1].Value;
                            if (Url != "") Url = Url.Replace(@"'", @"''");
                            XDocument XDoc = new XDocument();
                            try
                            {
                                XDoc = XDocument.Parse(File.ReadAllText(Environment.CurrentDirectory + @"\Emails\" + fname).Replace("&", "&amp;"), LoadOptions.PreserveWhitespace);
                            }
                            catch (Exception e)
                            {
                                SendMail(fname, "Dear Team,<Br/><Br/>Error while ABCats: <Br/>" + e.Message + "<Br/>" + e.StackTrace, "TNF_Abs", true, "FP", fname);
                                SaveToReport("XML file is not valid for:  " + Path.GetFileName(fname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                                //Clear();
                                ////Directory.Delete(Path.GetDirectoryName(Zipname) + @"\" + Path.GetFileNameWithoutExtension(Zipname), true);
                                continue;
                            }
                            string Job_ID = "", Title = "", Volume = "", Issue = "", ABS_Count = "";
                            if (XDoc.XPathSelectElements(@"//ArticleSet").Count() > 0) Job_ID = XDoc.XPathSelectElements(@"//ArticleSet").First().Attributes("id").First().Value;
                            if (XDoc.XPathSelectElements(@"//JournalTitle").Count() > 0) Title = XDoc.XPathSelectElements(@"//JournalTitle").First().Value;
                            if (XDoc.XPathSelectElements(@"//Volume").Count() > 0) Volume = XDoc.XPathSelectElements(@"//Volume").First().Value;
                            if (XDoc.XPathSelectElements(@"//Issue").Count() > 0) Issue = XDoc.XPathSelectElements(@"//Issue").First().Value;
                            if (XDoc.XPathSelectElements(@"//ArticleSet/Article").Count() > 0) ABS_Count = XDoc.XPathSelectElements(@"//ArticleSet/Article").Count().ToString();
                            DBClass Db = new DBClass();
                            if (ReturnDetail("Job_ID", "TnF_Abstract", Db, "Job_ID='" + Job_ID + "'") != "")
                            {
                                SendMail(fname, "Dear Team,<Br/><Br/>File already booked for ABCats: <Br/>" + fname, "TNF_Abs", true, "FP", fname);
                                SaveToReport("File already booked for ABCats:  " + Path.GetFileName(fname));
                                continue;
                            }
                            string book = "insert into TnF_Abstract(Job_ID,Journal_Title,Volume,Issue,Abstracts_Count,LastModifieddate,Receiveddate,Status,Start_Time,End_Time,Due_Date,URL) values('" + Job_ID + @"','" + Title.Replace("'", "''") + @"','" + Volume + @"','" + Issue + "','" + ABS_Count + "',getdate(),getdate(),'Booked',getdate(),getdate(),'" + dd + @"','" + Url + "')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: Processing AbCATS " + book);
                            SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Successfully booked ABCats: <Br/>" + fname + "<Br/>", "TNF_Abs", false, "FP", fname);
                            File.Copy(Environment.CurrentDirectory + @"\Emails\" + fname, @"\\techsetserver2\Final Web Data\AbCats\Received\ABCATS-source\" + fname, true);
                            pop.GetMessage(i).Save(new System.IO.FileInfo(@"\\techsetserver2\Final Web Data\AbCats\Received\ABCATS-source\" + pop.GetMessage(i).Headers.Subject.Replace(":", "") + ".eml"));
                            SaveToReport("Process completed. File: " + fname);
                        }
                    }
                    pop.DeleteMessage(i);
                }
                pop.Disconnect();
            }
            catch (Exception e)
            {
                SendMail(Path.GetFileName(Zipname), "Dear Team,<Br/><Br/>Error while ABCats: <Br/>" + e.Message + "<Br/>" + e.StackTrace, "TNF_Abs", true, "FP", Zipname);
                SaveToReport("XML file is not valid for:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
            }
        }
        //***
        public void Book_CUPRevises(string xlloc, string CL, string zippack = "")
        {
            bool skipbook = false;
            cupjrnl = ""; cuppmjrnl = false;
            if (File.Exists(Path.GetDirectoryName(xlloc) + @"\" + Path.GetFileNameWithoutExtension(xlloc) + ".txt"))
            {
                skipbook = true;
                File.Delete(Path.GetDirectoryName(xlloc) + @"\" + Path.GetFileNameWithoutExtension(xlloc) + ".txt");
            }
            string stage = "Revises 1";
            DBClass Db = new DBClass();
            System.Collections.ArrayList ArticleID = new System.Collections.ArrayList();
            System.Collections.ArrayList PIIDOI = new System.Collections.ArrayList();
            string volume = "", issue = "", PII = "", Journalid = "", coll = "", jacro = ""; int totpages = 0;
            Zipname = xlloc;
            if (zippack != "")
            {
                Zipname = zippack;
                if (ReturnDetail("isnull(Jrnl_User,'') as id", "journal", Db, "Jrnl_PublID='8' and Jrnl_Acronym='" + Path.GetFileNameWithoutExtension(zippack).Split('_')[0] + "'") != "")
                {
                    cuppmjrnl = true; cupjrnl = Path.GetFileNameWithoutExtension(zippack).Split('_')[0];
                }
            }
            try
            {
                if (Regex.IsMatch(Path.GetExtension(xlloc).ToLower(), @"\.xls"))
                {
                    SaveToReport("Status: Processing excel file: " + xlloc);
                    SerializedClass.p.Statusupdate("Status: Collecting data from excel file: " + xlloc);
                    SaveToReport("Status: Collecting data from excel file: " + xlloc);
                    Xl.Workbook xlWorkBook;
                    Xl.Worksheet xlWorkSheet;
                    Xl.Application xlapp;
                    xlapp = new Xl.Application();
                    xlapp.Visible = false;
                    xlWorkBook = xlapp.Workbooks.Open(xlloc);
                    xlWorkSheet = (Xl.Worksheet)xlWorkBook.Sheets[1];
                    int lastRow = xlWorkSheet.Cells.SpecialCells(Xl.XlCellType.xlCellTypeLastCell).Row;
                    System.Array MyValues = (System.Array)xlWorkSheet.get_Range("A1", "X" + lastRow.ToString()).Cells.Value;
                    int ros = MyValues.GetLength(0);
                    int cos = MyValues.GetLength(1);
                    xlapp.Quit();
                    xlapp = null;
                    GC.Collect();
                    GC.WaitForPendingFinalizers();
                    //xlapp = new Xl.Application();
                    //xlapp.Visible = false;
                    //object misValue = System.Reflection.Missing.Value;
                    //xlWorkBook = xlapp.Workbooks.Add(misValue);
                    //xlWorkSheet = (Xl.Worksheet)xlWorkBook.Worksheets.get_Item(1);
                    //for (int i = 1; i <= ros; i++)
                    //{
                    //    System.Threading.Thread.Sleep(2000);
                    //    for (int j = 1; j <= cos; j++)
                    //    {
                    //        if (MyValues.GetValue(i, j) != null)
                    //        {
                    //            xlWorkSheet.Cells[i, j] = MyValues.GetValue(i, j).ToString();
                    //        }
                    //    }
                    //}
                    foreach (Process P in Process.GetProcessesByName("EXCEL"))
                    {
                        try
                        {
                            P.Kill();
                        }
                        catch (Exception e) { }
                    }
                    //if (MyValues.GetValue(1, 6).ToString().ToLower() != "volumeno")
                    if (MyValues.GetValue(1, 7).ToString().ToLower() != "volumeno")
                    {
                        SendMail(Zipname, "Dear Team,<Br/><Br/>Unable to pick volumeNo. Please check its position in excel.", "CUP", true, stage, Zipname);
                        SaveToReport("Unable to pick volumeNo. Please check its position in excel: " + Path.GetFileName(Zipname));
                        SerializedClass.p.Statusupdate("Unable to pick volumeNo. Please check its position in excel:: " + xlloc);
                        //Move to Error
                        Clear();
                        return;
                    }
                    //else if (MyValues.GetValue(1, 7).ToString().ToLower() != "issueno")
                    else if (MyValues.GetValue(1, 8).ToString().ToLower() != "issueno")
                    {
                        SendMail(Zipname, "Dear Team,<Br/><Br/>Unable to pick issueNo. Please check its position in excel.", "CUP", true, stage, Zipname);
                        SaveToReport("Unable to pick issueNo. Please check its position in excel: " + Path.GetFileName(Zipname));
                        SerializedClass.p.Statusupdate("Unable to pick issueNo. Please check its position in excel: " + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    //else if (MyValues.GetValue(1, 8).ToString().ToLower() != "no of printed pages in the article")
                    else if (MyValues.GetValue(1, 9).ToString().ToLower() != "no of printed pages in the article")
                    {
                        SendMail(Zipname, "Dear Team,<Br/><Br/>Unable to pick pages. Please check its position in excel.", "CUP", true, stage, Zipname);
                        SaveToReport("Unable to pick Pages. Please check its position in excel: " + Path.GetFileName(Zipname));
                        SerializedClass.p.Statusupdate("Unable to pick Pages. Please check its position in excel: " + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    //else if (MyValues.GetValue(1, 22).ToString().ToLower() != "pii_new4display")
                    else if (MyValues.GetValue(1, 23).ToString().ToLower() != "pii_new4display")
                    {
                        SendMail(Zipname, "Dear Team,<Br/><Br/>Unable to PII_New4Display. Please check its position in excel.", "CUP", true, stage, Zipname);
                        SaveToReport("Unable to pick PII_New4Display. Please check its position in excel: " + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    for (int i = 2; i <= ros; i++)
                    {
                        //PII = MyValues.GetValue(i, 22).ToString();
                        //if (PII != "" && !PIIDOI.Contains(PII)) PIIDOI.Add(PII);
                        //if (volume == "") volume = MyValues.GetValue(i, 6).ToString();
                        //if (issue == "") issue = MyValues.GetValue(i, 7).ToString();

                        PII = MyValues.GetValue(i, 23).ToString();
                        if (PII != "" && !PIIDOI.Contains(PII)) PIIDOI.Add(PII);
                        if (volume == "") volume = MyValues.GetValue(i, 7).ToString();
                        if (issue == "") issue = MyValues.GetValue(i, 8).ToString();
                        if (PII != "")
                        {
                            SerializedClass.p.Statusupdate("Status: Fetch Article details " + PII);
                            SaveToReport("Status: Fetch Article details " + PII);
                            string Aid = ReturnDetail("Artcl_ArticleId", "Article", Db, "Artcl_DOI='" + PII + @"' or Artcl_PII='" + PII + @"' and charindex('_',Artcl_ArticleId)=0");
                            if (Journalid == "") Journalid = ReturnDetail("Artcl_JrnlId", "Article", Db, "Artcl_DOI='" + PII + @"' or Artcl_PII='" + PII + @"' and charindex('_',Artcl_ArticleId)=0");
                            if (Aid != "" && !ArticleID.Contains(Aid.ToUpper()))
                            {
                                Aid = Aid.ToUpper();
                                ArticleID.Add(Aid);
                                if (MyValues.GetValue(i, 4) == null) coll += Aid + ':' + "" + ':' + PII + ':' + "" + '~';
                                else coll += Aid + ':' + "" + ':' + PII + ':' + MyValues.GetValue(i, 4).ToString() + '~';
                            }
                            if (MyValues.GetValue(i, 8) != null) totpages += Convert.ToInt32(MyValues.GetValue(i, 8).ToString());
                        }

                    }
                }
                else if (Path.GetExtension(xlloc).ToLower() == ".xml")
                {
                    try
                    {
                        XDocument XDoc = new XDocument();
                        try
                        {
                            XDoc = XDocument.Parse(File.ReadAllText(xlloc).Replace(" & ", " &amp; ").Replace(@" xmlns=""http://www.filemaker.com/fmpdsoresult""", ""), LoadOptions.PreserveWhitespace);
                        }
                        catch (Exception e)
                        {
                            SendMail(Zipname, "Dear Team,<Br/><Br/>Error while issue booking CUP: <Br/>" + e.Message + "<Br/>" + e.StackTrace, "CUP", true, "FP", Zipname);
                            SaveToReport("XML file is not valid for:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                            Clear();
                            return;
                        }
                        if (XDoc.XPathSelectElements(@"//mnemonic").Count() > 0) jacro = XDoc.XPathSelectElements(@"//mnemonic").ToList().First().Value;
                        if (jacro != "") jacro = jacro.ToUpper();
                        if (jacro == "")
                        {
                            SendMail(Zipname, "Dear Team,<Br/><Br/>Journal acronym not found: <Br/>", "CUP", true, "FP", Zipname);
                            SaveToReport("Journal acronym not found:  " + Path.GetFileName(Zipname));
                            Clear();
                            return;
                        }
                        Journalid = ReturnDetail("Jrnl_id", "journal", Db, "Jrnl_PublID='8' and Jrnl_Acronym='" + jacro + "'");
                        if (Journalid == "")
                        {
                            Journalid = ReturnDetail("Jrnl_id", "journal", Db, "Jrnl_PublID='8' and Jrnl_Acronym='" + jacro + "CUP'");
                            if (Journalid != "") jacro = jacro + "CUP";
                        }
                        foreach (XElement e in XDoc.XPathSelectElements(@"//ROW").ToList())
                        {
                            PII = e.XPathSelectElements("PII_New4Display").ToList().First().Value;
                            string atype = e.XPathSelectElements("article_category").ToList().First().Value;
                            if (PII != "" && !Regex.IsMatch(atype.ToLower(), "(front cover and matter|back cover and matter|front cover matter|back cover matter|front matter|back matter)"))
                            {
                                SerializedClass.p.Statusupdate("Status: Fetch Article details " + PII);
                                SaveToReport("Status: Fetch Article details " + PII);
                                if (PII != "" && !PIIDOI.Contains(PII)) PIIDOI.Add(PII);
                                string Aid = ReturnDetail("Artcl_ArticleId", "Article", Db, "Artcl_DOI='" + PII + @"' or Artcl_PII='" + PII + @"' and charindex('_',Artcl_ArticleId)=0");
                                if (volume == "") volume = e.XPathSelectElements("volumeNo").ToList().First().Value;
                                if (issue == "") issue = e.XPathSelectElements("issueNo").ToList().First().Value;
                                string Article_no = "";
                                if (e.XPathSelectElements("Article_no").Count() > 0) Article_no = e.XPathSelectElements("Article_no").ToList().First().Value;
                                if (Journalid == "") Journalid = ReturnDetail("Artcl_JrnlId", "Article", Db, "Artcl_DOI='" + PII + @"' or Artcl_PII='" + PII + @"' and charindex('_',Artcl_ArticleId)=0");
                                if (Aid != "" && !ArticleID.Contains(Aid.ToUpper()))
                                {
                                    Aid = Aid.ToUpper();
                                    ArticleID.Add(Aid);
                                    coll += Aid + ':' + Article_no + ':' + PII + ':' + e.XPathSelectElements("author").ToList().First().Value + '~';
                                }
                                if (e.XPathSelectElements("no_of_printed_pages_in_the_article").Count() > 0 && e.XPathSelectElements("no_of_printed_pages_in_the_article").ToList().First().Value != "") totpages += Convert.ToInt32(e.XPathSelectElements("no_of_printed_pages_in_the_article").ToList().First().Value);
                            }
                            else if (PII != "" && Regex.IsMatch(atype.ToLower(), "(front cover and matter|back cover and matter|front cover matter|back cover matter|front matter|back matter)"))
                            {
                                SerializedClass.p.Statusupdate("Status: Fetch Article details " + PII);
                                SaveToReport("Status: Fetch Article details " + PII);
                                if (PII != "" && !PIIDOI.Contains(PII)) PIIDOI.Add(PII);
                                string Aid = ReturnDetail("Artcl_ArticleId", "Article", Db, "Artcl_DOI='" + PII + @"' or Artcl_PII='" + PII + @"' and charindex('_',Artcl_ArticleId)=0");
                                if (volume == "") volume = e.XPathSelectElements("volumeNo").ToList().First().Value;
                                if (issue == "") issue = e.XPathSelectElements("issueNo").ToList().First().Value;
                                string Article_no = "";
                                if (e.XPathSelectElements("Article_no").Count() > 0) Article_no = e.XPathSelectElements("Article_no").ToList().First().Value;
                                if (Journalid == "") Journalid = ReturnDetail("Artcl_JrnlId", "Article", Db, "Artcl_DOI='" + PII + @"' or Artcl_PII='" + PII + @"' and charindex('_',Artcl_ArticleId)=0");
                                if (Aid != "" && !ArticleID.Contains(Aid.ToUpper()))
                                {
                                    Aid = Aid.ToUpper();
                                    ArticleID.Add(Aid);
                                    coll += Aid + ':' + Article_no + ':' + PII + ':' + "" + '~';
                                }
                                else if (Aid == "" && Regex.IsMatch(PII, @"(\d{7})(\d|[A-Za-z])$"))
                                {
                                    Aid = jacro + Regex.Match(PII, @"(\d{7})(\d|[A-Za-z])$").Groups[1].Value;
                                    Aid = Aid.ToUpper();
                                    if (!ArticleID.Contains(Aid.ToUpper()))
                                    {
                                        if (volume == "")
                                        {
                                            SendMail(Zipname, "Dear Team,<Br/><Br/>Volume not found: <Br/>", "CUP", true, stage, Zipname);
                                            SaveToReport("Journal acronym not found:  " + Path.GetFileName(Zipname));
                                            Clear();
                                            return;
                                        }
                                        if (Journalid == "")
                                        {
                                            SendMail(Zipname, "Dear Team,<Br/><Br/>Journal not found: " + jacro + " <Br/>", "CUP", true, stage, Zipname);
                                            SaveToReport("Journal acronym not found:  " + Path.GetFileName(Zipname));
                                            Clear();
                                            return;
                                        }
                                        if (issue == "") issue = "1";
                                        ArticleID.Add(Aid);
                                        coll += Aid + ':' + Article_no + ':' + PII + ':' + "" + '~';
                                        SaveToReport("Status: insert dummy FP entry article table " + Aid);
                                        string Query = "insert into article(Artcl_JrnlId,artcl_articleid,Artcl_Volume,Artcl_Issue,Artcl_UploadedDt,Artcl_Status,LastModifiedDate,UsrID,Artcl_Comments,Artcl_ArtType,Artcl_DOI,Artcl_Title,Artcl_ReceivedDt,Complexity,Artcl_AuthorName,Artcl_TextFolios,Artcl_PII) values('" + Journalid + "','" + Aid + "','" + volume + "','" + issue + "',getdate(),'UL',GETDATE(),'1','Auto BookIn Entry for Issue Received Article.','733','" + PII + "','" + atype + "',GETDATE(),'none','n/a','4','" + PII + "') ";
                                        if (Regex.IsMatch(atype.ToLower(), "(back cover and matter|back cover matter|back matter)"))
                                        {
                                            Query = "insert into article(Artcl_JrnlId,artcl_articleid,Artcl_Volume,Artcl_Issue,Artcl_UploadedDt,Artcl_Status,LastModifiedDate,UsrID,Artcl_Comments,Artcl_ArtType,Artcl_DOI,Artcl_Title,Artcl_ReceivedDt,Complexity,Artcl_AuthorName,Artcl_TextFolios,Artcl_PII) values('" + Journalid + "','" + Aid + "','" + volume + "','" + issue + "',getdate(),'UL',GETDATE(),'1','Auto BookIn Entry for Issue Received Article.','734','" + PII + "','" + atype + "',GETDATE(),'none','n/a','4','" + PII + "') ";
                                        }
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: " + Query + Aid);
                                        SaveToReport("Status: insert dummy FP entry trnsjournal table " + Aid);
                                        string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                                        Query = "Insert into trnsjournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) Values(" + artid + ",1,'Administration',getdate(),getdate(),'14','Completed','33','Earticle closing','Auto Entry',getdate(),1,'Pending')";
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                        SaveToReport("Status: " + Query + " " + Aid);
                                    }
                                }
                            }
                        }
                    }

                    catch (Exception e)
                    {
                        SendMail(Zipname, "Dear Team,<Br/><Br/>Error while issue booking CUP: <Br/>" + e.Message + "<Br/>" + e.StackTrace, "CUP", true, stage, Zipname);
                        SaveToReport("XML file is not valid for:  " + Path.GetFileName(Zipname) + @"\n" + e.Message + @"\n" + e.StackTrace);
                        Clear();
                        return;
                    }
                }
                if (jacro == "")
                {
                    jacro = ReturnDetail("Jrnl_Acronym", "journal", Db, "Jrnl_id=" + Journalid);
                    if (jacro == "")
                    {
                        SendMail(Zipname, "Dear Team,<Br/><Br/>Journal acronym not found: <Br/>", "CUP", true, stage, Zipname);
                        SaveToReport("Journal acronym not found:  " + Path.GetFileName(Zipname));
                        Clear();
                        return;
                    }
                    else jacro = jacro.ToUpper();
                }
                if (Journalid == "")
                {
                    Journalid = ReturnDetail("Jrnl_id", "journal", Db, "Jrnl_PublID='8' and Jrnl_Acronym='" + jacro + "CUP'");
                    if (Journalid != "") jacro = jacro + "CUP";
                }
                if (Journalid == "")
                {
                    SendMail(Zipname, "Dear Team,<Br/><Br/>Journal not found: " + jacro + " <Br/>", "CUP", true, stage, Zipname);
                    SaveToReport("Journal acronym not found:  " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
                if (volume == "")
                {
                    SendMail(Zipname, "Dear Team,<Br/><Br/>Volume not found: <Br/>", "CUP", true, stage, Zipname);
                    SaveToReport("Journal acronym not found:  " + Path.GetFileName(Zipname));
                    Clear();
                    return;
                }
                if (issue == "") issue = "1";
                if (ReturnDetail("isnull(Jrnl_User,'') as id", "journal", Db, "Jrnl_id=" + Journalid) != "")
                {
                    cuppmjrnl = true; cupjrnl = jacro;
                }
                if (!skipbook)
                {
                    string JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                    string Query = "INSERT INTO JR_Main(JRM_Id,JRM_JournalID,LastModifiedDate,UsrID,Insert_Date, JRM_Volume, JRM_Issue) Values('" + (Convert.ToInt64(JRM_Id) + 1) + @"','" + Journalid + @"',getdate(),'1',getdate(),'" + volume + "','" + issue + "')";
                    JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                    if (JRM_Id == "")
                    {
                        JRM_Id = ReturnDetail("max(JRM_Id) as id", "JR_Main", Db, "");
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                    }
                    JRM_Id = ReturnDetail("JRM_Id", "JR_Main", Db, "JRM_ArticleID is null AND JRM_JournalID='" + Journalid + "' AND JRM_Volume='" + volume + "' AND JRM_Issue='" + issue + "'");
                    JRM_Id = Convert.ToString((Convert.ToInt64(JRM_Id) - 1));
                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran", Db, "JRST_JRM_ID=" + (Convert.ToInt64(JRM_Id) + 1) + " AND JRST_JRS_ID=38") != "")
                    {
                        SendMail(Zipname, "Dear Team,<Br/><Br/>File already booked for Revises 1: ", "CUP", true, stage, Zipname);
                        SaveToReport("File already booked for Revises 1: " + Path.GetFileName(Zipname));
                        SerializedClass.p.Statusupdate("File already booked for Revises 1: " + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    if (!Regex.IsMatch(jacro.ToUpper(), @"^(WPTCUP|JCT|SSR)$"))
                    {
                        if (!ArticleID.Contains(jacro + '_' + volume + '_' + issue + "_Cover")) ArticleID.Add(jacro + '_' + volume + '_' + issue + "_Cover");
                        if (!Regex.IsMatch(jacro.ToUpper(), @"^(PRM|PAR|PSM|OPR|ENG|NTS|ASS|ASO|BJA|BJI|JLO|BEC|JCL|ASO|PEM|JWE|LEG|CLM|MBI|ANS|MGM|DAR|LST)$"))
                        {
                            if (!ArticleID.Contains(jacro + '_' + volume + '_' + issue + "_Content")) ArticleID.Add(jacro + '_' + volume + '_' + issue + "_Content");
                        }
                    }
                    Db.Sqladptr = new SqlDataAdapter(new SqlCommand("select Artcl_ArticleId from Article where  Artcl_JrnlId=" + Journalid + " and Artcl_Volume='" + volume + "' and Artcl_Issue='" + issue + "' and charindex('_',Artcl_ArticleId)=0", Db.GetConnection()));
                    Db.dt = new DataTable();
                    Db.Sqladptr.Fill(Db.dt);
                    Db.CloseConnection();
                    DataSet ds = new DataSet("New_DataSet");
                    ds.Tables.Add(Db.dt);
                    var rows = ds.Tables[0].Rows;
                    string volisserr = "";
                    foreach (DataRow Aid1 in rows)
                    {
                        if (!ArticleID.Contains(Aid1[0]))
                        {
                            volisserr += Aid1[0] + "<Br/>";
                        }
                    }
                    if (volisserr != "")
                    {
                        SendMail(Zipname, "Dear Team,<Br/><Br/>Article in our database under this volume issue not included in issue make up file: <Br/>" + volisserr, "CUP", true, stage, Zipname);
                        SaveToReport("Article in our database under this volume issue not included in issue make up file: <Br/>" + volisserr + Path.GetFileName(Zipname));
                        SerializedClass.p.Statusupdate("Error Revises 1: " + Path.GetFileName(Zipname));
                        //Move to Error
                        Clear();
                        return;
                    }
                    int tat = 1;
                    string NFV = ReturnDetail("isnull(Jrnl_INVCategory,'') as id", "journal", Db, "Jrnl_PublID='8' and Jrnl_Acronym='" + jacro + "'");
                    if (NFV != "" && NFV.ToLower() == "non-first view")
                    {
                        tat = 2;
                    }
                    if (jacro.ToUpper() == "CAR") tat = 3;
                    if (Regex.IsMatch(jacro.ToUpper(), "^(JRS|JAS|AQY|BRI)$")) tat = 2;
                    if (ReturnDetail("isnull(Jrnl_UploadType,'') as id", "journal", Db, "Jrnl_id=" + Journalid) == "EditGenie")
                    {
                        foreach (string Aid1 in ArticleID)
                        {
                            if (!Aid1.Contains('_') && ReturnDetail("Artcl_Comments", "Article", Db, " Artcl_JrnlId=" + Journalid + " and Artcl_ArticleId='" + Aid1 + "'") != "Auto BookIn Entry for Issue Received Article.")
                            {
                                if (ReturnDetail("JRST_ID", "JR_Stage_Tran,JR_Main", Db, "JRM_ArticleID='" + Aid1 + "' AND JRM_JournalID='" + Journalid + "' AND JRST_JRM_ID=JRM_ID AND JRST_JRS_ID=35") != "")
                                {
                                    if (ReturnDetail("JRST_ID", "JR_Stage_Tran,JR_Main", Db, "JRM_ArticleID='" + Aid1 + "' AND JRM_JournalID='" + Journalid + "' AND JRST_JRM_ID=JRM_ID AND JRST_JRS_ID=35 AND isnull(JRST_UploadedDT,'')=''") != "")
                                    {
                                        SendMail(Zipname, "Dear Team,<Br/><Br/>EG article: Author Correction not uploaded yet but Revises requested: <Br/>" + Aid1, "CUP", true, stage, Zipname);
                                        SaveToReport("EG article: Author Correction not uploaded yet but Revises requested: <Br/>" + Aid1 + Path.GetFileName(Zipname));
                                        SerializedClass.p.Statusupdate("Error Revises 1: " + Path.GetFileName(Zipname));
                                        //Move to Error
                                        Clear();
                                        return;
                                    }
                                }
                                else
                                {
                                    SendMail(Zipname, "Dear Team,<Br/><Br/>EG article Author not submitted yet. Author Correction not booked but Revises requested: <Br/>" + Aid1, "CUP", true, stage, Zipname);
                                    SaveToReport("EG article Author not submitted yet. Author Correction not booked but Revises requested: <Br/>" + Aid1 + Path.GetFileName(Zipname));
                                    SerializedClass.p.Statusupdate("Error Revises 1: " + Path.GetFileName(Zipname));
                                    //Move to Error
                                    Clear();
                                    return;

                                }
                            }
                        }
                    }
                    //string Artcl_ExpFromTIDt = CalculateDueDate("AIP", Db, DateTime.Today, 1).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    //string Artcl_ScheduledDt = CalculateDueDate("AIP", Db, DateTime.Today, 2).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    string Artcl_ExpFromTIDt = CalculateDueDate("AIP", Db, DateTime.Today, tat - 1).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    string Artcl_ScheduledDt = CalculateDueDate("AIP", Db, DateTime.Today, tat).ToString("MM/dd/yyyy hh:mm:ss").Replace('-', '/');
                    string JRS_Id = ReturnDetail("max(JRST_ID) as id", "JR_Stage_Tran", Db, "");
                    string sts = "102";
                    if (jacro.ToUpper() == "MTO") sts = "17";
                    //Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','38','" + Artcl_ScheduledDt + "',getdate(),'" + Artcl_ScheduledDt + "','" + Artcl_ExpFromTIDt + "','17',getdate(),'1','')";
                    Query = "Insert into JR_Stage_Tran(JRST_ID,JRST_JRM_ID, JRST_JRS_ID, JRST_DueDtCats, JRST_ReceivedDt, JRST_ScheduledDt,JRST_ExpectedDt,JRST_Status, LastModifiedDate,UsrID,JRST_SmartRemarks) Values('" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + (Convert.ToInt64(JRM_Id) + 1) + @"','38','" + Artcl_ScheduledDt + "',getdate(),'" + Artcl_ScheduledDt + "','" + Artcl_ExpFromTIDt + "','" + sts + "',getdate(),'1','')";
                    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                    Db.OpenConnection();
                    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                    Db.SqlReader.Close();
                    foreach (string Aid1 in ArticleID)
                    {
                        string Aid = Aid1;
                        SerializedClass.p.Statusupdate("Booking: Article " + Aid);
                        if (!CheckWhetherFileBooked(Aid))
                        {
                            SaveToReport("Status: insert dummy FP entry article table " + Aid);
                            Query = "insert into article(Artcl_JrnlId,artcl_articleid,Artcl_Volume,Artcl_Issue,Artcl_UploadedDt,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_Status,Inv_OtherTypesetter) values('" + Journalid + "','" + Aid + "','" + volume + "','" + issue + "',getdate(),getdate(),getdate(),'UL','Y')";
                            if (Regex.IsMatch(Aid.ToLower(), "_(cover|content)")) Query = "insert into article(Artcl_JrnlId,artcl_articleid,Artcl_Volume,Artcl_Issue,Artcl_UploadedDt,Artcl_ReceivedDt,Artcl_ScheduledDt,Artcl_Status) values('" + Journalid + "','" + Aid + "','" + volume + "','" + issue + "',getdate(),getdate(),getdate(),'UL')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: " + Query + Aid);
                            SaveToReport("Status: insert dummy FP entry trnsjournal table " + Aid);
                            string artid = ReturnDetail("Artcl_Id", "Article", Db, "Artcl_ArticleId = '" + Aid + @"'");
                            Query = "Insert into trnsjournal(JrnlTrns_ArticleID,JrnlTrns_Emp,JrnlTrns_Dept,JrnlTrns_Intime,JrnlTrns_Outtime,JrnlTrns_ProcessCd,JrnlTrns_Status,JrnlTrns_NextProcessID,JrnlTrns_Jtype,JrnlTrns_Remarks,LastModifiedDate,UsrID,Jrnltrns_processtype) Values(" + artid + ",1,'Administration',getdate(),getdate(),'14','Completed','33','Earticle closing','Auto Entry',getdate(),1,'Pending')";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: " + Query + " " + Aid);
                        }
                        string uploaddate = ReturnDetail("Artcl_UploadedDt", "Article", Db, "Artcl_ArticleId='" + Aid + @"'");
                        if (uploaddate == "")
                        {
                            SaveToReport("Status: Update uploaded date status article table " + Aid);
                            Query = "update Article set Artcl_UploadedDt=getdate(),Artcl_Status='UL' where Artcl_ArticleId='" + Aid + @"'";
                            Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                            Db.OpenConnection();
                            Db.SqlReader = Db.SqlCmd.ExecuteReader();
                            Db.SqlReader.Close();
                            SaveToReport("Status: " + Query + " " + Aid);
                        }
                        //JR_Articles 
                        string JRA_ID = ReturnDetail("max(JRA_ID) as id", "JR_Articles", Db, "");
                        //Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','17','38',getdate(),'1')";
                        Query = "Insert into JR_Articles(JRA_ID,JRA_JRST_ID,JRA_ArticleID ,JRA_Status,JRA_StageID,LastModifiedDate,UsrID) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','" + (Convert.ToInt64(JRS_Id) + 1) + @"','" + Aid + @"','" + sts + "','38',getdate(),'1')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query + Path.GetFileName(Zipname));
                        SaveToReport("Status: Revises 1 update TrnsJournalRev Table file: " + Path.GetFileName(Zipname));
                        //TrnsJournalRev 
                        //Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','17',getdate(),'1','Revises 1','Pending')";
                        Query = "INSERT into TrnsJournalRev(JrnlTrns_ArticleId,JrnlTrns_Emp ,JrnlTrns_Dept,JrnlTrns_InTime ,JrnlTrns_OutTime,JrnlTrns_ProcessCd ,JrnlTrns_Status,JrnlTrns_Remarks,JrnlTrns_NextProcessID ,LastModifiedDate ,UsrID ,JrnlTrns_JType,Jrnltrns_processtype) Values('" + (Convert.ToInt64(JRA_ID) + 1) + @"','1','Administration',getdate(),getdate(),'14','Completed','Auto Entry','" + sts + "',getdate(),'1','Revises 1','Pending')";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query + Path.GetFileName(Zipname));
                        SaveToReport("Status: revises 1 update Article Table file: " + Path.GetFileName(Zipname));
                        Query = "update Article set Artcl_Volume='" + volume + "',Artcl_Issue='" + issue + "' where Artcl_ArticleId='" + Aid + @"'";
                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(Query, Db.GetConnection());
                        Db.OpenConnection();
                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                        Db.SqlReader.Close();
                        SaveToReport("Status: " + Query + " " + Path.GetFileName(Zipname));
                        System.Threading.Thread.Sleep(1500);
                    }
                    SaveToReport("Status: Moving Booked file: " + Path.GetFileName(Zipname) + " to " + CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\" + Path.GetFileNameWithoutExtension(Zipname));
                    if (Directory.Exists(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin") == false)
                    {
                        Directory.CreateDirectory(CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin");
                    }
                    File.Copy(Zipname, CL + @"\" + SerializedClass.month + @"\" + SerializedClass.Date + @"\Bookedin\" + Path.GetFileName(Zipname), true);
                    //string Outpath = @"\\Techsetserver2\Journal\CUP\" + jacro + @"\ISSUE\" + volume + "-" + issue + @"\DataSupplied\Revises 1\" + Path.GetFileName(Zipname);
                    //if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) CreateTxtfile(Zipname, Outpath, "", "CUP", "Revises 1", "", "", "");
                    //else File.Copy(Zipname, Outpath, true);
                    //File.Copy(Zipname, @"D:\WatchTXT\" + Path.GetFileName(Zipname), true);
                    //File.WriteAllText(@"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(Zipname) + @".txt", @"D:\WatchTXT\" + Path.GetFileName(Zipname) + @"~" + Outpath);
                    //Booking End         
                    SerializedClass.p.Statusupdate("Booking: Process Completed ");
                }
                string Outpath = @"\\Techsetserver2\Journal\CUP\" + jacro + @"\ISSUE\" + volume + "-" + issue + @"\DataSupplied\Revises 1\" + Path.GetFileName(Zipname);
                //if (!File.Exists(Outpath))
                //{
                //    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) { CreateTxtfile(Zipname, Outpath, "", "CUP", "Revises 1", "", "", ""); System.Threading.Thread.Sleep(60000); }
                //    else File.Copy(Zipname, Outpath, true);
                //}       
                CreateTxtfile(Zipname, Outpath, "", "CUP", "Revises 1", "", "", "");
                System.Threading.Thread.Sleep(60000);
                string SourcePath = "", destpath = "";
                string temp = @"\\techsetserver2\Journal\CUP\";// @"D:\Journal\CUP\";
                while (!Directory.Exists(temp + jacro + @"\ISSUE\" + volume + "-" + issue + @"\Pagination\"))
                {
                    System.Threading.Thread.Sleep(60000);
                }
                try
                {
                    SerializedClass.p.Statusupdate("Art: Processing Figures");
                    //string JournalAcronym = ReturnDetail("Jrnl_Acronym", "Journal", Db, "Jrnl_Id='" + Journalid + @"'");      
                    try
                    {
                        if (Directory.Exists(@"\\techsetserver2\Journal\CUP\" + jacro + @"\Articles\Pagination\Art"))
                        {
                            SourcePath = @"\\techsetserver2\Journal\CUP\" + jacro + @"\Articles\Pagination\Art";
                        }
                        string[] a = { "DLS", "ERM", "JAN", "JNS", "MBDCUP", "NGB", "PAX", "SIP", "AIE", "IJA", "HYG", "GRH", "LIN", "CLJ", "AGR", "WPTCUP", "GMH", "COR" };
                        string[] imgFiles, imgWebFiles, epsFiles, epsWebFiles, imgArtFiles, epsArtFiles;
                        if (!a.Contains(jacro))
                        {
                            if (!Directory.Exists(temp + jacro + @"\ISSUE\" + volume + "-" + issue + @"\Pagination\Art\Webfiles"))
                            {
                                Directory.CreateDirectory(temp + jacro + @"\ISSUE\" + volume + "-" + issue + @"\Pagination\Art\Webfiles");
                            }
                        }
                        else if (Directory.Exists(SourcePath + @"\Webfiles"))
                        {
                            SendMail(Zipname, "Dear Team,<Br/><Br/>Files are not copied. Because Webfiles folder exists in Article Pagination Art folder. ", "CUP", true, stage, Zipname);
                            SaveToReport("Files are not copied. Because Webfiles folder exists in Article Pagination Art folder." + Path.GetFileName(Zipname));
                            //Move to Error
                            Clear();
                            return;
                        }
                        destpath = temp + jacro + @"\ISSUE\" + volume + "-" + issue + @"\Pagination\Art";
                        if (!Directory.Exists(destpath))
                        {
                            Directory.CreateDirectory(destpath);
                        }
                        foreach (string name in PIIDOI)
                        {
                            SerializedClass.p.Statusupdate("Art: Processing Figures " + name);
                            if (!a.Contains(jacro))
                            {
                                imgWebFiles = Directory.GetFiles(SourcePath + @"\Webfiles", name + "*.tif");
                                if (imgWebFiles.Length > 0)
                                {
                                    for (int i = 0; i < imgWebFiles.Length; i++)
                                    {
                                        if (File.Exists(SourcePath + @"\" + Path.GetFileName(imgWebFiles[i])))
                                        {
                                            if (File.GetLastWriteTime(SourcePath + @"\" + Path.GetFileName(imgWebFiles[i])) < File.GetLastWriteTime(imgWebFiles[i]))
                                            {
                                                SaveToReport("Date of Webfile is greater." + imgWebFiles[i] + " " + name);
                                                continue;
                                            }
                                            System.Drawing.Image currimage = System.Drawing.Image.FromFile(imgWebFiles[i]);
                                            System.Drawing.Image Arcurrimage = System.Drawing.Image.FromFile(SourcePath + @"\" + Path.GetFileName(imgWebFiles[i]));

                                            if (currimage.PixelFormat != System.Drawing.Imaging.PixelFormat.Format24bppRgb)
                                            {
                                                SaveToReport("Color Mode of Web File " + imgWebFiles[i] + " is incorrect." + " " + name);
                                                continue;
                                            }
                                            if (currimage.PhysicalDimension != Arcurrimage.PhysicalDimension)
                                            {
                                                SaveToReport("Figure Dimension for " + imgWebFiles[i] + " is differed." + " " + name);
                                                continue;
                                            }
                                            currimage.Dispose();
                                            Arcurrimage.Dispose();
                                            File.Copy(SourcePath + @"\" + Path.GetFileName(imgWebFiles[i]), destpath + @"\" + Path.GetFileName(imgWebFiles[i]), true);
                                            SaveToReport("Status: " + "file copy: " + SourcePath + @"\" + Path.GetFileName(imgWebFiles[i]) + " to " + destpath + @"\" + Path.GetFileName(imgWebFiles[i]));
                                            File.Copy(imgWebFiles[i], destpath + @"\Webfiles\" + Path.GetFileName(imgWebFiles[i]), true);
                                            SaveToReport("file copy: " + imgWebFiles[i] + " to " + destpath + @"\Webfiles\" + Path.GetFileName(imgWebFiles[i]));
                                            File.Delete(imgWebFiles[i]);
                                        }
                                        else
                                        {
                                            SaveToReport("Art file not availabe, Only web file present. " + name + "  " + Path.GetFileName(Zipname));
                                            continue;
                                        }
                                    }
                                }
                                else
                                {
                                    SaveToReport("There is no tif files in local folder. " + Path.GetFileName(Zipname));
                                }
                                imgArtFiles = System.IO.Directory.GetFiles(SourcePath, name + "*.tif");
                                for (int i1 = 0; i1 < imgArtFiles.Length; i1++)
                                {
                                    File.Copy(imgArtFiles[i1], destpath + @"\" + Path.GetFileName(imgArtFiles[i1]), true);
                                    SaveToReport("Status: " + "file copy: " + imgArtFiles[i1] + " to " + destpath + @"\" + Path.GetFileName(imgArtFiles[i1]));
                                    File.Delete(imgArtFiles[i1]);
                                }

                                epsWebFiles = Directory.GetFiles(SourcePath + @"\Webfiles", name + "*.eps");
                                if (epsWebFiles.Length > 0)
                                {
                                    for (int i = 0; i < epsWebFiles.Length; i++)
                                    {
                                        if (File.Exists(SourcePath + @"\" + Path.GetFileName(epsWebFiles[i])))
                                        {
                                            if (File.GetLastWriteTime(SourcePath + @"\" + Path.GetFileName(epsWebFiles[i])) < File.GetLastWriteTime(epsWebFiles[i]))
                                            {
                                                SaveToReport("Date of Webfile is greater." + epsWebFiles[i] + " " + name);
                                                continue;
                                            }
                                            string[] s = File.ReadAllLines(SourcePath + @"\" + Path.GetFileName(epsWebFiles[i]));
                                            string[] s1 = File.ReadAllLines(epsWebFiles[i]);
                                            bool dim = false;
                                            foreach (string l in s)
                                            {
                                                if (l.Contains("BoundingBox"))
                                                {
                                                    foreach (string m in s1)
                                                    {
                                                        if (m.Contains("BoundingBox"))
                                                        {
                                                            if (m != l)
                                                            {
                                                                SaveToReport("Figure Dimension for " + epsWebFiles[i] + " is differed." + " " + name);
                                                                dim = true;
                                                            }
                                                            break;
                                                        }
                                                    }
                                                    break;
                                                }
                                            }
                                            if (dim) continue;
                                            File.Copy(SourcePath + @"\" + Path.GetFileName(epsWebFiles[i]), destpath + @"\" + Path.GetFileName(epsWebFiles[i]), true);
                                            SaveToReport("Status: " + "file copy: " + SourcePath + @"\" + Path.GetFileName(epsWebFiles[i]) + " to " + destpath + @"\" + Path.GetFileName(epsWebFiles[i]));
                                            File.Copy(epsWebFiles[i], destpath + @"\Webfiles\" + Path.GetFileName(epsWebFiles[i]), true);
                                            SaveToReport("Status: " + "file copy: " + epsWebFiles[i] + " to " + destpath + @"\Webfiles\" + Path.GetFileName(epsWebFiles[i]));
                                            File.Delete(epsWebFiles[i]);
                                        }
                                        else
                                        {
                                            SaveToReport("Art file not availabe, Only web file present. " + name + "  " + Path.GetFileName(Zipname));
                                            continue;
                                        }
                                    }
                                }
                                else
                                {
                                    SaveToReport("There is no EPS  files in local folder. " + Path.GetFileName(Zipname));
                                }
                                epsArtFiles = System.IO.Directory.GetFiles(SourcePath, name + "*.eps");
                                for (int i1 = 0; i1 < epsArtFiles.Length; i1++)
                                {
                                    File.Copy(epsArtFiles[i1], destpath + @"\" + Path.GetFileName(epsArtFiles[i1]), true);
                                    SaveToReport("Status: " + "file copy: " + epsArtFiles[i1] + " to " + destpath + @"\" + Path.GetFileName(epsArtFiles[i1]));
                                    File.Delete(epsArtFiles[i1]);
                                }
                            }
                            else if (jacro == "ORX")
                            {
                                imgArtFiles = Directory.GetFiles(SourcePath, name.Replace("-", "") + "*.tif");
                                if (imgArtFiles.Length > 0)
                                {
                                    for (int i = 0; i < imgArtFiles.Length; i++)
                                    {
                                        System.Drawing.Image currimage = System.Drawing.Image.FromFile(imgArtFiles[i]);
                                        if (Convert.ToInt16(currimage.PixelFormat) == 8207 && currimage.PixelFormat != System.Drawing.Imaging.PixelFormat.Format8bppIndexed)
                                        {
                                            SaveToReport("Color Mode of Art File " + imgArtFiles[i] + " is incorrect." + " " + name);
                                            continue;
                                        }
                                        currimage.Dispose();
                                        File.Copy(imgArtFiles[i], destpath + @"\" + Path.GetFileName(imgArtFiles[i]), true);
                                        SaveToReport("Status: " + "file copy: " + imgArtFiles[i] + " to " + destpath + @"\" + Path.GetFileName(imgArtFiles[i]));
                                        File.Delete(imgArtFiles[i]);
                                    }
                                }

                                else
                                {
                                    SaveToReport("There is no tif cmyk,Gray/mono  files in local folder. " + Path.GetFileName(Zipname));
                                }
                            }
                            else
                            {
                                imgWebFiles = Directory.GetFiles(SourcePath, name.Replace("-", "") + "*.tif");
                                epsFiles = System.IO.Directory.GetFiles(SourcePath, name + "*.eps");
                                if (imgWebFiles.Length > 0)
                                {
                                    for (int i = 0; i < imgWebFiles.Length; i++)
                                    {
                                        System.Drawing.Image currimage = System.Drawing.Image.FromFile(imgWebFiles[i]);
                                        if (Convert.ToInt16(currimage.PixelFormat) == 8207)
                                        {
                                            SaveToReport("Color Mode of cmyk File " + imgWebFiles[i] + " is incorrect." + " " + name);
                                            continue;
                                        }
                                        currimage.Dispose();
                                        File.Copy(imgWebFiles[i], destpath + Path.GetFileName(imgWebFiles[i]), true);
                                        SaveToReport("Status: " + "file copy: " + imgWebFiles[i] + " to " + destpath + @"\" + Path.GetFileName(imgWebFiles[i]));
                                        File.Delete(imgWebFiles[i]);
                                    }
                                }

                                else
                                {
                                    SaveToReport("There is no tif cmyk files in local folder. " + Path.GetFileName(Zipname));
                                }
                                if (epsFiles.Length > 0)
                                {
                                    for (int i = 0; i < epsFiles.Length; i++)
                                    {
                                        File.Copy(epsFiles[i], destpath + Path.GetFileName(epsFiles[i]), true);
                                        SaveToReport("Status: " + "file copy: " + epsFiles[i] + " to " + destpath + @"\" + Path.GetFileName(epsFiles[i]));
                                        File.Delete(epsFiles[i]);
                                    }
                                }

                                else
                                {
                                    SaveToReport("There is no eps file for this article in ArtFolder. " + name);
                                }
                            }
                        }
                    }
                    catch (Exception e1)
                    {
                        SendMail(Zipname, "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e1.Message, "CUP", true, stage, Zipname);
                        SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e1.Message + "\n" + e1.StackTrace);
                    }
                    SerializedClass.p.Statusupdate("Art: Processing Figures completed.");
                    SerializedClass.p.Statusupdate("Source file: Processing 3D files");
                    SourcePath = @"\\techsetserver2\Journal\CUP\" + jacro + @"\Articles\Pagination\";
                    destpath = temp + jacro + @"\ISSUE\" + volume + "-" + issue + @"\Pagination\";
                    if (!Directory.Exists(destpath))
                    {
                        Directory.CreateDirectory(destpath);
                    }
                    foreach (string name in PIIDOI)
                    {
                        SerializedClass.p.Statusupdate("Art: Processing 3D files " + name);
                        string[] F3DFiles = Directory.GetFiles(SourcePath, name.Replace("-", "") + "*.3D");
                        for (int i = 0; i < F3DFiles.Length; i++)
                        {
                            if (!Regex.IsMatch(Path.GetFileNameWithoutExtension(F3DFiles[i]), "(jra|jrv|jsc|jer|jab|jad|jbr|jbk|jed|jsc|jme|jlp|jxx)$", RegexOptions.IgnoreCase)) continue;
                            File.Copy(F3DFiles[i], destpath + Path.GetFileName(F3DFiles[i]), true);
                            SaveToReport("Status: " + "File copy: " + F3DFiles[i] + " to " + " " + destpath + Path.GetFileName(F3DFiles[i]));
                            File.Delete(F3DFiles[i]);
                        }
                        F3DFiles = System.IO.Directory.GetFiles(SourcePath, name + "*.3D");
                        for (int i = 0; i < F3DFiles.Length; i++)
                        {
                            if (!Regex.IsMatch(Path.GetFileNameWithoutExtension(F3DFiles[i]), "(jra|jrv|jsc|jer|jab|jad|jbr|jbk|jed|jsc|jme|jlp|jxx)$", RegexOptions.IgnoreCase)) continue;
                            File.Copy(F3DFiles[i], destpath + Path.GetFileName(F3DFiles[i]), true);
                            SaveToReport("Status: " + "File copy: " + F3DFiles[i] + " to " + " " + destpath + Path.GetFileName(F3DFiles[i]));
                            File.Delete(F3DFiles[i]);
                        }
                    }
                    SerializedClass.p.Statusupdate("Source file: Processing 3D files completed");
                }
                catch (Exception e1)
                {
                    SendMail(Zipname, "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e1.Message, "CUP", true, stage, Zipname);
                    SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e1.Message + "\n" + e1.StackTrace);
                }
                SerializedClass.p.Statusupdate("Source file: Generating IPS excel sheet");
                XLClass xl = new XLClass();
                coll = Regex.Replace(coll, "~$", "");
                //if (!Directory.Exists(temp + jacro + @"\ISSUE\" + volume + "-" + issue + @"\PDF\"))
                //{
                //    Directory.CreateDirectory(temp + jacro + @"\ISSUE\" + volume + "-" + issue + @"\PDF\");
                //}
                if (File.Exists(temp + jacro + @"\ISSUE\" + volume + "-" + issue + @"\PDF\" + jacro + "_" + volume + "_" + issue + "_IPS.xlsx"))
                {
                    File.Copy(temp + jacro + @"\ISSUE\" + volume + "-" + issue + @"\PDF\" + jacro + "_" + volume + "_" + issue + "_IPS.xlsx", temp + jacro + @"\ISSUE\" + volume + "-" + issue + @"\PDF\" + jacro + "_" + volume + "_" + issue + "_IPS_Old.xlsx", true);
                    File.Delete(temp + jacro + @"\ISSUE\" + volume + "-" + issue + @"\PDF\" + jacro + "_" + volume + "_" + issue + "_IPS.xlsx");
                }
                xl.GenerateIPSCUPXL(jacro, coll.Split('~'), volume, issue, totpages, temp + jacro + @"\ISSUE\" + volume + "-" + issue + @"\PDF\" + jacro + "_" + volume + "_" + issue + "_IPS.xlsx", Db, new CommonClass());
                SerializedClass.p.Statusupdate("Source file: Generating IPS excel sheet completed");
                File.Delete(Zipname);
                if (zippack != "" && Directory.Exists(Zipname.ToLower().Replace(".zip", ""))) Directory.Delete(Zipname.ToLower().Replace(".zip", ""), true);
                //SendMail(jacro + "_" + volume + "_" + issue, "Dear Team,<Br/><Br/>AutoBooking information updated successfully for file: " + Path.GetFileName(Zipname), "CUP", false, stage);
                SaveToReport("Process completed. File: " + Path.GetFileName(Zipname));
                SerializedClass.p.Statusupdate("Process completed. File: " + Path.GetFileName(Zipname));
                //System.Windows.Forms.MessageBox.Show("CUP Issue booking process completed for: " + Path.GetFileName(Zipname));
            }
            catch (Exception e)
            {
                Db.CloseConnection();
                SendMail(Zipname, "Dear Team,<Br/><Br/>Error while booking file: " + Path.GetFileName(Zipname) + "<Br/>" + e.Message, "CUP", true, stage, Zipname);
                SaveToReport("Error while booking file: " + Path.GetFileName(Zipname) + "\n" + e.Message + "\n" + e.StackTrace);
                //Move to Error
                Clear();
            }
            finally { Db.CloseConnection(); }
        }
        //***

        public void CreateTxtfile(string zipname, string aid, string jrnlname, string pub, string stage = "FP", string readme = "", string vol = "", string iss = "")
        {
            string id = "";
            switch (stage)
            {
                case "Revises 1":
                    if (!(Directory.Exists(@"D:\WatchTXT"))) Directory.CreateDirectory(@"D:\WatchTXT");
                    File.Copy(zipname, @"D:\WatchTXT\" + Path.GetFileName(zipname), true);
                    if (pub == "CUP")
                    {
                        File.WriteAllText(@"D:\WatchTXT\" + Path.GetFileNameWithoutExtension(zipname) + @".txt", @"D:\WatchTXT\" + Path.GetFileName(zipname) + @"~" + aid);
                    }
                    break;
                case "FP":
                    if (!(Directory.Exists(@"D:\WatchTXT"))) Directory.CreateDirectory(@"D:\WatchTXT");
                    File.Copy(zipname, @"D:\WatchTXT\" + Path.GetFileName(zipname), true);
                    if (pub == "GSL")
                    {
                        File.Copy(zipname.Replace(".zip", ".go.xml"), @"D:\WatchTXT\" + Path.GetFileName(zipname.Replace(".zip", ".go.xml")), true);
                        File.WriteAllText(@"D:\WatchTXT\" + aid + @".txt", @"D:\WatchTXT\" + Path.GetFileName(zipname) + @"~\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\First Proof\" + Path.GetFileName(zipname));
                        File.WriteAllText(@"D:\WatchTXT\" + aid + @"_1.txt", @"D:\WatchTXT\" + Path.GetFileName(zipname.Replace(".zip", ".go.xml")) + @"~\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\First Proof\" + Path.GetFileName(zipname.Replace(".zip", ".go.xml")));
                    }
                    else if (pub == "AIP") File.WriteAllText(@"D:\WatchTXT\" + aid + jrnlname + @".txt", @"D:\WatchTXT\" + Path.GetFileName(zipname) + @"~\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + jrnlname + @"\First Proof\" + Path.GetFileName(zipname));

                    else if (pub == "Veruscript" || pub == "ASME" || pub == "AIPNew" || pub == "GSA" || pub == "Frontiers") File.WriteAllText(@"D:\WatchTXT\" + aid + jrnlname + @".txt", @"D:\WatchTXT\" + Path.GetFileName(zipname) + @"~\\Techsetserver2\Journal\" + pub.Replace("AIPNew", "AIP") + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\First Proof\" + Path.GetFileName(zipname));

                    else if (pub == "APS") File.WriteAllText(@"D:\WatchTXT\" + aid + jrnlname + @".txt", @"D:\WatchTXT\" + Path.GetFileName(zipname) + @"~\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\First Proof\" + Path.GetFileName(zipname));
                    else if (pub == "OSA") File.WriteAllText(@"D:\WatchTXT\" + aid + jrnlname + @".txt", @"D:\WatchTXT\" + Path.GetFileName(zipname) + @"~\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + jrnlname + aid + @"\First Proof\" + Path.GetFileName(zipname));
                    break;
                case "PP":
                    if (!(Directory.Exists(@"D:\WatchTXT"))) Directory.CreateDirectory(@"D:\WatchTXT");
                    if (pub == "GSL")
                    {
                        File.Copy(zipname, @"D:\WatchTXT\" + Path.GetFileName(zipname), true);
                        File.Copy(zipname.Replace(".zip", ".go.xml"), @"D:\WatchTXT\" + Path.GetFileName(zipname.Replace(".zip", ".go.xml")), true);
                        File.WriteAllText(@"D:\WatchTXT\" + aid + @".txt", @"D:\WatchTXT\" + Path.GetFileName(zipname) + @"~\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\Pre-Process\" + Path.GetFileName(zipname));
                        File.WriteAllText(@"D:\WatchTXT\" + aid + @"_1.txt", @"D:\WatchTXT\" + Path.GetFileName(zipname.Replace(".zip", ".go.xml")) + @"~\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\Pre-Process\" + Path.GetFileName(zipname.Replace(".zip", ".go.xml")));
                    }
                    break;
                case "AC":
                    string Outpath = @"\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + jrnlname + @"\AU Correction\" + Path.GetFileName(zipname);
                    if (pub == "Veruscript" || pub == "GSL" || pub == "AIPNew" || pub == "GSA" || pub == "SAGE") Outpath = @"\\Techsetserver2\Journal\" + pub.Replace("AIPNew", "AIP") + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\AU Correction\" + Path.GetFileName(zipname);
                    if (pub == "ASME") Outpath = @"\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\Author Correction\" + Path.GetFileName(zipname);
                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    File.Copy(zipname, Outpath, true);
                    if (pub == "GSL") File.Copy(zipname.Replace(".zip", ".go.xml"), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileName(zipname.Replace(".zip", ".go.xml")));
                    if (Path.GetExtension(zipname).ToLower() == ".zip") UnZip(zipname, Path.GetDirectoryName(Outpath));
                    try
                    {
                        if (Regex.IsMatch(Outpath, @"\\AIP\\", RegexOptions.IgnoreCase) && (Path.GetExtension(Outpath).ToLower() == ".zip" || Path.GetExtension(Outpath).ToLower() == ".rar")) File.Delete(Outpath);
                    }
                    catch (Exception e1) { SaveToReport(e1.Message + e1.StackTrace); }
                    break;
                case "AC1":
                    Outpath = @"\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + jrnlname + @"\AU Correction 1\" + Path.GetFileName(zipname);
                    if (pub == "Veruscript" || pub == "GSL" || pub == "AIPNew" || pub == "GSA") Outpath = @"\\Techsetserver2\Journal\" + pub.Replace("AIPNew", "AIP") + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\AU Correction 1\" + Path.GetFileName(zipname);
                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    File.Copy(zipname, Outpath, true);
                    if (pub == "GSL") File.Copy(zipname.Replace(".zip", ".go.xml"), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileName(zipname.Replace(".zip", ".go.xml")));
                    UnZip(zipname, Path.GetDirectoryName(Outpath));
                    try
                    {
                        if (Regex.IsMatch(Outpath, @"\\AIP\\", RegexOptions.IgnoreCase) && (Path.GetExtension(Outpath).ToLower() == ".zip" || Path.GetExtension(Outpath).ToLower() == ".rar")) File.Delete(Outpath);
                    }
                    catch (Exception e1) { SaveToReport(e1.Message + e1.StackTrace); }
                    break;
                case "AC2":
                    Outpath = @"\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + jrnlname + @"\AU Correction 2\" + Path.GetFileName(zipname);
                    if (pub == "Veruscript" || pub == "GSL" || pub == "AIPNew" || pub == "GSA") Outpath = @"\\Techsetserver2\Journal\" + pub.Replace("AIPNew", "AIP") + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\AU Correction 2\" + Path.GetFileName(zipname);
                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    File.Copy(zipname, Outpath, true);
                    if (pub == "GSL") File.Copy(zipname.Replace(".zip", ".go.xml"), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileName(zipname.Replace(".zip", ".go.xml")));
                    UnZip(zipname, Path.GetDirectoryName(Outpath));
                    try
                    {
                        if (Regex.IsMatch(Outpath, @"\\AIP\\", RegexOptions.IgnoreCase) && (Path.GetExtension(Outpath).ToLower() == ".zip" || Path.GetExtension(Outpath).ToLower() == ".rar")) File.Delete(Outpath);
                    }
                    catch (Exception e1) { SaveToReport(e1.Message + e1.StackTrace); }
                    break;
                case "AC3":
                    Outpath = @"\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + jrnlname + @"\AU Correction 3\" + Path.GetFileName(zipname);
                    if (pub == "Veruscript" || pub == "GSL" || pub == "AIPNew" || pub == "GSA") Outpath = @"\\Techsetserver2\Journal\" + pub.Replace("AIPNew", "AIP") + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\AU Correction 3\" + Path.GetFileName(zipname);
                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    File.Copy(zipname, Outpath, true);
                    if (pub == "GSL") File.Copy(zipname.Replace(".zip", ".go.xml"), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileName(zipname.Replace(".zip", ".go.xml")));
                    UnZip(zipname, Path.GetDirectoryName(Outpath));
                    try
                    {
                        if (Regex.IsMatch(Outpath, @"\\AIP\\", RegexOptions.IgnoreCase) && (Path.GetExtension(Outpath).ToLower() == ".zip" || Path.GetExtension(Outpath).ToLower() == ".rar")) File.Delete(Outpath);
                    }
                    catch (Exception e1) { SaveToReport(e1.Message + e1.StackTrace); }
                    break;
                case "AC4":
                    Outpath = @"\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + jrnlname + @"\AU Correction 4\" + Path.GetFileName(zipname);
                    if (pub == "Veruscript" || pub == "GSL" || pub == "AIPNew" || pub == "GSA") Outpath = @"\\Techsetserver2\Journal\" + pub.Replace("AIPNew", "AIP") + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\AU Correction 4\" + Path.GetFileName(zipname);
                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    File.Copy(zipname, Outpath, true);
                    UnZip(zipname, Path.GetDirectoryName(Outpath));
                    try
                    {
                        if (Regex.IsMatch(Outpath, @"\\AIP\\", RegexOptions.IgnoreCase) && (Path.GetExtension(Outpath).ToLower() == ".zip" || Path.GetExtension(Outpath).ToLower() == ".rar")) File.Delete(Outpath);
                    }
                    catch (Exception e1) { SaveToReport(e1.Message + e1.StackTrace); }
                    break;
                case "AC5":
                    Outpath = @"\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + jrnlname + @"\AU Correction 5\" + Path.GetFileName(zipname);
                    if (pub == "Veruscript" || pub == "GSL" || pub == "AIPNew" || pub == "GSA") Outpath = @"\\Techsetserver2\Journal\" + pub.Replace("AIPNew", "AIP") + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\AU Correction 5\" + Path.GetFileName(zipname);
                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    File.Copy(zipname, Outpath, true);
                    if (pub == "GSL") File.Copy(zipname.Replace(".zip", ".go.xml"), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileName(zipname.Replace(".zip", ".go.xml")));
                    UnZip(zipname, Path.GetDirectoryName(Outpath));
                    try
                    {
                        if (Regex.IsMatch(Outpath, @"\\AIP\\", RegexOptions.IgnoreCase) && (Path.GetExtension(Outpath).ToLower() == ".zip" || Path.GetExtension(Outpath).ToLower() == ".rar")) File.Delete(Outpath);
                    }
                    catch (Exception e1) { SaveToReport(e1.Message + e1.StackTrace); }
                    break;
                case "PM":
                case "PM1":
                case "PM2":
                case "PM3":
                case "PM4":
                case "PM5":
                    id = Regex.Match(stage, @"\d$").Value;
                    if (id != "") id = " " + id;
                    Outpath = @"\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + jrnlname + @"\PM Correction" + id + @"\" + Path.GetFileName(zipname);
                    if (pub == "Veruscript" || pub == "GSL" || pub == "ASME") Outpath = @"\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\PM Correction" + id + @"\" + Path.GetFileName(zipname);
                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    File.Copy(zipname, Outpath, true);
                    if (Path.GetExtension(zipname).ToLower() == ".zip") UnZip(zipname, Path.GetDirectoryName(Outpath));
                    break;
                case "FC":
                case "FC1":
                case "FC2":
                case "FC3":
                case "FC4":
                case "FC5":
                case "FC6":
                case "FC7":
                    id = Regex.Match(stage, @"\d$").Value;
                    if (id != "") id = " " + id;
                    Outpath = @"\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + jrnlname + @"\Final Correction" + id + @"\" + Path.GetFileName(zipname);
                    if (pub == "Veruscript" || pub == "GSL" || pub == "ASME") Outpath = @"\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\Final Correction" + id + @"\" + Path.GetFileName(zipname);
                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    try
                    {
                        File.Copy(zipname, Outpath, true);
                        if (Path.GetExtension(zipname).ToLower() == ".zip") UnZip(zipname, Path.GetDirectoryName(Outpath));
                        File.Delete(Outpath);
                    }
                    catch (Exception e1)
                    {
                        throw e1;
                    }
                    break;
                case "TUC":
                    Outpath = @"\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + jrnlname + @"\TU Correction\" + Path.GetFileName(zipname);
                    if (pub == "Veruscript" || pub == "GSL" || pub == "AIPNew") Outpath = @"\\Techsetserver2\Journal\" + pub.Replace("AIPNew", "AIP") + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\TU Correction\" + Path.GetFileName(zipname);
                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    File.Copy(zipname, Outpath, true);
                    UnZip(zipname, Path.GetDirectoryName(Outpath));
                    try
                    {
                        if (Regex.IsMatch(Outpath, @"\\AIP\\", RegexOptions.IgnoreCase) && (Path.GetExtension(Outpath).ToLower() == ".zip" || Path.GetExtension(Outpath).ToLower() == ".rar")) File.Delete(Outpath);
                    }
                    catch (Exception e1) { SaveToReport(e1.Message + e1.StackTrace); }
                    break;
                case "TUC1":
                    Outpath = @"\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + jrnlname + @"\TU Correction 1\" + Path.GetFileName(zipname);
                    if (pub == "Veruscript" || pub == "GSL" || pub == "AIPNew") Outpath = @"\\Techsetserver2\Journal\" + pub.Replace("AIPNew", "AIP") + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\TU Correction 1\" + Path.GetFileName(zipname);
                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    File.Copy(zipname, Outpath, true);
                    if (pub == "GSL") File.Copy(zipname.Replace(".zip", ".go.xml"), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileName(zipname.Replace(".zip", ".go.xml")));
                    UnZip(zipname, Path.GetDirectoryName(Outpath));
                    try
                    {
                        if (Regex.IsMatch(Outpath, @"\\AIP\\", RegexOptions.IgnoreCase) && (Path.GetExtension(Outpath).ToLower() == ".zip" || Path.GetExtension(Outpath).ToLower() == ".rar")) File.Delete(Outpath);
                    }
                    catch (Exception e1) { SaveToReport(e1.Message + e1.StackTrace); }
                    break;
                case "TUC2":
                    Outpath = @"\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + jrnlname + @"\TU Correction 2\" + Path.GetFileName(zipname);
                    if (pub == "Veruscript" || pub == "GSL" || pub == "AIPNew") Outpath = @"\\Techsetserver2\Journal\" + pub.Replace("AIPNew", "AIP") + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\TU Correction 2\" + Path.GetFileName(zipname);
                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    File.Copy(zipname, Outpath, true);
                    if (pub == "GSL") File.Copy(zipname.Replace(".zip", ".go.xml"), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileName(zipname.Replace(".zip", ".go.xml")));
                    UnZip(zipname, Path.GetDirectoryName(Outpath));
                    try
                    {
                        if (Regex.IsMatch(Outpath, @"\\AIP\\", RegexOptions.IgnoreCase) && (Path.GetExtension(Outpath).ToLower() == ".zip" || Path.GetExtension(Outpath).ToLower() == ".rar")) File.Delete(Outpath);
                    }
                    catch (Exception e1) { SaveToReport(e1.Message + e1.StackTrace); }
                    break;
                case "FWD":
                    Outpath = @"\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + jrnlname + @"\Final Web Delivery\" + Path.GetFileName(zipname); if (pub == "Veruscript" || pub == "GSL" || pub == "AIPNew") Outpath = @"\\Techsetserver2\Journal\" + pub.Replace("AIPNew", "AIP") + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\Final Web Delivery\" + Path.GetFileName(zipname);
                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    File.Copy(zipname, Outpath, true);
                    UnZip(zipname, Path.GetDirectoryName(Outpath));
                    try
                    {
                        if (Regex.IsMatch(Outpath, @"\\AIP\\", RegexOptions.IgnoreCase) && (Path.GetExtension(Outpath).ToLower() == ".zip" || Path.GetExtension(Outpath).ToLower() == ".rar")) File.Delete(Outpath);
                    }
                    catch (Exception e1) { SaveToReport(e1.Message + e1.StackTrace); }
                    if (readme != "") File.WriteAllText(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath) + @"\readme.xml", readme);
                    if (Path.GetFileNameWithoutExtension(zipname).Split('_').Length > 1 && (pub == "AIP" || pub == "AIPNew"))
                    {
                        if (Directory.Exists(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath))) Directory.Move(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath).Split('_')[0]);
                    }
                    if (pub == "GSL") File.Copy(zipname.Replace(".zip", ".go.xml"), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileName(zipname.Replace(".zip", ".go.xml")));
                    break;
                case "FWD2":
                    Outpath = @"\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + jrnlname + @"\Final Web Delivery 2\" + Path.GetFileName(zipname);
                    if (pub == "Veruscript" || pub == "GSL" || pub == "AIPNew") Outpath = @"\\Techsetserver2\Journal\" + pub.Replace("AIPNew", "AIP") + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\Final Web Delivery 2\" + Path.GetFileName(zipname);
                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    File.Copy(zipname, Outpath, true);
                    UnZip(zipname, Path.GetDirectoryName(Outpath));
                    try
                    {
                        if (Regex.IsMatch(Outpath, @"\\AIP\\", RegexOptions.IgnoreCase) && (Path.GetExtension(Outpath).ToLower() == ".zip" || Path.GetExtension(Outpath).ToLower() == ".rar")) File.Delete(Outpath);
                    }
                    catch (Exception e1) { SaveToReport(e1.Message + e1.StackTrace); }
                    if (readme != "") File.WriteAllText(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath) + @"\readme.xml", readme);
                    if (Path.GetFileNameWithoutExtension(zipname).Split('_').Length > 1)
                    {
                        if (Directory.Exists(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath))) Directory.Move(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath).Split('_')[0]);
                    }
                    if (pub == "GSL") File.Copy(zipname.Replace(".zip", ".go.xml"), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileName(zipname.Replace(".zip", ".go.xml")));
                    break;
                case "FWD3":
                    Outpath = @"\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + jrnlname + @"\Final Web Delivery 3\" + Path.GetFileName(zipname);
                    if (pub == "Veruscript" || pub == "GSL" || pub == "AIPNew") Outpath = @"\\Techsetserver2\Journal\" + pub.Replace("AIPNew", "AIP") + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\Final Web Delivery 3\" + Path.GetFileName(zipname);
                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    File.Copy(zipname, Outpath, true);
                    UnZip(zipname, Path.GetDirectoryName(Outpath));
                    try
                    {
                        if (Regex.IsMatch(Outpath, @"\\AIP\\", RegexOptions.IgnoreCase) && (Path.GetExtension(Outpath).ToLower() == ".zip" || Path.GetExtension(Outpath).ToLower() == ".rar")) File.Delete(Outpath);
                    }
                    catch (Exception e1) { SaveToReport(e1.Message + e1.StackTrace); }
                    if (readme != "") File.WriteAllText(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath) + @"\readme.xml", readme);
                    if (Path.GetFileNameWithoutExtension(zipname).Split('_').Length > 1)
                    {
                        if (Directory.Exists(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath))) Directory.Move(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath).Split('_')[0]);
                    }
                    if (pub == "GSL") File.Copy(zipname.Replace(".zip", ".go.xml"), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileName(zipname.Replace(".zip", ".go.xml")));
                    break;
                case "FWD4":
                    Outpath = @"\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + jrnlname + @"\Final Web Delivery 4\" + Path.GetFileName(zipname);
                    if (pub == "Veruscript" || pub == "GSL" || pub == "AIPNew") Outpath = @"\\Techsetserver2\Journal\" + pub.Replace("AIPNew", "AIP") + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\Final Web Delivery 4\" + Path.GetFileName(zipname);
                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    File.Copy(zipname, Outpath, true);
                    UnZip(zipname, Path.GetDirectoryName(Outpath));
                    try
                    {
                        if (Regex.IsMatch(Outpath, @"\\AIP\\", RegexOptions.IgnoreCase) && (Path.GetExtension(Outpath).ToLower() == ".zip" || Path.GetExtension(Outpath).ToLower() == ".rar")) File.Delete(Outpath);
                    }
                    catch (Exception e1) { SaveToReport(e1.Message + e1.StackTrace); }
                    if (readme != "") File.WriteAllText(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath) + @"\readme.xml", readme);
                    if (Path.GetFileNameWithoutExtension(zipname).Split('_').Length > 1)
                    {
                        if (Directory.Exists(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath))) Directory.Move(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath).Split('_')[0]);
                    }
                    if (pub == "GSL") File.Copy(zipname.Replace(".zip", ".go.xml"), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileName(zipname.Replace(".zip", ".go.xml")));
                    break;
                case "FWD5":
                    Outpath = @"\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + jrnlname + @"\Final Web Delivery 5\" + Path.GetFileName(zipname);
                    if (pub == "Veruscript" || pub == "GSL" || pub == "AIPNew") Outpath = @"\\Techsetserver2\Journal\" + pub.Replace("AIPNew", "AIP") + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\Final Web Delivery 5\" + Path.GetFileName(zipname);
                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    File.Copy(zipname, Outpath, true);
                    UnZip(zipname, Path.GetDirectoryName(Outpath));
                    try
                    {
                        if (Regex.IsMatch(Outpath, @"\\AIP\\", RegexOptions.IgnoreCase) && (Path.GetExtension(Outpath).ToLower() == ".zip" || Path.GetExtension(Outpath).ToLower() == ".rar")) File.Delete(Outpath);
                    }
                    catch (Exception e1) { SaveToReport(e1.Message + e1.StackTrace); }
                    if (readme != "") File.WriteAllText(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath) + @"\readme.xml", readme);
                    if (Path.GetFileNameWithoutExtension(zipname).Split('_').Length > 1)
                    {
                        if (Directory.Exists(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath))) Directory.Move(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath).Split('_')[0]);
                    }
                    if (pub == "GSL") File.Copy(zipname.Replace(".zip", ".go.xml"), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileName(zipname.Replace(".zip", ".go.xml")));
                    break;
                case "FWD6":
                    Outpath = @"\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + jrnlname + @"\Final Web Delivery 6\" + Path.GetFileName(zipname);
                    if (pub == "Veruscript" || pub == "GSL" || pub == "AIPNew") Outpath = @"\\Techsetserver2\Journal\" + pub.Replace("AIPNew", "AIP") + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\Final Web Delivery 6\" + Path.GetFileName(zipname);
                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    File.Copy(zipname, Outpath, true);
                    UnZip(zipname, Path.GetDirectoryName(Outpath));
                    try
                    {
                        if (Regex.IsMatch(Outpath, @"\\AIP\\", RegexOptions.IgnoreCase) && (Path.GetExtension(Outpath).ToLower() == ".zip" || Path.GetExtension(Outpath).ToLower() == ".rar")) File.Delete(Outpath);
                    }
                    catch (Exception e1) { SaveToReport(e1.Message + e1.StackTrace); }
                    if (readme != "") File.WriteAllText(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath) + @"\readme.xml", readme);
                    if (Path.GetFileNameWithoutExtension(zipname).Split('_').Length > 1)
                    {
                        if (Directory.Exists(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath))) Directory.Move(Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileNameWithoutExtension(Outpath).Split('_')[0]);
                    }
                    if (pub == "GSL") File.Copy(zipname.Replace(".zip", ".go.xml"), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileName(zipname.Replace(".zip", ".go.xml")));
                    break;
                case "PAP":
                case "PAPI":
                case "PAPII":
                case "PAPIII":
                    Outpath = @"\\Techsetserver2\Journal\" + pub + @"\" + jrnlname + @"\Articles\DataSupplied\" + aid + @"\" + stage + @"\" + Path.GetFileName(zipname);
                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    if (pub == "GSL") File.Copy(zipname.Replace(".zip", ".go.xml"), Path.GetDirectoryName(Outpath) + @"\" + Path.GetFileName(zipname.Replace(".zip", ".go.xml")));
                    File.Copy(zipname, Outpath, true);
                    UnZip(zipname, Path.GetDirectoryName(Outpath));
                    break;
                case "Printer Files 3":
                case "Printer Files 2":
                case "Printer Files":
                    Outpath = @"\\Techsetserver2\Journal\" + pub.Replace("AIPNew", "AIP") + @"\" + jrnlname + @"\ISSUE\" + vol + "-" + iss + @"\DataSupplied\" + stage + @"\" + Path.GetFileName(zipname);
                    if (!(Directory.Exists(Path.GetDirectoryName(Outpath)))) Directory.CreateDirectory(Path.GetDirectoryName(Outpath));
                    File.Copy(zipname, Outpath, true);
                    if (File.Exists(Path.GetDirectoryName(zipname) + @"\" + Path.GetFileNameWithoutExtension(zipname) + @"\readme.xml")) File.Copy(Path.GetDirectoryName(zipname) + @"\" + Path.GetFileNameWithoutExtension(zipname) + @"\readme.xml", Path.GetDirectoryName(Outpath) + @"\readme.xml", true);
                    UnZip(zipname, Path.GetDirectoryName(Outpath));
                    try
                    {
                        if (Regex.IsMatch(Outpath, @"\\AIP\\", RegexOptions.IgnoreCase) && (Path.GetExtension(Outpath).ToLower() == ".zip" || Path.GetExtension(Outpath).ToLower() == ".rar")) File.Delete(Outpath);
                    }
                    catch (Exception e1) { SaveToReport(e1.Message + e1.StackTrace); }
                    break;
            }
        }

        public int DownloadFrontiersEmailTAT(string articleid = "", string jacro = "", string AUflag = "")
        {
            int days = 0;

            if (!Directory.Exists(Environment.CurrentDirectory + @"\Emails\Frontier")) Directory.CreateDirectory(Environment.CurrentDirectory + @"\Emails\Frontier");
            string TOF = "", doi = "", journal = "", field = "", msg = "";
            SaveToReport("Searching Email articleid against " + articleid);
            try
            {
                OpenPop.Pop3.Pop3Client pop = new OpenPop.Pop3.Pop3Client();
                pop.Connect("pop3.live.com", 995, true);
                pop.Authenticate("frontiers_booking@novatechset.com", "Run747961");

                SaveToReport("Email Authentication");

                for (int i = pop.GetMessageCount() - 1; i > 0; i--)
                {
                    string sub = pop.GetMessage(i).Headers.Subject.ToString();
                    DateTime dt = pop.GetMessage(i).Headers.DateSent.Date;
                    SaveToReport("Email Subject" + sub);
                    if (dt.Date == DateTime.Now.Date || dt.Date >= DateTime.Now.Date.AddDays(-2).Date)
                    {
                        if (sub != "" && Regex.IsMatch(sub, "^(Frontiers: New Comments in Private Proof Discussion|Frontiers: Author's Proof Corrections Submitted)$", RegexOptions.IgnoreCase))
                        {
                            SaveToReport("Email Subject " + sub);
                            try
                            {
                                msg = pop.GetMessage(i).FindFirstHtmlVersion().GetBodyAsText();
                            }
                            catch (Exception e1)
                            {
                                SaveToReport("Email msg e1" + e1.Message);
                                if (msg == "")
                                {
                                    try
                                    {
                                        msg = pop.GetMessage(i).FindFirstPlainTextVersion().GetBodyAsText();
                                    }
                                    catch (Exception e2)
                                    {
                                        SaveToReport("Email msg e2" + e2.Message);
                                        msg = "";
                                    }
                                }
                            }
                            if (msg == "") continue;
                            DBClass Db = new DBClass();
                            TOF = Regex.Match(msg, @"@TOF\s*(.*)", RegexOptions.IgnoreCase).Groups[1].Value;
                            doi = Regex.Match(msg, @"Article DOI:\s*(.*)", RegexOptions.IgnoreCase).Groups[1].Value;
                            journal = Regex.Match(msg, @"Journal:\s*(.*)", RegexOptions.IgnoreCase).Groups[1].Value;
                            field = Regex.Match(msg, @"Field:\s*(.*)", RegexOptions.IgnoreCase).Groups[1].Value;
                            SaveToReport("TOF:" + TOF + " journal:" + journal + " field:" + field + " doi:" + doi);
                            if (doi != "")
                            {
                                doi = doi.Replace("<br>", "").Trim();
                                TOF = TOF.Replace("<br>", "").Trim();

                                string Aid = doi.Split('/')[doi.Split('/').Length - 1];
                                Aid = Aid.Replace(".", "");
                                SaveToReport("Aid " + Aid);
                                SaveToReport("jacro " + jacro);
                                string Level = "L1";
                                if (TOF.Contains("L2")) { days = 7; Level = "L2"; }
                                else if (TOF.Contains("L3")) { days = 9; Level = "L3"; }
                                else { days = 0; }
                                ;

                                if (jacro == "" && Aid != "")
                                {
                                    string jid = ReturnDetail("Artcl_jrnlId", "Article", Db, "Artcl_ArticleId='" + Aid + @"' and Artcl_jrnlid in (select jrnl_id from journal where Jrnl_PublID=113)");

                                    jacro = ReturnDetail("Jrnl_Acronym", "journal", Db, "Jrnl_PublID = '113' and Jrnl_Id=" + jid + @"");
                                }
                                //try
                                //{
                                //    string book1 = "SSP_EmailNotification '', '" + Aid + "' ,'" + jacro + "' , '" + field + "', '" + sub + "' , '" + TOF + "' ,'" + Level + "' , '" + msg.Replace("'", "''") + "'";
                                //    SaveToReport("Process completed. File: " + book1);
                                //    Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book1, Db.GetConnection());
                                //    Db.OpenConnection();
                                //    Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                //    Db.SqlReader.Close();
                                //}
                                //catch (Exception e2) { SaveToReport("Manuscript against TAT update Error while Frontiers hanshake update::  " + articleid + @"\n" + e2.Message + @"\n" + e2.StackTrace); }
                                if (articleid == Aid)
                                {

                                    pop.GetMessage(i).Save(new System.IO.FileInfo(@"D:\WatchTXT\" + Aid + "_" + sub.Replace(":", "").Replace("\t", "") + ".eml"));
                                    pop.GetMessage(i).Save(new System.IO.FileInfo(@"D:\WatchTXTDel\" + Aid + "_" + sub.Replace(":", "").Replace("\t", "") + ".eml"));
                                    string outputpath = "";
                                    if (AUflag == "AU")
                                    {
                                        //S:\Frontiers\FPAIN\Articles\DataSupplied\fpain2022914473\AU Correction
                                        outputpath = @"\\techsetserver2\Journal\Frontiers\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\AU Correction\" + Aid + "_" + sub.Replace(":", "").Replace("\t", "") + @".eml";
                                    }
                                    else
                                    {
                                        outputpath = @"\\techsetserver2\Journal\Frontiers\" + jacro + @"\Articles\DataSupplied\" + Aid + @"\First Proof\" + Aid + "_" + sub.Replace(":", "").Replace("\t", "") + @".eml";
                                    }
                                    File.Copy(@"D:\WatchTXT\" + Aid + "_" + sub.Replace(":", "").Replace("\t", "") + ".eml", outputpath, true);

                                    File.WriteAllText(@"D:\WatchTXT\" + Aid + @"_HsEml.txt", @"D:\WatchTXT\" + Aid + "_" + sub.Replace(":", "").Replace("\t", "") + @".eml~" + outputpath);
                                    pop.DeleteMessage(i);
                                    SendMail(Aid, "Dear Team,<Br/><Br/>Frontiers Booking: Article ID:" + Aid + "_" + sub.Replace(":", "").Replace("\t", "") + ".eml<Br/>DOI:" + doi + "<Br/>", "Frontiers", false, "Frontiers hanshake Email" + AUflag, @"D:\WatchTXT\" + Aid + "_" + sub.Replace(":", "").Replace("\t", "") + ".eml");
                                    SaveToReport("Process completed. File: " + Aid);
                                    SaveToReport("Process completed. File: " + articleid + "TAT : " + days);
                                    try
                                    {
                                        string book1 = "SSP_EmailNotification '', '" + Aid + "' ,'" + jacro + "' , '" + field + "', '" + sub.Replace("'", "''") + "' , '" + TOF + "' ,'" + Level + "' , '" + msg.Replace("'", "''") + "'";
                                        SaveToReport("Process completed. File: " + book1);
                                        Db.SqlCmd = new System.Data.SqlClient.SqlCommand(book1, Db.GetConnection());
                                        Db.OpenConnection();
                                        Db.SqlReader = Db.SqlCmd.ExecuteReader();
                                        Db.SqlReader.Close();
                                    }
                                    catch (Exception e1)
                                    {
                                        SaveToReport("Manuscript against TAT update Error while Frontiers hanshake update:" + AUflag + "" + articleid + @"\n" + e1.Message + @"\n" + e1.StackTrace);
                                    }
                                    break;
                                } //pop.Disconnect();
                            }
                        }
                    }
                    else break;
                }
                pop.Disconnect();
            }
            catch (Exception e)
            {
                SaveToReport("Error while Frontiers hanshake update:" + jacro + "" + AUflag + "" + articleid + @"\n" + e.Message + @"\n" + e.StackTrace);
                SendMail(articleid, "Dear Team,<Br/><Br/>Error while Frontiers hanshake update: Article ID:" + jacro + " " + AUflag + " " + articleid + @"\n" + e.Message + @"\n" + e.StackTrace + "<Br/>DOI:" + doi + "<Br/>", "Frontiers", false, "First Proof");
            }
            return days;

        }
    }
}
